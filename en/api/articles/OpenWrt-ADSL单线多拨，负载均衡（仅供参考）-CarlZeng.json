{"title":"OpenWrt >  ADSL单线多拨，负载均衡(供参考)","slug":"OpenWrt-ADSL单线多拨，负载均衡（仅供参考）-CarlZeng","date":"2016-03-22T13:29:00.000Z","updated":"2023-11-27T09:09:26.617Z","comments":true,"path":"api/articles/OpenWrt-ADSL单线多拨，负载均衡（仅供参考）-CarlZeng.json","excerpt":"ADSL单线多拨，负载均衡","covers":["http://images2015.cnblogs.com/blog/41238/201603/41238-20160323125607870-97593375.jpg","http://images2015.cnblogs.com/blog/41238/201603/41238-20160326151505526-1086117574.jpg","http://images.cnblogs.com/OutliningIndicators/ContractedBlock.gif","http://images.cnblogs.com/OutliningIndicators/ContractedBlock.gif","http://images.cnblogs.com/OutliningIndicators/ContractedBlock.gif","http://images.cnblogs.com/OutliningIndicators/ContractedBlock.gif"],"content":"<p>ADSL单线多拨，负载均衡</p>\n<span id=\"more\"></span>\n<ul>\n<li>2021年11月更新：如果是K2P A2版本硬件，请参考更简易的步骤，更加高效，不需要太多代码知识。 <a href=\"https://www.cnblogs.com/backuper/p/15523365.html\">K2P刷机-坐标北京Unicom</a></li>\n</ul>\n<p><strong>前题</strong></p>\n<hr>\n<ul>\n<li>硬件：路由器，刷入<a href=\"https://openwrt.org/\">OpenWrt</a></li>\n<li>一些背景知识和动手能力</li>\n</ul>\n<p><strong>目标效果图</strong></p>\n<hr>\n<p><img data-src=\"http://images2015.cnblogs.com/blog/41238/201603/41238-20160323125607870-97593375.jpg\" alt=\"实际例子Sample \"></p>\n<p><img data-src=\"http://images2015.cnblogs.com/blog/41238/201603/41238-20160326151505526-1086117574.jpg\"></p>\n<p><strong>步骤</strong></p>\n<hr>\n<ol>\n<li><p>使用SSH 登陆路由器。I.e. ssh <a href=\"mailto:&#x72;&#x6f;&#111;&#x74;&#x40;&#x31;&#x39;&#50;&#x2e;&#x31;&#x36;&#x38;&#46;&#x32;&#46;&#x31;\">&#x72;&#x6f;&#111;&#x74;&#x40;&#x31;&#x39;&#50;&#x2e;&#x31;&#x36;&#x38;&#46;&#x32;&#46;&#x31;</a></p>\n</li>\n<li><p>运行&#x2F;usr&#x2F;bin&#x2F;duobo。日志类似：</p>\n</li>\n<li><p><img data-src=\"http://images.cnblogs.com/OutliningIndicators/ContractedBlock.gif\"><img data-src=\"http://images.cnblogs.com/OutliningIndicators/ExpandedBlockStart.gif\"></p>\n<p>sh: 2: unknown operand<br>Killed<br>Warning: Unable to locate ipset utility, disabling ipset support * Flushing IPv4 filter table * Flushing IPv4 nat table * Flushing IPv4 mangle table * Flushing IPv4 raw table * Flushing conntrack table … * Populating IPv4 filter table * Zone ‘lan’<br>   * Zone ‘wan’<br>   * Rule ‘Allow-DHCP-Renew’<br>   * Rule ‘Allow-Ping’<br>   * Rule ‘51413’<br>   * Rule ‘9091’<br>   * Rule ‘9000’<br>   * Rule ‘6800’<br>   * Forward ‘lan’ -&gt; ‘wan’<br> * Populating IPv4 nat table * Zone ‘lan’<br>   * Zone ‘wan’<br> * Populating IPv4 mangle table * Zone ‘lan’<br>   * Zone ‘wan’<br> * Populating IPv4 raw table * Zone ‘lan’<br>   * Zone ‘wan’<br> * Set tcp_ecn to off * Set tcp_syncookies to on * Set tcp_window_scaling to on * Running script ‘&#x2F;etc&#x2F;firewall.user’<br> * Running script ‘&#x2F;usr&#x2F;share&#x2F;miniupnpd&#x2F;firewall.include’<br> * Running script ‘&#x2F;usr&#x2F;share&#x2F;qos_gargoyle&#x2F;firewall.include’<br>   ! Failed with exit code 1 ___________________________________________________<br>开始第1次拔号………..<br>正在并发拔号中………….<br>等待3秒………….<br>[3]拔[0]拔成功, 小于设定的[2]拔，将重新拔号…</p>\n<p>_________________________</p>\n<p>View Code</p>\n</li>\n<li><p>_如果没有成功并发多播，根据提示信息调整duobo的内部参数设置，重新运行_。分享一些技巧：</p>\n</li>\n<li><p>number&#x3D;10 #number是重拔次数，本脚本启动后一共尝试的次数 n=7 #n是几拔，同时发出几拨，理论上设置越大成功概率越大！ ok=2 #ok是拔上几次后退出拔号, 要实现的预期目标<br>wait=5 #wait time 每次单线多拨失败后，重试的等待时间</p>\n<ul>\n<li><strong>原则：</strong>失败多次以后，建议冷重启路由器，多个运行中的脚本会互相冲突，把问题复杂化。</li>\n<li><strong>多拨失败以后，耐心等上1分钟；很多次的多播成功都是脚本完成以后退出，然后60秒内获取了超过预期的多条链接。</strong></li>\n<li><strong>把n调到7，这样会虚拟出很多wan接口，根据硬件性能，理论上设置越大成功概率越大！</strong></li>\n<li>将ok调低一点，比如2。我觉得别太贪心，如果能稳定多播2个ADSL的IP，那其实概率上更折中了稳定性和高负载下的带宽均衡。</li>\n<li>wait的时间我感觉5秒－8秒差不多，这个要看运行日志，做相应调整。</li>\n<li>看懂程序的原理，根据实际情况调整脚本程序。比如：这个版本的程序是这么多播的，ifup $prefix$i</li>\n</ul>\n</li>\n</ol>\n<p><strong>遗留问题</strong></p>\n<hr>\n<p><img data-src=\"http://images.cnblogs.com/OutliningIndicators/ContractedBlock.gif\"><img data-src=\"http://images.cnblogs.com/OutliningIndicators/ExpandedBlockStart.gif\"></p>\n<p> 1 开始第3次拔号………..<br> 2 正在并发拔号中………….<br> 3 等待10秒………….<br> 4 pppoe-wan Link encap:Point-to-Point Protocol<br> 5 pppoe-wan3 Link encap:Point-to-Point Protocol<br> 6 [3]拔[2]拔成功, 大于或等于设定的[2]拨，退出拔号…<br> 7 Error: an inet address is expected rather than “dev”.<br> 8 iptables v1.4.10: Couldn’t load target `zone_wan_notrack’:File not found<br> 9<br>10 Try `iptables -h’ or ‘iptables –help’ for more information.<br>11 iptables v1.4.10: Couldn’t load target `zone_wan_nat’:File not found 12<br>13 Try `iptables -h’ or ‘iptables –help’ for more information.<br>14 iptables: No chain&#x2F;target&#x2F;match by that name. 15 iptables v1.4.10: Couldn’t load target `zone_wan’:File not found 16<br>17 Try `iptables -h’ or ‘iptables –help’ for more information.<br>18 iptables: No chain&#x2F;target&#x2F;match by that name. 19 iptables: No chain&#x2F;target&#x2F;match by that name. 20 iptables: No chain&#x2F;target&#x2F;match by that name. 21 iptables: No chain&#x2F;target&#x2F;match by that name. 22 iptables: No chain&#x2F;target&#x2F;match by that name. 23 iptables: No chain&#x2F;target&#x2F;match by that name. 24 iptables: No chain&#x2F;target&#x2F;match by that name. 25 Error: an inet address is expected rather than “dev”. 26 iptables v1.4.10: Couldn’t load target `zone_wan_notrack’:File not found 27<br>28 Try `iptables -h’ or ‘iptables –help’ for more information.<br>29 iptables v1.4.10: Couldn’t load target `zone_wan_nat’:File not found 30<br>31 Try `iptables -h’ or ‘iptables –help’ for more information.<br>32 iptables: No chain&#x2F;target&#x2F;match by that name. 33 iptables v1.4.10: Couldn’t load target `zone_wan’:File not found 34<br>35 Try `iptables -h’ or ‘iptables –help’ for more information.<br>36 iptables: No chain&#x2F;target&#x2F;match by that name. 37 iptables: No chain&#x2F;target&#x2F;match by that name. 38 iptables: No chain&#x2F;target&#x2F;match by that name. 39 iptables: No chain&#x2F;target&#x2F;match by that name. 40 iptables: No chain&#x2F;target&#x2F;match by that name. 41 iptables: No chain&#x2F;target&#x2F;match by that name. 42 iptables: No chain&#x2F;target&#x2F;match by that name. 43 Error: an IP address is expected rather than “dev”<br>44 192.168.2.0&#x2F;24 dev br-lan  proto kernel  scope link  src 192.168.2.1<br>45 221.218.232.1 dev pppoe-wan3  proto kernel  scope link  src 123.112.248.148<br>46 221.218.232.1 dev pppoe-wan  proto kernel  scope link  src 221.218.236.51<br>47 Kernel IP routing table 48 Destination     Gateway         Genmask         Flags Metric Ref    Use Iface 49 192.168.2.0     0.0.0.0         255.255.255.0   U     0      0        0 br-lan 50 221.218.232.1   0.0.0.0         255.255.255.255 UH    0      0        0 pppoe-wan3 51 221.218.232.1   0.0.0.0         255.255.255.255 UH    0      0        0 pppoe-wan</p>\n<p>View Error Code</p>\n<p>显然这个0.3版本的脚本不完全适用于我的路由器，有时间我需要查查原因。</p>\n<p>估计都是关于iptables</p>\n<p>有没有大侠探讨一下？</p>\n<p><em>修正了下面版本中的一个错误</em></p>\n<p><em>line 19：if [ $j -ge $ok ] ;</em></p>\n<p><strong>多拨代码(V0.3)</strong></p>\n<hr>\n<p><img data-src=\"http://images.cnblogs.com/OutliningIndicators/ContractedBlock.gif\"><img data-src=\"http://images.cnblogs.com/OutliningIndicators/ExpandedBlockStart.gif\"></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"> 1 #!/bin/sh</span><br><span class=\"line\"> 2 #modified by muziling v0.3</span><br><span class=\"line\"> 3 #并发多拨脚本</span><br><span class=\"line\"> 4 </span><br><span class=\"line\"> 5 #number是重拔次数</span><br><span class=\"line\"> 6 #n是几拔</span><br><span class=\"line\"> 7 #ok是拔上几次后退出拔号</span><br><span class=\"line\"> 8 #wait time</span><br><span class=\"line\"> 9 </span><br><span class=\"line\"> 10 number=10</span><br><span class=\"line\"> 11 n=3</span><br><span class=\"line\"> 12 ok=2</span><br><span class=\"line\"> 13 wait\\=5</span><br><span class=\"line\"> 14 # avoid same with feixiang&#x27;s N-WAN naming and must start with &quot;wan&quot;</span><br><span class=\"line\"> 15 prefix=wan</span><br><span class=\"line\"> 16 vthprefix=vth</span><br><span class=\"line\"> 17 </span><br><span class=\"line\"> 18 j=$(ifconfig | grep pppoe-wan | wc -l)</span><br><span class=\"line\"> 19 if \\[ &quot;$j&quot; &gt;= &quot;$ok&quot; \\] ; 20 then</span><br><span class=\"line\"> 21     echo 已经是\\[$j\\]拔了，退出拔号... 22     exit 0</span><br><span class=\"line\"> 23 fi</span><br><span class=\"line\"> 24 </span><br><span class=\"line\"> 25 if \\[ -f /etc/config/nwannumset \\] ;</span><br><span class=\"line\"> 26 then</span><br><span class=\"line\"> 27     uci set nwannumset.@macvlan\\_numset\\[0\\].macvlan\\_num=1</span><br><span class=\"line\"> 28     uci commit nwannumset</span><br><span class=\"line\"> 29 fi</span><br><span class=\"line\"> 30 for i in $( seq 1 $(($n-1)))</span><br><span class=\"line\"> 31 do</span><br><span class=\"line\"> 32     ifname=$prefix$i</span><br><span class=\"line\"> 33     ifvth=$vthprefix$i</span><br><span class=\"line\"> 34     #ifwan=$(uci get network.wan.ifname)</span><br><span class=\"line\"> 35     pppoe\\_name=$(uci get network.wan.username) </span><br><span class=\"line\"> 36     pppoe\\_pw=$(uci get network.wan.password) </span><br><span class=\"line\"> 37 </span><br><span class=\"line\"> 38     if \\[ $(ip link | grep &quot; $&#123;ifvth&#125;@eth0.2:&quot; | wc -l) == &quot;0&quot; \\] ; 39     then</span><br><span class=\"line\"> 40         macfac=$(ifconfig | grep eth0.2 | tr -s &quot; &quot; | cut -d &quot; &quot; -f5 | cut -b 1\\-8)</span><br><span class=\"line\"> 41         mac=&quot;$macfac:&quot;$(md5sum /proc/sys/kernel/random/uuid | sed &#x27;s/\\\\(..\\\\)/&amp;:/g&#x27; | cut -b 1\\-8 | tr \\[a-f\\] \\[A-F\\])</span><br><span class=\"line\"> 42         ip link add link eth0.2 $ifvth type macvlan 43         ifconfig $ifvth hw ether $mac 44     fi</span><br><span class=\"line\"> 45 </span><br><span class=\"line\"> 46     # add /etc/config/network</span><br><span class=\"line\"> 47     uci delete network.$ifname</span><br><span class=\"line\"> 48     uci set network.$ifname=interface</span><br><span class=\"line\"> 49     uci set network.$ifname.ifname=$ifvth</span><br><span class=\"line\"> 50     #uci set network.$ifname.\\_orig\\_ifname=eth0.2</span><br><span class=\"line\"> 51     #uci set network.$ifname.\\_orig\\_bridge=false</span><br><span class=\"line\"> 52     uci set network.$ifname.proto=pppoe</span><br><span class=\"line\"> 53     uci set network.$ifname.username=$pppoe\\_name</span><br><span class=\"line\"> 54     uci set network.$ifname.password=$pppoe\\_pw</span><br><span class=\"line\"> 55     uci set network.$ifname.auto=0</span><br><span class=\"line\"> 56     uci set network.$ifname.defaultroute=0</span><br><span class=\"line\"> 57     uci set network.$ifname.peerdns=1</span><br><span class=\"line\"> 58     uci set network.$ifname.pppd\\_options=&quot;plugin rp-pppoe.so syncppp $n&quot;</span><br><span class=\"line\"> 59 </span><br><span class=\"line\"> 60     # add /etc/config/dhcp</span><br><span class=\"line\"> 61     uci delete dhcp.$ifvth</span><br><span class=\"line\"> 62     uci set dhcp.$ifvth=dhcp </span><br><span class=\"line\"> 63     uci set dhcp.$ifvth.interface=$ifname</span><br><span class=\"line\"> 64     uci set dhcp.$ifvth.ignore=1 </span><br><span class=\"line\"> 65 </span><br><span class=\"line\"> 66     if \\[ -f /etc/config/nwan \\] ;</span><br><span class=\"line\"> 67     then</span><br><span class=\"line\"> 68         uci delete nwan.$ifname</span><br><span class=\"line\"> 69         uci set nwan.$ifname=interface </span><br><span class=\"line\"> 70         uci set nwan.$ifname.name=telecom </span><br><span class=\"line\"> 71         uci set nwan.$ifname.route=balance </span><br><span class=\"line\"> 72         uci set nwan.$ifname.weight=1 </span><br><span class=\"line\"> 73         uci set nwan.$ifname.uptime\\=0day,0hour,0min</span><br><span class=\"line\"> 74         uci commit nwan</span><br><span class=\"line\"> 75     fi</span><br><span class=\"line\"> 76 done</span><br><span class=\"line\"> 77 uci set network.wan.defaultroute=0</span><br><span class=\"line\"> 78 uci set network.wan.peerdns=1</span><br><span class=\"line\"> 79 uci set network.wan.pppd\\_options=&quot;plugin rp-pppoe.so syncppp $n&quot;</span><br><span class=\"line\"> 80 uci commit network</span><br><span class=\"line\"> 81 uci commit dhcp</span><br><span class=\"line\"> 82 </span><br><span class=\"line\"> 83 fw\\_wan\\_list=$(uci show network |grep =interface |grep -v lan|grep -v loopback |cut -d&quot;.&quot; -f2 | awk -F &quot;\\=&quot; &#x27;&#123;printf $1&quot; &quot;&#125;&#x27;)</span><br><span class=\"line\"> 84 uci set firewall.@zone\\[1\\].network=&quot;$fw\\_wan\\_list&quot;</span><br><span class=\"line\"> 85 uci commit firewall</span><br><span class=\"line\"> 86 /etc/init.d/firewall restart</span><br><span class=\"line\"> 87 </span><br><span class=\"line\"> 88 for q in $( seq 1 $number ) 89 do</span><br><span class=\"line\"> 90     echo</span><br><span class=\"line\"> 91     echo \\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_ 92     echo 开始第$q次拔号........... 93     killall -q -SIG pppd</span><br><span class=\"line\"> 94     if \\[ &quot;$q&quot; == &quot;1&quot; \\] ; 95     then</span><br><span class=\"line\"> 96         for i in $( seq 1 $(($n-1)))</span><br><span class=\"line\"> 97         do</span><br><span class=\"line\"> 98             ifup $prefix$i</span><br><span class=\"line\"> 99         done</span><br><span class=\"line\">100     fi</span><br><span class=\"line\">101 </span><br><span class=\"line\">102     echo 正在并发拔号中............. 103     echo 等待$wait秒............. 104     sleep $wait</span><br><span class=\"line\">105 </span><br><span class=\"line\">106     j=$(ps | grep pppd | wc -l) 107     ! \\[ &quot;$j&quot; -ge &quot;$n&quot; \\]  &amp;&amp; ifup $&#123;prefix&#125;1</span><br><span class=\"line\">108 </span><br><span class=\"line\">109     ifconfig|grep pppoe 110     j=$(ifconfig | grep pppoe-wan | wc -l) 111 </span><br><span class=\"line\">112     ! \\[ &quot;$j&quot; -ge &quot;$ok&quot; \\] &amp;&amp; echo \\[$n\\]拔\\[$j\\]拔成功, 小于设定的\\[$ok\\]拔，将重新拔号... 113     \\[ &quot;$j&quot; -ge &quot;$ok&quot; \\] &amp;&amp; echo \\[$n\\]拔\\[$j\\]拔成功, 大于或等于设定的\\[$ok\\]拨，退出拔号... 114 </span><br><span class=\"line\">115     if \\[ &quot;$j&quot; -ge &quot;$ok&quot; \\] ; 116     then</span><br><span class=\"line\">117         for i in $( seq 0 $(($n-1))) 118         do</span><br><span class=\"line\">119             if \\[ &quot;$i&quot; == &quot;0&quot; \\] ; 120             then</span><br><span class=\"line\">121                 interface=wan 122             else</span><br><span class=\"line\">123                 interface=$prefix$i 124             fi</span><br><span class=\"line\">125             if \\[ $(ifconfig | grep &quot;pppoe-$interface &quot; | wc -l) == &quot;0&quot; \\] ; 126             then</span><br><span class=\"line\">127 ifdown $interface 128             fi</span><br><span class=\"line\">129         done</span><br><span class=\"line\">130 break 131     fi</span><br><span class=\"line\">132 done</span><br><span class=\"line\">133 # kill ddns sleep and re-check wan ip change 134 killall sleep</span><br><span class=\"line\">135 </span><br><span class=\"line\">136 j=$(ifconfig | grep pppoe-wan | wc -l) 137 ! \\[ &quot;$j&quot; -ge 0 \\] &amp;&amp; reboot 138 </span><br><span class=\"line\">139 #ppoename=$(ifconfig |grep &#x27;ppoe-&#x27; |awk &#x27;&#123;print substr($1,7)&#125;&#x27;|tr &#x27;\\\\n&#x27; &#x27; &#x27;) 140 ppoename=$(ifconfig |grep &#x27;ppoe-&#x27; |awk &#x27;&#123;print $1&#125;&#x27;|tr &#x27;\\\\n&#x27; &#x27; &#x27;) 141 i=0</span><br><span class=\"line\">142 vias=&quot;&quot;</span><br><span class=\"line\">143 for wan\\_ifname in $ppoename 144 do</span><br><span class=\"line\">145     vias=&quot;$vias nexthop via $wan\\_ip dev $wan\\_ifname weight 1 &quot;</span><br><span class=\"line\">146     let &quot;rt=100+$i&quot;</span><br><span class=\"line\">147     i=$(($i+1)) 148 ip route flush table $rt 149 ip route add default via $wan\\_ip dev $wan\\_ifname table $rt 150     ip route add table $rt to $(ip route | grep br-lan) 151 </span><br><span class=\"line\">152     if \\[ $(iptables -t nat -vxnL POSTROUTING | grep -c &quot; $wan\\_ifname &quot;) == &quot;0&quot; \\] ; 153     then</span><br><span class=\"line\">154         iptables -t raw -A PREROUTING -i $wan\\_ifname -j zone\\_wan\\_notrack 155         iptables -t nat -A PREROUTING -i $wan\\_ifname -j zone\\_wan\\_prerouting 156         iptables -t nat -A POSTROUTING -o $wan\\_ifname -j zone\\_wan\\_nat 157         iptables -t filter -A forward -i $wan\\_ifname -j zone\\_wan\\_forward 158         iptables -t filter -A input -i $wan\\_ifname -j zone\\_wan 159         iptables -t filter -A zone\\_wan\\_ACCEPT -o $wan\\_ifname -j ACCEPT 160         iptables -t filter -A zone\\_wan\\_ACCEPT -i $wan\\_ifname -j ACCEPT 161         iptables -t filter -A zone\\_wan\\_DROP -o $wan\\_ifname -j DROP 162         iptables -t filter -A zone\\_wan\\_DROP -i $wan\\_ifname -j DROP 163         iptables -t filter -A zone\\_wan\\_REJECT -o $wan\\_ifname -j reject 164         iptables -t filter -A zone\\_wan\\_REJECT -i $wan\\_ifname -j reject 165     fi</span><br><span class=\"line\">166     iptables -A PREROUTING -t mangle -i $wan\\_ifname -j MARK --set-mark $rt 167     iptables -t mangle -A zone\\_wan\\_MSSFIX -o $wan\\_ifname -p tcp -m tcp --tcp-flags SYN,RST SYN -j TCPMSS --clamp-mss-to-pmtu 168 ip rule add fwmark $rt table $rt prio $rt 169 done</span><br><span class=\"line\">170 ip route del default 171 ip route add default scope global $vias 172 ip route flush cache 173 ip route list 174 route -n 175 root@OpenWrt:~# </span><br></pre></td></tr></table></figure>\n<p>View Code (duobo)</p>\n<p>修订版（V0.3.1）</p>\n<p><img data-src=\"http://images.cnblogs.com/OutliningIndicators/ContractedBlock.gif\"><img data-src=\"http://images.cnblogs.com/OutliningIndicators/ExpandedBlockStart.gif\"></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"> 1 #!/bin/sh</span><br><span class=\"line\"> 2 #modified by muziling v0.3</span><br><span class=\"line\"> 3 #并发多拨脚本</span><br><span class=\"line\"> 4 #modified by carl v0.3.1 (修正一处bug，改善友好提示信息) 5 </span><br><span class=\"line\"> 6 #number是重拔次数，本脚本启动后一共尝试的次数</span><br><span class=\"line\"> 7 #n是几拔，同时发出几拨，理论上设置越大成功概率越大！</span><br><span class=\"line\"> 8 #ok是拔上几次后退出拔号, 要实现的预期目标</span><br><span class=\"line\"> 9 #wait time 每次单线多拨失败后，重试的等待时间 10 </span><br><span class=\"line\"> 11 number=15</span><br><span class=\"line\"> 12 n=7</span><br><span class=\"line\"> 13 ok=2</span><br><span class=\"line\"> 14 wait\\=8</span><br><span class=\"line\"> 15 # avoid same with feixiang&#x27;s N-WAN naming and must start with &quot;wan&quot;</span><br><span class=\"line\"> 16 prefix=wan</span><br><span class=\"line\"> 17 vthprefix=vth</span><br><span class=\"line\"> 18 </span><br><span class=\"line\"> 19 j=$(ifconfig | grep pppoe-wan | wc -l)</span><br><span class=\"line\"> 20 if \\[ $j -ge $ok \\] ;</span><br><span class=\"line\"> 21 then</span><br><span class=\"line\"> 22     echo 已经是\\[$j\\]拔了，退出拔号程序。 23     exit 0</span><br><span class=\"line\"> 24 fi</span><br><span class=\"line\"> 25 </span><br><span class=\"line\"> 26 if \\[ -f /etc/config/nwannumset \\] ;</span><br><span class=\"line\"> 27 then</span><br><span class=\"line\"> 28     uci set nwannumset.@macvlan\\_numset\\[0\\].macvlan\\_num=1</span><br><span class=\"line\"> 29     uci commit nwannumset</span><br><span class=\"line\"> 30 fi</span><br><span class=\"line\"> 31 </span><br><span class=\"line\"> 32 for i in $( seq 1 $(($n-1)))</span><br><span class=\"line\"> 33 do</span><br><span class=\"line\"> 34     ifname=$prefix$i</span><br><span class=\"line\"> 35     ifvth=$vthprefix$i</span><br><span class=\"line\"> 36     #ifwan=$(uci get network.wan.ifname)</span><br><span class=\"line\"> 37     pppoe\\_name=$(uci get network.wan.username) </span><br><span class=\"line\"> 38     pppoe\\_pw=$(uci get network.wan.password) </span><br><span class=\"line\"> 39 </span><br><span class=\"line\"> 40     if \\[ $(ip link | grep &quot; $&#123;ifvth&#125;@eth0.2:&quot; | wc -l) == &quot;0&quot; \\] ; 41     then</span><br><span class=\"line\"> 42         macfac=$(ifconfig | grep eth0.2 | tr -s &quot; &quot; | cut -d &quot; &quot; -f5 | cut -b 1\\-8)</span><br><span class=\"line\"> 43         mac=&quot;$macfac:&quot;$(md5sum /proc/sys/kernel/random/uuid | sed &#x27;s/\\\\(..\\\\)/&amp;:/g&#x27; | cut -b 1\\-8 | tr \\[a-f\\] \\[A-F\\])</span><br><span class=\"line\"> 44         ip link add link eth0.2 $ifvth type macvlan 45         ifconfig $ifvth hw ether $mac 46         echo 更换MAC完毕$ifvth. 47     fi</span><br><span class=\"line\"> 48 </span><br><span class=\"line\"> 49     # add /etc/config/network</span><br><span class=\"line\"> 50     uci delete network.$ifname</span><br><span class=\"line\"> 51     uci set network.$ifname=interface</span><br><span class=\"line\"> 52     uci set network.$ifname.ifname=$ifvth</span><br><span class=\"line\"> 53     #uci set network.$ifname.\\_orig\\_ifname=eth0.2</span><br><span class=\"line\"> 54     #uci set network.$ifname.\\_orig\\_bridge=false</span><br><span class=\"line\"> 55     uci set network.$ifname.proto=pppoe</span><br><span class=\"line\"> 56     uci set network.$ifname.username=$pppoe\\_name</span><br><span class=\"line\"> 57     uci set network.$ifname.password=$pppoe\\_pw</span><br><span class=\"line\"> 58     uci set network.$ifname.auto=0</span><br><span class=\"line\"> 59     uci set network.$ifname.defaultroute=0</span><br><span class=\"line\"> 60     uci set network.$ifname.peerdns=1</span><br><span class=\"line\"> 61     uci set network.$ifname.pppd\\_options=&quot;plugin rp-pppoe.so syncppp $n&quot;</span><br><span class=\"line\"> 62 </span><br><span class=\"line\"> 63     # add /etc/config/dhcp</span><br><span class=\"line\"> 64     uci delete dhcp.$ifvth</span><br><span class=\"line\"> 65     uci set dhcp.$ifvth=dhcp </span><br><span class=\"line\"> 66     uci set dhcp.$ifvth.interface=$ifname</span><br><span class=\"line\"> 67     uci set dhcp.$ifvth.ignore=1 </span><br><span class=\"line\"> 68 </span><br><span class=\"line\"> 69     if \\[ -f /etc/config/nwan \\] ;</span><br><span class=\"line\"> 70     then</span><br><span class=\"line\"> 71         uci delete nwan.$ifname</span><br><span class=\"line\"> 72         uci set nwan.$ifname=interface </span><br><span class=\"line\"> 73         uci set nwan.$ifname.name=unicom </span><br><span class=\"line\"> 74         uci set nwan.$ifname.route=balance </span><br><span class=\"line\"> 75         uci set nwan.$ifname.weight=1 </span><br><span class=\"line\"> 76         uci set nwan.$ifname.uptime\\=0day,0hour,0min</span><br><span class=\"line\"> 77         uci commit nwan</span><br><span class=\"line\"> 78     fi</span><br><span class=\"line\"> 79 done</span><br><span class=\"line\"> 80 </span><br><span class=\"line\"> 81 uci set network.wan.defaultroute=0</span><br><span class=\"line\"> 82 uci set network.wan.peerdns=1</span><br><span class=\"line\"> 83 uci set network.wan.pppd\\_options=&quot;plugin rp-pppoe.so syncppp $n&quot;</span><br><span class=\"line\"> 84 uci commit network</span><br><span class=\"line\"> 85 uci commit dhcp</span><br><span class=\"line\"> 86 </span><br><span class=\"line\"> 87 fw\\_wan\\_list=$(uci show network |grep =interface |grep -v lan|grep -v loopback |cut -d&quot;.&quot; -f2 | awk -F &quot;\\=&quot; &#x27;&#123;printf $1&quot; &quot;&#125;&#x27;)</span><br><span class=\"line\"> 88 uci set firewall.@zone\\[1\\].network=&quot;$fw\\_wan\\_list&quot;</span><br><span class=\"line\"> 89 uci commit firewall</span><br><span class=\"line\"> 90 /etc/init.d/firewall restart</span><br><span class=\"line\"> 91 </span><br><span class=\"line\"> 92 for q in $( seq 1 $number ) 93 do</span><br><span class=\"line\"> 94     echo</span><br><span class=\"line\"> 95     echo \\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_ 96     echo 开始第$q次拔号........... 97     killall -q -SIG pppd</span><br><span class=\"line\"> 98     if \\[ &quot;$q&quot; == &quot;1&quot; \\] ; 99     then</span><br><span class=\"line\">100         for i in $( seq 1 $(($n-1))) 101         do</span><br><span class=\"line\">102 ifup $prefix$i 103         done</span><br><span class=\"line\">104     fi</span><br><span class=\"line\">105 </span><br><span class=\"line\">106     echo 正在并发拔号中............. 107     echo 等待$wait秒............. 108     sleep $wait</span><br><span class=\"line\">109 </span><br><span class=\"line\">110     j=$(ps | grep pppd | wc -l) 111     ! \\[ &quot;$j&quot; -ge &quot;$n&quot; \\]  &amp;&amp; ifup $&#123;prefix&#125;1</span><br><span class=\"line\">112 </span><br><span class=\"line\">113     ifconfig | grep pppoe 114     j=$(ifconfig | grep pppoe-wan | wc -l) 115 </span><br><span class=\"line\">116     ! \\[ &quot;$j&quot; -ge &quot;$ok&quot; \\] &amp;&amp; echo \\[$n\\]拔\\[$j\\]拔成功, 小于设定的\\[$ok\\]拔，将重新拔号... 117     \\[ &quot;$j&quot; -ge &quot;$ok&quot; \\] &amp;&amp; echo \\[$n\\]拔\\[$j\\]拔成功, 大于或等于设定的\\[$ok\\]拨，退出拔号... 118     </span><br><span class=\"line\">119     if \\[ &quot;$j&quot; -ge &quot;$ok&quot; \\] ; 120     then</span><br><span class=\"line\">121         for i in $( seq 0 $(($n-1))) 122         do</span><br><span class=\"line\">123             if \\[ &quot;$i&quot; == &quot;0&quot; \\] ; 124             then</span><br><span class=\"line\">125                 interface=wan 126             else</span><br><span class=\"line\">127                 interface=$prefix$i 128             fi</span><br><span class=\"line\">129             if \\[ $(ifconfig | grep &quot;pppoe-$interface &quot; | wc -l) == &quot;0&quot; \\] ; 130             then</span><br><span class=\"line\">131 ifdown $interface 132             fi</span><br><span class=\"line\">133         done</span><br><span class=\"line\">134 break 135     fi</span><br><span class=\"line\">136 done # done/tried all tring times $number 137 </span><br><span class=\"line\">138 # kill ddns sleep and re-check wan ip change 139 killall sleep</span><br><span class=\"line\">140 </span><br><span class=\"line\">141 # reboot the machine if failed tried times 142 #sleep $wait</span><br><span class=\"line\">143 j=$(ifconfig | grep pppoe-wan | wc -l) 144 ! \\[ &quot;$j&quot; -gt 0 \\] &amp;&amp; reboot 145 </span><br><span class=\"line\">146 </span><br><span class=\"line\">147 echo \\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_ 148 echo 开始N-WAN负载均衡功能... 149 #ppoename=$(ifconfig |grep &#x27;ppoe-&#x27; |awk &#x27;&#123;print substr($1,7)&#125;&#x27;|tr &#x27;\\\\n&#x27; &#x27; &#x27;) 150 ppoename=$(ifconfig|grep &#x27;ppoe-&#x27; |awk &#x27;&#123;print $1&#125;&#x27;|tr &#x27;\\\\n&#x27; &#x27; &#x27;) 151 i=0</span><br><span class=\"line\">152 vias=&quot;&quot;</span><br><span class=\"line\">153 for wan\\_ifname in $ppoename 154 do</span><br><span class=\"line\">155     vias=&quot;$vias nexthop via $wan\\_ip dev $wan\\_ifname weight 1 &quot;</span><br><span class=\"line\">156     let &quot;rt=100+$i&quot;</span><br><span class=\"line\">157     i=$(($i+1)) 158 ip route flush table $rt 159 #REMOVE ERROR 160 ip route add default via $wan\\_ip dev $wan\\_ifname table $rt 161     ip route add table $rt to $(ip route | grep br-lan) 162 </span><br><span class=\"line\">163     if \\[ $(iptables -t nat -vxnL POSTROUTING | grep -c &quot; $wan\\_ifname &quot;) == &quot;0&quot; \\] ; 164     then</span><br><span class=\"line\">165 #REMOVE ERROR 166         iptables -t raw -A PREROUTING -i $wan\\_ifname -j zone\\_wan\\_notrack 167         iptables -t nat -A PREROUTING -i $wan\\_ifname -j zone\\_wan\\_prerouting 168 #REMOVE ERROR 169         iptables -t nat -A POSTROUTING -o $wan\\_ifname -j zone\\_wan\\_nat 170         iptables -t filter -A forward -i $wan\\_ifname -j zone\\_wan\\_forward 171 #REMOVE ERROR 172         iptables -t filter -A input -i $wan\\_ifname -j zone\\_wan 173         iptables -t filter -A zone\\_wan\\_ACCEPT -o $wan\\_ifname -j ACCEPT 174         iptables -t filter -A zone\\_wan\\_ACCEPT -i $wan\\_ifname -j ACCEPT 175         iptables -t filter -A zone\\_wan\\_DROP -o $wan\\_ifname -j DROP 176         iptables -t filter -A zone\\_wan\\_DROP -i $wan\\_ifname -j DROP 177         iptables -t filter -A zone\\_wan\\_REJECT -o $wan\\_ifname -j reject 178         iptables -t filter -A zone\\_wan\\_REJECT -i $wan\\_ifname -j reject 179     fi</span><br><span class=\"line\">180     </span><br><span class=\"line\">181     iptables -A PREROUTING -t mangle -i $wan\\_ifname -j MARK --set-mark $rt 182     iptables -t mangle -A zone\\_wan\\_MSSFIX -o $wan\\_ifname -p tcp -m tcp --tcp-flags SYN,RST SYN -j TCPMSS --clamp-mss-to-pmtu 183 ip rule add fwmark $rt table $rt prio $rt 184 done</span><br><span class=\"line\">185 </span><br><span class=\"line\">186 ip route del default 187 </span><br><span class=\"line\">188 echo \\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_ 189 echo 下面执行ip route add default scope global $vias 190 ip route add default scope global $vias 191 </span><br><span class=\"line\">192 ip route flush cache 193 </span><br><span class=\"line\">194 echo \\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_ 195 echo 下面输出ip route list 196 ip route list 197 </span><br><span class=\"line\">198 echo \\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_ 199 echo 下面输出route -n 200 route -n</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<p><strong>参考文献</strong></p>\n<hr>\n<p><a href=\"http://www.right.com.cn/forum/thread-102073-1-1.html\">OpenWrt For AR71xx系列 ar2 Tr 脱机 N-WAN r48549</a></p>\n<p><a href=\"http://www.right.com.cn/forum/thread-104970-1-1.html\">自己动手 4530R 脱机 Samba U-BOOT 多拨（11-04更新部分问题说明，请看2楼）</a></p>\n<p><a href=\"http://www.right.com.cn/forum/thread-102411-1-1.html\">[0916更新]WR703N WR720N 及其他各类 OpenWRT类路由实现一号多拨带宽叠加教程</a></p>\n","more":"<ul>\n<li>2021年11月更新：如果是K2P A2版本硬件，请参考更简易的步骤，更加高效，不需要太多代码知识。 <a href=\"https://www.cnblogs.com/backuper/p/15523365.html\">K2P刷机-坐标北京Unicom</a></li>\n</ul>\n<p><strong>前题</strong></p>\n<hr>\n<ul>\n<li>硬件：路由器，刷入<a href=\"https://openwrt.org/\">OpenWrt</a></li>\n<li>一些背景知识和动手能力</li>\n</ul>\n<p><strong>目标效果图</strong></p>\n<hr>\n<p><img data-src=\"http://images2015.cnblogs.com/blog/41238/201603/41238-20160323125607870-97593375.jpg\" alt=\"实际例子Sample \"></p>\n<p><img data-src=\"http://images2015.cnblogs.com/blog/41238/201603/41238-20160326151505526-1086117574.jpg\"></p>\n<p><strong>步骤</strong></p>\n<hr>\n<ol>\n<li><p>使用SSH 登陆路由器。I.e. ssh <a href=\"mailto:&#x72;&#x6f;&#111;&#x74;&#x40;&#x31;&#x39;&#50;&#x2e;&#x31;&#x36;&#x38;&#46;&#x32;&#46;&#x31;\">&#x72;&#x6f;&#111;&#x74;&#x40;&#x31;&#x39;&#50;&#x2e;&#x31;&#x36;&#x38;&#46;&#x32;&#46;&#x31;</a></p>\n</li>\n<li><p>运行&#x2F;usr&#x2F;bin&#x2F;duobo。日志类似：</p>\n</li>\n<li><p><img data-src=\"http://images.cnblogs.com/OutliningIndicators/ContractedBlock.gif\"><img data-src=\"http://images.cnblogs.com/OutliningIndicators/ExpandedBlockStart.gif\"></p>\n<p>sh: 2: unknown operand<br>Killed<br>Warning: Unable to locate ipset utility, disabling ipset support * Flushing IPv4 filter table * Flushing IPv4 nat table * Flushing IPv4 mangle table * Flushing IPv4 raw table * Flushing conntrack table … * Populating IPv4 filter table * Zone ‘lan’<br>   * Zone ‘wan’<br>   * Rule ‘Allow-DHCP-Renew’<br>   * Rule ‘Allow-Ping’<br>   * Rule ‘51413’<br>   * Rule ‘9091’<br>   * Rule ‘9000’<br>   * Rule ‘6800’<br>   * Forward ‘lan’ -&gt; ‘wan’<br> * Populating IPv4 nat table * Zone ‘lan’<br>   * Zone ‘wan’<br> * Populating IPv4 mangle table * Zone ‘lan’<br>   * Zone ‘wan’<br> * Populating IPv4 raw table * Zone ‘lan’<br>   * Zone ‘wan’<br> * Set tcp_ecn to off * Set tcp_syncookies to on * Set tcp_window_scaling to on * Running script ‘&#x2F;etc&#x2F;firewall.user’<br> * Running script ‘&#x2F;usr&#x2F;share&#x2F;miniupnpd&#x2F;firewall.include’<br> * Running script ‘&#x2F;usr&#x2F;share&#x2F;qos_gargoyle&#x2F;firewall.include’<br>   ! Failed with exit code 1 ___________________________________________________<br>开始第1次拔号………..<br>正在并发拔号中………….<br>等待3秒………….<br>[3]拔[0]拔成功, 小于设定的[2]拔，将重新拔号…</p>\n<p>_________________________</p>\n<p>View Code</p>\n</li>\n<li><p>_如果没有成功并发多播，根据提示信息调整duobo的内部参数设置，重新运行_。分享一些技巧：</p>\n</li>\n<li><p>number&#x3D;10 #number是重拔次数，本脚本启动后一共尝试的次数 n=7 #n是几拔，同时发出几拨，理论上设置越大成功概率越大！ ok=2 #ok是拔上几次后退出拔号, 要实现的预期目标<br>wait=5 #wait time 每次单线多拨失败后，重试的等待时间</p>\n<ul>\n<li><strong>原则：</strong>失败多次以后，建议冷重启路由器，多个运行中的脚本会互相冲突，把问题复杂化。</li>\n<li><strong>多拨失败以后，耐心等上1分钟；很多次的多播成功都是脚本完成以后退出，然后60秒内获取了超过预期的多条链接。</strong></li>\n<li><strong>把n调到7，这样会虚拟出很多wan接口，根据硬件性能，理论上设置越大成功概率越大！</strong></li>\n<li>将ok调低一点，比如2。我觉得别太贪心，如果能稳定多播2个ADSL的IP，那其实概率上更折中了稳定性和高负载下的带宽均衡。</li>\n<li>wait的时间我感觉5秒－8秒差不多，这个要看运行日志，做相应调整。</li>\n<li>看懂程序的原理，根据实际情况调整脚本程序。比如：这个版本的程序是这么多播的，ifup $prefix$i</li>\n</ul>\n</li>\n</ol>\n<p><strong>遗留问题</strong></p>\n<hr>\n<p><img data-src=\"http://images.cnblogs.com/OutliningIndicators/ContractedBlock.gif\"><img data-src=\"http://images.cnblogs.com/OutliningIndicators/ExpandedBlockStart.gif\"></p>\n<p> 1 开始第3次拔号………..<br> 2 正在并发拔号中………….<br> 3 等待10秒………….<br> 4 pppoe-wan Link encap:Point-to-Point Protocol<br> 5 pppoe-wan3 Link encap:Point-to-Point Protocol<br> 6 [3]拔[2]拔成功, 大于或等于设定的[2]拨，退出拔号…<br> 7 Error: an inet address is expected rather than “dev”.<br> 8 iptables v1.4.10: Couldn’t load target `zone_wan_notrack’:File not found<br> 9<br>10 Try `iptables -h’ or ‘iptables –help’ for more information.<br>11 iptables v1.4.10: Couldn’t load target `zone_wan_nat’:File not found 12<br>13 Try `iptables -h’ or ‘iptables –help’ for more information.<br>14 iptables: No chain&#x2F;target&#x2F;match by that name. 15 iptables v1.4.10: Couldn’t load target `zone_wan’:File not found 16<br>17 Try `iptables -h’ or ‘iptables –help’ for more information.<br>18 iptables: No chain&#x2F;target&#x2F;match by that name. 19 iptables: No chain&#x2F;target&#x2F;match by that name. 20 iptables: No chain&#x2F;target&#x2F;match by that name. 21 iptables: No chain&#x2F;target&#x2F;match by that name. 22 iptables: No chain&#x2F;target&#x2F;match by that name. 23 iptables: No chain&#x2F;target&#x2F;match by that name. 24 iptables: No chain&#x2F;target&#x2F;match by that name. 25 Error: an inet address is expected rather than “dev”. 26 iptables v1.4.10: Couldn’t load target `zone_wan_notrack’:File not found 27<br>28 Try `iptables -h’ or ‘iptables –help’ for more information.<br>29 iptables v1.4.10: Couldn’t load target `zone_wan_nat’:File not found 30<br>31 Try `iptables -h’ or ‘iptables –help’ for more information.<br>32 iptables: No chain&#x2F;target&#x2F;match by that name. 33 iptables v1.4.10: Couldn’t load target `zone_wan’:File not found 34<br>35 Try `iptables -h’ or ‘iptables –help’ for more information.<br>36 iptables: No chain&#x2F;target&#x2F;match by that name. 37 iptables: No chain&#x2F;target&#x2F;match by that name. 38 iptables: No chain&#x2F;target&#x2F;match by that name. 39 iptables: No chain&#x2F;target&#x2F;match by that name. 40 iptables: No chain&#x2F;target&#x2F;match by that name. 41 iptables: No chain&#x2F;target&#x2F;match by that name. 42 iptables: No chain&#x2F;target&#x2F;match by that name. 43 Error: an IP address is expected rather than “dev”<br>44 192.168.2.0&#x2F;24 dev br-lan  proto kernel  scope link  src 192.168.2.1<br>45 221.218.232.1 dev pppoe-wan3  proto kernel  scope link  src 123.112.248.148<br>46 221.218.232.1 dev pppoe-wan  proto kernel  scope link  src 221.218.236.51<br>47 Kernel IP routing table 48 Destination     Gateway         Genmask         Flags Metric Ref    Use Iface 49 192.168.2.0     0.0.0.0         255.255.255.0   U     0      0        0 br-lan 50 221.218.232.1   0.0.0.0         255.255.255.255 UH    0      0        0 pppoe-wan3 51 221.218.232.1   0.0.0.0         255.255.255.255 UH    0      0        0 pppoe-wan</p>\n<p>View Error Code</p>\n<p>显然这个0.3版本的脚本不完全适用于我的路由器，有时间我需要查查原因。</p>\n<p>估计都是关于iptables</p>\n<p>有没有大侠探讨一下？</p>\n<p><em>修正了下面版本中的一个错误</em></p>\n<p><em>line 19：if [ $j -ge $ok ] ;</em></p>\n<p><strong>多拨代码(V0.3)</strong></p>\n<hr>\n<p><img data-src=\"http://images.cnblogs.com/OutliningIndicators/ContractedBlock.gif\"><img data-src=\"http://images.cnblogs.com/OutliningIndicators/ExpandedBlockStart.gif\"></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"> 1 #!/bin/sh</span><br><span class=\"line\"> 2 #modified by muziling v0.3</span><br><span class=\"line\"> 3 #并发多拨脚本</span><br><span class=\"line\"> 4 </span><br><span class=\"line\"> 5 #number是重拔次数</span><br><span class=\"line\"> 6 #n是几拔</span><br><span class=\"line\"> 7 #ok是拔上几次后退出拔号</span><br><span class=\"line\"> 8 #wait time</span><br><span class=\"line\"> 9 </span><br><span class=\"line\"> 10 number=10</span><br><span class=\"line\"> 11 n=3</span><br><span class=\"line\"> 12 ok=2</span><br><span class=\"line\"> 13 wait\\=5</span><br><span class=\"line\"> 14 # avoid same with feixiang&#x27;s N-WAN naming and must start with &quot;wan&quot;</span><br><span class=\"line\"> 15 prefix=wan</span><br><span class=\"line\"> 16 vthprefix=vth</span><br><span class=\"line\"> 17 </span><br><span class=\"line\"> 18 j=$(ifconfig | grep pppoe-wan | wc -l)</span><br><span class=\"line\"> 19 if \\[ &quot;$j&quot; &gt;= &quot;$ok&quot; \\] ; 20 then</span><br><span class=\"line\"> 21     echo 已经是\\[$j\\]拔了，退出拔号... 22     exit 0</span><br><span class=\"line\"> 23 fi</span><br><span class=\"line\"> 24 </span><br><span class=\"line\"> 25 if \\[ -f /etc/config/nwannumset \\] ;</span><br><span class=\"line\"> 26 then</span><br><span class=\"line\"> 27     uci set nwannumset.@macvlan\\_numset\\[0\\].macvlan\\_num=1</span><br><span class=\"line\"> 28     uci commit nwannumset</span><br><span class=\"line\"> 29 fi</span><br><span class=\"line\"> 30 for i in $( seq 1 $(($n-1)))</span><br><span class=\"line\"> 31 do</span><br><span class=\"line\"> 32     ifname=$prefix$i</span><br><span class=\"line\"> 33     ifvth=$vthprefix$i</span><br><span class=\"line\"> 34     #ifwan=$(uci get network.wan.ifname)</span><br><span class=\"line\"> 35     pppoe\\_name=$(uci get network.wan.username) </span><br><span class=\"line\"> 36     pppoe\\_pw=$(uci get network.wan.password) </span><br><span class=\"line\"> 37 </span><br><span class=\"line\"> 38     if \\[ $(ip link | grep &quot; $&#123;ifvth&#125;@eth0.2:&quot; | wc -l) == &quot;0&quot; \\] ; 39     then</span><br><span class=\"line\"> 40         macfac=$(ifconfig | grep eth0.2 | tr -s &quot; &quot; | cut -d &quot; &quot; -f5 | cut -b 1\\-8)</span><br><span class=\"line\"> 41         mac=&quot;$macfac:&quot;$(md5sum /proc/sys/kernel/random/uuid | sed &#x27;s/\\\\(..\\\\)/&amp;:/g&#x27; | cut -b 1\\-8 | tr \\[a-f\\] \\[A-F\\])</span><br><span class=\"line\"> 42         ip link add link eth0.2 $ifvth type macvlan 43         ifconfig $ifvth hw ether $mac 44     fi</span><br><span class=\"line\"> 45 </span><br><span class=\"line\"> 46     # add /etc/config/network</span><br><span class=\"line\"> 47     uci delete network.$ifname</span><br><span class=\"line\"> 48     uci set network.$ifname=interface</span><br><span class=\"line\"> 49     uci set network.$ifname.ifname=$ifvth</span><br><span class=\"line\"> 50     #uci set network.$ifname.\\_orig\\_ifname=eth0.2</span><br><span class=\"line\"> 51     #uci set network.$ifname.\\_orig\\_bridge=false</span><br><span class=\"line\"> 52     uci set network.$ifname.proto=pppoe</span><br><span class=\"line\"> 53     uci set network.$ifname.username=$pppoe\\_name</span><br><span class=\"line\"> 54     uci set network.$ifname.password=$pppoe\\_pw</span><br><span class=\"line\"> 55     uci set network.$ifname.auto=0</span><br><span class=\"line\"> 56     uci set network.$ifname.defaultroute=0</span><br><span class=\"line\"> 57     uci set network.$ifname.peerdns=1</span><br><span class=\"line\"> 58     uci set network.$ifname.pppd\\_options=&quot;plugin rp-pppoe.so syncppp $n&quot;</span><br><span class=\"line\"> 59 </span><br><span class=\"line\"> 60     # add /etc/config/dhcp</span><br><span class=\"line\"> 61     uci delete dhcp.$ifvth</span><br><span class=\"line\"> 62     uci set dhcp.$ifvth=dhcp </span><br><span class=\"line\"> 63     uci set dhcp.$ifvth.interface=$ifname</span><br><span class=\"line\"> 64     uci set dhcp.$ifvth.ignore=1 </span><br><span class=\"line\"> 65 </span><br><span class=\"line\"> 66     if \\[ -f /etc/config/nwan \\] ;</span><br><span class=\"line\"> 67     then</span><br><span class=\"line\"> 68         uci delete nwan.$ifname</span><br><span class=\"line\"> 69         uci set nwan.$ifname=interface </span><br><span class=\"line\"> 70         uci set nwan.$ifname.name=telecom </span><br><span class=\"line\"> 71         uci set nwan.$ifname.route=balance </span><br><span class=\"line\"> 72         uci set nwan.$ifname.weight=1 </span><br><span class=\"line\"> 73         uci set nwan.$ifname.uptime\\=0day,0hour,0min</span><br><span class=\"line\"> 74         uci commit nwan</span><br><span class=\"line\"> 75     fi</span><br><span class=\"line\"> 76 done</span><br><span class=\"line\"> 77 uci set network.wan.defaultroute=0</span><br><span class=\"line\"> 78 uci set network.wan.peerdns=1</span><br><span class=\"line\"> 79 uci set network.wan.pppd\\_options=&quot;plugin rp-pppoe.so syncppp $n&quot;</span><br><span class=\"line\"> 80 uci commit network</span><br><span class=\"line\"> 81 uci commit dhcp</span><br><span class=\"line\"> 82 </span><br><span class=\"line\"> 83 fw\\_wan\\_list=$(uci show network |grep =interface |grep -v lan|grep -v loopback |cut -d&quot;.&quot; -f2 | awk -F &quot;\\=&quot; &#x27;&#123;printf $1&quot; &quot;&#125;&#x27;)</span><br><span class=\"line\"> 84 uci set firewall.@zone\\[1\\].network=&quot;$fw\\_wan\\_list&quot;</span><br><span class=\"line\"> 85 uci commit firewall</span><br><span class=\"line\"> 86 /etc/init.d/firewall restart</span><br><span class=\"line\"> 87 </span><br><span class=\"line\"> 88 for q in $( seq 1 $number ) 89 do</span><br><span class=\"line\"> 90     echo</span><br><span class=\"line\"> 91     echo \\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_ 92     echo 开始第$q次拔号........... 93     killall -q -SIG pppd</span><br><span class=\"line\"> 94     if \\[ &quot;$q&quot; == &quot;1&quot; \\] ; 95     then</span><br><span class=\"line\"> 96         for i in $( seq 1 $(($n-1)))</span><br><span class=\"line\"> 97         do</span><br><span class=\"line\"> 98             ifup $prefix$i</span><br><span class=\"line\"> 99         done</span><br><span class=\"line\">100     fi</span><br><span class=\"line\">101 </span><br><span class=\"line\">102     echo 正在并发拔号中............. 103     echo 等待$wait秒............. 104     sleep $wait</span><br><span class=\"line\">105 </span><br><span class=\"line\">106     j=$(ps | grep pppd | wc -l) 107     ! \\[ &quot;$j&quot; -ge &quot;$n&quot; \\]  &amp;&amp; ifup $&#123;prefix&#125;1</span><br><span class=\"line\">108 </span><br><span class=\"line\">109     ifconfig|grep pppoe 110     j=$(ifconfig | grep pppoe-wan | wc -l) 111 </span><br><span class=\"line\">112     ! \\[ &quot;$j&quot; -ge &quot;$ok&quot; \\] &amp;&amp; echo \\[$n\\]拔\\[$j\\]拔成功, 小于设定的\\[$ok\\]拔，将重新拔号... 113     \\[ &quot;$j&quot; -ge &quot;$ok&quot; \\] &amp;&amp; echo \\[$n\\]拔\\[$j\\]拔成功, 大于或等于设定的\\[$ok\\]拨，退出拔号... 114 </span><br><span class=\"line\">115     if \\[ &quot;$j&quot; -ge &quot;$ok&quot; \\] ; 116     then</span><br><span class=\"line\">117         for i in $( seq 0 $(($n-1))) 118         do</span><br><span class=\"line\">119             if \\[ &quot;$i&quot; == &quot;0&quot; \\] ; 120             then</span><br><span class=\"line\">121                 interface=wan 122             else</span><br><span class=\"line\">123                 interface=$prefix$i 124             fi</span><br><span class=\"line\">125             if \\[ $(ifconfig | grep &quot;pppoe-$interface &quot; | wc -l) == &quot;0&quot; \\] ; 126             then</span><br><span class=\"line\">127 ifdown $interface 128             fi</span><br><span class=\"line\">129         done</span><br><span class=\"line\">130 break 131     fi</span><br><span class=\"line\">132 done</span><br><span class=\"line\">133 # kill ddns sleep and re-check wan ip change 134 killall sleep</span><br><span class=\"line\">135 </span><br><span class=\"line\">136 j=$(ifconfig | grep pppoe-wan | wc -l) 137 ! \\[ &quot;$j&quot; -ge 0 \\] &amp;&amp; reboot 138 </span><br><span class=\"line\">139 #ppoename=$(ifconfig |grep &#x27;ppoe-&#x27; |awk &#x27;&#123;print substr($1,7)&#125;&#x27;|tr &#x27;\\\\n&#x27; &#x27; &#x27;) 140 ppoename=$(ifconfig |grep &#x27;ppoe-&#x27; |awk &#x27;&#123;print $1&#125;&#x27;|tr &#x27;\\\\n&#x27; &#x27; &#x27;) 141 i=0</span><br><span class=\"line\">142 vias=&quot;&quot;</span><br><span class=\"line\">143 for wan\\_ifname in $ppoename 144 do</span><br><span class=\"line\">145     vias=&quot;$vias nexthop via $wan\\_ip dev $wan\\_ifname weight 1 &quot;</span><br><span class=\"line\">146     let &quot;rt=100+$i&quot;</span><br><span class=\"line\">147     i=$(($i+1)) 148 ip route flush table $rt 149 ip route add default via $wan\\_ip dev $wan\\_ifname table $rt 150     ip route add table $rt to $(ip route | grep br-lan) 151 </span><br><span class=\"line\">152     if \\[ $(iptables -t nat -vxnL POSTROUTING | grep -c &quot; $wan\\_ifname &quot;) == &quot;0&quot; \\] ; 153     then</span><br><span class=\"line\">154         iptables -t raw -A PREROUTING -i $wan\\_ifname -j zone\\_wan\\_notrack 155         iptables -t nat -A PREROUTING -i $wan\\_ifname -j zone\\_wan\\_prerouting 156         iptables -t nat -A POSTROUTING -o $wan\\_ifname -j zone\\_wan\\_nat 157         iptables -t filter -A forward -i $wan\\_ifname -j zone\\_wan\\_forward 158         iptables -t filter -A input -i $wan\\_ifname -j zone\\_wan 159         iptables -t filter -A zone\\_wan\\_ACCEPT -o $wan\\_ifname -j ACCEPT 160         iptables -t filter -A zone\\_wan\\_ACCEPT -i $wan\\_ifname -j ACCEPT 161         iptables -t filter -A zone\\_wan\\_DROP -o $wan\\_ifname -j DROP 162         iptables -t filter -A zone\\_wan\\_DROP -i $wan\\_ifname -j DROP 163         iptables -t filter -A zone\\_wan\\_REJECT -o $wan\\_ifname -j reject 164         iptables -t filter -A zone\\_wan\\_REJECT -i $wan\\_ifname -j reject 165     fi</span><br><span class=\"line\">166     iptables -A PREROUTING -t mangle -i $wan\\_ifname -j MARK --set-mark $rt 167     iptables -t mangle -A zone\\_wan\\_MSSFIX -o $wan\\_ifname -p tcp -m tcp --tcp-flags SYN,RST SYN -j TCPMSS --clamp-mss-to-pmtu 168 ip rule add fwmark $rt table $rt prio $rt 169 done</span><br><span class=\"line\">170 ip route del default 171 ip route add default scope global $vias 172 ip route flush cache 173 ip route list 174 route -n 175 root@OpenWrt:~# </span><br></pre></td></tr></table></figure>\n<p>View Code (duobo)</p>\n<p>修订版（V0.3.1）</p>\n<p><img data-src=\"http://images.cnblogs.com/OutliningIndicators/ContractedBlock.gif\"><img data-src=\"http://images.cnblogs.com/OutliningIndicators/ExpandedBlockStart.gif\"></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"> 1 #!/bin/sh</span><br><span class=\"line\"> 2 #modified by muziling v0.3</span><br><span class=\"line\"> 3 #并发多拨脚本</span><br><span class=\"line\"> 4 #modified by carl v0.3.1 (修正一处bug，改善友好提示信息) 5 </span><br><span class=\"line\"> 6 #number是重拔次数，本脚本启动后一共尝试的次数</span><br><span class=\"line\"> 7 #n是几拔，同时发出几拨，理论上设置越大成功概率越大！</span><br><span class=\"line\"> 8 #ok是拔上几次后退出拔号, 要实现的预期目标</span><br><span class=\"line\"> 9 #wait time 每次单线多拨失败后，重试的等待时间 10 </span><br><span class=\"line\"> 11 number=15</span><br><span class=\"line\"> 12 n=7</span><br><span class=\"line\"> 13 ok=2</span><br><span class=\"line\"> 14 wait\\=8</span><br><span class=\"line\"> 15 # avoid same with feixiang&#x27;s N-WAN naming and must start with &quot;wan&quot;</span><br><span class=\"line\"> 16 prefix=wan</span><br><span class=\"line\"> 17 vthprefix=vth</span><br><span class=\"line\"> 18 </span><br><span class=\"line\"> 19 j=$(ifconfig | grep pppoe-wan | wc -l)</span><br><span class=\"line\"> 20 if \\[ $j -ge $ok \\] ;</span><br><span class=\"line\"> 21 then</span><br><span class=\"line\"> 22     echo 已经是\\[$j\\]拔了，退出拔号程序。 23     exit 0</span><br><span class=\"line\"> 24 fi</span><br><span class=\"line\"> 25 </span><br><span class=\"line\"> 26 if \\[ -f /etc/config/nwannumset \\] ;</span><br><span class=\"line\"> 27 then</span><br><span class=\"line\"> 28     uci set nwannumset.@macvlan\\_numset\\[0\\].macvlan\\_num=1</span><br><span class=\"line\"> 29     uci commit nwannumset</span><br><span class=\"line\"> 30 fi</span><br><span class=\"line\"> 31 </span><br><span class=\"line\"> 32 for i in $( seq 1 $(($n-1)))</span><br><span class=\"line\"> 33 do</span><br><span class=\"line\"> 34     ifname=$prefix$i</span><br><span class=\"line\"> 35     ifvth=$vthprefix$i</span><br><span class=\"line\"> 36     #ifwan=$(uci get network.wan.ifname)</span><br><span class=\"line\"> 37     pppoe\\_name=$(uci get network.wan.username) </span><br><span class=\"line\"> 38     pppoe\\_pw=$(uci get network.wan.password) </span><br><span class=\"line\"> 39 </span><br><span class=\"line\"> 40     if \\[ $(ip link | grep &quot; $&#123;ifvth&#125;@eth0.2:&quot; | wc -l) == &quot;0&quot; \\] ; 41     then</span><br><span class=\"line\"> 42         macfac=$(ifconfig | grep eth0.2 | tr -s &quot; &quot; | cut -d &quot; &quot; -f5 | cut -b 1\\-8)</span><br><span class=\"line\"> 43         mac=&quot;$macfac:&quot;$(md5sum /proc/sys/kernel/random/uuid | sed &#x27;s/\\\\(..\\\\)/&amp;:/g&#x27; | cut -b 1\\-8 | tr \\[a-f\\] \\[A-F\\])</span><br><span class=\"line\"> 44         ip link add link eth0.2 $ifvth type macvlan 45         ifconfig $ifvth hw ether $mac 46         echo 更换MAC完毕$ifvth. 47     fi</span><br><span class=\"line\"> 48 </span><br><span class=\"line\"> 49     # add /etc/config/network</span><br><span class=\"line\"> 50     uci delete network.$ifname</span><br><span class=\"line\"> 51     uci set network.$ifname=interface</span><br><span class=\"line\"> 52     uci set network.$ifname.ifname=$ifvth</span><br><span class=\"line\"> 53     #uci set network.$ifname.\\_orig\\_ifname=eth0.2</span><br><span class=\"line\"> 54     #uci set network.$ifname.\\_orig\\_bridge=false</span><br><span class=\"line\"> 55     uci set network.$ifname.proto=pppoe</span><br><span class=\"line\"> 56     uci set network.$ifname.username=$pppoe\\_name</span><br><span class=\"line\"> 57     uci set network.$ifname.password=$pppoe\\_pw</span><br><span class=\"line\"> 58     uci set network.$ifname.auto=0</span><br><span class=\"line\"> 59     uci set network.$ifname.defaultroute=0</span><br><span class=\"line\"> 60     uci set network.$ifname.peerdns=1</span><br><span class=\"line\"> 61     uci set network.$ifname.pppd\\_options=&quot;plugin rp-pppoe.so syncppp $n&quot;</span><br><span class=\"line\"> 62 </span><br><span class=\"line\"> 63     # add /etc/config/dhcp</span><br><span class=\"line\"> 64     uci delete dhcp.$ifvth</span><br><span class=\"line\"> 65     uci set dhcp.$ifvth=dhcp </span><br><span class=\"line\"> 66     uci set dhcp.$ifvth.interface=$ifname</span><br><span class=\"line\"> 67     uci set dhcp.$ifvth.ignore=1 </span><br><span class=\"line\"> 68 </span><br><span class=\"line\"> 69     if \\[ -f /etc/config/nwan \\] ;</span><br><span class=\"line\"> 70     then</span><br><span class=\"line\"> 71         uci delete nwan.$ifname</span><br><span class=\"line\"> 72         uci set nwan.$ifname=interface </span><br><span class=\"line\"> 73         uci set nwan.$ifname.name=unicom </span><br><span class=\"line\"> 74         uci set nwan.$ifname.route=balance </span><br><span class=\"line\"> 75         uci set nwan.$ifname.weight=1 </span><br><span class=\"line\"> 76         uci set nwan.$ifname.uptime\\=0day,0hour,0min</span><br><span class=\"line\"> 77         uci commit nwan</span><br><span class=\"line\"> 78     fi</span><br><span class=\"line\"> 79 done</span><br><span class=\"line\"> 80 </span><br><span class=\"line\"> 81 uci set network.wan.defaultroute=0</span><br><span class=\"line\"> 82 uci set network.wan.peerdns=1</span><br><span class=\"line\"> 83 uci set network.wan.pppd\\_options=&quot;plugin rp-pppoe.so syncppp $n&quot;</span><br><span class=\"line\"> 84 uci commit network</span><br><span class=\"line\"> 85 uci commit dhcp</span><br><span class=\"line\"> 86 </span><br><span class=\"line\"> 87 fw\\_wan\\_list=$(uci show network |grep =interface |grep -v lan|grep -v loopback |cut -d&quot;.&quot; -f2 | awk -F &quot;\\=&quot; &#x27;&#123;printf $1&quot; &quot;&#125;&#x27;)</span><br><span class=\"line\"> 88 uci set firewall.@zone\\[1\\].network=&quot;$fw\\_wan\\_list&quot;</span><br><span class=\"line\"> 89 uci commit firewall</span><br><span class=\"line\"> 90 /etc/init.d/firewall restart</span><br><span class=\"line\"> 91 </span><br><span class=\"line\"> 92 for q in $( seq 1 $number ) 93 do</span><br><span class=\"line\"> 94     echo</span><br><span class=\"line\"> 95     echo \\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_ 96     echo 开始第$q次拔号........... 97     killall -q -SIG pppd</span><br><span class=\"line\"> 98     if \\[ &quot;$q&quot; == &quot;1&quot; \\] ; 99     then</span><br><span class=\"line\">100         for i in $( seq 1 $(($n-1))) 101         do</span><br><span class=\"line\">102 ifup $prefix$i 103         done</span><br><span class=\"line\">104     fi</span><br><span class=\"line\">105 </span><br><span class=\"line\">106     echo 正在并发拔号中............. 107     echo 等待$wait秒............. 108     sleep $wait</span><br><span class=\"line\">109 </span><br><span class=\"line\">110     j=$(ps | grep pppd | wc -l) 111     ! \\[ &quot;$j&quot; -ge &quot;$n&quot; \\]  &amp;&amp; ifup $&#123;prefix&#125;1</span><br><span class=\"line\">112 </span><br><span class=\"line\">113     ifconfig | grep pppoe 114     j=$(ifconfig | grep pppoe-wan | wc -l) 115 </span><br><span class=\"line\">116     ! \\[ &quot;$j&quot; -ge &quot;$ok&quot; \\] &amp;&amp; echo \\[$n\\]拔\\[$j\\]拔成功, 小于设定的\\[$ok\\]拔，将重新拔号... 117     \\[ &quot;$j&quot; -ge &quot;$ok&quot; \\] &amp;&amp; echo \\[$n\\]拔\\[$j\\]拔成功, 大于或等于设定的\\[$ok\\]拨，退出拔号... 118     </span><br><span class=\"line\">119     if \\[ &quot;$j&quot; -ge &quot;$ok&quot; \\] ; 120     then</span><br><span class=\"line\">121         for i in $( seq 0 $(($n-1))) 122         do</span><br><span class=\"line\">123             if \\[ &quot;$i&quot; == &quot;0&quot; \\] ; 124             then</span><br><span class=\"line\">125                 interface=wan 126             else</span><br><span class=\"line\">127                 interface=$prefix$i 128             fi</span><br><span class=\"line\">129             if \\[ $(ifconfig | grep &quot;pppoe-$interface &quot; | wc -l) == &quot;0&quot; \\] ; 130             then</span><br><span class=\"line\">131 ifdown $interface 132             fi</span><br><span class=\"line\">133         done</span><br><span class=\"line\">134 break 135     fi</span><br><span class=\"line\">136 done # done/tried all tring times $number 137 </span><br><span class=\"line\">138 # kill ddns sleep and re-check wan ip change 139 killall sleep</span><br><span class=\"line\">140 </span><br><span class=\"line\">141 # reboot the machine if failed tried times 142 #sleep $wait</span><br><span class=\"line\">143 j=$(ifconfig | grep pppoe-wan | wc -l) 144 ! \\[ &quot;$j&quot; -gt 0 \\] &amp;&amp; reboot 145 </span><br><span class=\"line\">146 </span><br><span class=\"line\">147 echo \\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_ 148 echo 开始N-WAN负载均衡功能... 149 #ppoename=$(ifconfig |grep &#x27;ppoe-&#x27; |awk &#x27;&#123;print substr($1,7)&#125;&#x27;|tr &#x27;\\\\n&#x27; &#x27; &#x27;) 150 ppoename=$(ifconfig|grep &#x27;ppoe-&#x27; |awk &#x27;&#123;print $1&#125;&#x27;|tr &#x27;\\\\n&#x27; &#x27; &#x27;) 151 i=0</span><br><span class=\"line\">152 vias=&quot;&quot;</span><br><span class=\"line\">153 for wan\\_ifname in $ppoename 154 do</span><br><span class=\"line\">155     vias=&quot;$vias nexthop via $wan\\_ip dev $wan\\_ifname weight 1 &quot;</span><br><span class=\"line\">156     let &quot;rt=100+$i&quot;</span><br><span class=\"line\">157     i=$(($i+1)) 158 ip route flush table $rt 159 #REMOVE ERROR 160 ip route add default via $wan\\_ip dev $wan\\_ifname table $rt 161     ip route add table $rt to $(ip route | grep br-lan) 162 </span><br><span class=\"line\">163     if \\[ $(iptables -t nat -vxnL POSTROUTING | grep -c &quot; $wan\\_ifname &quot;) == &quot;0&quot; \\] ; 164     then</span><br><span class=\"line\">165 #REMOVE ERROR 166         iptables -t raw -A PREROUTING -i $wan\\_ifname -j zone\\_wan\\_notrack 167         iptables -t nat -A PREROUTING -i $wan\\_ifname -j zone\\_wan\\_prerouting 168 #REMOVE ERROR 169         iptables -t nat -A POSTROUTING -o $wan\\_ifname -j zone\\_wan\\_nat 170         iptables -t filter -A forward -i $wan\\_ifname -j zone\\_wan\\_forward 171 #REMOVE ERROR 172         iptables -t filter -A input -i $wan\\_ifname -j zone\\_wan 173         iptables -t filter -A zone\\_wan\\_ACCEPT -o $wan\\_ifname -j ACCEPT 174         iptables -t filter -A zone\\_wan\\_ACCEPT -i $wan\\_ifname -j ACCEPT 175         iptables -t filter -A zone\\_wan\\_DROP -o $wan\\_ifname -j DROP 176         iptables -t filter -A zone\\_wan\\_DROP -i $wan\\_ifname -j DROP 177         iptables -t filter -A zone\\_wan\\_REJECT -o $wan\\_ifname -j reject 178         iptables -t filter -A zone\\_wan\\_REJECT -i $wan\\_ifname -j reject 179     fi</span><br><span class=\"line\">180     </span><br><span class=\"line\">181     iptables -A PREROUTING -t mangle -i $wan\\_ifname -j MARK --set-mark $rt 182     iptables -t mangle -A zone\\_wan\\_MSSFIX -o $wan\\_ifname -p tcp -m tcp --tcp-flags SYN,RST SYN -j TCPMSS --clamp-mss-to-pmtu 183 ip rule add fwmark $rt table $rt prio $rt 184 done</span><br><span class=\"line\">185 </span><br><span class=\"line\">186 ip route del default 187 </span><br><span class=\"line\">188 echo \\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_ 189 echo 下面执行ip route add default scope global $vias 190 ip route add default scope global $vias 191 </span><br><span class=\"line\">192 ip route flush cache 193 </span><br><span class=\"line\">194 echo \\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_ 195 echo 下面输出ip route list 196 ip route list 197 </span><br><span class=\"line\">198 echo \\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_ 199 echo 下面输出route -n 200 route -n</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<p><strong>参考文献</strong></p>\n<hr>\n<p><a href=\"http://www.right.com.cn/forum/thread-102073-1-1.html\">OpenWrt For AR71xx系列 ar2 Tr 脱机 N-WAN r48549</a></p>\n<p><a href=\"http://www.right.com.cn/forum/thread-104970-1-1.html\">自己动手 4530R 脱机 Samba U-BOOT 多拨（11-04更新部分问题说明，请看2楼）</a></p>\n<p><a href=\"http://www.right.com.cn/forum/thread-102411-1-1.html\">[0916更新]WR703N WR720N 及其他各类 OpenWRT类路由实现一号多拨带宽叠加教程</a></p>","categories":[{"name":"OpenWrt","path":"api/categories/OpenWrt.json"}],"tags":[{"name":"OpenWrt","path":"api/tags/OpenWrt.json"},{"name":"K2P","path":"api/tags/K2P.json"},{"name":"ADSL","path":"api/tags/ADSL.json"}]}
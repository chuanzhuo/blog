{"title":"Practical Solutions for Resolving Full PVE Disk Occupancy","slug":"PVE磁盘占满解决方案实践","date":"2024-01-11T01:31:48.000Z","updated":"2024-01-16T01:09:38.813Z","comments":true,"path":"api/articles/PVE磁盘占满解决方案实践.json","excerpt":" [Figure] Addressing the practical issue of a full PVE disk.","covers":null,"content":"<img class=\"lozad\" data-src=\"\">\n\n<p>Addressing the practical issue of a full PVE disk.</p>\n<span id=\"more\"></span>\n\n<div> <button onclick=\"synthesizeSpeech()\">Read Aloud Entire Text</button> </div> <audio controls id=\"audioPlayer\">Your browser does not support the audio element.</audio> <script> function synthesizeSpeech() { var inputText = document.getElementsByClassName('post-block')[0].innerText; var voice = \"ZH\"; var url = 'https://tts.carlzeng.top:3/speech?text=' + encodeURIComponent(inputText.substring(0,3000)) + '&voice=' + voice; var audioPlayer = document.getElementById('audioPlayer'); audioPlayer.src = url; audioPlayer.load(); audioPlayer.play(); } </script>\n\n<h1 id=\"Purpose\"><a href=\"#Purpose\" class=\"headerlink\" title=\"Purpose\"></a>Purpose</h1><p>Addressing the practical issue of a full PVE disk.</p>\n<h1 id=\"Solution-1-Cleaning-PVE-Space\"><a href=\"#Solution-1-Cleaning-PVE-Space\" class=\"headerlink\" title=\"Solution 1: Cleaning PVE Space\"></a>Solution 1: Cleaning PVE Space</h1><p>To clean PVE, log in to PVE’s SSH:</p>\n<ol>\n<li><p>View the sizes of files in various directories, sorted by size from largest to smallest:</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">du -s /* | sort -nr </span><br></pre></td></tr></table></figure>\n\n<p>Here, &#x2F;* can be any directory, for example, &#x2F;lib&#x2F;* would show the file sizes in the lib directory.</p>\n<p>Delete unnecessary files</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta prompt_\">&gt; </span><span class=\"language-bash\">find / -size +800M -<span class=\"built_in\">exec</span> <span class=\"built_in\">ls</span> -lh &#123;&#125; \\;</span>         </span><br><span class=\"line\"></span><br><span class=\"line\">-r-------- 1 root root 128T Nov 19 19:24 /proc/kcore   </span><br><span class=\"line\">...</span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">Check <span class=\"keyword\">for</span> abnormally large <span class=\"built_in\">log</span> files</span></span><br></pre></td></tr></table></figure>\n</li>\n<li><p>Delete unnecessary log files</p>\n<ol>\n<li>rm -rf &#x2F;log&#x2F;*.gz</li>\n<li>rm -rf &#x2F;var&#x2F;log&#x2F;*.1</li>\n</ol>\n</li>\n<li><p>Configure the size of log files</p>\n<ol>\n<li><p>journalctl –vacuum-size&#x3D;512M</p>\n</li>\n<li><p>Automatic removal of logs older than 2 days</p>\n<p>journalctl –vacuum-time&#x3D;2d</p>\n</li>\n<li></li>\n</ol>\n</li>\n<li><p>If there is a need to move large files from the PVE docker in Debian:</p>\n<ol>\n<li>Approach: debian docker data-root</li>\n<li><a href=\"https://medium.com/@calvineotieno010/change-docker-default-root-data-directory-a1d9271056f4\">Change Docker Default Root Data Directory</a></li>\n</ol>\n</li>\n<li><p>For a more detailed record, see: <a href=\"https://www.carlzeng.top/202312290851\">PVE Synology NAS Repair Notes</a> 》 Taking measures</p>\n</li>\n</ol>\n<h1 id=\"Solution-2-Adding-a-New-Disk\"><a href=\"#Solution-2-Adding-a-New-Disk\" class=\"headerlink\" title=\"Solution 2: Adding a New Disk\"></a>Solution 2: Adding a New Disk</h1><ol>\n<li>Connect a 1TB external hard drive to the USB port</li>\n</ol>\n<p>View the status of each disk (including its name), or use the command</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ls /dev/disk/by-id</span><br></pre></td></tr></table></figure>\n\n<p>Or in the PVE interface under Datacenter &gt; PVE Name &gt; Disks</p>\n<ol>\n<li>Add a new directory under the mnt folder, for example: mkdir usbToshiBa1T<br>If you see &#x2F;dev&#x2F;sdc2 as a partition</li>\n</ol>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">mount /dev/sdc2 /mnt/usbToshiBa1T</span><br></pre></td></tr></table></figure>\n\n<ol>\n<li><p>In the interface, select the disk partition: “Erase Disk”; or manage partitions using the command:</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">fdisk /dev/sdc</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>Add the partition as a ‘directory’ for PVE</p>\n<p>Select in the UI: Datacenter &gt; PVE Name &gt; Disks &gt; Directory</p>\n<p>Button: Create Directory</p>\n</li>\n</ol>\n<p>When creating a new virtual machine, please manually select this new “directory”</p>\n<h1 id=\"Related-Content\"><a href=\"#Related-Content\" class=\"headerlink\" title=\"Related Content\"></a>Related Content</h1><iframe style=\"box-shadow: 0px 0px 20px -10px;\" src=\"https://query.carlzeng.top:3/appsearch?q=pve\" frameborder=\"0\" scrolling=\"auto\" width=\"100%\" height=\"500\"></iframe>\n\n<h1 id=\"Source-of-Inspiration\"><a href=\"#Source-of-Inspiration\" class=\"headerlink\" title=\"Source of Inspiration\"></a>Source of Inspiration</h1><p><a href=\"https://www.carlzeng.top/202312290851\">PVE Synology NAS Repair Notes</a></p>\n","more":"<div> <button onclick=\"synthesizeSpeech()\">Read Aloud Entire Text</button> </div> <audio controls id=\"audioPlayer\">Your browser does not support the audio element.</audio> <script> function synthesizeSpeech() { var inputText = document.getElementsByClassName('post-block')[0].innerText; var voice = \"ZH\"; var url = 'https://tts.carlzeng.top:3/speech?text=' + encodeURIComponent(inputText.substring(0,3000)) + '&voice=' + voice; var audioPlayer = document.getElementById('audioPlayer'); audioPlayer.src = url; audioPlayer.load(); audioPlayer.play(); } </script>\n\n<h1 id=\"Purpose\"><a href=\"#Purpose\" class=\"headerlink\" title=\"Purpose\"></a>Purpose</h1><p>Addressing the practical issue of a full PVE disk.</p>\n<h1 id=\"Solution-1-Cleaning-PVE-Space\"><a href=\"#Solution-1-Cleaning-PVE-Space\" class=\"headerlink\" title=\"Solution 1: Cleaning PVE Space\"></a>Solution 1: Cleaning PVE Space</h1><p>To clean PVE, log in to PVE’s SSH:</p>\n<ol>\n<li><p>View the sizes of files in various directories, sorted by size from largest to smallest:</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">du -s /* | sort -nr </span><br></pre></td></tr></table></figure>\n\n<p>Here, &#x2F;* can be any directory, for example, &#x2F;lib&#x2F;* would show the file sizes in the lib directory.</p>\n<p>Delete unnecessary files</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta prompt_\">&gt; </span><span class=\"language-bash\">find / -size +800M -<span class=\"built_in\">exec</span> <span class=\"built_in\">ls</span> -lh &#123;&#125; \\;</span>         </span><br><span class=\"line\"></span><br><span class=\"line\">-r-------- 1 root root 128T Nov 19 19:24 /proc/kcore   </span><br><span class=\"line\">...</span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">Check <span class=\"keyword\">for</span> abnormally large <span class=\"built_in\">log</span> files</span></span><br></pre></td></tr></table></figure>\n</li>\n<li><p>Delete unnecessary log files</p>\n<ol>\n<li>rm -rf &#x2F;log&#x2F;*.gz</li>\n<li>rm -rf &#x2F;var&#x2F;log&#x2F;*.1</li>\n</ol>\n</li>\n<li><p>Configure the size of log files</p>\n<ol>\n<li><p>journalctl –vacuum-size&#x3D;512M</p>\n</li>\n<li><p>Automatic removal of logs older than 2 days</p>\n<p>journalctl –vacuum-time&#x3D;2d</p>\n</li>\n<li></li>\n</ol>\n</li>\n<li><p>If there is a need to move large files from the PVE docker in Debian:</p>\n<ol>\n<li>Approach: debian docker data-root</li>\n<li><a href=\"https://medium.com/@calvineotieno010/change-docker-default-root-data-directory-a1d9271056f4\">Change Docker Default Root Data Directory</a></li>\n</ol>\n</li>\n<li><p>For a more detailed record, see: <a href=\"https://www.carlzeng.top/202312290851\">PVE Synology NAS Repair Notes</a> 》 Taking measures</p>\n</li>\n</ol>\n<h1 id=\"Solution-2-Adding-a-New-Disk\"><a href=\"#Solution-2-Adding-a-New-Disk\" class=\"headerlink\" title=\"Solution 2: Adding a New Disk\"></a>Solution 2: Adding a New Disk</h1><ol>\n<li>Connect a 1TB external hard drive to the USB port</li>\n</ol>\n<p>View the status of each disk (including its name), or use the command</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ls /dev/disk/by-id</span><br></pre></td></tr></table></figure>\n\n<p>Or in the PVE interface under Datacenter &gt; PVE Name &gt; Disks</p>\n<ol>\n<li>Add a new directory under the mnt folder, for example: mkdir usbToshiBa1T<br>If you see &#x2F;dev&#x2F;sdc2 as a partition</li>\n</ol>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">mount /dev/sdc2 /mnt/usbToshiBa1T</span><br></pre></td></tr></table></figure>\n\n<ol>\n<li><p>In the interface, select the disk partition: “Erase Disk”; or manage partitions using the command:</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">fdisk /dev/sdc</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>Add the partition as a ‘directory’ for PVE</p>\n<p>Select in the UI: Datacenter &gt; PVE Name &gt; Disks &gt; Directory</p>\n<p>Button: Create Directory</p>\n</li>\n</ol>\n<p>When creating a new virtual machine, please manually select this new “directory”</p>\n<h1 id=\"Related-Content\"><a href=\"#Related-Content\" class=\"headerlink\" title=\"Related Content\"></a>Related Content</h1><iframe style=\"box-shadow: 0px 0px 20px -10px;\" src=\"https://query.carlzeng.top:3/appsearch?q=pve\" frameborder=\"0\" scrolling=\"auto\" width=\"100%\" height=\"500\"></iframe>\n\n<h1 id=\"Source-of-Inspiration\"><a href=\"#Source-of-Inspiration\" class=\"headerlink\" title=\"Source of Inspiration\"></a>Source of Inspiration</h1><p><a href=\"https://www.carlzeng.top/202312290851\">PVE Synology NAS Repair Notes</a></p>","categories":[{"name":"Linux","path":"api/categories/Linux.json"}],"tags":[{"name":"Linux","path":"api/tags/Linux.json"},{"name":"PVE","path":"api/tags/PVE.json"}]}
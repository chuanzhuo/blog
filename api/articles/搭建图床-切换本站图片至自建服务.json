{"title":"搭建图床 切换本站图片至自建服务","slug":"搭建图床-切换本站图片至自建服务","date":"2024-01-22T13:51:38.000Z","updated":"2024-10-07T12:11:47.581Z","comments":true,"path":"api/articles/搭建图床-切换本站图片至自建服务.json","excerpt":" [Figure] 家宽环境搭建兰空图床实践过程记录分享; 结合ffmpeg抽帧和Synology Photos分享特定照片库","covers":["https://img.carlzeng.top:3/i/2024/02/21/65d5961d744d1.png","https://img.carlzeng.top:3/i/2024/09/26/66f4f8453d18a.png"],"content":"<img class=\"lozad\" data-src=\"https://img.carlzeng.top:3/i/2024/02/21/65d5961d744d1.png\">\n\n<p>家宽环境搭建兰空图床实践过程记录分享; 结合ffmpeg抽帧和Synology Photos分享特定照片库</p>\n<span id=\"more\"></span>\n\n<div> \n<button onclick=\"synthesizeSpeech()\">朗读全文</button>\n</div>\n<audio controls id=\"audioPlayer\">Your browser does not support the audio element.</audio>      \n<script>\n  function synthesizeSpeech() { \n    var inputText = document.getElementsByClassName('post-block')[0].innerText;\n    var voice = \"ZH\";\n    var url = 'https://tts.carlzeng.top:3/speech?text=' + encodeURIComponent(inputText.substring(0,3000)) + '&voice=' + voice;\n    var audioPlayer = document.getElementById('audioPlayer');          \n    audioPlayer.src = url;\n    audioPlayer.load();\n    audioPlayer.play();\n  }\n</script>\n\n\n<h1 id=\"有什么用-怎么用\"><a href=\"#有什么用-怎么用\" class=\"headerlink\" title=\"有什么用&#x2F;怎么用\"></a>有什么用&#x2F;怎么用</h1><ul>\n<li>自建图床，自用的情况下暂时是够用的</li>\n<li>群晖 Synology Photos, 备份各个手机中的照片</li>\n<li>ffmpeg抽帧实践</li>\n</ul>\n<p>访问：<a href=\"https://img.carlzeng.top:3/\">Carl Notes 图床</a></p>\n<p>登录后台管理图床中的图片内容等操作</p>\n<h1 id=\"相关内容\"><a href=\"#相关内容\" class=\"headerlink\" title=\"相关内容\"></a>相关内容</h1><iframe style=\"box-shadow: 0px 0px 20px -10px;\" src=\"https://query.carlzeng.top:3/appsearch?q=image\" frameborder=\"0\" scrolling=\"auto\" width=\"100%\" height=\"500\"></iframe>\n\n<h1 id=\"实现方法\"><a href=\"#实现方法\" class=\"headerlink\" title=\"实现方法\"></a>实现方法</h1><h2 id=\"Docker搭建Lsky-Pro图床应用\"><a href=\"#Docker搭建Lsky-Pro图床应用\" class=\"headerlink\" title=\"Docker搭建Lsky Pro图床应用\"></a>Docker搭建Lsky Pro图床应用</h2><figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">docker pull dko0/lsky-pro</span><br><span class=\"line\"></span><br><span class=\"line\">docker run  --name lsky-pro --restart always -p 8091:80 -d -v /volume2/KingchuxingSSD512G/MacBookPro_Skitch:/var/www/html dko0/lsky-pro</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\">#</span><span class=\"language-bash\">转化为docker-compose</span></span><br><span class=\"line\">version: &#x27;3.9&#x27;</span><br><span class=\"line\">services:</span><br><span class=\"line\">    lsky-pro:</span><br><span class=\"line\">        image: dko0/lsky-pro</span><br><span class=\"line\">        volumes:</span><br><span class=\"line\">            - &#x27;/volume2/KingchuxingSSD512G/MacBookPro_Skitch:/var/www/html&#x27;</span><br><span class=\"line\">        ports:</span><br><span class=\"line\">            - &#x27;8091:80&#x27;</span><br><span class=\"line\">        restart: always</span><br><span class=\"line\">        container_name: lsky-pro</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"配置PicGO\"><a href=\"#配置PicGO\" class=\"headerlink\" title=\"配置PicGO\"></a>配置PicGO</h2><p>下载并安装PicGo，Mac OS X：[PicGo-2.4.0-beta.6-x64.dmg](<a href=\"https://github.com/Molunerfinn/PicGo/releases\">https://github.com/Molunerfinn/PicGo/releases</a><br><a href=\"https://picgo-release.molunerfinn.com/2.4.0-beta.6/PicGo-2.4.0-beta.6-x64.dmg\">https://picgo-release.molunerfinn.com/2.4.0-beta.6/PicGo-2.4.0-beta.6-x64.dmg</a>)</p>\n<p>打开主界面&#x2F;窗口，插件设置，搜索并安装插件名：lankong （我下载的版本是：lankong 1.1.3）</p>\n<p>图床配置 》 lankong</p>\n<figure class=\"highlight ini\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Lsky Pro Version： V2</span><br><span class=\"line\">Server: https://img.carlzeng.top:3</span><br><span class=\"line\">Auth token: Bearer 1|ZRZcNz1E6hAuyV4LytmCqmGx5yST0g9OyhdptXXX</span><br></pre></td></tr></table></figure>\n\n<p>获取 Lsky Pro 兰空图床的Auth Token的方式，推荐(Terminal 运行命令)：</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">curl --location --request POST &#x27;https://imgserver.com:3/api/v1/tokens&#x27; \\</span><br><span class=\"line\">\t--form &#x27;email=&quot;email@email.com&quot;&#x27; \\</span><br><span class=\"line\">\t--form &#x27;password=&quot;password&quot;&#x27;</span><br></pre></td></tr></table></figure>\n\n<p>请修改一下URL地址为访问自建兰空图床的URL地址，email和密码为登录图传所使用的用户名和密码</p>\n<p>本章节参见：<a href=\"https://github.com/hellodk34/picgo-plugin-lankong\">https://github.com/hellodk34/picgo-plugin-lankong</a></p>\n<p>测试：将文件拖拽到此处，或 点击上传，然后到兰空图床的URL后台，确认图片已上传至系统中</p>\n<h2 id=\"配置Typora\"><a href=\"#配置Typora\" class=\"headerlink\" title=\"配置Typora\"></a>配置Typora</h2><p>设置 偏好设置</p>\n<ol>\n<li><p>切换Typora到中文语言版（因为目前只有中文版有PicGo的选项）</p>\n</li>\n<li><p>偏好设置 》 图像 〉上传服务设定。 选择：PicGo.app</p>\n</li>\n<li><p>然后点击：验证图片上传选项  </p>\n<p>我的设置第一次显示失败了，按提示的信息查看日志：</p>\n<figure class=\"highlight ini\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">------Error Stack Begin------</span><br><span class=\"line\">Error: You must be logged in to use.</span><br><span class=\"line\">    at Object.We <span class=\"section\">[as handle]</span> (/Applications/PicGo.app/Contents/Resources/app.asar/node_modules/picgo/dist/index.cjs.js:1:21399)</span><br><span class=\"line\">    at processTicksAndRejections (node:internal/process/task_queues:96:5)</span><br><span class=\"line\">    at async je.doUpload (/Applications/PicGo.app/Contents/Resources/app.asar/node_modules/picgo/dist/index.cjs.js:1:19834)</span><br><span class=\"line\">    at async je.start (/Applications/PicGo.app/Contents/Resources/app.asar/node_modules/picgo/dist/index.cjs.js:1:18605)</span><br><span class=\"line\">    at async $t.upload (/Applications/PicGo.app/Contents/Resources/app.asar/node_modules/picgo/dist/index.cjs.js:1:74902)</span><br><span class=\"line\">    at async Object.upload (/Applications/PicGo.app/Contents/Resources/app.asar/index.js:2:686906)</span><br><span class=\"line\">    at async hr (/Applications/PicGo.app/Contents/Resources/app.asar/index.js:2:689655)</span><br><span class=\"line\">    at async /Applications/PicGo.app/Contents/Resources/app.asar/index.js:2:690736</span><br><span class=\"line\">-------Error Stack End------- </span><br><span class=\"line\">2024-02-21 13:37:13 <span class=\"section\">[PicGo INFO]</span> <span class=\"section\">[PicGo Server]</span> upload result  </span><br><span class=\"line\">2024-02-21 13:37:13 <span class=\"section\">[PicGo WARN]</span> <span class=\"section\">[PicGo Server]</span> upload failed, see picgo.log for more detail ↑ </span><br></pre></td></tr></table></figure>\n\n\n</li>\n<li><p>复制一张图片到剪贴板，在某个文章的内容中，粘贴图片；鼠标右键选中图片，上传图片</p>\n</li>\n<li><p>这时PicGo会显示待上传的图片，以及上传进度，直到图片被自动上传到图床中</p>\n</li>\n<li><p>全流程结束</p>\n</li>\n</ol>\n<p>本章节可以参见：<a href=\"https://support.typora.io/Upload-Image/#picgoapp-chinese-language-only\">Upload Images</a></p>\n<h2 id=\"关联Alist的目录\"><a href=\"#关联Alist的目录\" class=\"headerlink\" title=\"关联Alist的目录\"></a>关联Alist的目录</h2><p>这是根据个人自身的使用情况做的拓展，分享出图床中的所有图片</p>\n<p>修改docker-compose.yml, 添加映射：</p>\n<ul>\n<li>&#x2F;volume2&#x2F;KingchuxingSSD512G&#x2F;MacBookPro_Skitch:&#x2F;home&#x2F;share10</li>\n</ul>\n<p>docker exec -it alist &#x2F;bin&#x2F;bash</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">mkdir share7 &amp;&amp; mkdir share8 &amp;&amp; mkdir share9 &amp;&amp; mkdir share10 &amp;&amp; mkdir shar</span><br><span class=\"line\">e11 &amp;&amp; mkdir share12 </span><br></pre></td></tr></table></figure>\n\n\n\n<p>重启docker-compose</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta prompt_\">#</span><span class=\"language-bash\">这是不会成功的，需要使用docker-compose down 和 up</span></span><br><span class=\"line\">docker-compose restart</span><br><span class=\"line\"></span><br><span class=\"line\">docker-compose down</span><br><span class=\"line\">docker-compose up -d</span><br></pre></td></tr></table></figure>\n\n\n\n<p>进入Alist的后台管理，新增 “本机存储”</p>\n<p>映射&#x2F;home&#x2F;share10 至外观目录：&#x2F;图床MacBookPro_Skitch</p>\n<p>效果如：<a href=\"https://file.carlzeng.top:3/%E5%9B%BE%E5%BA%8AMacBookPro_Skitch/storage/app/uploads/2024/02/21\">https://file.carlzeng.top:3/%E5%9B%BE%E5%BA%8AMacBookPro_Skitch/storage/app/uploads/2024/02/21</a></p>\n<h2 id=\"NPM反代后带端口访问\"><a href=\"#NPM反代后带端口访问\" class=\"headerlink\" title=\"NPM反代后带端口访问\"></a>NPM反代后带端口访问</h2><p>1、修改&#x2F;config&#x2F;app.php （大约在57-60行的地方，修改以下2行内容）</p>\n<figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">//原先：</span></span><br><span class=\"line\">  <span class=\"string\">&#x27;url&#x27;</span> =&gt; <span class=\"title function_ invoke__\">env</span>(<span class=\"string\">&#x27;APP_URL&#x27;</span>, <span class=\"string\">&#x27;http://localhost&#x27;</span>),</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">//新：</span></span><br><span class=\"line\">  <span class=\"string\">&#x27;url&#x27;</span> =&gt; <span class=\"title function_ invoke__\">env</span>(<span class=\"string\">&#x27;APP_URL&#x27;</span>, <span class=\"string\">&#x27;https://xxxxx.com:4443&#x27;</span>),</span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">//原先：</span></span><br><span class=\"line\">  <span class=\"string\">&#x27;asset_url&#x27;</span> =&gt; <span class=\"title function_ invoke__\">env</span>(<span class=\"string\">&#x27;ASSET_URL&#x27;</span>, <span class=\"literal\">null</span>),</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">//新：</span></span><br><span class=\"line\">  <span class=\"string\">&#x27;asset_url&#x27;</span> =&gt; <span class=\"title function_ invoke__\">env</span>(<span class=\"string\">&#x27;ASSET_URL&#x27;</span>, <span class=\"string\">&#x27;https://xxxxx.com:4443&#x27;</span>),</span><br></pre></td></tr></table></figure>\n\n<p>请根据自身情况修改<a href=\"https://xxxxx.com:4443为自己的域名和端口。\">https://xxxxx.com:4443为自己的域名和端口。</a></p>\n<p>2、修改 &#x2F;app&#x2F;Providers&#x2F;ApServiceProvider.php  第 32 行下面追加一行：</p>\n<figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">\\Illuminate\\Support\\Facades\\URL::<span class=\"title function_ invoke__\">forceScheme</span>(<span class=\"string\">&#x27;https&#x27;</span>);</span><br></pre></td></tr></table></figure>\n\n\n\n<h1 id=\"如何让游客可以直接查看照片\"><a href=\"#如何让游客可以直接查看照片\" class=\"headerlink\" title=\"如何让游客可以直接查看照片?\"></a>如何让游客可以直接查看照片?</h1><p>用了这么长时间(大半年) 终于发现它的一些弊端:</p>\n<ul>\n<li>无法让游客直接浏览到游客组或游客用户的照片, 设计思路是先登录开始的(这一点不够人性化)</li>\n<li>无法直接自动加载目录上的照片到图片库里面; 这样就是一直需要有‘上传’的动作</li>\n<li>我的图片目录都存放在这个文文件夹下, 根据月份份分割开子文件夹&#x2F;KingchuxingSSD512G&#x2F;MacBookPro_Skitch&#x2F;storage&#x2F;app&#x2F;uploads&#x2F;2024</li>\n<li></li>\n</ul>\n<p>我需要一个自动读取目录下所有的照片, 然后不管是幻灯片展示,还是如何一张张下拉HTML展示也行的. 类似于图片展示</p>\n<h2 id=\"Synology-Photos\"><a href=\"#Synology-Photos\" class=\"headerlink\" title=\"Synology Photos\"></a>Synology Photos</h2><p>发现了以上的那些图床的弊端以后,</p>\n<p>查资料翻到photoprism, Lychee, immich, 很喜欢这个风格; 然后想到了群晖NAS也有Photo! </p>\n<p>也是超级喜欢的风格, Synology Photos:</p>\n<p>登录路径 <a href=\"https://nas.carlzeng.top:4443/?launchApp=SYNO.Foto.Sharing.AppInstance&app_name=SYNO.Foto.Sharing.AppInstance&action=external_login#/signin\">https://nas.carlzeng.top:4443/?launchApp=SYNO.Foto.Sharing.AppInstance&amp;app_name=SYNO.Foto.Sharing.AppInstance&amp;action=external_login#/signin</a></p>\n<p>设置了一个用户: 13261977480 (去除了NAS的访问权限, 是的, 取消非photo资源的访问)</p>\n<p>密码: 1Carlzeng.top</p>\n<p>设置下个, 获取 &#x2F;homes 目录的绝对路径: </p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">/volume2/homes/13261977480/Photos</span><br></pre></td></tr></table></figure>\n\n<p>然后把ffmpeg抽帧生成的照片放到这个目录, 这样自动就会往这个相册里面增加照片</p>\n<p>后台运行(视频流抽帧)命令如下:</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#每小时1张</span></span><br><span class=\"line\"><span class=\"built_in\">nohup</span> ffmpeg -i <span class=\"string\">&quot;rtsp://a:a@192.168.6.126:554&quot;</span> -y -f image2 -r 1/3600 /volume2/homes/13261977480/Photos/camc%03d.jpg 1&gt;/dev/null 2&gt;&amp;1 &amp;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#每半小时1张</span></span><br><span class=\"line\"><span class=\"built_in\">nohup</span> ffmpeg -i <span class=\"string\">&quot;rtsp://a:a@192.168.6.126:554&quot;</span> -y -f image2 -r 1/1800 /volume2/homes/13261977480/Photos/camc%03d.jpg 1&gt;/dev/null 2&gt;&amp;1 &amp;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#每15分钟1张</span></span><br><span class=\"line\"><span class=\"built_in\">nohup</span> ffmpeg -i <span class=\"string\">&quot;rtsp://a:a@192.168.6.126:554&quot;</span> -y -f image2 -r 1/900 /volume2/homes/13261977480/Photos/camc%03d.jpg 1&gt;/dev/null 2&gt;&amp;1 &amp;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#每10分钟1张</span></span><br><span class=\"line\"><span class=\"built_in\">nohup</span> ffmpeg -i <span class=\"string\">&quot;rtsp://a:a@192.168.6.126:554&quot;</span> -y -f image2 -r 1/600 /volume2/homes/13261977480/Photos/camc%03d.jpg 1&gt;/dev/null 2&gt;&amp;1 &amp;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#每5分钟1张</span></span><br><span class=\"line\"><span class=\"built_in\">nohup</span> ffmpeg -i <span class=\"string\">&quot;rtsp://a:a@192.168.6.126:554&quot;</span> -y -f image2 -r 1/300 /volume2/homes/13261977480/Photos/camc%03d.jpg 1&gt;/dev/null 2&gt;&amp;1 &amp;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#每3分钟1张, 命名手动修改日期,和第几次启动抽帧,这二者数字相连</span></span><br><span class=\"line\"><span class=\"built_in\">nohup</span> ffmpeg -i <span class=\"string\">&quot;rtsp://a:a@192.168.6.211:554&quot;</span> -y -f image2 -r 1/180 /volume2/homes/13261977480/Photos/202409241%03d.jpg 1&gt;/dev/null 2&gt;&amp;1 &amp;</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"如何退出-nohup-进程\"><a href=\"#如何退出-nohup-进程\" class=\"headerlink\" title=\"如何退出 nohup 进程\"></a>如何退出 nohup 进程</h3><p>以上的进程运行后, 又是SSH终端会断开(由于长时间不在电脑前 自动断开).</p>\n<p>这时无法使用PS命令来查看ffmpeg的进程pid, 从而导致无法kill 掉ffmpeg的 nohup进程.</p>\n<p>方法:</p>\n<p>打开群晖的web管理界面, 右上角搜索: 任务管理器</p>\n<p>点击 ‘进程’ 查看进程明细, 这时(比ps更详细)可以看到后台nohup的ffmpeg的进程pid</p>\n<p>在回到SSH的终端, kill 看到的nohup ffmeg进程pid即可.</p>\n<p><img data-src=\"https://img.carlzeng.top:3/i/2024/09/26/66f4f8453d18a.png\" alt=\"image-20240926135930307\"></p>\n<h2 id=\"ffmpeg对视频抽帧时让结果图片文件名带上时间戳\"><a href=\"#ffmpeg对视频抽帧时让结果图片文件名带上时间戳\" class=\"headerlink\" title=\"ffmpeg对视频抽帧时让结果图片文件名带上时间戳\"></a>ffmpeg对视频抽帧时让结果图片文件名带上时间戳</h2><p>文件名的部分, 目前是 %03d 意思是: 三位数字, 三位递增的数字, 001, 002, 003….</p>\n<p>output%Y-%m-%d-%H-%M-%S.jpg 意思是: output年-月-日-时-分-秒</p>\n<p>nohup ffmpeg -i “rtsp:&#x2F;&#x2F;a:<a href=\"mailto:&#x61;&#x40;&#x31;&#57;&#50;&#x2e;&#x31;&#54;&#56;&#x2e;&#x36;&#46;&#x31;&#50;&#54;\">&#x61;&#x40;&#x31;&#57;&#50;&#x2e;&#x31;&#54;&#56;&#x2e;&#x36;&#46;&#x31;&#50;&#54;</a>:554” -y -f image2 -r 1&#x2F;180 &#x2F;volume2&#x2F;homes&#x2F;13261977480&#x2F;Photos&#x2F;camc%Y-%m-%d-%H-%M-%S.jpg 1&gt;&#x2F;dev&#x2F;null 2&gt;&amp;1 &amp;</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[image2 @ 0x55bcf2b2d900] The specified filename &#x27;/volume2/homes/13261977480/Photos/camc%Y%m%d%H%M%S.png&#x27; does</span><br><span class=\"line\"> not contain an image sequence pattern or a pattern is invalid. </span><br></pre></td></tr></table></figure>\n\n<p>以上这个方法给文件名添加时间戳, 都是失败了.</p>\n<h2 id=\"FFMPEG输出帧名称问题\"><a href=\"#FFMPEG输出帧名称问题\" class=\"headerlink\" title=\"FFMPEG输出帧名称问题\"></a>FFMPEG输出帧名称问题</h2><p>FFMPEG是一款开源的跨平台音视频处理工具，可以用于处理音视频文件的编码、解码、转码、剪辑等操作。在使用FFMPEG进行音视频处理时，输出帧名称问题可能是指输出的音视频帧的命名规则或命名方式的问题。</p>\n<p>在FFMPEG中，输出帧的命名可以通过设置参数来进行控制。常见的参数包括：</p>\n<ol>\n<li><code>-vf</code>或<code>-filter_complex</code>：用于设置视频滤镜，可以通过滤镜参数来修改输出帧的命名方式。</li>\n<li><code>-frames:v</code>：用于设置输出视频的帧数，可以通过设置帧数来控制输出帧的数量。</li>\n<li><code>-ss</code>和<code>-t</code>：用于设置视频的起始时间和持续时间，可以通过设置起始时间和持续时间来控制输出帧的时间范围。</li>\n</ol>\n<h2 id=\"转场抽帧\"><a href=\"#转场抽帧\" class=\"headerlink\" title=\"转场抽帧\"></a>转场抽帧</h2><p>为了更好的生成封面图我们可以通过抽取转场帧来随机一个</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta prompt_\">$ </span><span class=\"language-bash\">ffmpeg -i input.mp4 -filter:v <span class=\"string\">&quot;select=&#x27;gt(scene,0.25)&#x27;&quot;</span> -vsync vfr -y ./frames/thumbnail_%04d.png</span></span><br></pre></td></tr></table></figure>\n\n<ul>\n<li><code>select=&#39;gt(scene,0.25)&#39;</code>: 通过 <code>select</code> 滤镜来筛选场景变化。<code>gt(scene,0.25)</code> 表示筛选出场景变化程度大于0.25的帧。<code>scene</code>是一种场景检测器，它会计算帧与帧之间的差异，当差异超过指定的阈值时，认为发生了场景变化</li>\n</ul>\n<p>由于ffmpeg抽取帧并无法按照时间戳来命名，需要手动将ffprobe提取出来的帧时间与抽取帧的图片进行对应重命名。关键帧具体的定义和用途可以参考：<br><a href=\"https://en.wikipedia.org/wiki/Key_frame\">Https://en.wikipedia.org/wiki/Key_frame</a></p>\n<h2 id=\"下一步\"><a href=\"#下一步\" class=\"headerlink\" title=\"下一步:\"></a>下一步:</h2><ol>\n<li>设置定时, 仅在特定的时间段开放视频流抽帧<ol>\n<li>或者手动输入命令后, 按命令中的特定频率抽帧, 比如每分钟1帧</li>\n</ol>\n</li>\n<li>上峰顶(时间封顶, 或者数量封顶)<ol>\n<li>设置参数, 仅运行到特定的时间点, 就退出(不要无限循环下去)</li>\n<li>设置参数, 仅抽到指定张数的图片, 就退出(不要无限循环下去)</li>\n</ol>\n</li>\n<li>点击按钮, 自动提交photo的登录form; <ol>\n<li>可以吗? 这样避免用户输入的繁琐&#x2F;冗余动作</li>\n</ol>\n</li>\n<li>避免 覆盖的机制? <ol>\n<li>不重要, 不要覆盖, 最好要一直保留下去</li>\n<li>目前是每次运行都从0开始编号, 这样就覆盖了上一次的文件截图</li>\n<li>手动输上日期就好了, 这样不会被覆盖</li>\n<li>如何让文件名包含动态的时间戳? 目前是动态的递增序号. <ol>\n<li>[ffmpeg不支持]让文件名包含动态的时间戳</li>\n</ol>\n</li>\n</ol>\n</li>\n<li>权限: 去除上传功能<ol>\n<li>设置了新的用户组, 设置了配额可仿佛不生效, 依旧可以上传</li>\n</ol>\n</li>\n</ol>\n<h1 id=\"灵感来源\"><a href=\"#灵感来源\" class=\"headerlink\" title=\"灵感来源\"></a>灵感来源</h1><p><a href=\"https://hellodk.cn/post/964\">写了一个适配兰空图床 Lsky Pro 的 PicGo 图片上传插件</a>  <a href=\"https://github.com/hellodk34/picgo-plugin-lankong\">picgo-plugin-lankong</a></p>\n<p><a href=\"https://github.com/lsky-org/lsky-pro/issues/317\">静态资源加载失败 #317</a></p>\n<p><a href=\"https://github.com/lsky-org/lsky-pro/issues/607\">https+域名+端口的访问问题，NginxProxyManager反代 #607</a></p>\n<p><a href=\"https://xyzbz.cn/archives/1080/\">树莓派通过Docker部署兰空图床</a></p>\n","more":"<div> \n<button onclick=\"synthesizeSpeech()\">朗读全文</button>\n</div>\n<audio controls id=\"audioPlayer\">Your browser does not support the audio element.</audio>      \n<script>\n  function synthesizeSpeech() { \n    var inputText = document.getElementsByClassName('post-block')[0].innerText;\n    var voice = \"ZH\";\n    var url = 'https://tts.carlzeng.top:3/speech?text=' + encodeURIComponent(inputText.substring(0,3000)) + '&voice=' + voice;\n    var audioPlayer = document.getElementById('audioPlayer');          \n    audioPlayer.src = url;\n    audioPlayer.load();\n    audioPlayer.play();\n  }\n</script>\n\n\n<h1 id=\"有什么用-怎么用\"><a href=\"#有什么用-怎么用\" class=\"headerlink\" title=\"有什么用&#x2F;怎么用\"></a>有什么用&#x2F;怎么用</h1><ul>\n<li>自建图床，自用的情况下暂时是够用的</li>\n<li>群晖 Synology Photos, 备份各个手机中的照片</li>\n<li>ffmpeg抽帧实践</li>\n</ul>\n<p>访问：<a href=\"https://img.carlzeng.top:3/\">Carl Notes 图床</a></p>\n<p>登录后台管理图床中的图片内容等操作</p>\n<h1 id=\"相关内容\"><a href=\"#相关内容\" class=\"headerlink\" title=\"相关内容\"></a>相关内容</h1><iframe style=\"box-shadow: 0px 0px 20px -10px;\" src=\"https://query.carlzeng.top:3/appsearch?q=image\" frameborder=\"0\" scrolling=\"auto\" width=\"100%\" height=\"500\"></iframe>\n\n<h1 id=\"实现方法\"><a href=\"#实现方法\" class=\"headerlink\" title=\"实现方法\"></a>实现方法</h1><h2 id=\"Docker搭建Lsky-Pro图床应用\"><a href=\"#Docker搭建Lsky-Pro图床应用\" class=\"headerlink\" title=\"Docker搭建Lsky Pro图床应用\"></a>Docker搭建Lsky Pro图床应用</h2><figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">docker pull dko0/lsky-pro</span><br><span class=\"line\"></span><br><span class=\"line\">docker run  --name lsky-pro --restart always -p 8091:80 -d -v /volume2/KingchuxingSSD512G/MacBookPro_Skitch:/var/www/html dko0/lsky-pro</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\">#</span><span class=\"language-bash\">转化为docker-compose</span></span><br><span class=\"line\">version: &#x27;3.9&#x27;</span><br><span class=\"line\">services:</span><br><span class=\"line\">    lsky-pro:</span><br><span class=\"line\">        image: dko0/lsky-pro</span><br><span class=\"line\">        volumes:</span><br><span class=\"line\">            - &#x27;/volume2/KingchuxingSSD512G/MacBookPro_Skitch:/var/www/html&#x27;</span><br><span class=\"line\">        ports:</span><br><span class=\"line\">            - &#x27;8091:80&#x27;</span><br><span class=\"line\">        restart: always</span><br><span class=\"line\">        container_name: lsky-pro</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"配置PicGO\"><a href=\"#配置PicGO\" class=\"headerlink\" title=\"配置PicGO\"></a>配置PicGO</h2><p>下载并安装PicGo，Mac OS X：[PicGo-2.4.0-beta.6-x64.dmg](<a href=\"https://github.com/Molunerfinn/PicGo/releases\">https://github.com/Molunerfinn/PicGo/releases</a><br><a href=\"https://picgo-release.molunerfinn.com/2.4.0-beta.6/PicGo-2.4.0-beta.6-x64.dmg\">https://picgo-release.molunerfinn.com/2.4.0-beta.6/PicGo-2.4.0-beta.6-x64.dmg</a>)</p>\n<p>打开主界面&#x2F;窗口，插件设置，搜索并安装插件名：lankong （我下载的版本是：lankong 1.1.3）</p>\n<p>图床配置 》 lankong</p>\n<figure class=\"highlight ini\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Lsky Pro Version： V2</span><br><span class=\"line\">Server: https://img.carlzeng.top:3</span><br><span class=\"line\">Auth token: Bearer 1|ZRZcNz1E6hAuyV4LytmCqmGx5yST0g9OyhdptXXX</span><br></pre></td></tr></table></figure>\n\n<p>获取 Lsky Pro 兰空图床的Auth Token的方式，推荐(Terminal 运行命令)：</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">curl --location --request POST &#x27;https://imgserver.com:3/api/v1/tokens&#x27; \\</span><br><span class=\"line\">\t--form &#x27;email=&quot;email@email.com&quot;&#x27; \\</span><br><span class=\"line\">\t--form &#x27;password=&quot;password&quot;&#x27;</span><br></pre></td></tr></table></figure>\n\n<p>请修改一下URL地址为访问自建兰空图床的URL地址，email和密码为登录图传所使用的用户名和密码</p>\n<p>本章节参见：<a href=\"https://github.com/hellodk34/picgo-plugin-lankong\">https://github.com/hellodk34/picgo-plugin-lankong</a></p>\n<p>测试：将文件拖拽到此处，或 点击上传，然后到兰空图床的URL后台，确认图片已上传至系统中</p>\n<h2 id=\"配置Typora\"><a href=\"#配置Typora\" class=\"headerlink\" title=\"配置Typora\"></a>配置Typora</h2><p>设置 偏好设置</p>\n<ol>\n<li><p>切换Typora到中文语言版（因为目前只有中文版有PicGo的选项）</p>\n</li>\n<li><p>偏好设置 》 图像 〉上传服务设定。 选择：PicGo.app</p>\n</li>\n<li><p>然后点击：验证图片上传选项  </p>\n<p>我的设置第一次显示失败了，按提示的信息查看日志：</p>\n<figure class=\"highlight ini\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">------Error Stack Begin------</span><br><span class=\"line\">Error: You must be logged in to use.</span><br><span class=\"line\">    at Object.We <span class=\"section\">[as handle]</span> (/Applications/PicGo.app/Contents/Resources/app.asar/node_modules/picgo/dist/index.cjs.js:1:21399)</span><br><span class=\"line\">    at processTicksAndRejections (node:internal/process/task_queues:96:5)</span><br><span class=\"line\">    at async je.doUpload (/Applications/PicGo.app/Contents/Resources/app.asar/node_modules/picgo/dist/index.cjs.js:1:19834)</span><br><span class=\"line\">    at async je.start (/Applications/PicGo.app/Contents/Resources/app.asar/node_modules/picgo/dist/index.cjs.js:1:18605)</span><br><span class=\"line\">    at async $t.upload (/Applications/PicGo.app/Contents/Resources/app.asar/node_modules/picgo/dist/index.cjs.js:1:74902)</span><br><span class=\"line\">    at async Object.upload (/Applications/PicGo.app/Contents/Resources/app.asar/index.js:2:686906)</span><br><span class=\"line\">    at async hr (/Applications/PicGo.app/Contents/Resources/app.asar/index.js:2:689655)</span><br><span class=\"line\">    at async /Applications/PicGo.app/Contents/Resources/app.asar/index.js:2:690736</span><br><span class=\"line\">-------Error Stack End------- </span><br><span class=\"line\">2024-02-21 13:37:13 <span class=\"section\">[PicGo INFO]</span> <span class=\"section\">[PicGo Server]</span> upload result  </span><br><span class=\"line\">2024-02-21 13:37:13 <span class=\"section\">[PicGo WARN]</span> <span class=\"section\">[PicGo Server]</span> upload failed, see picgo.log for more detail ↑ </span><br></pre></td></tr></table></figure>\n\n\n</li>\n<li><p>复制一张图片到剪贴板，在某个文章的内容中，粘贴图片；鼠标右键选中图片，上传图片</p>\n</li>\n<li><p>这时PicGo会显示待上传的图片，以及上传进度，直到图片被自动上传到图床中</p>\n</li>\n<li><p>全流程结束</p>\n</li>\n</ol>\n<p>本章节可以参见：<a href=\"https://support.typora.io/Upload-Image/#picgoapp-chinese-language-only\">Upload Images</a></p>\n<h2 id=\"关联Alist的目录\"><a href=\"#关联Alist的目录\" class=\"headerlink\" title=\"关联Alist的目录\"></a>关联Alist的目录</h2><p>这是根据个人自身的使用情况做的拓展，分享出图床中的所有图片</p>\n<p>修改docker-compose.yml, 添加映射：</p>\n<ul>\n<li>&#x2F;volume2&#x2F;KingchuxingSSD512G&#x2F;MacBookPro_Skitch:&#x2F;home&#x2F;share10</li>\n</ul>\n<p>docker exec -it alist &#x2F;bin&#x2F;bash</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">mkdir share7 &amp;&amp; mkdir share8 &amp;&amp; mkdir share9 &amp;&amp; mkdir share10 &amp;&amp; mkdir shar</span><br><span class=\"line\">e11 &amp;&amp; mkdir share12 </span><br></pre></td></tr></table></figure>\n\n\n\n<p>重启docker-compose</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta prompt_\">#</span><span class=\"language-bash\">这是不会成功的，需要使用docker-compose down 和 up</span></span><br><span class=\"line\">docker-compose restart</span><br><span class=\"line\"></span><br><span class=\"line\">docker-compose down</span><br><span class=\"line\">docker-compose up -d</span><br></pre></td></tr></table></figure>\n\n\n\n<p>进入Alist的后台管理，新增 “本机存储”</p>\n<p>映射&#x2F;home&#x2F;share10 至外观目录：&#x2F;图床MacBookPro_Skitch</p>\n<p>效果如：<a href=\"https://file.carlzeng.top:3/%E5%9B%BE%E5%BA%8AMacBookPro_Skitch/storage/app/uploads/2024/02/21\">https://file.carlzeng.top:3/%E5%9B%BE%E5%BA%8AMacBookPro_Skitch/storage/app/uploads/2024/02/21</a></p>\n<h2 id=\"NPM反代后带端口访问\"><a href=\"#NPM反代后带端口访问\" class=\"headerlink\" title=\"NPM反代后带端口访问\"></a>NPM反代后带端口访问</h2><p>1、修改&#x2F;config&#x2F;app.php （大约在57-60行的地方，修改以下2行内容）</p>\n<figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">//原先：</span></span><br><span class=\"line\">  <span class=\"string\">&#x27;url&#x27;</span> =&gt; <span class=\"title function_ invoke__\">env</span>(<span class=\"string\">&#x27;APP_URL&#x27;</span>, <span class=\"string\">&#x27;http://localhost&#x27;</span>),</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">//新：</span></span><br><span class=\"line\">  <span class=\"string\">&#x27;url&#x27;</span> =&gt; <span class=\"title function_ invoke__\">env</span>(<span class=\"string\">&#x27;APP_URL&#x27;</span>, <span class=\"string\">&#x27;https://xxxxx.com:4443&#x27;</span>),</span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">//原先：</span></span><br><span class=\"line\">  <span class=\"string\">&#x27;asset_url&#x27;</span> =&gt; <span class=\"title function_ invoke__\">env</span>(<span class=\"string\">&#x27;ASSET_URL&#x27;</span>, <span class=\"literal\">null</span>),</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">//新：</span></span><br><span class=\"line\">  <span class=\"string\">&#x27;asset_url&#x27;</span> =&gt; <span class=\"title function_ invoke__\">env</span>(<span class=\"string\">&#x27;ASSET_URL&#x27;</span>, <span class=\"string\">&#x27;https://xxxxx.com:4443&#x27;</span>),</span><br></pre></td></tr></table></figure>\n\n<p>请根据自身情况修改<a href=\"https://xxxxx.com:4443为自己的域名和端口。\">https://xxxxx.com:4443为自己的域名和端口。</a></p>\n<p>2、修改 &#x2F;app&#x2F;Providers&#x2F;ApServiceProvider.php  第 32 行下面追加一行：</p>\n<figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">\\Illuminate\\Support\\Facades\\URL::<span class=\"title function_ invoke__\">forceScheme</span>(<span class=\"string\">&#x27;https&#x27;</span>);</span><br></pre></td></tr></table></figure>\n\n\n\n<h1 id=\"如何让游客可以直接查看照片\"><a href=\"#如何让游客可以直接查看照片\" class=\"headerlink\" title=\"如何让游客可以直接查看照片?\"></a>如何让游客可以直接查看照片?</h1><p>用了这么长时间(大半年) 终于发现它的一些弊端:</p>\n<ul>\n<li>无法让游客直接浏览到游客组或游客用户的照片, 设计思路是先登录开始的(这一点不够人性化)</li>\n<li>无法直接自动加载目录上的照片到图片库里面; 这样就是一直需要有‘上传’的动作</li>\n<li>我的图片目录都存放在这个文文件夹下, 根据月份份分割开子文件夹&#x2F;KingchuxingSSD512G&#x2F;MacBookPro_Skitch&#x2F;storage&#x2F;app&#x2F;uploads&#x2F;2024</li>\n<li></li>\n</ul>\n<p>我需要一个自动读取目录下所有的照片, 然后不管是幻灯片展示,还是如何一张张下拉HTML展示也行的. 类似于图片展示</p>\n<h2 id=\"Synology-Photos\"><a href=\"#Synology-Photos\" class=\"headerlink\" title=\"Synology Photos\"></a>Synology Photos</h2><p>发现了以上的那些图床的弊端以后,</p>\n<p>查资料翻到photoprism, Lychee, immich, 很喜欢这个风格; 然后想到了群晖NAS也有Photo! </p>\n<p>也是超级喜欢的风格, Synology Photos:</p>\n<p>登录路径 <a href=\"https://nas.carlzeng.top:4443/?launchApp=SYNO.Foto.Sharing.AppInstance&app_name=SYNO.Foto.Sharing.AppInstance&action=external_login#/signin\">https://nas.carlzeng.top:4443/?launchApp=SYNO.Foto.Sharing.AppInstance&amp;app_name=SYNO.Foto.Sharing.AppInstance&amp;action=external_login#/signin</a></p>\n<p>设置了一个用户: 13261977480 (去除了NAS的访问权限, 是的, 取消非photo资源的访问)</p>\n<p>密码: 1Carlzeng.top</p>\n<p>设置下个, 获取 &#x2F;homes 目录的绝对路径: </p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">/volume2/homes/13261977480/Photos</span><br></pre></td></tr></table></figure>\n\n<p>然后把ffmpeg抽帧生成的照片放到这个目录, 这样自动就会往这个相册里面增加照片</p>\n<p>后台运行(视频流抽帧)命令如下:</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#每小时1张</span></span><br><span class=\"line\"><span class=\"built_in\">nohup</span> ffmpeg -i <span class=\"string\">&quot;rtsp://a:a@192.168.6.126:554&quot;</span> -y -f image2 -r 1/3600 /volume2/homes/13261977480/Photos/camc%03d.jpg 1&gt;/dev/null 2&gt;&amp;1 &amp;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#每半小时1张</span></span><br><span class=\"line\"><span class=\"built_in\">nohup</span> ffmpeg -i <span class=\"string\">&quot;rtsp://a:a@192.168.6.126:554&quot;</span> -y -f image2 -r 1/1800 /volume2/homes/13261977480/Photos/camc%03d.jpg 1&gt;/dev/null 2&gt;&amp;1 &amp;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#每15分钟1张</span></span><br><span class=\"line\"><span class=\"built_in\">nohup</span> ffmpeg -i <span class=\"string\">&quot;rtsp://a:a@192.168.6.126:554&quot;</span> -y -f image2 -r 1/900 /volume2/homes/13261977480/Photos/camc%03d.jpg 1&gt;/dev/null 2&gt;&amp;1 &amp;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#每10分钟1张</span></span><br><span class=\"line\"><span class=\"built_in\">nohup</span> ffmpeg -i <span class=\"string\">&quot;rtsp://a:a@192.168.6.126:554&quot;</span> -y -f image2 -r 1/600 /volume2/homes/13261977480/Photos/camc%03d.jpg 1&gt;/dev/null 2&gt;&amp;1 &amp;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#每5分钟1张</span></span><br><span class=\"line\"><span class=\"built_in\">nohup</span> ffmpeg -i <span class=\"string\">&quot;rtsp://a:a@192.168.6.126:554&quot;</span> -y -f image2 -r 1/300 /volume2/homes/13261977480/Photos/camc%03d.jpg 1&gt;/dev/null 2&gt;&amp;1 &amp;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#每3分钟1张, 命名手动修改日期,和第几次启动抽帧,这二者数字相连</span></span><br><span class=\"line\"><span class=\"built_in\">nohup</span> ffmpeg -i <span class=\"string\">&quot;rtsp://a:a@192.168.6.211:554&quot;</span> -y -f image2 -r 1/180 /volume2/homes/13261977480/Photos/202409241%03d.jpg 1&gt;/dev/null 2&gt;&amp;1 &amp;</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"如何退出-nohup-进程\"><a href=\"#如何退出-nohup-进程\" class=\"headerlink\" title=\"如何退出 nohup 进程\"></a>如何退出 nohup 进程</h3><p>以上的进程运行后, 又是SSH终端会断开(由于长时间不在电脑前 自动断开).</p>\n<p>这时无法使用PS命令来查看ffmpeg的进程pid, 从而导致无法kill 掉ffmpeg的 nohup进程.</p>\n<p>方法:</p>\n<p>打开群晖的web管理界面, 右上角搜索: 任务管理器</p>\n<p>点击 ‘进程’ 查看进程明细, 这时(比ps更详细)可以看到后台nohup的ffmpeg的进程pid</p>\n<p>在回到SSH的终端, kill 看到的nohup ffmeg进程pid即可.</p>\n<p><img data-src=\"https://img.carlzeng.top:3/i/2024/09/26/66f4f8453d18a.png\" alt=\"image-20240926135930307\"></p>\n<h2 id=\"ffmpeg对视频抽帧时让结果图片文件名带上时间戳\"><a href=\"#ffmpeg对视频抽帧时让结果图片文件名带上时间戳\" class=\"headerlink\" title=\"ffmpeg对视频抽帧时让结果图片文件名带上时间戳\"></a>ffmpeg对视频抽帧时让结果图片文件名带上时间戳</h2><p>文件名的部分, 目前是 %03d 意思是: 三位数字, 三位递增的数字, 001, 002, 003….</p>\n<p>output%Y-%m-%d-%H-%M-%S.jpg 意思是: output年-月-日-时-分-秒</p>\n<p>nohup ffmpeg -i “rtsp:&#x2F;&#x2F;a:<a href=\"mailto:&#x61;&#x40;&#x31;&#57;&#50;&#x2e;&#x31;&#54;&#56;&#x2e;&#x36;&#46;&#x31;&#50;&#54;\">&#x61;&#x40;&#x31;&#57;&#50;&#x2e;&#x31;&#54;&#56;&#x2e;&#x36;&#46;&#x31;&#50;&#54;</a>:554” -y -f image2 -r 1&#x2F;180 &#x2F;volume2&#x2F;homes&#x2F;13261977480&#x2F;Photos&#x2F;camc%Y-%m-%d-%H-%M-%S.jpg 1&gt;&#x2F;dev&#x2F;null 2&gt;&amp;1 &amp;</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[image2 @ 0x55bcf2b2d900] The specified filename &#x27;/volume2/homes/13261977480/Photos/camc%Y%m%d%H%M%S.png&#x27; does</span><br><span class=\"line\"> not contain an image sequence pattern or a pattern is invalid. </span><br></pre></td></tr></table></figure>\n\n<p>以上这个方法给文件名添加时间戳, 都是失败了.</p>\n<h2 id=\"FFMPEG输出帧名称问题\"><a href=\"#FFMPEG输出帧名称问题\" class=\"headerlink\" title=\"FFMPEG输出帧名称问题\"></a>FFMPEG输出帧名称问题</h2><p>FFMPEG是一款开源的跨平台音视频处理工具，可以用于处理音视频文件的编码、解码、转码、剪辑等操作。在使用FFMPEG进行音视频处理时，输出帧名称问题可能是指输出的音视频帧的命名规则或命名方式的问题。</p>\n<p>在FFMPEG中，输出帧的命名可以通过设置参数来进行控制。常见的参数包括：</p>\n<ol>\n<li><code>-vf</code>或<code>-filter_complex</code>：用于设置视频滤镜，可以通过滤镜参数来修改输出帧的命名方式。</li>\n<li><code>-frames:v</code>：用于设置输出视频的帧数，可以通过设置帧数来控制输出帧的数量。</li>\n<li><code>-ss</code>和<code>-t</code>：用于设置视频的起始时间和持续时间，可以通过设置起始时间和持续时间来控制输出帧的时间范围。</li>\n</ol>\n<h2 id=\"转场抽帧\"><a href=\"#转场抽帧\" class=\"headerlink\" title=\"转场抽帧\"></a>转场抽帧</h2><p>为了更好的生成封面图我们可以通过抽取转场帧来随机一个</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta prompt_\">$ </span><span class=\"language-bash\">ffmpeg -i input.mp4 -filter:v <span class=\"string\">&quot;select=&#x27;gt(scene,0.25)&#x27;&quot;</span> -vsync vfr -y ./frames/thumbnail_%04d.png</span></span><br></pre></td></tr></table></figure>\n\n<ul>\n<li><code>select=&#39;gt(scene,0.25)&#39;</code>: 通过 <code>select</code> 滤镜来筛选场景变化。<code>gt(scene,0.25)</code> 表示筛选出场景变化程度大于0.25的帧。<code>scene</code>是一种场景检测器，它会计算帧与帧之间的差异，当差异超过指定的阈值时，认为发生了场景变化</li>\n</ul>\n<p>由于ffmpeg抽取帧并无法按照时间戳来命名，需要手动将ffprobe提取出来的帧时间与抽取帧的图片进行对应重命名。关键帧具体的定义和用途可以参考：<br><a href=\"https://en.wikipedia.org/wiki/Key_frame\">Https://en.wikipedia.org/wiki/Key_frame</a></p>\n<h2 id=\"下一步\"><a href=\"#下一步\" class=\"headerlink\" title=\"下一步:\"></a>下一步:</h2><ol>\n<li>设置定时, 仅在特定的时间段开放视频流抽帧<ol>\n<li>或者手动输入命令后, 按命令中的特定频率抽帧, 比如每分钟1帧</li>\n</ol>\n</li>\n<li>上峰顶(时间封顶, 或者数量封顶)<ol>\n<li>设置参数, 仅运行到特定的时间点, 就退出(不要无限循环下去)</li>\n<li>设置参数, 仅抽到指定张数的图片, 就退出(不要无限循环下去)</li>\n</ol>\n</li>\n<li>点击按钮, 自动提交photo的登录form; <ol>\n<li>可以吗? 这样避免用户输入的繁琐&#x2F;冗余动作</li>\n</ol>\n</li>\n<li>避免 覆盖的机制? <ol>\n<li>不重要, 不要覆盖, 最好要一直保留下去</li>\n<li>目前是每次运行都从0开始编号, 这样就覆盖了上一次的文件截图</li>\n<li>手动输上日期就好了, 这样不会被覆盖</li>\n<li>如何让文件名包含动态的时间戳? 目前是动态的递增序号. <ol>\n<li>[ffmpeg不支持]让文件名包含动态的时间戳</li>\n</ol>\n</li>\n</ol>\n</li>\n<li>权限: 去除上传功能<ol>\n<li>设置了新的用户组, 设置了配额可仿佛不生效, 依旧可以上传</li>\n</ol>\n</li>\n</ol>\n<h1 id=\"灵感来源\"><a href=\"#灵感来源\" class=\"headerlink\" title=\"灵感来源\"></a>灵感来源</h1><p><a href=\"https://hellodk.cn/post/964\">写了一个适配兰空图床 Lsky Pro 的 PicGo 图片上传插件</a>  <a href=\"https://github.com/hellodk34/picgo-plugin-lankong\">picgo-plugin-lankong</a></p>\n<p><a href=\"https://github.com/lsky-org/lsky-pro/issues/317\">静态资源加载失败 #317</a></p>\n<p><a href=\"https://github.com/lsky-org/lsky-pro/issues/607\">https+域名+端口的访问问题，NginxProxyManager反代 #607</a></p>\n<p><a href=\"https://xyzbz.cn/archives/1080/\">树莓派通过Docker部署兰空图床</a></p>","categories":[{"name":"图床","path":"api/categories/图床.json"}],"tags":[{"name":"NPM","path":"api/tags/NPM.json"},{"name":"Docker","path":"api/tags/Docker.json"},{"name":"图床","path":"api/tags/图床.json"},{"name":"LskyPro","path":"api/tags/LskyPro.json"}]}
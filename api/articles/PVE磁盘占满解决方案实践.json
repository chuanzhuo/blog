{"title":"PVE磁盘占满解决方案实践","slug":"PVE磁盘占满解决方案实践","date":"2024-01-11T01:31:48.000Z","updated":"2024-04-13T03:46:00.334Z","comments":true,"path":"api/articles/PVE磁盘占满解决方案实践.json","excerpt":" [Figure] 应对PVE磁盘占满的现实情况","covers":["https://img.carlzeng.top:3/i/2024/04/13/6619ff7ea2496.png"],"content":"<img class=\"lozad\" data-src=\"\">\n\n<p>应对PVE磁盘占满的现实情况</p>\n<span id=\"more\"></span>\n\n<div> \n<button onclick=\"synthesizeSpeech()\">朗读全文</button>\n</div>\n<audio controls id=\"audioPlayer\">Your browser does not support the audio element.</audio>      \n<script>\n  function synthesizeSpeech() { \n    var inputText = document.getElementsByClassName('post-block')[0].innerText;\n    var voice = \"ZH\";\n    var url = 'https://tts.carlzeng.top:3/speech?text=' + encodeURIComponent(inputText.substring(0,3000)) + '&voice=' + voice;\n    var audioPlayer = document.getElementById('audioPlayer');          \n    audioPlayer.src = url;\n    audioPlayer.load();\n    audioPlayer.play();\n  }\n</script>\n# 有什么用\n\n<p>应对PVE磁盘占满的现实情况</p>\n<h1 id=\"方案1-清理PVE空间\"><a href=\"#方案1-清理PVE空间\" class=\"headerlink\" title=\"方案1: 清理PVE空间\"></a>方案1: 清理PVE空间</h1><p>清理pve，登录pve的ssh：</p>\n<ol>\n<li><p>查看各个目录下的文件大小，按文件大小从大到小排序：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">du -s /* | sort -nr </span><br></pre></td></tr></table></figure>\n\n<p>其中 &#x2F;*，可以时任何一个目录，比如&#x2F;lib&#x2F;*就是查看lib目录下的文件大小。</p>\n<p>删除无用的文件</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta prompt_\">&gt; </span><span class=\"language-bash\">find / -size +800M -<span class=\"built_in\">exec</span> <span class=\"built_in\">ls</span> -lh &#123;&#125; \\;</span>         </span><br><span class=\"line\"></span><br><span class=\"line\">-r-------- 1 root root 128T Nov 19 19:24 /proc/kcore   </span><br><span class=\"line\">...</span><br><span class=\"line\"><span class=\"meta prompt_\">#</span><span class=\"language-bash\">检查异常大小的<span class=\"built_in\">log</span>文件</span></span><br></pre></td></tr></table></figure>\n</li>\n<li><p>删除无用的日志文件</p>\n</li>\n<li><p>rm -rf &#x2F;log&#x2F;*.gz  </p>\n</li>\n<li><p>rm -rf &#x2F;var&#x2F;log&#x2F;*.1</p>\n</li>\n<li><p>配置日志文件大小多少 </p>\n<ol>\n<li><p>journalctl –vacuum-size&#x3D;512M </p>\n</li>\n<li><p>2d之前的自动删除</p>\n<p>journalctl –vacuum-time&#x3D;2d </p>\n</li>\n<li></li>\n</ol>\n</li>\n<li><p>如果有挪移PVE docker 出来的Debian中的大文件的需求</p>\n<ol>\n<li>思路：debian docker data-root</li>\n<li><a href=\"https://medium.com/@calvineotieno010/change-docker-default-root-data-directory-a1d9271056f4\">Change Docker Default Root Data Directory</a></li>\n</ol>\n</li>\n<li><p>更详细的记录详见： <a href=\"https://www.carlzeng.top/202312290851\">PVE群晖NAS修复笔记</a> 》 采取措施</p>\n</li>\n</ol>\n<h1 id=\"方案2-添加新磁盘\"><a href=\"#方案2-添加新磁盘\" class=\"headerlink\" title=\"方案2: 添加新磁盘\"></a>方案2: 添加新磁盘</h1><ol>\n<li>把1T的移动硬盘插到USB上</li>\n</ol>\n<p>查看各磁盘情况（含名称），或者可以用命令</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ls /dev/disk/by-id</span><br></pre></td></tr></table></figure>\n\n<p>或者PVE的UI上数据中心&gt;PVE名称&gt;磁盘</p>\n<ol start=\"2\">\n<li>在mnt文件夹下新增一个目录，比如：mkdir usbToshiBa1T<ol>\n<li>比如看到的是&#x2F;dev&#x2F;sdc2分区</li>\n</ol>\n</li>\n</ol>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">mount /dev/sdc2 /mnt/usbToshiBa1T</span><br></pre></td></tr></table></figure>\n\n\n\n<ol start=\"3\">\n<li><p>界面上，选中磁盘分区：“擦除磁盘” ； 或者可以用命令管理分区：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">fdisk /dev/sdc</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>把分区添加为PVE的 ‘目录’</p>\n<p>UI上选择：数据中心 &gt; PVE名称 &gt; 磁盘 &gt; 目录</p>\n<p>按钮：创建目录</p>\n</li>\n</ol>\n<p>新建虚拟机时：请手动选择该新的‘目录’</p>\n<h1 id=\"相关内容\"><a href=\"#相关内容\" class=\"headerlink\" title=\"相关内容\"></a>相关内容</h1><iframe style=\"box-shadow: 0px 0px 20px -10px;\" src=\"https://query.carlzeng.top:3/appsearch?q=pve\" frameborder=\"0\" scrolling=\"auto\" width=\"100%\" height=\"500\"></iframe>\n\n\n\n<p>J4125机器被强制重启后，需要重新设置磁盘挂载</p>\n<p><img data-src=\"https://img.carlzeng.top:3/i/2024/04/13/6619ff7ea2496.png\" alt=\"image-20240413114355003\"></p>\n<h1 id=\"灵感来源\"><a href=\"#灵感来源\" class=\"headerlink\" title=\"灵感来源\"></a>灵感来源</h1><p> <a href=\"https://www.carlzeng.top/202312290851\">PVE群晖NAS修复笔记</a> </p>\n<p><a href=\"https://www.lategege.com/?p=538\">Proxmox VE(PVE)添加硬盘详解</a></p>\n","more":"<div> \n<button onclick=\"synthesizeSpeech()\">朗读全文</button>\n</div>\n<audio controls id=\"audioPlayer\">Your browser does not support the audio element.</audio>      \n<script>\n  function synthesizeSpeech() { \n    var inputText = document.getElementsByClassName('post-block')[0].innerText;\n    var voice = \"ZH\";\n    var url = 'https://tts.carlzeng.top:3/speech?text=' + encodeURIComponent(inputText.substring(0,3000)) + '&voice=' + voice;\n    var audioPlayer = document.getElementById('audioPlayer');          \n    audioPlayer.src = url;\n    audioPlayer.load();\n    audioPlayer.play();\n  }\n</script>\n# 有什么用\n\n<p>应对PVE磁盘占满的现实情况</p>\n<h1 id=\"方案1-清理PVE空间\"><a href=\"#方案1-清理PVE空间\" class=\"headerlink\" title=\"方案1: 清理PVE空间\"></a>方案1: 清理PVE空间</h1><p>清理pve，登录pve的ssh：</p>\n<ol>\n<li><p>查看各个目录下的文件大小，按文件大小从大到小排序：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">du -s /* | sort -nr </span><br></pre></td></tr></table></figure>\n\n<p>其中 &#x2F;*，可以时任何一个目录，比如&#x2F;lib&#x2F;*就是查看lib目录下的文件大小。</p>\n<p>删除无用的文件</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta prompt_\">&gt; </span><span class=\"language-bash\">find / -size +800M -<span class=\"built_in\">exec</span> <span class=\"built_in\">ls</span> -lh &#123;&#125; \\;</span>         </span><br><span class=\"line\"></span><br><span class=\"line\">-r-------- 1 root root 128T Nov 19 19:24 /proc/kcore   </span><br><span class=\"line\">...</span><br><span class=\"line\"><span class=\"meta prompt_\">#</span><span class=\"language-bash\">检查异常大小的<span class=\"built_in\">log</span>文件</span></span><br></pre></td></tr></table></figure>\n</li>\n<li><p>删除无用的日志文件</p>\n</li>\n<li><p>rm -rf &#x2F;log&#x2F;*.gz  </p>\n</li>\n<li><p>rm -rf &#x2F;var&#x2F;log&#x2F;*.1</p>\n</li>\n<li><p>配置日志文件大小多少 </p>\n<ol>\n<li><p>journalctl –vacuum-size&#x3D;512M </p>\n</li>\n<li><p>2d之前的自动删除</p>\n<p>journalctl –vacuum-time&#x3D;2d </p>\n</li>\n<li></li>\n</ol>\n</li>\n<li><p>如果有挪移PVE docker 出来的Debian中的大文件的需求</p>\n<ol>\n<li>思路：debian docker data-root</li>\n<li><a href=\"https://medium.com/@calvineotieno010/change-docker-default-root-data-directory-a1d9271056f4\">Change Docker Default Root Data Directory</a></li>\n</ol>\n</li>\n<li><p>更详细的记录详见： <a href=\"https://www.carlzeng.top/202312290851\">PVE群晖NAS修复笔记</a> 》 采取措施</p>\n</li>\n</ol>\n<h1 id=\"方案2-添加新磁盘\"><a href=\"#方案2-添加新磁盘\" class=\"headerlink\" title=\"方案2: 添加新磁盘\"></a>方案2: 添加新磁盘</h1><ol>\n<li>把1T的移动硬盘插到USB上</li>\n</ol>\n<p>查看各磁盘情况（含名称），或者可以用命令</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ls /dev/disk/by-id</span><br></pre></td></tr></table></figure>\n\n<p>或者PVE的UI上数据中心&gt;PVE名称&gt;磁盘</p>\n<ol start=\"2\">\n<li>在mnt文件夹下新增一个目录，比如：mkdir usbToshiBa1T<ol>\n<li>比如看到的是&#x2F;dev&#x2F;sdc2分区</li>\n</ol>\n</li>\n</ol>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">mount /dev/sdc2 /mnt/usbToshiBa1T</span><br></pre></td></tr></table></figure>\n\n\n\n<ol start=\"3\">\n<li><p>界面上，选中磁盘分区：“擦除磁盘” ； 或者可以用命令管理分区：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">fdisk /dev/sdc</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>把分区添加为PVE的 ‘目录’</p>\n<p>UI上选择：数据中心 &gt; PVE名称 &gt; 磁盘 &gt; 目录</p>\n<p>按钮：创建目录</p>\n</li>\n</ol>\n<p>新建虚拟机时：请手动选择该新的‘目录’</p>\n<h1 id=\"相关内容\"><a href=\"#相关内容\" class=\"headerlink\" title=\"相关内容\"></a>相关内容</h1><iframe style=\"box-shadow: 0px 0px 20px -10px;\" src=\"https://query.carlzeng.top:3/appsearch?q=pve\" frameborder=\"0\" scrolling=\"auto\" width=\"100%\" height=\"500\"></iframe>\n\n\n\n<p>J4125机器被强制重启后，需要重新设置磁盘挂载</p>\n<p><img data-src=\"https://img.carlzeng.top:3/i/2024/04/13/6619ff7ea2496.png\" alt=\"image-20240413114355003\"></p>\n<h1 id=\"灵感来源\"><a href=\"#灵感来源\" class=\"headerlink\" title=\"灵感来源\"></a>灵感来源</h1><p> <a href=\"https://www.carlzeng.top/202312290851\">PVE群晖NAS修复笔记</a> </p>\n<p><a href=\"https://www.lategege.com/?p=538\">Proxmox VE(PVE)添加硬盘详解</a></p>","categories":[{"name":"linux","path":"api/categories/linux.json"}],"tags":[{"name":"linux","path":"api/tags/linux.json"},{"name":"PVE","path":"api/tags/PVE.json"}]}
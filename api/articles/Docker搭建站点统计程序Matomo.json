{"title":"Docker搭建站点统计程序Matomo","slug":"Docker搭建站点统计程序Matomo","date":"2023-12-01T08:25:35.000Z","updated":"2024-07-18T12:31:12.664Z","comments":true,"path":"api/articles/Docker搭建站点统计程序Matomo.json","excerpt":" [Figure] 开源的网站统计程序Matomo","covers":["https://www.evernote.com/shard/s122/sh/14b45feb-7952-49cd-adc5-9829c831239c/4l2YY4NBQFgAW-dGKXvuDVkpt-8PPYT9QM18Xksc38qFUnbgXycF7UfFdw/deep/0/image.png","https://img.carlzeng.top:3/i/2024/07/17/6697ce3243bfb.png"],"content":"<img class=\"lozad\" data-src=\"https://www.evernote.com/shard/s122/sh/14b45feb-7952-49cd-adc5-9829c831239c/4l2YY4NBQFgAW-dGKXvuDVkpt-8PPYT9QM18Xksc38qFUnbgXycF7UfFdw/deep/0/image.png\">\n开源的网站统计程序Matomo\n\n<span id=\"more\"></span>\n\n<h1 id=\"有什么用\"><a href=\"#有什么用\" class=\"headerlink\" title=\"有什么用\"></a>有什么用</h1><p>一款非常好用的网站统计程序，Matomo.  Matomo的前身是著名的Piwik.  作为一款免费开源的统计程序，它不仅能够对每一条访问提供准确及时的访问记录，还能够自动生成极其专业的统计报表，包括根据地理位置生成的全球访问热点地图，实时访问图景，每一条访问的每一个点击操作详细分析，页面跳转率，来路分析，访客浏览器，访客硬件设备，关键词，等等等等……您还可以使用API，将统计功能整合在客户端、小程序等场景。虽然功能非常丰富，但是Mamoto非常轻量，几乎不需要占用什么资源。</p>\n<h1 id=\"实现方法\"><a href=\"#实现方法\" class=\"headerlink\" title=\"实现方法\"></a>实现方法</h1><p>分享可用的docker-compose.yml文件内容如下：</p>\n<p>cd &#x2F;www&#x2F;server&#x2F;panel&#x2F;data&#x2F;compose&#x2F;matomo</p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">version:</span> <span class=\"string\">&#x27;3.9&#x27;</span></span><br><span class=\"line\"><span class=\"attr\">services:</span></span><br><span class=\"line\">  <span class=\"attr\">mariadb:</span></span><br><span class=\"line\">    <span class=\"attr\">container_name:</span> <span class=\"string\">Matomo-DB</span></span><br><span class=\"line\">    <span class=\"attr\">image:</span> <span class=\"string\">mariadb:jammy</span></span><br><span class=\"line\">    <span class=\"attr\">command:</span> <span class=\"string\">--max_allowed_packet=1073741824</span></span><br><span class=\"line\">    <span class=\"attr\">restart:</span> <span class=\"string\">always</span></span><br><span class=\"line\">    <span class=\"comment\">#restart: on-failure:3</span></span><br><span class=\"line\">    <span class=\"attr\">volumes:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">./matomodb:/var/lib/mysql</span></span><br><span class=\"line\">    <span class=\"attr\">environment:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">MYSQL_ALLOW_EMPTY_PASSWORD=yes</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">MYSQL_DATABASE=matomodb</span></span><br><span class=\"line\">  <span class=\"attr\">matomo:</span></span><br><span class=\"line\">    <span class=\"attr\">container_name:</span> <span class=\"string\">Matomo</span></span><br><span class=\"line\">    <span class=\"attr\">environment:</span></span><br><span class=\"line\">      <span class=\"comment\">#- PUID=1026</span></span><br><span class=\"line\">      <span class=\"comment\">#- PGID=100</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">TZ=Asia/Shanghai</span></span><br><span class=\"line\">    <span class=\"attr\">ports:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"number\">8597</span><span class=\"string\">:80</span></span><br><span class=\"line\">    <span class=\"attr\">depends_on:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">mariadb</span></span><br><span class=\"line\">    <span class=\"attr\">volumes:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">./matomo:/var/www/html:rw</span></span><br><span class=\"line\">    <span class=\"attr\">image:</span> <span class=\"string\">matomo</span></span><br><span class=\"line\">    <span class=\"attr\">restart:</span> <span class=\"string\">always</span></span><br></pre></td></tr></table></figure>\n\n\n\n\n\n\n<figure class=\"highlight ini\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\">&lt;!-- Matomo --&gt;</span><br><span class=\"line\">&lt;script&gt;</span><br><span class=\"line\">  var <span class=\"attr\">_paq</span> = window._paq = window._paq || []<span class=\"comment\">;</span></span><br><span class=\"line\">  /* tracker methods like &quot;setCustomDimension&quot; should be called before &quot;trackPageView&quot; */</span><br><span class=\"line\">  _paq.push(<span class=\"section\">[&quot;setDocumentTitle&quot;, document.domain + &quot;/&quot; + document.title]</span>)<span class=\"comment\">;</span></span><br><span class=\"line\">  _paq.push(<span class=\"section\">[&quot;setCookieDomain&quot;, &quot;*.carlzeng.top&quot;]</span>)<span class=\"comment\">;</span></span><br><span class=\"line\">  _paq.push(<span class=\"section\">[&#x27;trackPageView&#x27;]</span>)<span class=\"comment\">;</span></span><br><span class=\"line\">  _paq.push(<span class=\"section\">[&#x27;enableLinkTracking&#x27;]</span>)<span class=\"comment\">;</span></span><br><span class=\"line\">  (function() &#123;</span><br><span class=\"line\">    var <span class=\"attr\">u</span>=<span class=\"string\">&quot;//192.168.6.116:8597/&quot;</span><span class=\"comment\">;</span></span><br><span class=\"line\">    _paq.push(<span class=\"section\">[&#x27;setTrackerUrl&#x27;, u+&#x27;matomo.php&#x27;]</span>)<span class=\"comment\">;</span></span><br><span class=\"line\">    _paq.push(<span class=\"section\">[&#x27;setSiteId&#x27;, &#x27;1&#x27;]</span>)<span class=\"comment\">;</span></span><br><span class=\"line\">    var <span class=\"attr\">d</span>=document, g=d.createElement(<span class=\"string\">&#x27;script&#x27;</span>), s=d.getElementsByTagName(<span class=\"string\">&#x27;script&#x27;</span>)[<span class=\"number\">0</span>]<span class=\"comment\">;</span></span><br><span class=\"line\">    <span class=\"attr\">g.async</span>=<span class=\"literal\">true</span><span class=\"comment\">; g.src=u+&#x27;matomo.js&#x27;; s.parentNode.insertBefore(g,s);</span></span><br><span class=\"line\">  &#125;)()<span class=\"comment\">;</span></span><br><span class=\"line\">&lt;/script&gt;</span><br><span class=\"line\">&lt;noscript&gt;&lt;p&gt;&lt;img <span class=\"attr\">src</span>=<span class=\"string\">&quot;//192.168.6.116:8597/matomo.php?idsite=1&amp;amp;rec=1&quot;</span> style=<span class=\"string\">&quot;border:0;&quot;</span> alt=<span class=\"string\">&quot;&quot;</span> /&gt;&lt;/p&gt;&lt;/noscript&gt;</span><br><span class=\"line\">&lt;!-- End Matomo Code --&gt;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n\n<p>docker-compose up</p>\n<ol>\n<li>Database Server: type in <strong>mariadb</strong></li>\n<li>Login: type in <strong>root</strong></li>\n<li>Password: leave blank</li>\n<li>Database Name: type in <strong>matomodb</strong></li>\n</ol>\n<p>Tracking code for Carl Notes</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;!-- Matomo --&gt;</span><br><span class=\"line\">&lt;script&gt;</span><br><span class=\"line\">  var _paq = window._paq = window._paq || [];</span><br><span class=\"line\">  /* tracker methods like &quot;setCustomDimension&quot; should be called before &quot;trackPageView&quot; */</span><br><span class=\"line\">  _paq.push([&#x27;trackPageView&#x27;]);</span><br><span class=\"line\">  _paq.push([&#x27;enableLinkTracking&#x27;]);</span><br><span class=\"line\">  (function() &#123;</span><br><span class=\"line\">    var u=&quot;//192.168.192.3/&quot;;</span><br><span class=\"line\">    _paq.push([&#x27;setTrackerUrl&#x27;, u+&#x27;matomo.php&#x27;]);</span><br><span class=\"line\">    _paq.push([&#x27;setSiteId&#x27;, &#x27;1&#x27;]);</span><br><span class=\"line\">    var d=document, g=d.createElement(&#x27;script&#x27;), s=d.getElementsByTagName(&#x27;script&#x27;)[0];</span><br><span class=\"line\">    g.async=true; g.src=u+&#x27;matomo.js&#x27;; s.parentNode.insertBefore(g,s);</span><br><span class=\"line\">  &#125;)();</span><br><span class=\"line\">&lt;/script&gt;</span><br><span class=\"line\">&lt;!-- End Matomo Code --&gt;</span><br></pre></td></tr></table></figure>\n\n\n\n<p>开启防火墙的8597</p>\n<p>NPM 新建<br><a href=\"https://statcounter.carlzeng.top:4443/\">https://statcounter.carlzeng.top:4443</a></p>\n<p><a href=\"https://statcounter.carlzeng.top:4443/?module=Login\">https://statcounter.carlzeng.top:4443/?module=Login</a><br>Error: The form security failed because of invalid origin. If you previously connected using HTTPS, please ensure you are connecting over a secure (SSL&#x2F;TLS) connection and try again.</p>\n<p>docker-compose down<br>docker-compose up</p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\">&lt;!-- <span class=\"title class_\">Matomo</span> --&gt;</span><br><span class=\"line\"><span class=\"language-xml\"><span class=\"tag\">&lt;<span class=\"name\">script</span>&gt;</span><span class=\"language-javascript\"></span></span></span><br><span class=\"line\"><span class=\"language-javascript\"><span class=\"language-xml\">  <span class=\"keyword\">var</span> _paq = <span class=\"variable language_\">window</span>.<span class=\"property\">_paq</span> = <span class=\"variable language_\">window</span>.<span class=\"property\">_paq</span> || [];</span></span></span><br><span class=\"line\"><span class=\"language-javascript\"><span class=\"language-xml\">  <span class=\"comment\">/* tracker methods like &quot;setCustomDimension&quot; should be called before &quot;trackPageView&quot; */</span></span></span></span><br><span class=\"line\"><span class=\"language-javascript\"><span class=\"language-xml\">  _paq.<span class=\"title function_\">push</span>([<span class=\"string\">&quot;setDocumentTitle&quot;</span>, <span class=\"variable language_\">document</span>.<span class=\"property\">domain</span> + <span class=\"string\">&quot;/&quot;</span> + <span class=\"variable language_\">document</span>.<span class=\"property\">title</span>]);</span></span></span><br><span class=\"line\"><span class=\"language-javascript\"><span class=\"language-xml\">  _paq.<span class=\"title function_\">push</span>([<span class=\"string\">&quot;setCookieDomain&quot;</span>, <span class=\"string\">&quot;*.carlzeng.top&quot;</span>]);</span></span></span><br><span class=\"line\"><span class=\"language-javascript\"><span class=\"language-xml\">  _paq.<span class=\"title function_\">push</span>([<span class=\"string\">&#x27;trackPageView&#x27;</span>]);</span></span></span><br><span class=\"line\"><span class=\"language-javascript\"><span class=\"language-xml\">  _paq.<span class=\"title function_\">push</span>([<span class=\"string\">&#x27;enableLinkTracking&#x27;</span>]);</span></span></span><br><span class=\"line\"><span class=\"language-javascript\"><span class=\"language-xml\">  (<span class=\"keyword\">function</span>(<span class=\"params\"></span>) &#123;</span></span></span><br><span class=\"line\"><span class=\"language-javascript\"><span class=\"language-xml\">    <span class=\"keyword\">var</span> u=<span class=\"string\">&quot;//statcounter.carlzeng.top:4443/&quot;</span>;</span></span></span><br><span class=\"line\"><span class=\"language-javascript\"><span class=\"language-xml\">    _paq.<span class=\"title function_\">push</span>([<span class=\"string\">&#x27;setTrackerUrl&#x27;</span>, u+<span class=\"string\">&#x27;matomo.php&#x27;</span>]);</span></span></span><br><span class=\"line\"><span class=\"language-javascript\"><span class=\"language-xml\">    _paq.<span class=\"title function_\">push</span>([<span class=\"string\">&#x27;setSiteId&#x27;</span>, <span class=\"string\">&#x27;1&#x27;</span>]);</span></span></span><br><span class=\"line\"><span class=\"language-javascript\"><span class=\"language-xml\">    <span class=\"keyword\">var</span> d=<span class=\"variable language_\">document</span>, g=d.<span class=\"title function_\">createElement</span>(<span class=\"string\">&#x27;script&#x27;</span>), s=d.<span class=\"title function_\">getElementsByTagName</span>(<span class=\"string\">&#x27;script&#x27;</span>)[<span class=\"number\">0</span>];</span></span></span><br><span class=\"line\"><span class=\"language-javascript\"><span class=\"language-xml\">    g.<span class=\"property\">async</span>=<span class=\"literal\">true</span>; g.<span class=\"property\">src</span>=u+<span class=\"string\">&#x27;matomo.js&#x27;</span>; s.<span class=\"property\">parentNode</span>.<span class=\"title function_\">insertBefore</span>(g,s);</span></span></span><br><span class=\"line\"><span class=\"language-javascript\"><span class=\"language-xml\">  &#125;)();</span></span></span><br><span class=\"line\"><span class=\"language-javascript\"><span class=\"language-xml\"></span><span class=\"tag\">&lt;/<span class=\"name\">script</span>&gt;</span></span></span><br><span class=\"line\"><span class=\"language-xml\"><span class=\"tag\">&lt;<span class=\"name\">noscript</span>&gt;</span><span class=\"tag\">&lt;<span class=\"name\">p</span>&gt;</span><span class=\"tag\">&lt;<span class=\"name\">img</span> <span class=\"attr\">src</span>=<span class=\"string\">&quot;//statcounter.carlzeng.top:4443/matomo.php?idsite=1<span class=\"symbol\">&amp;amp;</span>rec=1&quot;</span> <span class=\"attr\">style</span>=<span class=\"string\">&quot;border:0;&quot;</span> <span class=\"attr\">alt</span>=<span class=\"string\">&quot;&quot;</span> /&gt;</span><span class=\"tag\">&lt;/<span class=\"name\">p</span>&gt;</span><span class=\"tag\">&lt;/<span class=\"name\">noscript</span>&gt;</span></span></span><br><span class=\"line\">&lt;!-- <span class=\"title class_\">End</span> <span class=\"title class_\">Matomo</span> <span class=\"title class_\">Code</span> --&gt;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n\n\n<h2 id=\"设置\"><a href=\"#设置\" class=\"headerlink\" title=\"设置\"></a>设置</h2><h3 id=\"UI语言\"><a href=\"#UI语言\" class=\"headerlink\" title=\"UI语言\"></a>UI语言</h3><p>登录Matomo（之前叫Piwik）<br>点击右上角的齿轮小图标，进入设置界面<br>点击左菜单：Personal &#x3D;&#x3D;&gt; settings.<br>设置中文（Language表单项，如下图）</p>\n<h2 id=\"访客IP不正确，访客IP全部变成了代理IP\"><a href=\"#访客IP不正确，访客IP全部变成了代理IP\" class=\"headerlink\" title=\"访客IP不正确，访客IP全部变成了代理IP\"></a>访客IP不正确，访客IP全部变成了代理IP</h2><p>[General]<br>assume_secure_protocol &#x3D; 1</p>\n<p>参见 <a href=\"http://www.matomo.net.cn/2019/03/setup-matomo-in-proxy-env/\">http://www.matomo.net.cn/2019/03/setup-matomo-in-proxy-env/</a></p>\n<p>; Uncomment line below if you use a standard proxy<br>proxy_client_headers[] &#x3D; HTTP_X_FORWARDED_FOR<br>proxy_host_headers[] &#x3D; HTTP_X_FORWARDED_HOST</p>\n<h2 id=\"已解决-疑惑TODO\"><a href=\"#已解决-疑惑TODO\" class=\"headerlink\" title=\"[已解决]疑惑TODO\"></a>[已解决]疑惑TODO</h2><p>mamoto NPM failed to login：statcounter.carlzeng.top:4443</p>\n<p>Error: The form security failed because of invalid origin. If you previously connected using HTTPS, please ensure you are connecting over a secure (SSL&#x2F;TLS) connection and try again.</p>\n<p>[done]本地局域网访问假如在config.ini.php中开启下面这条配置，会导致无法登录<br>;assume_secure_protocol &#x3D; 1</p>\n<div class=\"note success\"><p>2023年12月初：解决办法：用<a href=\"https://c.carlzeng.top:3/web2\">在线云浏览器Firefox</a>，远程过去访问本地局域网的NPM面板即可</p>\n<p>Mamoto面板反代以后无法正常登录，也请使用<a href=\"https://c.carlzeng.top:3/web2\">在线云浏览器Firefox</a></p>\n<p>2024年1月中旬：彻底解决方案：配置和使用frpc的p2p模式，通过本地局域网运行frpc -c frpc.ini将Matomo的管理地址映射到frp服务上；控制端通过使用frpc -c frpc.ini P2P连接到受控端来远程访问Matomo Web页面</p>\n<p>详细解决思路和技术细节请参见：<a href=\"https://query.carlzeng.top:3/appsearch?q=frp%E5%86%85%E7%BD%91%E7%A9%BF%E9%80%8F\">Docker搭建FRP内网穿透服务</a></p>\n</div>\n\n<h2 id=\"如何添加到JS文件\"><a href=\"#如何添加到JS文件\" class=\"headerlink\" title=\"如何添加到JS文件\"></a>如何添加到JS文件</h2><p>截取部分的代码如下, 直接加入到JS的位置（”use strict”;的后面）</p>\n<p>比如app&#x2F;public&#x2F;server&#x2F;server.client.js</p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">var</span> _paq = <span class=\"variable language_\">window</span>.<span class=\"property\">_paq</span> = <span class=\"variable language_\">window</span>.<span class=\"property\">_paq</span> || [];</span><br><span class=\"line\">    <span class=\"comment\">/* tracker methods like &quot;setCustomDimension&quot; should be called before &quot;trackPageView&quot; */</span></span><br><span class=\"line\">    _paq.<span class=\"title function_\">push</span>([<span class=\"string\">&quot;setDocumentTitle&quot;</span>, <span class=\"variable language_\">document</span>.<span class=\"property\">domain</span> + <span class=\"string\">&quot;/&quot;</span> + <span class=\"variable language_\">document</span>.<span class=\"property\">title</span>]);</span><br><span class=\"line\">    _paq.<span class=\"title function_\">push</span>([<span class=\"string\">&quot;setCookieDomain&quot;</span>, <span class=\"string\">&quot;*.carlzeng.top&quot;</span>]);</span><br><span class=\"line\">    _paq.<span class=\"title function_\">push</span>([<span class=\"string\">&#x27;trackPageView&#x27;</span>]);</span><br><span class=\"line\">    _paq.<span class=\"title function_\">push</span>([<span class=\"string\">&#x27;enableLinkTracking&#x27;</span>]);</span><br><span class=\"line\">    (<span class=\"keyword\">function</span>(<span class=\"params\"></span>) &#123;</span><br><span class=\"line\">      <span class=\"keyword\">var</span> u=<span class=\"string\">&quot;//statcounter.carlzeng.top:4443/&quot;</span>;</span><br><span class=\"line\">      _paq.<span class=\"title function_\">push</span>([<span class=\"string\">&#x27;setTrackerUrl&#x27;</span>, u+<span class=\"string\">&#x27;matomo.php&#x27;</span>]);</span><br><span class=\"line\">      _paq.<span class=\"title function_\">push</span>([<span class=\"string\">&#x27;setSiteId&#x27;</span>, <span class=\"string\">&#x27;1&#x27;</span>]);</span><br><span class=\"line\">      <span class=\"keyword\">var</span> d=<span class=\"variable language_\">document</span>, g=d.<span class=\"title function_\">createElement</span>(<span class=\"string\">&#x27;script&#x27;</span>), s=d.<span class=\"title function_\">getElementsByTagName</span>(<span class=\"string\">&#x27;script&#x27;</span>)[<span class=\"number\">0</span>];</span><br><span class=\"line\">      g.<span class=\"property\">async</span>=<span class=\"literal\">true</span>; g.<span class=\"property\">src</span>=u+<span class=\"string\">&#x27;matomo.js&#x27;</span>; s.<span class=\"property\">parentNode</span>.<span class=\"title function_\">insertBefore</span>(g,s);</span><br><span class=\"line\">    &#125;)();</span><br></pre></td></tr></table></figure>\n\n\n\n<h1 id=\"高阶定制-配置\"><a href=\"#高阶定制-配置\" class=\"headerlink\" title=\"高阶定制&#x2F;配置\"></a>高阶定制&#x2F;配置</h1><ul>\n<li>【done】配置详细的IP地址库，可以像statcounter那样看到很详细的地址信息<br>– <a href=\"https://qing.su/article/164.html\">4, 配置IP地理位置数据库</a><br>– 方案二（暂时没必要），使用插件 <a href=\"https://www.afengblog.com/matomo-uses-ip2location-location-service.html\">Matomo 使用 IP 2 Location 数据库提升地域分析精度</a></li>\n<li>ISP数据库<ul>\n<li>文档<a href=\"https://dev.maxmind.com/geoip/docs/databases/isp\">GeoIP2 ISP Databases</a>中获得文件名：GeoIP2-ISP.mmdb<ul>\n<li>这只是一个<a href=\"https://github.com/maxmind/MaxMind-DB/blob/main/test-data/GeoIP2-ISP-Test.mmdb\">模版</a>（没有实际用处）</li>\n<li>google找了半天没有，终于在github找到一个，分享出来<a href=\"https://github.com/KevinKien/Webservice-API-IPInfo/blob/main/data/GeoIP2-ISP.mmdb\">https://github.com/KevinKien/Webservice-API-IPInfo/blob/main/data/GeoIP2-ISP.mmdb</a> （4 years ago的版本）</li>\n<li>小心翼翼给上传到docker映射目录的 .&#x2F;matomo&#x2F;misc下面，和GeoLite2-City.mmdb放在一起</li>\n</ul>\n</li>\n</ul>\n</li>\n</ul>\n<blockquote>\n<p>20231216 实践证明没有变化。下一步动作</p>\n<ol>\n<li><p>下载<a href=\"alecthw/mmdb_china_ip_list\">alecthw&#x2F;mmdb_china_ip_list</a>获得文件Country.mmdb</p>\n</li>\n<li><p>上传至&#x2F;compose&#x2F;matomo&#x2F;matomo&#x2F;misc，覆盖原先的GeoLite2-City.mmdb. </p>\n</li>\n<li><p>重启Docker，TODO 静观其变</p>\n<ol>\n<li>效果立竿见影，只有6.1M的Country.mmdb明显无法显示到精确city级别。</li>\n</ol>\n</li>\n<li><p>找到一个<a href=\"https://github.com/P3TERX/GeoLite.mmdb/releases/tag/2023.12.16\">https://github.com/P3TERX/GeoLite.mmdb/releases/tag/2023.12.16</a></p>\n<ol>\n<li>下载得到三个文件：<ol>\n<li>GeoLite2-ASN.mmdb</li>\n<li>GeoLite2-Country.mmdb</li>\n<li>GeoLite2-City.mmdb</li>\n</ol>\n</li>\n<li>如果可以像<a href=\"https://ip.skk.moe/query%E9%82%A3%E6%A0%B7%E6%98%BE%E7%A4%BAISP/Orgnization%E9%82%A3%E8%AF%A5%E5%A4%9A%E5%A5%BD\">https://ip.skk.moe/query那样显示ISP/Orgnization那该多好</a></li>\n</ol>\n</li>\n</ol>\n</blockquote>\n<h2 id=\"数据库查询\"><a href=\"#数据库查询\" class=\"headerlink\" title=\"数据库查询\"></a>数据库查询</h2><p>工具: [navicat16&#x2F;17 mac版无限重置试用期脚本](navicat16&#x2F;17 mac版无限重置试用期脚本)<br>    navicat, 或者 <a href=\"https://dbeaver.io/\">dbeaver</a></p>\n<p>故障: 由于当前docker中的mariadb没有映射出端口+没有设置root密码; 导致无法连接.</p>\n<p>解决办法: 修改docker-compose文件, 添加ports:  -3308:3306</p>\n<p><img data-src=\"https://img.carlzeng.top:3/i/2024/07/17/6697ce3243bfb.png\"></p>\n<h3 id=\"查询特定页面所有的具体访问\"><a href=\"#查询特定页面所有的具体访问\" class=\"headerlink\" title=\"查询特定页面所有的具体访问\"></a>查询特定页面所有的具体访问</h3><p>应用场景: 想要查看某个特定页面的所有访问</p>\n<figure class=\"highlight sql\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">select</span> <span class=\"operator\">*</span> <span class=\"keyword\">FROM</span> matomo_log_visit </span><br><span class=\"line\"><span class=\"keyword\">where</span> visit_entry_idaction_url <span class=\"keyword\">in</span> (</span><br><span class=\"line\"><span class=\"keyword\">select</span> idaction  <span class=\"keyword\">FROM</span> matomo_log_action <span class=\"keyword\">WHERE</span> name <span class=\"keyword\">like</span> <span class=\"string\">&#x27;%202304131736%&#x27;</span></span><br><span class=\"line\">)</span><br><span class=\"line\"><span class=\"keyword\">ORDER</span> <span class=\"keyword\">BY</span> visit_last_action_time <span class=\"keyword\">DESC</span></span><br></pre></td></tr></table></figure>\n\n<p>替换’%202304131736%’为具体的URL地址(节选关键字即可)</p>\n<p>字段说明: <a href=\"http://www.matomo.net.cn/matomo-piwik-database-schema-pdf/\">http://www.matomo.net.cn/matomo-piwik-database-schema-pdf/</a></p>\n<h3 id=\"查询用户的所有历史访问\"><a href=\"#查询用户的所有历史访问\" class=\"headerlink\" title=\"查询用户的所有历史访问\"></a>查询用户的所有历史访问</h3><p>应用场景: 锁定特定的visitor, 如何查询到他相关的关注的页面? 比如他的浏览器客户端信息等</p>\n<p>Matomo数据库中location_ip与idvisitor如何转化成明文</p>\n<figure class=\"highlight sql\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">SELECT</span> inet_ntoa(conv(hex(location_ip), <span class=\"number\">16</span>, <span class=\"number\">10</span>)) <span class=\"keyword\">as</span> ip, conv(hex(idvisitor), <span class=\"number\">16</span>, <span class=\"number\">10</span>) <span class=\"keyword\">as</span> visitorId <span class=\"keyword\">FROM</span> matomo_log_visit;</span><br></pre></td></tr></table></figure>\n\n\n\n\n\n<p>引入Matomo Tag Manager, 测试中…</p>\n<figure class=\"highlight html\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">&lt;!-- Matomo Tag Manager --&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">script</span>&gt;</span><span class=\"language-javascript\"></span></span><br><span class=\"line\"><span class=\"language-javascript\">      <span class=\"keyword\">var</span> _mtm = <span class=\"variable language_\">window</span>.<span class=\"property\">_mtm</span> = <span class=\"variable language_\">window</span>.<span class=\"property\">_mtm</span> || [];</span></span><br><span class=\"line\"><span class=\"language-javascript\">      _mtm.<span class=\"title function_\">push</span>(&#123;<span class=\"string\">&#x27;mtm.startTime&#x27;</span>: (<span class=\"keyword\">new</span> <span class=\"title class_\">Date</span>().<span class=\"title function_\">getTime</span>()), <span class=\"string\">&#x27;event&#x27;</span>: <span class=\"string\">&#x27;mtm.Start&#x27;</span>&#125;);</span></span><br><span class=\"line\"><span class=\"language-javascript\">      (<span class=\"keyword\">function</span>(<span class=\"params\"></span>) &#123;</span></span><br><span class=\"line\"><span class=\"language-javascript\">        <span class=\"keyword\">var</span> d=<span class=\"variable language_\">document</span>, g=d.<span class=\"title function_\">createElement</span>(<span class=\"string\">&#x27;script&#x27;</span>), s=d.<span class=\"title function_\">getElementsByTagName</span>(<span class=\"string\">&#x27;script&#x27;</span>)[<span class=\"number\">0</span>];</span></span><br><span class=\"line\"><span class=\"language-javascript\">        g.<span class=\"property\">async</span>=<span class=\"literal\">true</span>; g.<span class=\"property\">src</span>=<span class=\"string\">&#x27;//statcounter.carlzeng.top:4443/js/container_v1cUcIiP.js&#x27;</span>; s.<span class=\"property\">parentNode</span>.<span class=\"title function_\">insertBefore</span>(g,s);</span></span><br><span class=\"line\"><span class=\"language-javascript\">      &#125;)();</span></span><br><span class=\"line\"><span class=\"language-javascript\">    </span><span class=\"tag\">&lt;/<span class=\"name\">script</span>&gt;</span></span><br><span class=\"line\">    <span class=\"comment\">&lt;!-- End Matomo Tag Manager --&gt;</span></span><br></pre></td></tr></table></figure>\n\n\n\n\n\n<h1 id=\"灵感来源\"><a href=\"#灵感来源\" class=\"headerlink\" title=\"灵感来源\"></a>灵感来源</h1><p><a href=\"https://mariushosting.com/how-to-install-matomo-on-your-synology-nas/\">How to Install Matomo on Your Synology NAS</a></p>\n<p>Matomo will always cost you nothing to use, but that doesn’t mean it costs us nothing to make.<br>Matomo needs your continued support to grow and thrive.</p>\n<p><a href=\"https://i12bretro.wordpress.com/2023/09/18/run-matomo-google-analytics-alternative-in-docker/\">Run Matomo – Google Analytics Alternative – in Docker</a></p>\n<p><a href=\"https://qing.su/article/164.html\">可能是世界上最牛逼的网站统计程序——Matomo</a></p>\n","more":"<h1 id=\"有什么用\"><a href=\"#有什么用\" class=\"headerlink\" title=\"有什么用\"></a>有什么用</h1><p>一款非常好用的网站统计程序，Matomo.  Matomo的前身是著名的Piwik.  作为一款免费开源的统计程序，它不仅能够对每一条访问提供准确及时的访问记录，还能够自动生成极其专业的统计报表，包括根据地理位置生成的全球访问热点地图，实时访问图景，每一条访问的每一个点击操作详细分析，页面跳转率，来路分析，访客浏览器，访客硬件设备，关键词，等等等等……您还可以使用API，将统计功能整合在客户端、小程序等场景。虽然功能非常丰富，但是Mamoto非常轻量，几乎不需要占用什么资源。</p>\n<h1 id=\"实现方法\"><a href=\"#实现方法\" class=\"headerlink\" title=\"实现方法\"></a>实现方法</h1><p>分享可用的docker-compose.yml文件内容如下：</p>\n<p>cd &#x2F;www&#x2F;server&#x2F;panel&#x2F;data&#x2F;compose&#x2F;matomo</p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">version:</span> <span class=\"string\">&#x27;3.9&#x27;</span></span><br><span class=\"line\"><span class=\"attr\">services:</span></span><br><span class=\"line\">  <span class=\"attr\">mariadb:</span></span><br><span class=\"line\">    <span class=\"attr\">container_name:</span> <span class=\"string\">Matomo-DB</span></span><br><span class=\"line\">    <span class=\"attr\">image:</span> <span class=\"string\">mariadb:jammy</span></span><br><span class=\"line\">    <span class=\"attr\">command:</span> <span class=\"string\">--max_allowed_packet=1073741824</span></span><br><span class=\"line\">    <span class=\"attr\">restart:</span> <span class=\"string\">always</span></span><br><span class=\"line\">    <span class=\"comment\">#restart: on-failure:3</span></span><br><span class=\"line\">    <span class=\"attr\">volumes:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">./matomodb:/var/lib/mysql</span></span><br><span class=\"line\">    <span class=\"attr\">environment:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">MYSQL_ALLOW_EMPTY_PASSWORD=yes</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">MYSQL_DATABASE=matomodb</span></span><br><span class=\"line\">  <span class=\"attr\">matomo:</span></span><br><span class=\"line\">    <span class=\"attr\">container_name:</span> <span class=\"string\">Matomo</span></span><br><span class=\"line\">    <span class=\"attr\">environment:</span></span><br><span class=\"line\">      <span class=\"comment\">#- PUID=1026</span></span><br><span class=\"line\">      <span class=\"comment\">#- PGID=100</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">TZ=Asia/Shanghai</span></span><br><span class=\"line\">    <span class=\"attr\">ports:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"number\">8597</span><span class=\"string\">:80</span></span><br><span class=\"line\">    <span class=\"attr\">depends_on:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">mariadb</span></span><br><span class=\"line\">    <span class=\"attr\">volumes:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">./matomo:/var/www/html:rw</span></span><br><span class=\"line\">    <span class=\"attr\">image:</span> <span class=\"string\">matomo</span></span><br><span class=\"line\">    <span class=\"attr\">restart:</span> <span class=\"string\">always</span></span><br></pre></td></tr></table></figure>\n\n\n\n\n\n\n<figure class=\"highlight ini\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\">&lt;!-- Matomo --&gt;</span><br><span class=\"line\">&lt;script&gt;</span><br><span class=\"line\">  var <span class=\"attr\">_paq</span> = window._paq = window._paq || []<span class=\"comment\">;</span></span><br><span class=\"line\">  /* tracker methods like &quot;setCustomDimension&quot; should be called before &quot;trackPageView&quot; */</span><br><span class=\"line\">  _paq.push(<span class=\"section\">[&quot;setDocumentTitle&quot;, document.domain + &quot;/&quot; + document.title]</span>)<span class=\"comment\">;</span></span><br><span class=\"line\">  _paq.push(<span class=\"section\">[&quot;setCookieDomain&quot;, &quot;*.carlzeng.top&quot;]</span>)<span class=\"comment\">;</span></span><br><span class=\"line\">  _paq.push(<span class=\"section\">[&#x27;trackPageView&#x27;]</span>)<span class=\"comment\">;</span></span><br><span class=\"line\">  _paq.push(<span class=\"section\">[&#x27;enableLinkTracking&#x27;]</span>)<span class=\"comment\">;</span></span><br><span class=\"line\">  (function() &#123;</span><br><span class=\"line\">    var <span class=\"attr\">u</span>=<span class=\"string\">&quot;//192.168.6.116:8597/&quot;</span><span class=\"comment\">;</span></span><br><span class=\"line\">    _paq.push(<span class=\"section\">[&#x27;setTrackerUrl&#x27;, u+&#x27;matomo.php&#x27;]</span>)<span class=\"comment\">;</span></span><br><span class=\"line\">    _paq.push(<span class=\"section\">[&#x27;setSiteId&#x27;, &#x27;1&#x27;]</span>)<span class=\"comment\">;</span></span><br><span class=\"line\">    var <span class=\"attr\">d</span>=document, g=d.createElement(<span class=\"string\">&#x27;script&#x27;</span>), s=d.getElementsByTagName(<span class=\"string\">&#x27;script&#x27;</span>)[<span class=\"number\">0</span>]<span class=\"comment\">;</span></span><br><span class=\"line\">    <span class=\"attr\">g.async</span>=<span class=\"literal\">true</span><span class=\"comment\">; g.src=u+&#x27;matomo.js&#x27;; s.parentNode.insertBefore(g,s);</span></span><br><span class=\"line\">  &#125;)()<span class=\"comment\">;</span></span><br><span class=\"line\">&lt;/script&gt;</span><br><span class=\"line\">&lt;noscript&gt;&lt;p&gt;&lt;img <span class=\"attr\">src</span>=<span class=\"string\">&quot;//192.168.6.116:8597/matomo.php?idsite=1&amp;amp;rec=1&quot;</span> style=<span class=\"string\">&quot;border:0;&quot;</span> alt=<span class=\"string\">&quot;&quot;</span> /&gt;&lt;/p&gt;&lt;/noscript&gt;</span><br><span class=\"line\">&lt;!-- End Matomo Code --&gt;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n\n<p>docker-compose up</p>\n<ol>\n<li>Database Server: type in <strong>mariadb</strong></li>\n<li>Login: type in <strong>root</strong></li>\n<li>Password: leave blank</li>\n<li>Database Name: type in <strong>matomodb</strong></li>\n</ol>\n<p>Tracking code for Carl Notes</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;!-- Matomo --&gt;</span><br><span class=\"line\">&lt;script&gt;</span><br><span class=\"line\">  var _paq = window._paq = window._paq || [];</span><br><span class=\"line\">  /* tracker methods like &quot;setCustomDimension&quot; should be called before &quot;trackPageView&quot; */</span><br><span class=\"line\">  _paq.push([&#x27;trackPageView&#x27;]);</span><br><span class=\"line\">  _paq.push([&#x27;enableLinkTracking&#x27;]);</span><br><span class=\"line\">  (function() &#123;</span><br><span class=\"line\">    var u=&quot;//192.168.192.3/&quot;;</span><br><span class=\"line\">    _paq.push([&#x27;setTrackerUrl&#x27;, u+&#x27;matomo.php&#x27;]);</span><br><span class=\"line\">    _paq.push([&#x27;setSiteId&#x27;, &#x27;1&#x27;]);</span><br><span class=\"line\">    var d=document, g=d.createElement(&#x27;script&#x27;), s=d.getElementsByTagName(&#x27;script&#x27;)[0];</span><br><span class=\"line\">    g.async=true; g.src=u+&#x27;matomo.js&#x27;; s.parentNode.insertBefore(g,s);</span><br><span class=\"line\">  &#125;)();</span><br><span class=\"line\">&lt;/script&gt;</span><br><span class=\"line\">&lt;!-- End Matomo Code --&gt;</span><br></pre></td></tr></table></figure>\n\n\n\n<p>开启防火墙的8597</p>\n<p>NPM 新建<br><a href=\"https://statcounter.carlzeng.top:4443/\">https://statcounter.carlzeng.top:4443</a></p>\n<p><a href=\"https://statcounter.carlzeng.top:4443/?module=Login\">https://statcounter.carlzeng.top:4443/?module=Login</a><br>Error: The form security failed because of invalid origin. If you previously connected using HTTPS, please ensure you are connecting over a secure (SSL&#x2F;TLS) connection and try again.</p>\n<p>docker-compose down<br>docker-compose up</p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\">&lt;!-- <span class=\"title class_\">Matomo</span> --&gt;</span><br><span class=\"line\"><span class=\"language-xml\"><span class=\"tag\">&lt;<span class=\"name\">script</span>&gt;</span><span class=\"language-javascript\"></span></span></span><br><span class=\"line\"><span class=\"language-javascript\"><span class=\"language-xml\">  <span class=\"keyword\">var</span> _paq = <span class=\"variable language_\">window</span>.<span class=\"property\">_paq</span> = <span class=\"variable language_\">window</span>.<span class=\"property\">_paq</span> || [];</span></span></span><br><span class=\"line\"><span class=\"language-javascript\"><span class=\"language-xml\">  <span class=\"comment\">/* tracker methods like &quot;setCustomDimension&quot; should be called before &quot;trackPageView&quot; */</span></span></span></span><br><span class=\"line\"><span class=\"language-javascript\"><span class=\"language-xml\">  _paq.<span class=\"title function_\">push</span>([<span class=\"string\">&quot;setDocumentTitle&quot;</span>, <span class=\"variable language_\">document</span>.<span class=\"property\">domain</span> + <span class=\"string\">&quot;/&quot;</span> + <span class=\"variable language_\">document</span>.<span class=\"property\">title</span>]);</span></span></span><br><span class=\"line\"><span class=\"language-javascript\"><span class=\"language-xml\">  _paq.<span class=\"title function_\">push</span>([<span class=\"string\">&quot;setCookieDomain&quot;</span>, <span class=\"string\">&quot;*.carlzeng.top&quot;</span>]);</span></span></span><br><span class=\"line\"><span class=\"language-javascript\"><span class=\"language-xml\">  _paq.<span class=\"title function_\">push</span>([<span class=\"string\">&#x27;trackPageView&#x27;</span>]);</span></span></span><br><span class=\"line\"><span class=\"language-javascript\"><span class=\"language-xml\">  _paq.<span class=\"title function_\">push</span>([<span class=\"string\">&#x27;enableLinkTracking&#x27;</span>]);</span></span></span><br><span class=\"line\"><span class=\"language-javascript\"><span class=\"language-xml\">  (<span class=\"keyword\">function</span>(<span class=\"params\"></span>) &#123;</span></span></span><br><span class=\"line\"><span class=\"language-javascript\"><span class=\"language-xml\">    <span class=\"keyword\">var</span> u=<span class=\"string\">&quot;//statcounter.carlzeng.top:4443/&quot;</span>;</span></span></span><br><span class=\"line\"><span class=\"language-javascript\"><span class=\"language-xml\">    _paq.<span class=\"title function_\">push</span>([<span class=\"string\">&#x27;setTrackerUrl&#x27;</span>, u+<span class=\"string\">&#x27;matomo.php&#x27;</span>]);</span></span></span><br><span class=\"line\"><span class=\"language-javascript\"><span class=\"language-xml\">    _paq.<span class=\"title function_\">push</span>([<span class=\"string\">&#x27;setSiteId&#x27;</span>, <span class=\"string\">&#x27;1&#x27;</span>]);</span></span></span><br><span class=\"line\"><span class=\"language-javascript\"><span class=\"language-xml\">    <span class=\"keyword\">var</span> d=<span class=\"variable language_\">document</span>, g=d.<span class=\"title function_\">createElement</span>(<span class=\"string\">&#x27;script&#x27;</span>), s=d.<span class=\"title function_\">getElementsByTagName</span>(<span class=\"string\">&#x27;script&#x27;</span>)[<span class=\"number\">0</span>];</span></span></span><br><span class=\"line\"><span class=\"language-javascript\"><span class=\"language-xml\">    g.<span class=\"property\">async</span>=<span class=\"literal\">true</span>; g.<span class=\"property\">src</span>=u+<span class=\"string\">&#x27;matomo.js&#x27;</span>; s.<span class=\"property\">parentNode</span>.<span class=\"title function_\">insertBefore</span>(g,s);</span></span></span><br><span class=\"line\"><span class=\"language-javascript\"><span class=\"language-xml\">  &#125;)();</span></span></span><br><span class=\"line\"><span class=\"language-javascript\"><span class=\"language-xml\"></span><span class=\"tag\">&lt;/<span class=\"name\">script</span>&gt;</span></span></span><br><span class=\"line\"><span class=\"language-xml\"><span class=\"tag\">&lt;<span class=\"name\">noscript</span>&gt;</span><span class=\"tag\">&lt;<span class=\"name\">p</span>&gt;</span><span class=\"tag\">&lt;<span class=\"name\">img</span> <span class=\"attr\">src</span>=<span class=\"string\">&quot;//statcounter.carlzeng.top:4443/matomo.php?idsite=1<span class=\"symbol\">&amp;amp;</span>rec=1&quot;</span> <span class=\"attr\">style</span>=<span class=\"string\">&quot;border:0;&quot;</span> <span class=\"attr\">alt</span>=<span class=\"string\">&quot;&quot;</span> /&gt;</span><span class=\"tag\">&lt;/<span class=\"name\">p</span>&gt;</span><span class=\"tag\">&lt;/<span class=\"name\">noscript</span>&gt;</span></span></span><br><span class=\"line\">&lt;!-- <span class=\"title class_\">End</span> <span class=\"title class_\">Matomo</span> <span class=\"title class_\">Code</span> --&gt;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n\n\n<h2 id=\"设置\"><a href=\"#设置\" class=\"headerlink\" title=\"设置\"></a>设置</h2><h3 id=\"UI语言\"><a href=\"#UI语言\" class=\"headerlink\" title=\"UI语言\"></a>UI语言</h3><p>登录Matomo（之前叫Piwik）<br>点击右上角的齿轮小图标，进入设置界面<br>点击左菜单：Personal &#x3D;&#x3D;&gt; settings.<br>设置中文（Language表单项，如下图）</p>\n<h2 id=\"访客IP不正确，访客IP全部变成了代理IP\"><a href=\"#访客IP不正确，访客IP全部变成了代理IP\" class=\"headerlink\" title=\"访客IP不正确，访客IP全部变成了代理IP\"></a>访客IP不正确，访客IP全部变成了代理IP</h2><p>[General]<br>assume_secure_protocol &#x3D; 1</p>\n<p>参见 <a href=\"http://www.matomo.net.cn/2019/03/setup-matomo-in-proxy-env/\">http://www.matomo.net.cn/2019/03/setup-matomo-in-proxy-env/</a></p>\n<p>; Uncomment line below if you use a standard proxy<br>proxy_client_headers[] &#x3D; HTTP_X_FORWARDED_FOR<br>proxy_host_headers[] &#x3D; HTTP_X_FORWARDED_HOST</p>\n<h2 id=\"已解决-疑惑TODO\"><a href=\"#已解决-疑惑TODO\" class=\"headerlink\" title=\"[已解决]疑惑TODO\"></a>[已解决]疑惑TODO</h2><p>mamoto NPM failed to login：statcounter.carlzeng.top:4443</p>\n<p>Error: The form security failed because of invalid origin. If you previously connected using HTTPS, please ensure you are connecting over a secure (SSL&#x2F;TLS) connection and try again.</p>\n<p>[done]本地局域网访问假如在config.ini.php中开启下面这条配置，会导致无法登录<br>;assume_secure_protocol &#x3D; 1</p>\n<div class=\"note success\"><p>2023年12月初：解决办法：用<a href=\"https://c.carlzeng.top:3/web2\">在线云浏览器Firefox</a>，远程过去访问本地局域网的NPM面板即可</p>\n<p>Mamoto面板反代以后无法正常登录，也请使用<a href=\"https://c.carlzeng.top:3/web2\">在线云浏览器Firefox</a></p>\n<p>2024年1月中旬：彻底解决方案：配置和使用frpc的p2p模式，通过本地局域网运行frpc -c frpc.ini将Matomo的管理地址映射到frp服务上；控制端通过使用frpc -c frpc.ini P2P连接到受控端来远程访问Matomo Web页面</p>\n<p>详细解决思路和技术细节请参见：<a href=\"https://query.carlzeng.top:3/appsearch?q=frp%E5%86%85%E7%BD%91%E7%A9%BF%E9%80%8F\">Docker搭建FRP内网穿透服务</a></p>\n</div>\n\n<h2 id=\"如何添加到JS文件\"><a href=\"#如何添加到JS文件\" class=\"headerlink\" title=\"如何添加到JS文件\"></a>如何添加到JS文件</h2><p>截取部分的代码如下, 直接加入到JS的位置（”use strict”;的后面）</p>\n<p>比如app&#x2F;public&#x2F;server&#x2F;server.client.js</p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">var</span> _paq = <span class=\"variable language_\">window</span>.<span class=\"property\">_paq</span> = <span class=\"variable language_\">window</span>.<span class=\"property\">_paq</span> || [];</span><br><span class=\"line\">    <span class=\"comment\">/* tracker methods like &quot;setCustomDimension&quot; should be called before &quot;trackPageView&quot; */</span></span><br><span class=\"line\">    _paq.<span class=\"title function_\">push</span>([<span class=\"string\">&quot;setDocumentTitle&quot;</span>, <span class=\"variable language_\">document</span>.<span class=\"property\">domain</span> + <span class=\"string\">&quot;/&quot;</span> + <span class=\"variable language_\">document</span>.<span class=\"property\">title</span>]);</span><br><span class=\"line\">    _paq.<span class=\"title function_\">push</span>([<span class=\"string\">&quot;setCookieDomain&quot;</span>, <span class=\"string\">&quot;*.carlzeng.top&quot;</span>]);</span><br><span class=\"line\">    _paq.<span class=\"title function_\">push</span>([<span class=\"string\">&#x27;trackPageView&#x27;</span>]);</span><br><span class=\"line\">    _paq.<span class=\"title function_\">push</span>([<span class=\"string\">&#x27;enableLinkTracking&#x27;</span>]);</span><br><span class=\"line\">    (<span class=\"keyword\">function</span>(<span class=\"params\"></span>) &#123;</span><br><span class=\"line\">      <span class=\"keyword\">var</span> u=<span class=\"string\">&quot;//statcounter.carlzeng.top:4443/&quot;</span>;</span><br><span class=\"line\">      _paq.<span class=\"title function_\">push</span>([<span class=\"string\">&#x27;setTrackerUrl&#x27;</span>, u+<span class=\"string\">&#x27;matomo.php&#x27;</span>]);</span><br><span class=\"line\">      _paq.<span class=\"title function_\">push</span>([<span class=\"string\">&#x27;setSiteId&#x27;</span>, <span class=\"string\">&#x27;1&#x27;</span>]);</span><br><span class=\"line\">      <span class=\"keyword\">var</span> d=<span class=\"variable language_\">document</span>, g=d.<span class=\"title function_\">createElement</span>(<span class=\"string\">&#x27;script&#x27;</span>), s=d.<span class=\"title function_\">getElementsByTagName</span>(<span class=\"string\">&#x27;script&#x27;</span>)[<span class=\"number\">0</span>];</span><br><span class=\"line\">      g.<span class=\"property\">async</span>=<span class=\"literal\">true</span>; g.<span class=\"property\">src</span>=u+<span class=\"string\">&#x27;matomo.js&#x27;</span>; s.<span class=\"property\">parentNode</span>.<span class=\"title function_\">insertBefore</span>(g,s);</span><br><span class=\"line\">    &#125;)();</span><br></pre></td></tr></table></figure>\n\n\n\n<h1 id=\"高阶定制-配置\"><a href=\"#高阶定制-配置\" class=\"headerlink\" title=\"高阶定制&#x2F;配置\"></a>高阶定制&#x2F;配置</h1><ul>\n<li>【done】配置详细的IP地址库，可以像statcounter那样看到很详细的地址信息<br>– <a href=\"https://qing.su/article/164.html\">4, 配置IP地理位置数据库</a><br>– 方案二（暂时没必要），使用插件 <a href=\"https://www.afengblog.com/matomo-uses-ip2location-location-service.html\">Matomo 使用 IP 2 Location 数据库提升地域分析精度</a></li>\n<li>ISP数据库<ul>\n<li>文档<a href=\"https://dev.maxmind.com/geoip/docs/databases/isp\">GeoIP2 ISP Databases</a>中获得文件名：GeoIP2-ISP.mmdb<ul>\n<li>这只是一个<a href=\"https://github.com/maxmind/MaxMind-DB/blob/main/test-data/GeoIP2-ISP-Test.mmdb\">模版</a>（没有实际用处）</li>\n<li>google找了半天没有，终于在github找到一个，分享出来<a href=\"https://github.com/KevinKien/Webservice-API-IPInfo/blob/main/data/GeoIP2-ISP.mmdb\">https://github.com/KevinKien/Webservice-API-IPInfo/blob/main/data/GeoIP2-ISP.mmdb</a> （4 years ago的版本）</li>\n<li>小心翼翼给上传到docker映射目录的 .&#x2F;matomo&#x2F;misc下面，和GeoLite2-City.mmdb放在一起</li>\n</ul>\n</li>\n</ul>\n</li>\n</ul>\n<blockquote>\n<p>20231216 实践证明没有变化。下一步动作</p>\n<ol>\n<li><p>下载<a href=\"alecthw/mmdb_china_ip_list\">alecthw&#x2F;mmdb_china_ip_list</a>获得文件Country.mmdb</p>\n</li>\n<li><p>上传至&#x2F;compose&#x2F;matomo&#x2F;matomo&#x2F;misc，覆盖原先的GeoLite2-City.mmdb. </p>\n</li>\n<li><p>重启Docker，TODO 静观其变</p>\n<ol>\n<li>效果立竿见影，只有6.1M的Country.mmdb明显无法显示到精确city级别。</li>\n</ol>\n</li>\n<li><p>找到一个<a href=\"https://github.com/P3TERX/GeoLite.mmdb/releases/tag/2023.12.16\">https://github.com/P3TERX/GeoLite.mmdb/releases/tag/2023.12.16</a></p>\n<ol>\n<li>下载得到三个文件：<ol>\n<li>GeoLite2-ASN.mmdb</li>\n<li>GeoLite2-Country.mmdb</li>\n<li>GeoLite2-City.mmdb</li>\n</ol>\n</li>\n<li>如果可以像<a href=\"https://ip.skk.moe/query%E9%82%A3%E6%A0%B7%E6%98%BE%E7%A4%BAISP/Orgnization%E9%82%A3%E8%AF%A5%E5%A4%9A%E5%A5%BD\">https://ip.skk.moe/query那样显示ISP/Orgnization那该多好</a></li>\n</ol>\n</li>\n</ol>\n</blockquote>\n<h2 id=\"数据库查询\"><a href=\"#数据库查询\" class=\"headerlink\" title=\"数据库查询\"></a>数据库查询</h2><p>工具: [navicat16&#x2F;17 mac版无限重置试用期脚本](navicat16&#x2F;17 mac版无限重置试用期脚本)<br>    navicat, 或者 <a href=\"https://dbeaver.io/\">dbeaver</a></p>\n<p>故障: 由于当前docker中的mariadb没有映射出端口+没有设置root密码; 导致无法连接.</p>\n<p>解决办法: 修改docker-compose文件, 添加ports:  -3308:3306</p>\n<p><img data-src=\"https://img.carlzeng.top:3/i/2024/07/17/6697ce3243bfb.png\"></p>\n<h3 id=\"查询特定页面所有的具体访问\"><a href=\"#查询特定页面所有的具体访问\" class=\"headerlink\" title=\"查询特定页面所有的具体访问\"></a>查询特定页面所有的具体访问</h3><p>应用场景: 想要查看某个特定页面的所有访问</p>\n<figure class=\"highlight sql\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">select</span> <span class=\"operator\">*</span> <span class=\"keyword\">FROM</span> matomo_log_visit </span><br><span class=\"line\"><span class=\"keyword\">where</span> visit_entry_idaction_url <span class=\"keyword\">in</span> (</span><br><span class=\"line\"><span class=\"keyword\">select</span> idaction  <span class=\"keyword\">FROM</span> matomo_log_action <span class=\"keyword\">WHERE</span> name <span class=\"keyword\">like</span> <span class=\"string\">&#x27;%202304131736%&#x27;</span></span><br><span class=\"line\">)</span><br><span class=\"line\"><span class=\"keyword\">ORDER</span> <span class=\"keyword\">BY</span> visit_last_action_time <span class=\"keyword\">DESC</span></span><br></pre></td></tr></table></figure>\n\n<p>替换’%202304131736%’为具体的URL地址(节选关键字即可)</p>\n<p>字段说明: <a href=\"http://www.matomo.net.cn/matomo-piwik-database-schema-pdf/\">http://www.matomo.net.cn/matomo-piwik-database-schema-pdf/</a></p>\n<h3 id=\"查询用户的所有历史访问\"><a href=\"#查询用户的所有历史访问\" class=\"headerlink\" title=\"查询用户的所有历史访问\"></a>查询用户的所有历史访问</h3><p>应用场景: 锁定特定的visitor, 如何查询到他相关的关注的页面? 比如他的浏览器客户端信息等</p>\n<p>Matomo数据库中location_ip与idvisitor如何转化成明文</p>\n<figure class=\"highlight sql\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">SELECT</span> inet_ntoa(conv(hex(location_ip), <span class=\"number\">16</span>, <span class=\"number\">10</span>)) <span class=\"keyword\">as</span> ip, conv(hex(idvisitor), <span class=\"number\">16</span>, <span class=\"number\">10</span>) <span class=\"keyword\">as</span> visitorId <span class=\"keyword\">FROM</span> matomo_log_visit;</span><br></pre></td></tr></table></figure>\n\n\n\n\n\n<p>引入Matomo Tag Manager, 测试中…</p>\n<figure class=\"highlight html\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">&lt;!-- Matomo Tag Manager --&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">script</span>&gt;</span><span class=\"language-javascript\"></span></span><br><span class=\"line\"><span class=\"language-javascript\">      <span class=\"keyword\">var</span> _mtm = <span class=\"variable language_\">window</span>.<span class=\"property\">_mtm</span> = <span class=\"variable language_\">window</span>.<span class=\"property\">_mtm</span> || [];</span></span><br><span class=\"line\"><span class=\"language-javascript\">      _mtm.<span class=\"title function_\">push</span>(&#123;<span class=\"string\">&#x27;mtm.startTime&#x27;</span>: (<span class=\"keyword\">new</span> <span class=\"title class_\">Date</span>().<span class=\"title function_\">getTime</span>()), <span class=\"string\">&#x27;event&#x27;</span>: <span class=\"string\">&#x27;mtm.Start&#x27;</span>&#125;);</span></span><br><span class=\"line\"><span class=\"language-javascript\">      (<span class=\"keyword\">function</span>(<span class=\"params\"></span>) &#123;</span></span><br><span class=\"line\"><span class=\"language-javascript\">        <span class=\"keyword\">var</span> d=<span class=\"variable language_\">document</span>, g=d.<span class=\"title function_\">createElement</span>(<span class=\"string\">&#x27;script&#x27;</span>), s=d.<span class=\"title function_\">getElementsByTagName</span>(<span class=\"string\">&#x27;script&#x27;</span>)[<span class=\"number\">0</span>];</span></span><br><span class=\"line\"><span class=\"language-javascript\">        g.<span class=\"property\">async</span>=<span class=\"literal\">true</span>; g.<span class=\"property\">src</span>=<span class=\"string\">&#x27;//statcounter.carlzeng.top:4443/js/container_v1cUcIiP.js&#x27;</span>; s.<span class=\"property\">parentNode</span>.<span class=\"title function_\">insertBefore</span>(g,s);</span></span><br><span class=\"line\"><span class=\"language-javascript\">      &#125;)();</span></span><br><span class=\"line\"><span class=\"language-javascript\">    </span><span class=\"tag\">&lt;/<span class=\"name\">script</span>&gt;</span></span><br><span class=\"line\">    <span class=\"comment\">&lt;!-- End Matomo Tag Manager --&gt;</span></span><br></pre></td></tr></table></figure>\n\n\n\n\n\n<h1 id=\"灵感来源\"><a href=\"#灵感来源\" class=\"headerlink\" title=\"灵感来源\"></a>灵感来源</h1><p><a href=\"https://mariushosting.com/how-to-install-matomo-on-your-synology-nas/\">How to Install Matomo on Your Synology NAS</a></p>\n<p>Matomo will always cost you nothing to use, but that doesn’t mean it costs us nothing to make.<br>Matomo needs your continued support to grow and thrive.</p>\n<p><a href=\"https://i12bretro.wordpress.com/2023/09/18/run-matomo-google-analytics-alternative-in-docker/\">Run Matomo – Google Analytics Alternative – in Docker</a></p>\n<p><a href=\"https://qing.su/article/164.html\">可能是世界上最牛逼的网站统计程序——Matomo</a></p>","categories":[{"name":"Docker","path":"api/categories/Docker.json"}],"tags":[{"name":"Docker","path":"api/tags/Docker.json"},{"name":"Matomo","path":"api/tags/Matomo.json"},{"name":"统计","path":"api/tags/统计.json"},{"name":"分析","path":"api/tags/分析.json"}]}
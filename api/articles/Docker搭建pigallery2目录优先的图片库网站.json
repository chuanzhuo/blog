{"title":"Docker搭建pigallery2目录优先的图片库网站","slug":"Docker搭建pigallery2目录优先的图片库网站","date":"2025-04-16T08:59:57.000Z","updated":"2025-05-23T05:09:36.295Z","comments":true,"path":"api/articles/Docker搭建pigallery2目录优先的图片库网站.json","excerpt":" [Figure] 搭建pigallery2目录优先的图片库网站","covers":["https://img.carlzeng.com:3/i/2025/04/16/67ffb78336961.png","https://img.carlzeng.com:3/i/2025/04/19/6803ba1f6f707.png"],"content":"<img class=\"lozad\" data-src=\"https://img.carlzeng.com:3/i/2025/04/16/67ffb78336961.png\">\n\n<p>搭建pigallery2目录优先的图片库网站</p>\n<span id=\"more\"></span>\n\n<div> \n<button onclick=\"synthesizeSpeech()\">朗读全文</button>\n</div>\n<audio controls id=\"audioPlayer\">Your browser does not support the audio element.</audio>      \n<script>\n  function synthesizeSpeech() { \n    var inputText = document.getElementsByClassName('post-block')[0].innerText;\n    var voice = \"ZH\";\n    var url = 'https://tts.carlzeng.com:3/speech?text=' + encodeURIComponent(inputText.substring(0,3000)) + '&voice=' + voice;\n    var audioPlayer = document.getElementById('audioPlayer');          \n    audioPlayer.src = url;\n    audioPlayer.load();\n    audioPlayer.play();\n  }\n</script>\n\n\n<h1 id=\"有什么用\"><a href=\"#有什么用\" class=\"headerlink\" title=\"有什么用\"></a>有什么用</h1><p>搭建pigallery2目录优先的图片库网站</p>\n<p>然后使用rsync同步工具来 喂给pigallery2图片库网站, 这样实现全自动(定时任务)的图片文件备份 及 展示</p>\n<h1 id=\"怎么用\"><a href=\"#怎么用\" class=\"headerlink\" title=\"怎么用\"></a>怎么用</h1><p>章节中讲解了一步步的搭建过程 和 遇到的错误(已经解决步骤)</p>\n<h1 id=\"相关内容\"><a href=\"#相关内容\" class=\"headerlink\" title=\"相关内容\"></a>相关内容</h1><iframe style=\"box-shadow: 0px 0px 20px -10px;\" src=\"https://query.carlzeng.com:3/appsearch?q=pigallery2\" frameborder=\"0\" scrolling=\"auto\" width=\"100%\" height=\"500\"></iframe>\n\n<h1 id=\"实现方法\"><a href=\"#实现方法\" class=\"headerlink\" title=\"实现方法\"></a>实现方法</h1><h2 id=\"DS918部署pigallery2\"><a href=\"#DS918部署pigallery2\" class=\"headerlink\" title=\"DS918部署pigallery2\"></a>DS918部署pigallery2</h2><p>部署在DS918中, 执行如下命令, 预备动作: </p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">mkdir image &amp;&amp; mkdir tmp &amp;&amp; mkdir config</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">vi docker-compose.yml </span><br></pre></td></tr></table></figure>\n\n\n\n<p>docker-compose.yml</p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">version:</span> <span class=\"string\">&#x27;3&#x27;</span></span><br><span class=\"line\"><span class=\"attr\">services:</span></span><br><span class=\"line\">  <span class=\"attr\">nginx:</span></span><br><span class=\"line\">    <span class=\"attr\">image:</span> <span class=\"string\">nginx:latest</span></span><br><span class=\"line\">    <span class=\"attr\">container_name:</span> <span class=\"string\">nginx</span></span><br><span class=\"line\">    <span class=\"attr\">volumes:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">./nginx.conf:/etc/nginx/nginx.conf</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">./nginx/error.log:/etc/nginx/error_log.log</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">./nginx/cache/:/etc/nginx/cache</span></span><br><span class=\"line\"><span class=\"comment\">#      - /etc/letsencrypt/:/etc/letsencrypt/</span></span><br><span class=\"line\">    <span class=\"attr\">ports:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"number\">8083</span><span class=\"string\">:80</span></span><br><span class=\"line\"><span class=\"comment\">#      - 8084:443</span></span><br><span class=\"line\">    <span class=\"attr\">restart:</span> <span class=\"string\">always</span></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"attr\">pigallery2:</span></span><br><span class=\"line\">    <span class=\"attr\">image:</span> <span class=\"string\">bpatrik/pigallery2:latest</span></span><br><span class=\"line\">    <span class=\"attr\">container_name:</span> <span class=\"string\">pigallery2</span></span><br><span class=\"line\">    <span class=\"attr\">environment:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">NODE_ENV=production</span> <span class=\"comment\"># set to &#x27;debug&#x27; for full debug logging</span></span><br><span class=\"line\">      <span class=\"comment\"># - NODE_OPTIONS=--enable-source-maps # enable source map support on the backend for development</span></span><br><span class=\"line\">    <span class=\"attr\">volumes:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">&quot;./config:/app/data/config&quot;</span> <span class=\"comment\"># CHANGE ME</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">&quot;db-data:/app/data/db&quot;</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">&quot;./images:/app/data/images:ro&quot;</span> <span class=\"comment\"># CHANGE ME, &#x27;:ro&#x27; means read-only</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">&quot;./tmp:/app/data/tmp&quot;</span> <span class=\"comment\"># CHANGE ME</span></span><br><span class=\"line\">    <span class=\"attr\">expose:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">&quot;80&quot;</span></span><br><span class=\"line\">    <span class=\"attr\">restart:</span> <span class=\"string\">always</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attr\">volumes:</span></span><br><span class=\"line\">  <span class=\"attr\">db-data:</span></span><br></pre></td></tr></table></figure>\n\n\n\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">vi nginx.conf  </span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">events &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">http &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">\t##</span><br><span class=\"line\">\t# Basic Settings</span><br><span class=\"line\">\t##</span><br><span class=\"line\"></span><br><span class=\"line\">\tsendfile on;</span><br><span class=\"line\">\ttcp_nopush on;</span><br><span class=\"line\">\ttcp_nodelay on;</span><br><span class=\"line\">\tkeepalive_timeout 65;</span><br><span class=\"line\">\ttypes_hash_max_size 2048;</span><br><span class=\"line\"></span><br><span class=\"line\">\tinclude /etc/nginx/mime.types;</span><br><span class=\"line\">\tdefault_type application/octet-stream;</span><br><span class=\"line\"></span><br><span class=\"line\">\t##</span><br><span class=\"line\">\t# SSL Settings</span><br><span class=\"line\">\t##</span><br><span class=\"line\"></span><br><span class=\"line\">\tssl_protocols TLSv1 TLSv1.1 TLSv1.2 TLSv1.3; # Dropping SSLv3, ref: POODLE</span><br><span class=\"line\">\tssl_prefer_server_ciphers on;</span><br><span class=\"line\"></span><br><span class=\"line\">\t##</span><br><span class=\"line\">\t# Logging Settings</span><br><span class=\"line\">\t##</span><br><span class=\"line\"></span><br><span class=\"line\">\taccess_log /var/log/nginx/access.log;</span><br><span class=\"line\">\terror_log /var/log/nginx/error.log;</span><br><span class=\"line\"></span><br><span class=\"line\">\t##</span><br><span class=\"line\">\t# Gzip Settings</span><br><span class=\"line\">\t##</span><br><span class=\"line\"></span><br><span class=\"line\">\tgzip on;</span><br><span class=\"line\">\tgzip_proxied any;</span><br><span class=\"line\">\tgzip_comp_level 6;</span><br><span class=\"line\">\tgzip_types</span><br><span class=\"line\">\t\ttext/css</span><br><span class=\"line\">\t\ttext/plain</span><br><span class=\"line\">\t\ttext/javascript</span><br><span class=\"line\">\t\ttext/markdown</span><br><span class=\"line\">\t\tapplication/javascript</span><br><span class=\"line\">\t\tapplication/json</span><br><span class=\"line\">\t\tapplication/gpx+xml</span><br><span class=\"line\">\t\tapplication/x-javascript</span><br><span class=\"line\">\t\tapplication/xml</span><br><span class=\"line\">\t\tapplication/xml+rss</span><br><span class=\"line\">\t\tapplication/xhtml+xml</span><br><span class=\"line\">\t\tapplication/x-font-ttf</span><br><span class=\"line\">\t\tapplication/x-font-opentype</span><br><span class=\"line\">\t\tapplication/vnd.ms-fontobject</span><br><span class=\"line\">\t\timage/svg+xml</span><br><span class=\"line\">\t\timage/x-icon</span><br><span class=\"line\">\t\tapplication/rss+xml</span><br><span class=\"line\">\t\tapplication/atom_xml;</span><br><span class=\"line\">  gzip_disable &quot;MSIE [1-6]\\.(?!.*SV1)&quot;;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">\t##</span><br><span class=\"line\">\t# Virtual Host Configs</span><br><span class=\"line\">\t##</span><br><span class=\"line\"></span><br><span class=\"line\">   server &#123;</span><br><span class=\"line\">  \tlisten 8083 default_server;</span><br><span class=\"line\">  \tlisten [::]:8083 default_server;</span><br><span class=\"line\"></span><br><span class=\"line\">  \tserver_name case.carlzeng.com; # CHANGE ME</span><br><span class=\"line\">  \treturn 301 https://$server_name$request_uri;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  server &#123;</span><br><span class=\"line\">    server_name carlzeng.com;  # CHANGE ME</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">    # Only allow all methods (GET,POST,PUT,etc..) for root (/pgapi).</span><br><span class=\"line\">    # see https://github.com/bpatrik/pigallery2/issues/214</span><br><span class=\"line\">    location /pgapi &#123; # NOTE: no ending &#x27;/&#x27; as it would forward /pgapi to /</span><br><span class=\"line\">      proxy_pass http://pigallery2:80; # forwarding to the other container, named &#x27;pigallery2&#x27;</span><br><span class=\"line\">      proxy_http_version 1.1;</span><br><span class=\"line\">      proxy_set_header Upgrade $http_upgrade;</span><br><span class=\"line\">      proxy_set_header Connection &#x27;upgrade&#x27;;</span><br><span class=\"line\">      proxy_set_header Host $host;</span><br><span class=\"line\">      proxy_cache_bypass $http_upgrade;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    location / &#123;</span><br><span class=\"line\">      limit_except GET &#123;</span><br><span class=\"line\">        deny  all;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">      proxy_pass http://pigallery2:80; # forwarding to the other container, named &#x27;pigallery2&#x27;</span><br><span class=\"line\">      proxy_http_version 1.1;</span><br><span class=\"line\">      proxy_set_header Upgrade $http_upgrade;</span><br><span class=\"line\">      proxy_set_header Connection &#x27;upgrade&#x27;;</span><br><span class=\"line\">      proxy_set_header Host $host;</span><br><span class=\"line\">      proxy_cache_bypass $http_upgrade;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">#    listen 8084 ssl default_server;</span><br><span class=\"line\">#    listen [::]:8084 ssl default_server;</span><br><span class=\"line\"></span><br><span class=\"line\">#    ssl_certificate /etc/letsencrypt/live/yourdomain.com/fullchain.pem; # CHANGE ME</span><br><span class=\"line\">#    ssl_certificate_key /etc/letsencrypt/live/yourdomain.com/privkey.pem; # CHANGE ME</span><br><span class=\"line\">#    include /etc/letsencrypt/options-ssl-nginx.conf;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n\n\n<p>修改过配置文件, 去掉ssl相关的配置后, 可以访问测试网站</p>\n<p><a href=\"http://192.168.6.117:8083/gallery/\">http://192.168.6.117:8083/gallery/</a></p>\n<p>没有图片.</p>\n<p>实现: 如何映射Debian12中的图片目录到DS920中?</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\">源目录, DS918中的</span><br><span class=\"line\">/volume2/homes/13261977480/Photos/</span><br><span class=\"line\"></span><br><span class=\"line\">目标目录, Debian12中的:</span><br><span class=\"line\">/root/pigallery2/images</span><br></pre></td></tr></table></figure>\n\n\n\n<h2 id=\"Debian如何配置rsync手工同步\"><a href=\"#Debian如何配置rsync手工同步\" class=\"headerlink\" title=\"Debian如何配置rsync手工同步\"></a>Debian如何配置rsync手工同步</h2><h3 id=\"安装rsync\"><a href=\"#安装rsync\" class=\"headerlink\" title=\"安装rsync\"></a>安装rsync</h3><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">root@debian12:~/pigallery2# apt install -y rsync                                                  </span><br><span class=\"line\">Reading package lists... Done                                                                     </span><br><span class=\"line\">Building dependency tree... Done                                                                  </span><br><span class=\"line\">Reading state information... Done                                                                 </span><br><span class=\"line\">Suggested packages:                                                                               </span><br><span class=\"line\">  python3-braceexpand                                                                             </span><br><span class=\"line\">The following NEW packages will be installed:                                                     </span><br><span class=\"line\">  rsync                                                                                           </span><br><span class=\"line\">0 upgraded, 1 newly installed, 0 to remove and 37 not upgraded.                                   </span><br><span class=\"line\">Need to get 417 kB of archives.                                                                   </span><br><span class=\"line\">After this operation, 795 kB of additional disk space will be used.                               </span><br><span class=\"line\">Err:1 http://deb.debian.org/debian bookworm/main amd64 rsync amd64 3.2.7-1                        </span><br><span class=\"line\">  404  Not Found [IP: 151.101.90.132 80]                                                          </span><br><span class=\"line\">E: Failed to fetch http://deb.debian.org/debian/pool/main/r/rsync/rsync_3.2.7-1_amd64.deb  404  No</span><br><span class=\"line\">t Found [IP: 151.101.90.132 80]                                                                   </span><br><span class=\"line\">E: Unable to fetch some archives, maybe run apt-get update or try with --fix-missing? </span><br></pre></td></tr></table></figure>\n\n<p>错误解决办法:</p>\n<p>apt update</p>\n<p>apt install rsync</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">-v: 打印命令执行过程中的详细信息</span><br><span class=\"line\">-r: 递归拷贝数据（在传递文件的过程中不会保留权限信息以及时间戳）</span><br><span class=\"line\">-a: 归档模式，可以允许递归拷贝数据，并且保留链接符号，文件权限，用户和用户组的归属，时间戳</span><br><span class=\"line\">-z: 压缩数据</span><br><span class=\"line\">-h: 可读模式，输出可读的数字格式</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">rsync -avzh --progress root@192.168.6.203:/volume2/homes/13261977480/Photos /root/pigallery2/images</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">切换各种用户测试</span><br><span class=\"line\">rsync -avzh --progress DS918@192.168.6.203:/volume2/homes/132619</span><br><span class=\"line\">77480/Photos /root/pigallery2/images</span><br><span class=\"line\">DS918@192.168.6.203&#x27;s password: </span><br><span class=\"line\">Permission denied, please try again.</span><br><span class=\"line\">rsync: connection unexpectedly closed (0 bytes received so far) [Receiver]</span><br><span class=\"line\">rsync error: error in rsync protocol data stream (code 12) at io.c(232) [Receiver=3.2.7]</span><br></pre></td></tr></table></figure>\n\n<p>没办法 DS918的目录权限太绕了, 无法访问到想要的文件夹和文件; 只能让DS918来运行rsync了</p>\n<p>rsync -avzh –progress &#x2F;volume2&#x2F;homes&#x2F;13261977480&#x2F;Photos <a href=\"mailto:&#99;&#97;&#x72;&#x6c;&#x7a;&#x65;&#110;&#x67;&#64;&#49;&#57;&#x32;&#x2e;&#49;&#54;&#56;&#x2e;&#54;&#x2e;&#x31;&#49;&#55;\">&#99;&#97;&#x72;&#x6c;&#x7a;&#x65;&#110;&#x67;&#64;&#49;&#57;&#x32;&#x2e;&#49;&#54;&#56;&#x2e;&#54;&#x2e;&#x31;&#49;&#55;</a>:&#x2F;root&#x2F;pigallery2&#x2F;images</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">root@DS918:~# rsync -avzh --progress /volume2/homes/13261977480/Photos carlzeng***@192.168.6.117:/root/pigallery2/images                                                                               </span><br><span class=\"line\">The authenticity of host &#x27;192.168.6.117 (192.168.6.117)&#x27; can&#x27;t be established.                    </span><br><span class=\"line\">ECDSA key fingerprint is SHA256:2DtPJyL4F/scW7WqVrX7G4KimA8kokRW8DjCUV3MZp8.                      </span><br><span class=\"line\">Are you sure you want to continue connecting (yes/no/[fingerprint])? yes                          </span><br><span class=\"line\">Warning: Permanently added &#x27;192.168.6.117&#x27; (ECDSA) to the list of known hosts.                    </span><br><span class=\"line\">carlzeng@192.168.6.117&#x27;s password:                                                                </span><br><span class=\"line\">sending incremental file list                                                                     </span><br><span class=\"line\">rsync: [Receiver] ERROR: cannot stat destination &quot;/root/pigallery2/images&quot;: Permission denied (13)</span><br><span class=\"line\">rsync error: errors selecting input/output files, dirs (code 3) at main.c(772) [Receiver=3.2.7]</span><br></pre></td></tr></table></figure>\n\n<p>切换思路, 既然root用户无法登录ssh, 其他用户又无法访问到&#x2F;root目录下面的所有文件; </p>\n<p>那就把照片的目录换到最顶级, 让大家(所有ssh登录的用户)都可以访问的位置, 比如 &#x2F;</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">rsync -avzh --progress /volume2/homes/13261977480/Photos carlzeng***@192.168.6.117:/   </span><br><span class=\"line\">carlzeng***@192.168.6.117&#x27;s password:                                                                </span><br><span class=\"line\">sending incremental file list                                                                     </span><br><span class=\"line\">rsync: [generator] recv_generator: mkdir &quot;/Photos&quot; failed: Permission denied (13)                 </span><br><span class=\"line\">*** Skipping any contents from this failed directory ***                                          </span><br><span class=\"line\">Photos/                                                                                           </span><br><span class=\"line\">                                                                                                  </span><br><span class=\"line\">sent 2.38M bytes  received 13.90K bytes  368.38K bytes/sec                                        </span><br><span class=\"line\">total size is 8.45G  speedup is 3,528.67                                                          </span><br><span class=\"line\">rsync error: some files/attrs were not transferred (see previous errors) (code 23) at main.c(1462)</span><br><span class=\"line\"> [sender=3.1.2]                                </span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">正确的目录:  /home/carlzeng</span><br><span class=\"line\"></span><br><span class=\"line\">rsync -avzh --progress /volume2/homes/13261977480/Photos carlzeng***@192.168.6.117:/home/carlzeng</span><br><span class=\"line\"></span><br><span class=\"line\">......</span><br><span class=\"line\">sent 8.44G bytes  received 1.50M bytes  14.38M bytes/sec</span><br><span class=\"line\">total size is 8.45G  speedup is 1.00</span><br></pre></td></tr></table></figure>\n\n\n\n<p>对临时用户的访问, 在时间上做限制, 比如有效期1小时, </p>\n<p>1小时内可访问(有效); 或者 10分钟有效期</p>\n<h3 id=\"TODO-done-配置rsync-自动同步\"><a href=\"#TODO-done-配置rsync-自动同步\" class=\"headerlink\" title=\"TODO-done: 配置rsync 自动同步\"></a>TODO-done: 配置rsync 自动同步</h3><p>配置成服务, 这样系统定时自动同步(时间是一个纬度, 有没有其他的触发机制?)</p>\n<h3 id=\"定时同步\"><a href=\"#定时同步\" class=\"headerlink\" title=\"定时同步\"></a>定时同步</h3><p>编辑crontab</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">crontab -e</span><br></pre></td></tr></table></figure>\n\n<p>加入如下代码：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">10 0 * * * rsync -avzP --delete --password-file=/tmp/rsync.password zj@192.168.7.101::zjhome /cygdrive/d/Pic/</span><br></pre></td></tr></table></figure>\n\n<ol>\n<li><p>先在~目录下(执行rsync的目录, &#x2F;root )建个一个rsync_auth.txt的文件 用来存储密钥</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">***car**&gt;rsync_auth.txt</span><br></pre></td></tr></table></figure>\n\n\n</li>\n<li><p>编辑命令, 准备输入给crontab -e</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">rsync -avzh --password-file=/root/rsync_auth.txt /volume2/homes/13261977480/Photos carlzeng***@192.168.6.117:/home/carlzeng</span><br></pre></td></tr></table></figure></li>\n</ol>\n<p>The –password-file option may only be used when accessing an rsync daemon. rsync error: syntax or usage error (code 1) at main.c(1666) [sender&#x3D;3.1.2]</p>\n<p>解决办法:</p>\n<p>sshpass</p>\n<p>DS918无法安装sshpass</p>\n<p>切换方案到</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<ul>\n<li>cd to a private directory of the user which will be running the script (typically “$HOME&#x2F;.ssh”, to be created if needed). That directory must be protected to write acces from other users, fix the modes if needed.</li>\n<li>generate the keypair using command “ssh-keygen” (“&#x2F;usr&#x2F;syno&#x2F;bin&#x2F;ssh-keygen” if not in your PATH)</li>\n<li>at the prompt “Enter file in which to save the key”, choose a file name (let’s say “mykey”)</li>\n<li>at the prompt “Enter passphrase (empty for no passphrase):” press return (this will create a passwordless private key)</li>\n<li>Two files will be created: “mykey” and “mykey.pub”</li>\n<li>copy the contents of mykey.pub inside “$HOME&#x2F;.ssh&#x2F;authorized_keys” file of user account on the remote machine your script is going to connect to.</li>\n<li>in your script, add “-i<full_path of mykey.pub>“ as argument to the ssh command</li>\n</ul>\n<p>“ssh -i’&#x2F;root&#x2F;.ssh&#x2F;mykey’”</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">rsync -avzhe &quot;ssh -i&#x27;/tmp/mykey&#x27;&quot; &#x27;/volume2/homes/13261977480/Photos&#x27;  &#x27;carlzeng****@</span><br><span class=\"line\">192.168.6.117:/home/carlzeng***&#x27;                                                                     </span><br><span class=\"line\">carlzeng****@192.168.6.117&#x27;s password:</span><br><span class=\"line\"></span><br><span class=\"line\">还是失败了, 需要输入密码</span><br></pre></td></tr></table></figure>\n\n\n\n<p>最后还是这个方法配置成功了! </p>\n<p>authorized_keys</p>\n<h3 id=\"下一步-ignore-切换到-rsync服务\"><a href=\"#下一步-ignore-切换到-rsync服务\" class=\"headerlink\" title=\"下一步(ignore): 切换到 rsync服务\"></a>下一步(ignore): 切换到 rsync服务</h3><p>不用切换了, 找到原因了, 原来是文档中的笔误 $HOME&#x2F;.ssh&#x2F;<strong>authorized_keys</strong>, 必需是使用这个文件名“authorized_keys”</p>\n<p>测试调试的办法是: </p>\n<p>​\t直接在DS918的shell中使用ssh -i 命令 来测试. </p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ssh -i /tmp/mykey carlzeng***@192.168.6.117    </span><br></pre></td></tr></table></figure>\n\n<p>如果这条命令成功了, 就可以应用到rsync中去.</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">rsync -avzh -e &#x27;ssh -i /tmp/mykey&#x27; /volume2/homes/13261977480/Photos carlzeng***@192.16</span><br><span class=\"line\">8.6.117:/home/carlzeng</span><br></pre></td></tr></table></figure>\n\n\n\n\n\n<ol>\n<li><p>如果是群晖, 那直接使用系统的定时任务功能</p>\n<p><img data-src=\"https://img.carlzeng.com:3/i/2025/04/19/6803ba1f6f707.png\" alt=\"image-20250419225836532\"></p>\n</li>\n</ol>\n<p>到此就设置成功了, NAS中定时的自动同步(到另外一台服务器)的功能.</p>\n<h3 id=\"后期测试及改进-增强\"><a href=\"#后期测试及改进-增强\" class=\"headerlink\" title=\"后期测试及改进&#x2F;增强\"></a>后期测试及改进&#x2F;增强</h3><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">rsync -avzh -e &#x27;ssh -i ~/mykey&#x27; /volume2/homes/13261977480/Photos carlzeng***@192.16</span><br><span class=\"line\">8.6.117:/home/carlzeng</span><br></pre></td></tr></table></figure>\n\n<p>不要使用&#x2F;tmp&#x2F;mykey, 因为这个文件夹下的文件是临时的, 重启或什么操作之后就丢失了;</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">...</span><br><span class=\"line\">Photos/@eaDir/202505232034.jpg/</span><br><span class=\"line\">Photos/@eaDir/202505232034.jpg/SYNOINDEX_MEDIA_INFO</span><br><span class=\"line\">Photos/@eaDir/202505232034.jpg/SYNOPHOTO_THUMB_M.jpg</span><br><span class=\"line\">Photos/@eaDir/202505232034.jpg/SYNOPHOTO_THUMB_SM.jpg</span><br><span class=\"line\">Photos/@eaDir/202505232034.jpg/SYNOPHOTO_THUMB_XL.jpg</span><br><span class=\"line\">Photos/@eaDir/bgm2.mp3/</span><br><span class=\"line\">Photos/@eaDir/bgm2.mp3/SYNOINDEX_MEDIA_INFO</span><br><span class=\"line\">sent 1.65G bytes  received 483.20K bytes  13.37M bytes/sec                                        </span><br><span class=\"line\">total size is 10.75G  speedup is 6.51 </span><br></pre></td></tr></table></figure>\n\n\n\n<p><a href=\"https://www.rehiy.com/post/98/\">Ubuntu&#x2F;Debian 安装 rsync 服务</a></p>\n<h2 id=\"配置统计和分析\"><a href=\"#配置统计和分析\" class=\"headerlink\" title=\"配置统计和分析\"></a>配置统计和分析</h2><p>设置一下后台的HTML页头位置, 由于整个设置内容已经会自动被<script>标签包围, 所以去掉该标签, 放进设置内容即可.</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">var _paq = window._paq = window._paq || [];</span><br><span class=\"line\">  _paq.push([&quot;setDocumentTitle&quot;, document.domain + &quot;/&quot; + document.title]);</span><br><span class=\"line\">  _paq.push([&quot;setCookieDomain&quot;, &quot;*.carlzeng.com&quot;]);</span><br><span class=\"line\">  _paq.push([&#x27;trackPageView&#x27;]);</span><br><span class=\"line\">  _paq.push([&#x27;enableLinkTracking&#x27;]);</span><br><span class=\"line\">  (function() &#123;</span><br><span class=\"line\">    var u=&quot;//statcounter.carlzeng.com:4443/&quot;;</span><br><span class=\"line\">    _paq.push([&#x27;setTrackerUrl&#x27;, u+&#x27;matomo.php&#x27;]);</span><br><span class=\"line\">    _paq.push([&#x27;setSiteId&#x27;, &#x27;1&#x27;]);</span><br><span class=\"line\">    var d=document, g=d.createElement(&#x27;script&#x27;), s=d.getElementsByTagName(&#x27;script&#x27;)[0];</span><br><span class=\"line\">    g.async=true; g.src=u+&#x27;matomo.js&#x27;; s.parentNode.insertBefore(g,s);</span><br><span class=\"line\">  &#125;)();</span><br></pre></td></tr></table></figure>\n\n<p>查看后台, 跟踪统计正常</p>\n<h1 id=\"下一步\"><a href=\"#下一步\" class=\"headerlink\" title=\"下一步\"></a>下一步</h1><ol>\n<li>照片EXIF编辑器, 批量编辑照片的信息, 或者tag; 方便归类</li>\n</ol>\n<p>​\texiftool.org</p>\n<ol start=\"2\">\n<li><p>(思路切换, done)pigallery2 如何通过链接自动填写用户名密码? </p>\n<ol>\n<li>可以添加用户名和密码</li>\n<li>切换成: 使用临时分享的URL地址</li>\n</ol>\n</li>\n<li><p>如何修改pigallery2默认的语言? 如何修改默认用户的密码?</p>\n</li>\n</ol>\n<h1 id=\"灵感来源\"><a href=\"#灵感来源\" class=\"headerlink\" title=\"灵感来源\"></a>灵感来源</h1><p><a href=\"https://laosu.tech/2023/09/16/%E7%9B%AE%E5%BD%95%E4%BC%98%E5%85%88%E7%9A%84%E5%9B%BE%E7%89%87%E5%BA%93%E7%BD%91%E7%AB%99PiGallery2/?highlight=pigallery2\">目录优先的图片库网站PiGallery2</a></p>\n<p><a href=\"https://github.com/bpatrik/pigallery2/blob/master/docker/README.md\">PiGallery2 docker installation</a></p>\n","more":"<div> \n<button onclick=\"synthesizeSpeech()\">朗读全文</button>\n</div>\n<audio controls id=\"audioPlayer\">Your browser does not support the audio element.</audio>      \n<script>\n  function synthesizeSpeech() { \n    var inputText = document.getElementsByClassName('post-block')[0].innerText;\n    var voice = \"ZH\";\n    var url = 'https://tts.carlzeng.com:3/speech?text=' + encodeURIComponent(inputText.substring(0,3000)) + '&voice=' + voice;\n    var audioPlayer = document.getElementById('audioPlayer');          \n    audioPlayer.src = url;\n    audioPlayer.load();\n    audioPlayer.play();\n  }\n</script>\n\n\n<h1 id=\"有什么用\"><a href=\"#有什么用\" class=\"headerlink\" title=\"有什么用\"></a>有什么用</h1><p>搭建pigallery2目录优先的图片库网站</p>\n<p>然后使用rsync同步工具来 喂给pigallery2图片库网站, 这样实现全自动(定时任务)的图片文件备份 及 展示</p>\n<h1 id=\"怎么用\"><a href=\"#怎么用\" class=\"headerlink\" title=\"怎么用\"></a>怎么用</h1><p>章节中讲解了一步步的搭建过程 和 遇到的错误(已经解决步骤)</p>\n<h1 id=\"相关内容\"><a href=\"#相关内容\" class=\"headerlink\" title=\"相关内容\"></a>相关内容</h1><iframe style=\"box-shadow: 0px 0px 20px -10px;\" src=\"https://query.carlzeng.com:3/appsearch?q=pigallery2\" frameborder=\"0\" scrolling=\"auto\" width=\"100%\" height=\"500\"></iframe>\n\n<h1 id=\"实现方法\"><a href=\"#实现方法\" class=\"headerlink\" title=\"实现方法\"></a>实现方法</h1><h2 id=\"DS918部署pigallery2\"><a href=\"#DS918部署pigallery2\" class=\"headerlink\" title=\"DS918部署pigallery2\"></a>DS918部署pigallery2</h2><p>部署在DS918中, 执行如下命令, 预备动作: </p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">mkdir image &amp;&amp; mkdir tmp &amp;&amp; mkdir config</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">vi docker-compose.yml </span><br></pre></td></tr></table></figure>\n\n\n\n<p>docker-compose.yml</p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">version:</span> <span class=\"string\">&#x27;3&#x27;</span></span><br><span class=\"line\"><span class=\"attr\">services:</span></span><br><span class=\"line\">  <span class=\"attr\">nginx:</span></span><br><span class=\"line\">    <span class=\"attr\">image:</span> <span class=\"string\">nginx:latest</span></span><br><span class=\"line\">    <span class=\"attr\">container_name:</span> <span class=\"string\">nginx</span></span><br><span class=\"line\">    <span class=\"attr\">volumes:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">./nginx.conf:/etc/nginx/nginx.conf</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">./nginx/error.log:/etc/nginx/error_log.log</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">./nginx/cache/:/etc/nginx/cache</span></span><br><span class=\"line\"><span class=\"comment\">#      - /etc/letsencrypt/:/etc/letsencrypt/</span></span><br><span class=\"line\">    <span class=\"attr\">ports:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"number\">8083</span><span class=\"string\">:80</span></span><br><span class=\"line\"><span class=\"comment\">#      - 8084:443</span></span><br><span class=\"line\">    <span class=\"attr\">restart:</span> <span class=\"string\">always</span></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"attr\">pigallery2:</span></span><br><span class=\"line\">    <span class=\"attr\">image:</span> <span class=\"string\">bpatrik/pigallery2:latest</span></span><br><span class=\"line\">    <span class=\"attr\">container_name:</span> <span class=\"string\">pigallery2</span></span><br><span class=\"line\">    <span class=\"attr\">environment:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">NODE_ENV=production</span> <span class=\"comment\"># set to &#x27;debug&#x27; for full debug logging</span></span><br><span class=\"line\">      <span class=\"comment\"># - NODE_OPTIONS=--enable-source-maps # enable source map support on the backend for development</span></span><br><span class=\"line\">    <span class=\"attr\">volumes:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">&quot;./config:/app/data/config&quot;</span> <span class=\"comment\"># CHANGE ME</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">&quot;db-data:/app/data/db&quot;</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">&quot;./images:/app/data/images:ro&quot;</span> <span class=\"comment\"># CHANGE ME, &#x27;:ro&#x27; means read-only</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">&quot;./tmp:/app/data/tmp&quot;</span> <span class=\"comment\"># CHANGE ME</span></span><br><span class=\"line\">    <span class=\"attr\">expose:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">&quot;80&quot;</span></span><br><span class=\"line\">    <span class=\"attr\">restart:</span> <span class=\"string\">always</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attr\">volumes:</span></span><br><span class=\"line\">  <span class=\"attr\">db-data:</span></span><br></pre></td></tr></table></figure>\n\n\n\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">vi nginx.conf  </span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">events &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">http &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">\t##</span><br><span class=\"line\">\t# Basic Settings</span><br><span class=\"line\">\t##</span><br><span class=\"line\"></span><br><span class=\"line\">\tsendfile on;</span><br><span class=\"line\">\ttcp_nopush on;</span><br><span class=\"line\">\ttcp_nodelay on;</span><br><span class=\"line\">\tkeepalive_timeout 65;</span><br><span class=\"line\">\ttypes_hash_max_size 2048;</span><br><span class=\"line\"></span><br><span class=\"line\">\tinclude /etc/nginx/mime.types;</span><br><span class=\"line\">\tdefault_type application/octet-stream;</span><br><span class=\"line\"></span><br><span class=\"line\">\t##</span><br><span class=\"line\">\t# SSL Settings</span><br><span class=\"line\">\t##</span><br><span class=\"line\"></span><br><span class=\"line\">\tssl_protocols TLSv1 TLSv1.1 TLSv1.2 TLSv1.3; # Dropping SSLv3, ref: POODLE</span><br><span class=\"line\">\tssl_prefer_server_ciphers on;</span><br><span class=\"line\"></span><br><span class=\"line\">\t##</span><br><span class=\"line\">\t# Logging Settings</span><br><span class=\"line\">\t##</span><br><span class=\"line\"></span><br><span class=\"line\">\taccess_log /var/log/nginx/access.log;</span><br><span class=\"line\">\terror_log /var/log/nginx/error.log;</span><br><span class=\"line\"></span><br><span class=\"line\">\t##</span><br><span class=\"line\">\t# Gzip Settings</span><br><span class=\"line\">\t##</span><br><span class=\"line\"></span><br><span class=\"line\">\tgzip on;</span><br><span class=\"line\">\tgzip_proxied any;</span><br><span class=\"line\">\tgzip_comp_level 6;</span><br><span class=\"line\">\tgzip_types</span><br><span class=\"line\">\t\ttext/css</span><br><span class=\"line\">\t\ttext/plain</span><br><span class=\"line\">\t\ttext/javascript</span><br><span class=\"line\">\t\ttext/markdown</span><br><span class=\"line\">\t\tapplication/javascript</span><br><span class=\"line\">\t\tapplication/json</span><br><span class=\"line\">\t\tapplication/gpx+xml</span><br><span class=\"line\">\t\tapplication/x-javascript</span><br><span class=\"line\">\t\tapplication/xml</span><br><span class=\"line\">\t\tapplication/xml+rss</span><br><span class=\"line\">\t\tapplication/xhtml+xml</span><br><span class=\"line\">\t\tapplication/x-font-ttf</span><br><span class=\"line\">\t\tapplication/x-font-opentype</span><br><span class=\"line\">\t\tapplication/vnd.ms-fontobject</span><br><span class=\"line\">\t\timage/svg+xml</span><br><span class=\"line\">\t\timage/x-icon</span><br><span class=\"line\">\t\tapplication/rss+xml</span><br><span class=\"line\">\t\tapplication/atom_xml;</span><br><span class=\"line\">  gzip_disable &quot;MSIE [1-6]\\.(?!.*SV1)&quot;;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">\t##</span><br><span class=\"line\">\t# Virtual Host Configs</span><br><span class=\"line\">\t##</span><br><span class=\"line\"></span><br><span class=\"line\">   server &#123;</span><br><span class=\"line\">  \tlisten 8083 default_server;</span><br><span class=\"line\">  \tlisten [::]:8083 default_server;</span><br><span class=\"line\"></span><br><span class=\"line\">  \tserver_name case.carlzeng.com; # CHANGE ME</span><br><span class=\"line\">  \treturn 301 https://$server_name$request_uri;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  server &#123;</span><br><span class=\"line\">    server_name carlzeng.com;  # CHANGE ME</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">    # Only allow all methods (GET,POST,PUT,etc..) for root (/pgapi).</span><br><span class=\"line\">    # see https://github.com/bpatrik/pigallery2/issues/214</span><br><span class=\"line\">    location /pgapi &#123; # NOTE: no ending &#x27;/&#x27; as it would forward /pgapi to /</span><br><span class=\"line\">      proxy_pass http://pigallery2:80; # forwarding to the other container, named &#x27;pigallery2&#x27;</span><br><span class=\"line\">      proxy_http_version 1.1;</span><br><span class=\"line\">      proxy_set_header Upgrade $http_upgrade;</span><br><span class=\"line\">      proxy_set_header Connection &#x27;upgrade&#x27;;</span><br><span class=\"line\">      proxy_set_header Host $host;</span><br><span class=\"line\">      proxy_cache_bypass $http_upgrade;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    location / &#123;</span><br><span class=\"line\">      limit_except GET &#123;</span><br><span class=\"line\">        deny  all;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">      proxy_pass http://pigallery2:80; # forwarding to the other container, named &#x27;pigallery2&#x27;</span><br><span class=\"line\">      proxy_http_version 1.1;</span><br><span class=\"line\">      proxy_set_header Upgrade $http_upgrade;</span><br><span class=\"line\">      proxy_set_header Connection &#x27;upgrade&#x27;;</span><br><span class=\"line\">      proxy_set_header Host $host;</span><br><span class=\"line\">      proxy_cache_bypass $http_upgrade;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">#    listen 8084 ssl default_server;</span><br><span class=\"line\">#    listen [::]:8084 ssl default_server;</span><br><span class=\"line\"></span><br><span class=\"line\">#    ssl_certificate /etc/letsencrypt/live/yourdomain.com/fullchain.pem; # CHANGE ME</span><br><span class=\"line\">#    ssl_certificate_key /etc/letsencrypt/live/yourdomain.com/privkey.pem; # CHANGE ME</span><br><span class=\"line\">#    include /etc/letsencrypt/options-ssl-nginx.conf;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n\n\n<p>修改过配置文件, 去掉ssl相关的配置后, 可以访问测试网站</p>\n<p><a href=\"http://192.168.6.117:8083/gallery/\">http://192.168.6.117:8083/gallery/</a></p>\n<p>没有图片.</p>\n<p>实现: 如何映射Debian12中的图片目录到DS920中?</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\">源目录, DS918中的</span><br><span class=\"line\">/volume2/homes/13261977480/Photos/</span><br><span class=\"line\"></span><br><span class=\"line\">目标目录, Debian12中的:</span><br><span class=\"line\">/root/pigallery2/images</span><br></pre></td></tr></table></figure>\n\n\n\n<h2 id=\"Debian如何配置rsync手工同步\"><a href=\"#Debian如何配置rsync手工同步\" class=\"headerlink\" title=\"Debian如何配置rsync手工同步\"></a>Debian如何配置rsync手工同步</h2><h3 id=\"安装rsync\"><a href=\"#安装rsync\" class=\"headerlink\" title=\"安装rsync\"></a>安装rsync</h3><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">root@debian12:~/pigallery2# apt install -y rsync                                                  </span><br><span class=\"line\">Reading package lists... Done                                                                     </span><br><span class=\"line\">Building dependency tree... Done                                                                  </span><br><span class=\"line\">Reading state information... Done                                                                 </span><br><span class=\"line\">Suggested packages:                                                                               </span><br><span class=\"line\">  python3-braceexpand                                                                             </span><br><span class=\"line\">The following NEW packages will be installed:                                                     </span><br><span class=\"line\">  rsync                                                                                           </span><br><span class=\"line\">0 upgraded, 1 newly installed, 0 to remove and 37 not upgraded.                                   </span><br><span class=\"line\">Need to get 417 kB of archives.                                                                   </span><br><span class=\"line\">After this operation, 795 kB of additional disk space will be used.                               </span><br><span class=\"line\">Err:1 http://deb.debian.org/debian bookworm/main amd64 rsync amd64 3.2.7-1                        </span><br><span class=\"line\">  404  Not Found [IP: 151.101.90.132 80]                                                          </span><br><span class=\"line\">E: Failed to fetch http://deb.debian.org/debian/pool/main/r/rsync/rsync_3.2.7-1_amd64.deb  404  No</span><br><span class=\"line\">t Found [IP: 151.101.90.132 80]                                                                   </span><br><span class=\"line\">E: Unable to fetch some archives, maybe run apt-get update or try with --fix-missing? </span><br></pre></td></tr></table></figure>\n\n<p>错误解决办法:</p>\n<p>apt update</p>\n<p>apt install rsync</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">-v: 打印命令执行过程中的详细信息</span><br><span class=\"line\">-r: 递归拷贝数据（在传递文件的过程中不会保留权限信息以及时间戳）</span><br><span class=\"line\">-a: 归档模式，可以允许递归拷贝数据，并且保留链接符号，文件权限，用户和用户组的归属，时间戳</span><br><span class=\"line\">-z: 压缩数据</span><br><span class=\"line\">-h: 可读模式，输出可读的数字格式</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">rsync -avzh --progress root@192.168.6.203:/volume2/homes/13261977480/Photos /root/pigallery2/images</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">切换各种用户测试</span><br><span class=\"line\">rsync -avzh --progress DS918@192.168.6.203:/volume2/homes/132619</span><br><span class=\"line\">77480/Photos /root/pigallery2/images</span><br><span class=\"line\">DS918@192.168.6.203&#x27;s password: </span><br><span class=\"line\">Permission denied, please try again.</span><br><span class=\"line\">rsync: connection unexpectedly closed (0 bytes received so far) [Receiver]</span><br><span class=\"line\">rsync error: error in rsync protocol data stream (code 12) at io.c(232) [Receiver=3.2.7]</span><br></pre></td></tr></table></figure>\n\n<p>没办法 DS918的目录权限太绕了, 无法访问到想要的文件夹和文件; 只能让DS918来运行rsync了</p>\n<p>rsync -avzh –progress &#x2F;volume2&#x2F;homes&#x2F;13261977480&#x2F;Photos <a href=\"mailto:&#99;&#97;&#x72;&#x6c;&#x7a;&#x65;&#110;&#x67;&#64;&#49;&#57;&#x32;&#x2e;&#49;&#54;&#56;&#x2e;&#54;&#x2e;&#x31;&#49;&#55;\">&#99;&#97;&#x72;&#x6c;&#x7a;&#x65;&#110;&#x67;&#64;&#49;&#57;&#x32;&#x2e;&#49;&#54;&#56;&#x2e;&#54;&#x2e;&#x31;&#49;&#55;</a>:&#x2F;root&#x2F;pigallery2&#x2F;images</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">root@DS918:~# rsync -avzh --progress /volume2/homes/13261977480/Photos carlzeng***@192.168.6.117:/root/pigallery2/images                                                                               </span><br><span class=\"line\">The authenticity of host &#x27;192.168.6.117 (192.168.6.117)&#x27; can&#x27;t be established.                    </span><br><span class=\"line\">ECDSA key fingerprint is SHA256:2DtPJyL4F/scW7WqVrX7G4KimA8kokRW8DjCUV3MZp8.                      </span><br><span class=\"line\">Are you sure you want to continue connecting (yes/no/[fingerprint])? yes                          </span><br><span class=\"line\">Warning: Permanently added &#x27;192.168.6.117&#x27; (ECDSA) to the list of known hosts.                    </span><br><span class=\"line\">carlzeng@192.168.6.117&#x27;s password:                                                                </span><br><span class=\"line\">sending incremental file list                                                                     </span><br><span class=\"line\">rsync: [Receiver] ERROR: cannot stat destination &quot;/root/pigallery2/images&quot;: Permission denied (13)</span><br><span class=\"line\">rsync error: errors selecting input/output files, dirs (code 3) at main.c(772) [Receiver=3.2.7]</span><br></pre></td></tr></table></figure>\n\n<p>切换思路, 既然root用户无法登录ssh, 其他用户又无法访问到&#x2F;root目录下面的所有文件; </p>\n<p>那就把照片的目录换到最顶级, 让大家(所有ssh登录的用户)都可以访问的位置, 比如 &#x2F;</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">rsync -avzh --progress /volume2/homes/13261977480/Photos carlzeng***@192.168.6.117:/   </span><br><span class=\"line\">carlzeng***@192.168.6.117&#x27;s password:                                                                </span><br><span class=\"line\">sending incremental file list                                                                     </span><br><span class=\"line\">rsync: [generator] recv_generator: mkdir &quot;/Photos&quot; failed: Permission denied (13)                 </span><br><span class=\"line\">*** Skipping any contents from this failed directory ***                                          </span><br><span class=\"line\">Photos/                                                                                           </span><br><span class=\"line\">                                                                                                  </span><br><span class=\"line\">sent 2.38M bytes  received 13.90K bytes  368.38K bytes/sec                                        </span><br><span class=\"line\">total size is 8.45G  speedup is 3,528.67                                                          </span><br><span class=\"line\">rsync error: some files/attrs were not transferred (see previous errors) (code 23) at main.c(1462)</span><br><span class=\"line\"> [sender=3.1.2]                                </span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">正确的目录:  /home/carlzeng</span><br><span class=\"line\"></span><br><span class=\"line\">rsync -avzh --progress /volume2/homes/13261977480/Photos carlzeng***@192.168.6.117:/home/carlzeng</span><br><span class=\"line\"></span><br><span class=\"line\">......</span><br><span class=\"line\">sent 8.44G bytes  received 1.50M bytes  14.38M bytes/sec</span><br><span class=\"line\">total size is 8.45G  speedup is 1.00</span><br></pre></td></tr></table></figure>\n\n\n\n<p>对临时用户的访问, 在时间上做限制, 比如有效期1小时, </p>\n<p>1小时内可访问(有效); 或者 10分钟有效期</p>\n<h3 id=\"TODO-done-配置rsync-自动同步\"><a href=\"#TODO-done-配置rsync-自动同步\" class=\"headerlink\" title=\"TODO-done: 配置rsync 自动同步\"></a>TODO-done: 配置rsync 自动同步</h3><p>配置成服务, 这样系统定时自动同步(时间是一个纬度, 有没有其他的触发机制?)</p>\n<h3 id=\"定时同步\"><a href=\"#定时同步\" class=\"headerlink\" title=\"定时同步\"></a>定时同步</h3><p>编辑crontab</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">crontab -e</span><br></pre></td></tr></table></figure>\n\n<p>加入如下代码：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">10 0 * * * rsync -avzP --delete --password-file=/tmp/rsync.password zj@192.168.7.101::zjhome /cygdrive/d/Pic/</span><br></pre></td></tr></table></figure>\n\n<ol>\n<li><p>先在~目录下(执行rsync的目录, &#x2F;root )建个一个rsync_auth.txt的文件 用来存储密钥</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">***car**&gt;rsync_auth.txt</span><br></pre></td></tr></table></figure>\n\n\n</li>\n<li><p>编辑命令, 准备输入给crontab -e</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">rsync -avzh --password-file=/root/rsync_auth.txt /volume2/homes/13261977480/Photos carlzeng***@192.168.6.117:/home/carlzeng</span><br></pre></td></tr></table></figure></li>\n</ol>\n<p>The –password-file option may only be used when accessing an rsync daemon. rsync error: syntax or usage error (code 1) at main.c(1666) [sender&#x3D;3.1.2]</p>\n<p>解决办法:</p>\n<p>sshpass</p>\n<p>DS918无法安装sshpass</p>\n<p>切换方案到</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<ul>\n<li>cd to a private directory of the user which will be running the script (typically “$HOME&#x2F;.ssh”, to be created if needed). That directory must be protected to write acces from other users, fix the modes if needed.</li>\n<li>generate the keypair using command “ssh-keygen” (“&#x2F;usr&#x2F;syno&#x2F;bin&#x2F;ssh-keygen” if not in your PATH)</li>\n<li>at the prompt “Enter file in which to save the key”, choose a file name (let’s say “mykey”)</li>\n<li>at the prompt “Enter passphrase (empty for no passphrase):” press return (this will create a passwordless private key)</li>\n<li>Two files will be created: “mykey” and “mykey.pub”</li>\n<li>copy the contents of mykey.pub inside “$HOME&#x2F;.ssh&#x2F;authorized_keys” file of user account on the remote machine your script is going to connect to.</li>\n<li>in your script, add “-i<full_path of mykey.pub>“ as argument to the ssh command</li>\n</ul>\n<p>“ssh -i’&#x2F;root&#x2F;.ssh&#x2F;mykey’”</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">rsync -avzhe &quot;ssh -i&#x27;/tmp/mykey&#x27;&quot; &#x27;/volume2/homes/13261977480/Photos&#x27;  &#x27;carlzeng****@</span><br><span class=\"line\">192.168.6.117:/home/carlzeng***&#x27;                                                                     </span><br><span class=\"line\">carlzeng****@192.168.6.117&#x27;s password:</span><br><span class=\"line\"></span><br><span class=\"line\">还是失败了, 需要输入密码</span><br></pre></td></tr></table></figure>\n\n\n\n<p>最后还是这个方法配置成功了! </p>\n<p>authorized_keys</p>\n<h3 id=\"下一步-ignore-切换到-rsync服务\"><a href=\"#下一步-ignore-切换到-rsync服务\" class=\"headerlink\" title=\"下一步(ignore): 切换到 rsync服务\"></a>下一步(ignore): 切换到 rsync服务</h3><p>不用切换了, 找到原因了, 原来是文档中的笔误 $HOME&#x2F;.ssh&#x2F;<strong>authorized_keys</strong>, 必需是使用这个文件名“authorized_keys”</p>\n<p>测试调试的办法是: </p>\n<p>​\t直接在DS918的shell中使用ssh -i 命令 来测试. </p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ssh -i /tmp/mykey carlzeng***@192.168.6.117    </span><br></pre></td></tr></table></figure>\n\n<p>如果这条命令成功了, 就可以应用到rsync中去.</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">rsync -avzh -e &#x27;ssh -i /tmp/mykey&#x27; /volume2/homes/13261977480/Photos carlzeng***@192.16</span><br><span class=\"line\">8.6.117:/home/carlzeng</span><br></pre></td></tr></table></figure>\n\n\n\n\n\n<ol>\n<li><p>如果是群晖, 那直接使用系统的定时任务功能</p>\n<p><img data-src=\"https://img.carlzeng.com:3/i/2025/04/19/6803ba1f6f707.png\" alt=\"image-20250419225836532\"></p>\n</li>\n</ol>\n<p>到此就设置成功了, NAS中定时的自动同步(到另外一台服务器)的功能.</p>\n<h3 id=\"后期测试及改进-增强\"><a href=\"#后期测试及改进-增强\" class=\"headerlink\" title=\"后期测试及改进&#x2F;增强\"></a>后期测试及改进&#x2F;增强</h3><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">rsync -avzh -e &#x27;ssh -i ~/mykey&#x27; /volume2/homes/13261977480/Photos carlzeng***@192.16</span><br><span class=\"line\">8.6.117:/home/carlzeng</span><br></pre></td></tr></table></figure>\n\n<p>不要使用&#x2F;tmp&#x2F;mykey, 因为这个文件夹下的文件是临时的, 重启或什么操作之后就丢失了;</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">...</span><br><span class=\"line\">Photos/@eaDir/202505232034.jpg/</span><br><span class=\"line\">Photos/@eaDir/202505232034.jpg/SYNOINDEX_MEDIA_INFO</span><br><span class=\"line\">Photos/@eaDir/202505232034.jpg/SYNOPHOTO_THUMB_M.jpg</span><br><span class=\"line\">Photos/@eaDir/202505232034.jpg/SYNOPHOTO_THUMB_SM.jpg</span><br><span class=\"line\">Photos/@eaDir/202505232034.jpg/SYNOPHOTO_THUMB_XL.jpg</span><br><span class=\"line\">Photos/@eaDir/bgm2.mp3/</span><br><span class=\"line\">Photos/@eaDir/bgm2.mp3/SYNOINDEX_MEDIA_INFO</span><br><span class=\"line\">sent 1.65G bytes  received 483.20K bytes  13.37M bytes/sec                                        </span><br><span class=\"line\">total size is 10.75G  speedup is 6.51 </span><br></pre></td></tr></table></figure>\n\n\n\n<p><a href=\"https://www.rehiy.com/post/98/\">Ubuntu&#x2F;Debian 安装 rsync 服务</a></p>\n<h2 id=\"配置统计和分析\"><a href=\"#配置统计和分析\" class=\"headerlink\" title=\"配置统计和分析\"></a>配置统计和分析</h2><p>设置一下后台的HTML页头位置, 由于整个设置内容已经会自动被<script>标签包围, 所以去掉该标签, 放进设置内容即可.</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">var _paq = window._paq = window._paq || [];</span><br><span class=\"line\">  _paq.push([&quot;setDocumentTitle&quot;, document.domain + &quot;/&quot; + document.title]);</span><br><span class=\"line\">  _paq.push([&quot;setCookieDomain&quot;, &quot;*.carlzeng.com&quot;]);</span><br><span class=\"line\">  _paq.push([&#x27;trackPageView&#x27;]);</span><br><span class=\"line\">  _paq.push([&#x27;enableLinkTracking&#x27;]);</span><br><span class=\"line\">  (function() &#123;</span><br><span class=\"line\">    var u=&quot;//statcounter.carlzeng.com:4443/&quot;;</span><br><span class=\"line\">    _paq.push([&#x27;setTrackerUrl&#x27;, u+&#x27;matomo.php&#x27;]);</span><br><span class=\"line\">    _paq.push([&#x27;setSiteId&#x27;, &#x27;1&#x27;]);</span><br><span class=\"line\">    var d=document, g=d.createElement(&#x27;script&#x27;), s=d.getElementsByTagName(&#x27;script&#x27;)[0];</span><br><span class=\"line\">    g.async=true; g.src=u+&#x27;matomo.js&#x27;; s.parentNode.insertBefore(g,s);</span><br><span class=\"line\">  &#125;)();</span><br></pre></td></tr></table></figure>\n\n<p>查看后台, 跟踪统计正常</p>\n<h1 id=\"下一步\"><a href=\"#下一步\" class=\"headerlink\" title=\"下一步\"></a>下一步</h1><ol>\n<li>照片EXIF编辑器, 批量编辑照片的信息, 或者tag; 方便归类</li>\n</ol>\n<p>​\texiftool.org</p>\n<ol start=\"2\">\n<li><p>(思路切换, done)pigallery2 如何通过链接自动填写用户名密码? </p>\n<ol>\n<li>可以添加用户名和密码</li>\n<li>切换成: 使用临时分享的URL地址</li>\n</ol>\n</li>\n<li><p>如何修改pigallery2默认的语言? 如何修改默认用户的密码?</p>\n</li>\n</ol>\n<h1 id=\"灵感来源\"><a href=\"#灵感来源\" class=\"headerlink\" title=\"灵感来源\"></a>灵感来源</h1><p><a href=\"https://laosu.tech/2023/09/16/%E7%9B%AE%E5%BD%95%E4%BC%98%E5%85%88%E7%9A%84%E5%9B%BE%E7%89%87%E5%BA%93%E7%BD%91%E7%AB%99PiGallery2/?highlight=pigallery2\">目录优先的图片库网站PiGallery2</a></p>\n<p><a href=\"https://github.com/bpatrik/pigallery2/blob/master/docker/README.md\">PiGallery2 docker installation</a></p>","categories":[{"name":"pigallery2","path":"api/categories/pigallery2.json"}],"tags":[{"name":"docker","path":"api/tags/docker.json"},{"name":"pigallery2","path":"api/tags/pigallery2.json"}]}
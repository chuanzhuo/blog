{"title":"Docker自建Email服务器 - 私人邮件系统","slug":"Docker自建Email服务器-已购域名上私人邮件系统","date":"2024-03-01T03:30:00.000Z","updated":"2024-10-25T13:16:40.671Z","comments":true,"path":"api/articles/Docker自建Email服务器-已购域名上私人邮件系统.json","excerpt":" [Figure] 搭建Email服务，该方法适用于个人，公司或组织","covers":["https://img.carlzeng.com:3/i/2024/03/01/65e1492380515.png","https://img.carlzeng.com:3/i/2024/02/29/65dfda2b7efb5.png","https://img.carlzeng.com:3/i/2024/02/29/65e0282f016cc.png","https://img.carlzeng.com:3/i/2024/02/29/65e0289fe89be.png","https://img.carlzeng.com:3/i/2024/03/21/65fc214953f21.png","https://img.carlzeng.com:3/i/2024/03/22/65fccd6f7a5fc.png","https://img.carlzeng.com:3/i/2024/03/01/65e142d55ffd2.png","https://images.mxtoolbox.com/public/images/statusicons/problem.png","https://images.mxtoolbox.com/public/images/statusicons/info.png","https://images.mxtoolbox.com/public/images/statusicons/problem.png","https://images.mxtoolbox.com/public/images/statusicons/info.png","https://images.mxtoolbox.com/public/images/statusicons/problem.png","https://img.carlzeng.com:3/i/2024/02/29/65e089fcef838.png","https://img.carlzeng.com:3/i/2024/03/01/65e139600f9ea.png","https://img.carlzeng.com:3/i/2024/03/01/65e140a62c982.png","https://img.carlzeng.com:3/i/2024/03/28/6605735e21430.png","https://img.carlzeng.com:3/i/2024/04/23/66271bd148a22.png","https://img.carlzeng.com:3/i/2024/04/23/662722fde4c91.png","https://img.carlzeng.com:3/i/2024/04/23/662725ef860df.png"],"content":"<img class=\"lozad\" data-src=\"https://img.carlzeng.com:3/i/2024/03/01/65e1492380515.png\">\n\n<p>搭建Email服务，该方法适用于个人，公司或组织</p>\n<span id=\"more\"></span>\n\n<p>备注：这是我找到唯一简便安装且能正常使用的邮件系统，请留言告诉我你是否有更好的自建解决方案。</p>\n<p>踩了很多的坑，经历了一个月左右的时间，才测试收发邮件成功（部分邮箱目的地无法达到，由于互联网上的反垃圾邮件策略），持续更新完善中.</p>\n<p>2024年3月18日 新增章节：“维护定时任务”</p>\n<p>2024年3月22日 新增章节：“SMTP服务测试” 并修正spf的DNS设置内容；关注到另外一个备选方案：<a href=\"https://lala.im/8977.html\">Stalwart Mail Server（All-in-One 邮件服务器）</a></p>\n<p>下一步：朋友提出新需求：如何批量发送邮件？</p>\n<div> \n<button onclick=\"synthesizeSpeech()\">朗读全文</button>\n</div>\n<audio controls id=\"audioPlayer\">Your browser does not support the audio element.</audio>      \n<script>\n  function synthesizeSpeech() { \n    var inputText = document.getElementsByClassName('post-block')[0].innerText;\n    var voice = \"ZH\";\n    var url = 'https://tts.carlzeng.com:3/speech?text=' + encodeURIComponent(inputText.substring(0,3000)) + '&voice=' + voice;\n    var audioPlayer = document.getElementById('audioPlayer');          \n    audioPlayer.src = url;\n    audioPlayer.load();\n    audioPlayer.play();\n  }\n</script>\n\n\n<h1 id=\"怎么用\"><a href=\"#怎么用\" class=\"headerlink\" title=\"怎么用\"></a>怎么用</h1><ul>\n<li><p>日常收发邮件</p>\n<ul>\n<li>通过搭建邮件服务来收发你自己域名下的邮件</li>\n</ul>\n</li>\n<li><p>第三方平台（或自己搭建的服务）上需要设置的SMTP服务（SMTP邮箱设置）邮件通知&#x2F;告知</p>\n</li>\n</ul>\n<h1 id=\"相关内容\"><a href=\"#相关内容\" class=\"headerlink\" title=\"相关内容\"></a>相关内容</h1><iframe style=\"box-shadow: 0px 0px 20px -10px;\" src=\"https://query.carlzeng.com:3/appsearch?q=email\" frameborder=\"0\" scrolling=\"auto\" width=\"100%\" height=\"500\"></iframe>\n\n<h1 id=\"实现方法\"><a href=\"#实现方法\" class=\"headerlink\" title=\"实现方法\"></a>实现方法</h1><h2 id=\"iRedMail-Docker搭建\"><a href=\"#iRedMail-Docker搭建\" class=\"headerlink\" title=\"iRedMail Docker搭建\"></a>iRedMail Docker搭建</h2><p>iRedMail docker-compose.yml</p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">version:</span> <span class=\"string\">&#x27;3.9&#x27;</span></span><br><span class=\"line\"><span class=\"attr\">services:</span></span><br><span class=\"line\">        <span class=\"attr\">mariadb:</span></span><br><span class=\"line\">            <span class=\"attr\">image:</span> <span class=\"string\">&#x27;iredmail/mariadb:stable&#x27;</span></span><br><span class=\"line\">            <span class=\"attr\">volumes:</span></span><br><span class=\"line\">                <span class=\"bullet\">-</span> <span class=\"string\">&#x27;./postfix_queue:/var/spool/postfix&#x27;</span></span><br><span class=\"line\">                <span class=\"bullet\">-</span> <span class=\"string\">&#x27;./sa_rules:/var/lib/spamassassin&#x27;</span></span><br><span class=\"line\">                <span class=\"bullet\">-</span> <span class=\"string\">&#x27;./clamav:/var/lib/clamav&#x27;</span></span><br><span class=\"line\">                <span class=\"bullet\">-</span> <span class=\"string\">&#x27;./mysql:/var/lib/mysql&#x27;</span></span><br><span class=\"line\">                <span class=\"bullet\">-</span> <span class=\"string\">&#x27;./ssl:/opt/iredmail/ssl&#x27;</span></span><br><span class=\"line\">                <span class=\"bullet\">-</span> <span class=\"string\">&#x27;./custom:/opt/iredmail/custom&#x27;</span></span><br><span class=\"line\">                <span class=\"bullet\">-</span> <span class=\"string\">&#x27;./imapsieve_copy:/var/vmail/imapsieve_copy&#x27;</span></span><br><span class=\"line\">                <span class=\"bullet\">-</span> <span class=\"string\">&#x27;./mlmmj-archive:/var/vmail/mlmmj-archive&#x27;</span></span><br><span class=\"line\">                <span class=\"bullet\">-</span> <span class=\"string\">&#x27;./mlmmj:/var/vmail/mlmmj&#x27;</span></span><br><span class=\"line\">                <span class=\"bullet\">-</span> <span class=\"string\">&#x27;./mailboxes:/var/vmail/vmail1&#x27;</span></span><br><span class=\"line\">                <span class=\"bullet\">-</span> <span class=\"string\">&#x27;./backup-mysql:/var/vmail/backup/mysql&#x27;</span></span><br><span class=\"line\">                <span class=\"bullet\">-</span> <span class=\"string\">&quot;/etc/localtime:/etc/localtime:ro&quot;</span> <span class=\"comment\">#这条可纠正邮件系统的时区</span></span><br><span class=\"line\">            <span class=\"attr\">ports:</span></span><br><span class=\"line\">                <span class=\"bullet\">-</span> <span class=\"string\">&#x27;587:587&#x27;</span></span><br><span class=\"line\">                <span class=\"bullet\">-</span> <span class=\"string\">&#x27;465:465&#x27;</span></span><br><span class=\"line\">                <span class=\"bullet\">-</span> <span class=\"string\">&#x27;25:25&#x27;</span></span><br><span class=\"line\">                <span class=\"bullet\">-</span> <span class=\"string\">&#x27;993:993&#x27;</span></span><br><span class=\"line\">                <span class=\"bullet\">-</span> <span class=\"string\">&#x27;143:143&#x27;</span></span><br><span class=\"line\">                <span class=\"bullet\">-</span> <span class=\"string\">&#x27;995:995&#x27;</span></span><br><span class=\"line\">                <span class=\"bullet\">-</span> <span class=\"string\">&#x27;110:110&#x27;</span></span><br><span class=\"line\">                <span class=\"bullet\">-</span> <span class=\"string\">&#x27;4433:443&#x27;</span></span><br><span class=\"line\">                <span class=\"bullet\">-</span> <span class=\"string\">&#x27;8093:80&#x27;</span></span><br><span class=\"line\">            <span class=\"attr\">env_file:</span></span><br><span class=\"line\">                <span class=\"bullet\">-</span> <span class=\"string\">./iredmail-docker.conf</span></span><br><span class=\"line\">            <span class=\"attr\">container_name:</span> <span class=\"string\">iRedMail</span></span><br></pre></td></tr></table></figure>\n\n<p>Docker启动后，假如一切正常则调试信息类似于：</p>\n<p><img data-src=\"https://img.carlzeng.com:3/i/2024/02/29/65dfda2b7efb5.png\" alt=\"docker启动iRedMail成功后输出信息\"></p>\n<p>一切启动正常后，可以开始设置DNS记录，然后端口映射出防火墙。</p>\n<p>最后可用系统自带的WEB网页客户端来收发邮件，或使用Outlook等客户端配置SMTP，POP3来收发邮件</p>\n<h2 id=\"设置DNS\"><a href=\"#设置DNS\" class=\"headerlink\" title=\"设置DNS\"></a>设置DNS</h2><p>Your DNS MX record should point to this value</p>\n<p>设置DNS项范例：</p>\n<p><img data-src=\"https://img.carlzeng.com:3/i/2024/02/29/65e0282f016cc.png\" alt=\"image-20240229144603695\"></p>\n<p><img data-src=\"https://img.carlzeng.com:3/i/2024/02/29/65e0289fe89be.png\" alt=\"image-20240229144758944\"></p>\n<p>| DNS类型 | DNS记录名 | 内容&#x2F;值 | 说明&#x2F;备注 |</p>\n<table>\n<thead>\n<tr>\n<th>DNS类型</th>\n<th>DNS记录名</th>\n<th>内容&#x2F;值</th>\n<th>备注&#x2F;说明</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>MX</td>\n<td>carlzeng.com.</td>\n<td>mail.carlzeng.com.</td>\n<td>标识邮件服务器名称，DNS MX entry</td>\n</tr>\n<tr>\n<td>A</td>\n<td>mail.carlzeng.com.</td>\n<td>*.8.18.*</td>\n<td>邮件服务器的IP地址</td>\n</tr>\n<tr>\n<td>TXT</td>\n<td>carlzeng.com.</td>\n<td>v&#x3D;spf1 mx -all</td>\n<td>SPF entry&#x2F;记录</td>\n</tr>\n<tr>\n<td>TXT</td>\n<td>dkim._domainkey.carlzeng.com.</td>\n<td>v&#x3D;DKIM1; k&#x3D;rsm; p&#x3D;*</td>\n<td>DKIM entry&#x2F;记录，含DKIM公钥public key，详见下方如何在docker中用命令获取这个内容值</td>\n</tr>\n<tr>\n<td>TXT</td>\n<td>dmarc.carlzeng.com</td>\n<td>v&#x3D;DMARC1; p&#x3D; reject; rua&#x3D;*</td>\n<td>DMARC entry&#x2F;记录</td>\n</tr>\n</tbody></table>\n<p>问：三个TXT记录不知道怎么从iRedMail邮件系统中获取？</p>\n<p>答：After installation: <a href=\"https://docs.iredmail.org/setup.dns.html#mx\">Setup DNS records for your iRedMail server (A, PTR, MX, SPF, DKIM, DMARC)</a></p>\n<p>假如想要检测DNS记录的正确性，可以使用：<a href=\"https://mxtoolbox.com/\">https://mxtoolbox.com/</a></p>\n<h3 id=\"SPF-entry-记录\"><a href=\"#SPF-entry-记录\" class=\"headerlink\" title=\"SPF entry&#x2F;记录\"></a>SPF entry&#x2F;记录</h3><p>v&#x3D;spf1 mx a:mail.carlzeng.com -all</p>\n<blockquote>\n<p>根据SMTP测试报告，这条记录可能存在错误</p>\n</blockquote>\n<p><img data-src=\"https://img.carlzeng.com:3/i/2024/03/21/65fc214953f21.png\" alt=\"image-20240321195957875\"></p>\n<p>v&#x3D;spf1 a mx include:_spf.google.com ~all</p>\n<p>CF中编辑DNS记录后使用dig检测：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">% dig carlzeng.com txt</span><br><span class=\"line\"></span><br><span class=\"line\">; &lt;&lt;&gt;&gt; DiG 9.10.6 &lt;&lt;&gt;&gt; carlzeng.com txt</span><br><span class=\"line\">;; global options: +cmd</span><br><span class=\"line\">;; Got answer:</span><br><span class=\"line\">;; -&gt;&gt;HEADER&lt;&lt;- opcode: QUERY, status: NOERROR, id: 49494</span><br><span class=\"line\">;; flags: qr rd ra; QUERY: 1, ANSWER: 3, AUTHORITY: 2, ADDITIONAL: 7</span><br><span class=\"line\"></span><br><span class=\"line\">;; OPT PSEUDOSECTION:</span><br><span class=\"line\">; EDNS: version: 0, flags:; udp: 1024</span><br><span class=\"line\">;; QUESTION SECTION:</span><br><span class=\"line\">;carlzeng.com.                  IN      TXT</span><br><span class=\"line\"></span><br><span class=\"line\">;; ANSWER SECTION:</span><br><span class=\"line\">carlzeng.com.           2099    IN      TXT     &quot;google-site-verification=709aI8iBja5qWYVP85LxviHsfbHWjpuJZmBOqENAXBM&quot;</span><br><span class=\"line\">carlzeng.com.           2099    IN      TXT     &quot;v=spf1 mx a:mail.carlzeng.com -all&quot;</span><br><span class=\"line\">carlzeng.com.           2099    IN      TXT     &quot;google-site-verification=CLgNXe3i4ZobXoFz9U4gy6OzMAa8gNmXImQbNmTiNPY&quot;</span><br><span class=\"line\"></span><br><span class=\"line\">;; AUTHORITY SECTION:</span><br><span class=\"line\">carlzeng.com.           0       IN      NS      amir.ns.cloudflare.com.</span><br><span class=\"line\">carlzeng.com.           0       IN      NS      paityn.ns.cloudflare.com.</span><br><span class=\"line\"></span><br><span class=\"line\">;; ADDITIONAL SECTION:</span><br><span class=\"line\">amir.ns.cloudflare.com. 20184   IN      A       108.162.193.62</span><br><span class=\"line\">amir.ns.cloudflare.com. 20184   IN      A       172.64.33.62</span><br><span class=\"line\">amir.ns.cloudflare.com. 20184   IN      A       173.245.59.62</span><br><span class=\"line\">paityn.ns.cloudflare.com. 59423 IN      A       108.162.194.18</span><br><span class=\"line\">paityn.ns.cloudflare.com. 59423 IN      A       172.64.34.18</span><br><span class=\"line\">paityn.ns.cloudflare.com. 59423 IN      A       162.159.38.18</span><br><span class=\"line\"></span><br><span class=\"line\">;; Query time: 5 msec</span><br><span class=\"line\">;; SERVER: 223.5.5.5#53(223.5.5.5)</span><br><span class=\"line\">;; WHEN: Thu Mar 21 20:18:20 CST 2024</span><br><span class=\"line\">;; MSG SIZE  rcvd: 403</span><br></pre></td></tr></table></figure>\n\n<p>大约半小时时间，修改过后的spf记录仍然没有得到更新，持续关注中….</p>\n<p>纠正了这条spf相关的DNS记录以后，测试SMTP；显示成功：</p>\n<p><img data-src=\"https://img.carlzeng.com:3/i/2024/03/22/65fccd6f7a5fc.png\" alt=\"image-20240322081436077\"></p>\n<h3 id=\"DKIM-entry-记录\"><a href=\"#DKIM-entry-记录\" class=\"headerlink\" title=\"DKIM entry&#x2F;记录\"></a>DKIM entry&#x2F;记录</h3><p>关于如何获取dkim._domainkey.mydomain.com.的内容&#x2F;值，举例：</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\">&gt; </span><span class=\"language-bash\">docker <span class=\"built_in\">exec</span> -it iRedMail bash</span></span><br><span class=\"line\"></span><br><span class=\"line\">root@cc9dd27b3e25:/etc/amavis/conf.d# amavisd-new showkeys</span><br><span class=\"line\">; key#1 1024 bits, i=dkim, d=carlzeng.com, /opt/iredmail/custom/amavisd/dkim/carlzeng.com.pem</span><br><span class=\"line\">dkim._domainkey.carlzeng.com.   3600 TXT (</span><br><span class=\"line\">  &quot;v=DKIM1; p=&quot;</span><br><span class=\"line\">  &quot;MIGfMA0GCSqGSIb3DQEBAQUAA4GNADCBiQKBgQDDUF5BslOb2fARJjXK41xsAPSg&quot;</span><br><span class=\"line\">  &quot;hToQAkJzRuxp5pwaCyqPzIbFNxTZ66z9yw+rbeXYKdpu3bKemHhKVQ7rvnmVlFFL&quot;</span><br><span class=\"line\">  &quot;Nvef7Pk9ddT/nur2T1sfUY6yDu5QRcZArClAQRjfNCFRA11VgsD5q6OKS5GTNtE5&quot;</span><br><span class=\"line\">  &quot;dz3kJGpVdCllilo4OwIDAQAB&quot;)</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<h3 id=\"DMARC-entry-记录\"><a href=\"#DMARC-entry-记录\" class=\"headerlink\" title=\"DMARC entry&#x2F;记录\"></a>DMARC entry&#x2F;记录</h3><figure class=\"highlight ini\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">v</span>=DMARC1<span class=\"comment\">; p=reject; sp=none; adkim=s; aspf=s; rua=mailto:postmaster@carlzeng.com; ruf=mailto:postmaster@carlzeng.com</span></span><br></pre></td></tr></table></figure>\n\n\n\n<h2 id=\"端口映射\"><a href=\"#端口映射\" class=\"headerlink\" title=\"端口映射\"></a>端口映射</h2><p>这个步骤的作用是让路由器上接收到的邮件相关的数据，都转发给正确的邮件服务系统。</p>\n<table>\n<thead>\n<tr>\n<th>外部端口</th>\n<th>内部NAS&#x2F;Mail主机端口</th>\n<th>说明</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>‘587:587’</td>\n<td></td>\n<td></td>\n</tr>\n<tr>\n<td>‘465:465’</td>\n<td></td>\n<td></td>\n</tr>\n<tr>\n<td>‘25:25’</td>\n<td></td>\n<td></td>\n</tr>\n<tr>\n<td>‘993:993’</td>\n<td></td>\n<td></td>\n</tr>\n<tr>\n<td>‘143:143’</td>\n<td></td>\n<td></td>\n</tr>\n<tr>\n<td>‘995:995’</td>\n<td></td>\n<td></td>\n</tr>\n<tr>\n<td>‘110:110’</td>\n<td></td>\n<td></td>\n</tr>\n<tr>\n<td></td>\n<td></td>\n<td></td>\n</tr>\n<tr>\n<td>4433</td>\n<td>4433</td>\n<td>添加到443端口的访问可能</td>\n</tr>\n<tr>\n<td></td>\n<td></td>\n<td></td>\n</tr>\n</tbody></table>\n<p>将这些端口一一对应，很庆幸这些端口还没有被ISP屏蔽；</p>\n<p><img data-src=\"https://img.carlzeng.com:3/i/2024/03/01/65e142d55ffd2.png\" alt=\"image-20240301105204159\"></p>\n<h2 id=\"SMTP设置发邮件\"><a href=\"#SMTP设置发邮件\" class=\"headerlink\" title=\"SMTP设置发邮件\"></a>SMTP设置发邮件</h2><p>比如在<a href=\"https://bestbuy.carlzeng.com:3/admin#/smtp\">佰阅发卡kamifaka</a>中设置邮箱信息，用于消息通知之邮箱通知。</p>\n<p>错误：无法成功到达邮件目的地</p>\n<p>解决办法：详见‘错误及解决办法’的章节：SMTP服务测试</p>\n<p>调整了SPF的那条DNS记录（第二天发现生效），再次测试；可以正常发送测试邮箱。</p>\n<h2 id=\"错误及解决方法\"><a href=\"#错误及解决方法\" class=\"headerlink\" title=\"错误及解决方法\"></a>错误及解决方法</h2><h3 id=\"Docker启动错误：”Permission-denied”\"><a href=\"#Docker启动错误：”Permission-denied”\" class=\"headerlink\" title=\"Docker启动错误：”Permission denied”\"></a>Docker启动错误：”Permission denied”</h3><p>iRedMail   | &#x2F;usr&#x2F;sbin&#x2F;mysqld: Can’t create file ‘&#x2F;var&#x2F;lib&#x2F;mysql&#x2F;mysqld.err’ (errno: 13 “Permission denied”)<br>iRedMail   | 2024-02-28 16:12:07 0 [ERROR] mysqld: Can’t create&#x2F;write to file ‘&#x2F;var&#x2F;lib&#x2F;mysql&#x2F;aria_log_control’ (Errcode: 13 “Permission denied”)</p>\n<p>解决办法：</p>\n<p>chmod 777 -R &#x2F;volume2&#x2F;KingchuxingSSD512G&#x2F;docker&#x2F;compose&#x2F;iRedMail<br>chmod 777 -R &#x2F;volume2&#x2F;KingchuxingSSD512G&#x2F;docker&#x2F;compose&#x2F;iRedMail&#x2F;mysql&#x2F;</p>\n<h3 id=\"DNS设置错误之No-DMARC-Record-found\"><a href=\"#DNS设置错误之No-DMARC-Record-found\" class=\"headerlink\" title=\"DNS设置错误之No DMARC Record found\"></a>DNS设置错误之No DMARC Record found</h3><p>错误列表检测自：<a href=\"https://mxtoolbox.com/emailhealth/carlzeng.com/\">https://mxtoolbox.com/emailhealth/carlzeng.com/</a></p>\n<table>\n<thead>\n<tr>\n<th align=\"left\"></th>\n<th align=\"left\">Category</th>\n<th align=\"left\">Host</th>\n<th align=\"left\">Result</th>\n<th align=\"left\"></th>\n</tr>\n</thead>\n<tbody><tr>\n<td align=\"left\"><img data-src=\"https://images.mxtoolbox.com/public/images/statusicons/problem.png\" alt=\"Status Problem\"></td>\n<td align=\"left\">dmarc</td>\n<td align=\"left\">carlzeng.com</td>\n<td align=\"left\">No DMARC Record found</td>\n<td align=\"left\"><a href=\"https://mxtoolbox.com/problem/dmarc/DMARC-Record-Published?page=health_dmarc&hidetoc=0&hidepitch=0&showlogin=1&action=dmarc:carlzeng.com&domain=carlzeng.com\"><img data-src=\"https://images.mxtoolbox.com/public/images/statusicons/info.png\" alt=\"information\"> More Info</a></td>\n</tr>\n<tr>\n<td align=\"left\"><img data-src=\"https://images.mxtoolbox.com/public/images/statusicons/problem.png\" alt=\"Status Problem\"></td>\n<td align=\"left\">blacklist</td>\n<td align=\"left\">mail.carlzeng.com</td>\n<td align=\"left\">Blacklisted by UCEPROTECTL3</td>\n<td align=\"left\"><a href=\"https://mxtoolbox.com/problem/blacklist/UCEPROTECTL3?page=health_blacklist&hidetoc=0&hidepitch=0&showlogin=1&action=blacklist:mail.carlzeng.com&domain=carlzeng.com\"><img data-src=\"https://images.mxtoolbox.com/public/images/statusicons/info.png\" alt=\"information\"> More Info</a></td>\n</tr>\n<tr>\n<td align=\"left\"><img data-src=\"https://images.mxtoolbox.com/public/images/statusicons/problem.png\" alt=\"Status Problem\"></td>\n<td align=\"left\">mx</td>\n<td align=\"left\">carlzeng.com</td>\n<td align=\"left\">No DMARC Record found</td>\n<td align=\"left\"><a href=\"https://mxtoolbox.com/problem/mx/DMARC-Record-Published?page=health_mx&hidetoc=0&hidepitch=0&showlogin=1&action=mx:carlzeng.com&domain=carlzeng.com\"><img data-src=\"https://img.carlzeng.com:3/i/2024/02/29/65e089fcef838.png\" alt=\"information\"> More Info</a></td>\n</tr>\n</tbody></table>\n<p>错误解决：</p>\n<p>原来DNS记录的名称搞错了，正确的dmarc DNS记录名必须是（含下划线）：_dmarc</p>\n<h3 id=\"iredadmin操作不携带端口错误\"><a href=\"#iredadmin操作不携带端口错误\" class=\"headerlink\" title=\"iredadmin操作不携带端口错误\"></a>iredadmin操作不携带端口错误</h3><p>操作的后台<a href=\"https://iredmail.carlzeng.com:3/iredadmin%EF%BC%8C%E5%BD%93%E6%8F%90%E4%BA%A4%E6%96%B0%E7%9A%84%E7%A1%AE%E8%AE%A4%E6%93%8D%E4%BD%9C%E6%97%B6%EF%BC%8C%E9%A1%B5%E9%9D%A2%E8%B7%B3%E8%BD%AC%E5%88%B0%E6%9C%AA%E6%90%BA%E5%B8%A6%E7%AB%AF%E5%8F%A3%E7%8A%B6%E6%80%81\">https://iredmail.carlzeng.com:3/iredadmin，当提交新的确认操作时，页面跳转到未携带端口状态</a></p>\n<p>错误解决：</p>\n<p><img data-src=\"https://img.carlzeng.com:3/i/2024/03/01/65e139600f9ea.png\" alt=\"image-20240301101140381\"></p>\n<p>没有解决自动携带端口的问题，等待docker重启后继续测试</p>\n<h3 id=\"icloud通信受阻rejected-due-to-listing-in-Spamhaus-PBL\"><a href=\"#icloud通信受阻rejected-due-to-listing-in-Spamhaus-PBL\" class=\"headerlink\" title=\"icloud通信受阻rejected due to listing in Spamhaus PBL\"></a>icloud通信受阻rejected due to listing in Spamhaus PBL</h3><p>host mx01.mail.icloud.com[17.56.9.31] said: 550<br>  5.7.1 Mail from IP 111.197.216.113 was rejected due to listing in Spamhaus<br>  PBL. For details please see<br>  <a href=\"http://www.spamhaus.org/query/bl?ip=111.197.216.113\">http://www.spamhaus.org/query/bl?ip=111.197.216.113</a> (in reply to RCPT TO<br>  command)</p>\n<p>解决办法：</p>\n<p>去给定的<a href=\"https://check.spamhaus.org/\">IP AND DOMAIN REPUTATION CHECKER网站</a>上提交解封申请，提交成功后，如图：</p>\n<p><img data-src=\"https://img.carlzeng.com:3/i/2024/03/01/65e140a62c982.png\" alt=\"image-20240301104242813\"></p>\n<h3 id=\"程序发邮件被自我拦截为SPAM\"><a href=\"#程序发邮件被自我拦截为SPAM\" class=\"headerlink\" title=\"程序发邮件被自我拦截为SPAM\"></a>程序发邮件被自我拦截为SPAM</h3><p>从网站平台配置的SMTP，程序发邮件被自我拦截为SPAM；</p>\n<figure class=\"highlight ini\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Spam scanner report:</span><br><span class=\"line\"> Spam detection software, running on the system &quot;cc9dd27b3e25&quot;,</span><br><span class=\"line\"> has identified this incoming email as possible spam.  The original</span><br><span class=\"line\"> message has been attached to this so you can view it or label</span><br><span class=\"line\"> similar future email.  If you have any questions, see</span><br><span class=\"line\"> the administrator of that system for details.</span><br><span class=\"line\"></span><br><span class=\"line\"> Content preview:  Test send email</span><br></pre></td></tr></table></figure>\n\n<p>解决办法： 未知，如何关闭自己对自己发邮件的过度SPAM检测（邮件不是SPAM，系统误判）。。。</p>\n<p>- <a href=\"https://docs.iredmail.org/disable.spam.virus.scanning.for.outgoing.mails.html\">https://docs.iredmail.org/disable.spam. … mails.html</a><br>- <a href=\"https://docs.iredmail.org/completely.disable.amavisd.clamav.spamassassin.html\">https://docs.iredmail.org/completely.di … assin.html</a></p>\n<blockquote>\n<p>docker exec -it iRedMail bash</p>\n</blockquote>\n<p>没有找到这个文件：&#x2F;etc&#x2F;amavis&#x2F;conf.d&#x2F;50-user</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"># @bypass_virus_checks_maps = (1);  # controls running of anti-virus code</span><br><span class=\"line\"># @bypass_spam_checks_maps  = (1);  # controls running of anti-spam code</span><br></pre></td></tr></table></figure>\n\n<p>Restarting Amavisd service is required after changing settings.</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&gt; service  amavis restart                                                     </span><br><span class=\"line\">Stopping amavisd: amavisd-new.                                                                                    </span><br><span class=\"line\">Starting amavisd: amavisd-new.              </span><br></pre></td></tr></table></figure>\n\n<p>environment:</p>\n<p>TZ&#x3D;Asia&#x2F;Shanghai</p>\n<p>发现：使用最初的账户没有这个误判的情况。</p>\n<h3 id=\"是否可删除mail-的DNS记录？\"><a href=\"#是否可删除mail-的DNS记录？\" class=\"headerlink\" title=\"是否可删除mail.**的DNS记录？\"></a>是否可删除mail.**的DNS记录？</h3><p>由于设定了泛域名解析道正确的IP <em>，目前增加的这条mail.carlzeng.com反而增加了DDNS需要去轮询更新IP的任务数，没有这条DNS解析，直接ping mail.</em>* 也一样得到最新且正确的IP地址。</p>\n<p>待实践核实&#x2F;测试… (理论上没问题，因为iodine已经成功删除&#x2F;优化掉A记录）</p>\n<h3 id=\"维护定时任务\"><a href=\"#维护定时任务\" class=\"headerlink\" title=\"维护定时任务\"></a>维护定时任务</h3><p>每天邮箱中都收到6封系统自动备份的邮件：</p>\n<figure class=\"highlight txt\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Cron &lt;root@c7e4835b8e6d&gt; /bin/bash /var/vmail/backup/backup_mysql.sh </span><br><span class=\"line\"></span><br><span class=\"line\">/bin/sh: 1: freshclam: not found</span><br><span class=\"line\"></span><br><span class=\"line\">/etc/cron.daily/logrotate:</span><br><span class=\"line\">invoke-rc.d: could not determine current runlevel</span><br><span class=\"line\">invoke-rc.d: policy-rc.d denied execution of reload-log.</span><br></pre></td></tr></table></figure>\n\n<p>进入docker</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">docker exec -it iRedMail bash   </span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">编辑Linux中的定时任务的命令</span></span><br><span class=\"line\">crontab -e</span><br></pre></td></tr></table></figure>\n\n<p>注释掉</p>\n<figure class=\"highlight txt\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">#40 3 * * * /bin/bash /var/vmail/backup/backup_mysql.sh </span><br><span class=\"line\"></span><br><span class=\"line\">#Ansible: freshclam: update database regularly.</span><br><span class=\"line\">#1 */6 * * * freshclam --quiet --foreground --config-file=/etc/clamav/freshclam.conf --daemon-notify=/etc/clamav/clamd.conf &gt;/dev/null</span><br><span class=\"line\"></span><br><span class=\"line\">#Ansible: Scan spam/ham reported by end users.</span><br><span class=\"line\">#*/10 * * * * /bin/bash /opt/iredmail/bin/dovecot/scan_reported_mails &gt;/dev/null</span><br></pre></td></tr></table></figure>\n\n<p>感受：去掉这些每天的自动备份功能以后，清爽许多 :-)</p>\n<p>尴尬的是，这种进bash编辑的方式，重启整个NAS后，编辑的内容会重置，还得再去编辑….</p>\n<p>这次NAS运行81天多才重启一次，暂且用这种收邮件的方式就知道docker中的内容被恢复了。</p>\n<h3 id=\"纠正邮件系统的时区\"><a href=\"#纠正邮件系统的时区\" class=\"headerlink\" title=\"纠正邮件系统的时区\"></a>纠正邮件系统的时区</h3><p>修改docker-compose文件，在volumes下面新增这条，可纠正邮件系统的时区：</p>\n<ul>\n<li>“&#x2F;etc&#x2F;localtime:&#x2F;etc&#x2F;localtime:ro” #这条可纠正邮件系统的时区</li>\n</ul>\n<h3 id=\"SMTP服务测试\"><a href=\"#SMTP服务测试\" class=\"headerlink\" title=\"SMTP服务测试\"></a>SMTP服务测试</h3><p><a href=\"https://www.gmass.co/smtp-test#\">SMTP Test Tool</a></p>\n<p>​\t优点：实时显示详细的debug日志。赞！</p>\n<p><a href=\"https://smtpserver.com/mail-tester\">Email Check Spam Score and Improve Quality</a></p>\n<p>​\t优点：可以检测出详细的DNS配置错误（如果有错误的话），并给出修正的建议。赞！</p>\n<h3 id=\"iredMail证书配置\"><a href=\"#iredMail证书配置\" class=\"headerlink\" title=\"iredMail证书配置\"></a>iredMail证书配置</h3><p>Using <a href=\"http://www.checktls.com/\">http://www.checktls.com/</a>, it’s clear that the Zendesk TLS cert is incorrect in that it doesn’t specify that mail.pod-4 host.</p>\n<p><img data-src=\"https://img.carlzeng.com:3/i/2024/03/28/6605735e21430.png\" alt=\"image-20240328214042643\"></p>\n<p>从这点来看，可能是自签证书的问题？那么如何替换和生成一个证书呢？</p>\n<p>测试配置步骤：</p>\n<ol>\n<li>下载NPM中生成的泛域名证书，得到certificate.zip，解压缩一共是4个文件。</li>\n<li>上传fullchain.pem 和 privkey.pem 到 映射的目录中（&#x2F;KingchuxingSSD512G&#x2F;docker&#x2F;compose&#x2F;iRedMail&#x2F;ssl），分别重命名为iRedMail.crt 和 iRedMail.key。再重新上传一遍（备份原文件名）</li>\n<li>测试<a href=\"https://www.ssllabs.com/ssltest/index.html\">https://www.ssllabs.com/ssltest/index.html</a> 和 <a href=\"https://www.checktls.com/\">https://www.checktls.com/</a></li>\n<li></li>\n<li></li>\n</ol>\n<p>本章节参考：</p>\n<p><a href=\"https://docs.iredmail.org/use.a.bought.ssl.certificate.html\">Use a bought SSL certificate</a></p>\n<p><a href=\"https://docs.iredmail.org/letsencrypt.html\">Request a free cert from Let’s Encrypt (for servers deployed with downloadable iRedMail installer)</a></p>\n<p><img data-src=\"https://img.carlzeng.com:3/i/2024/04/23/66271bd148a22.png\" alt=\"image-20240423102406511\"></p>\n<p>确保证书是： mail.carlzeng.com<br>    使用dns challenge的方式，dns_cloudflare_api_token<br>    Processing… This might take a few minutes.</p>\n<p><a href=\"https://dash.cloudflare.com/profile/api-tokens\">https://dash.cloudflare.com/profile/api-tokens</a><br>    &gt; Global API Key</p>\n<p>fail to get the cert by dns challenge<br>    成功了，原来不是使用Global API KEY；要使用”API 令牌”中的‘创建令牌’ 》 编辑区域 DNS\t</p>\n<p><img data-src=\"https://img.carlzeng.com:3/i/2024/04/23/662722fde4c91.png\" alt=\"image-20240423105448516\"></p>\n<p>cp mail.jbritian.com_bundle.crt cert.pem </p>\n<p>cp mail.jbritian.com_bundle.crt combined.pem </p>\n<p>cp mail.jbritian.com.key key.pem</p>\n<p><img data-src=\"https://img.carlzeng.com:3/i/2024/04/23/662725ef860df.png\" alt=\"image-20240423110722391\"></p>\n<p>cert1.pem 重命名成： cert.pem </p>\n<p>fullchain1.pem 重命名成：combined.pem</p>\n<p>privkey1.pem 重命名成：key.pem</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ln -s /etc/letsencrypt/live/mail.mydomain.com/fullchain.pem /etc/ssl/certs/iRedMail.crt</span><br><span class=\"line\">ln -s /etc/letsencrypt/live/mail.mydomain.com/privkey.pem /etc/ssl/private/iRedMail.key</span><br></pre></td></tr></table></figure>\n\n<p>都检查过这些组件了，确实都是映射到容器中的 &#x2F;opt&#x2F;iredmail&#x2F;ssl 目录中的三个文件</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Postfix</span><br><span class=\"line\">File /etc/postfix/main.cf (on Linux/OpenBSD)</span><br><span class=\"line\"></span><br><span class=\"line\">Dovecot</span><br><span class=\"line\">File `/etc/dovecot/dovecot.conf` (on Linux/OpenBSD) </span><br><span class=\"line\"></span><br><span class=\"line\">Nginx</span><br><span class=\"line\">File /etc/nginx/templates/ssl.tmpl (on Linux/OpenBSD)</span><br><span class=\"line\"></span><br><span class=\"line\">MySQL, MariaDB</span><br><span class=\"line\">On Debian and Ubuntu, it&#x27;s defined in /etc/mysql/my.cnf.</span><br></pre></td></tr></table></figure>\n\n<p>TXT记录变更：<br>    v&#x3D;spf1 a mx include:_spf.google.com ~all<br>    v&#x3D;spf1 mx -all</p>\n<hr>\n<h1 id=\"以下为踩坑记录-请跳过\"><a href=\"#以下为踩坑记录-请跳过\" class=\"headerlink\" title=\"以下为踩坑记录(请跳过)\"></a>以下为踩坑记录(请跳过)</h1><h2 id=\"docker-mailserver\"><a href=\"#docker-mailserver\" class=\"headerlink\" title=\"docker-mailserver\"></a>docker-mailserver</h2><p>docker-compose.yml (docker-mailserver)</p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">services:</span></span><br><span class=\"line\">  <span class=\"attr\">mailserver:</span></span><br><span class=\"line\">    <span class=\"attr\">image:</span> <span class=\"string\">ghcr.io/docker-mailserver/docker-mailserver:latest</span></span><br><span class=\"line\">    <span class=\"attr\">container_name:</span> <span class=\"string\">mailserver</span></span><br><span class=\"line\">    <span class=\"comment\"># Provide the FQDN of your mail server here (Your DNS MX record should point to this value)</span></span><br><span class=\"line\">    <span class=\"attr\">hostname:</span> <span class=\"string\">mail.carlzeng.com</span></span><br><span class=\"line\">    <span class=\"attr\">ports:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">&quot;25:25&quot;</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">&quot;465:465&quot;</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">&quot;587:587&quot;</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">&quot;993:993&quot;</span></span><br><span class=\"line\">    <span class=\"attr\">volumes:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">./mail-data/:/var/mail/</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">./mail-state/:/var/mail-state/</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">./mail-logs/:/var/log/mail/</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">./config/:/tmp/docker-mailserver/</span></span><br><span class=\"line\">    <span class=\"attr\">environment:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">ENABLE_RSPAMD=0</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">ENABLE_CLAMAV=0</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">ENABLE_FAIL2BAN=1</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">TZ=Asia/Shanghai</span></span><br><span class=\"line\">    <span class=\"attr\">cap_add:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">NET_ADMIN</span> <span class=\"comment\"># For Fail2Ban to work</span></span><br><span class=\"line\">    <span class=\"attr\">restart:</span> <span class=\"string\">always</span></span><br></pre></td></tr></table></figure>\n\n\n\n<p>docker-compose up 测试中…</p>\n<p>下一步要生成配置文件？</p>\n<p>docker exec -ti mailserver setup</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">mailserver    | [ WARNING ]  You need at least one mail account to start Dovecot (120s left for account creation before shutdown)</span><br></pre></td></tr></table></figure>\n\n\n\n<p>docker exec -ti mailserver setup email add <a href=\"mailto:&#x73;&#x65;&#x72;&#118;&#x69;&#99;&#x65;&#64;&#x63;&#x61;&#x72;&#108;&#122;&#101;&#110;&#x67;&#46;&#99;&#x6f;&#x6d;\">&#x73;&#x65;&#x72;&#118;&#x69;&#99;&#x65;&#64;&#x63;&#x61;&#x72;&#108;&#122;&#101;&#110;&#x67;&#46;&#99;&#x6f;&#x6d;</a></p>\n<p>解决办法：未知</p>\n<p>文档信息：</p>\n<p><a href=\"https://github.com/docker-mailserver/docker-mailserver?tab=readme-ov-file\">https://github.com/docker-mailserver/docker-mailserver?tab=readme-ov-file</a></p>\n<p><a href=\"https://docker-mailserver.github.io/docker-mailserver/latest/\">https://docker-mailserver.github.io/docker-mailserver/latest/</a></p>\n<h2 id=\"postfix-and-postfixadmin\"><a href=\"#postfix-and-postfixadmin\" class=\"headerlink\" title=\"postfix and postfixadmin\"></a>postfix and postfixadmin</h2><p>docker-compose for postfix and postfixadmin</p>\n<p>postfixadmin<br>    Postfix Admin is a web based interface to configure and manage a Postfix based email server for many users.</p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">version:</span> <span class=\"string\">&#x27;3&#x27;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attr\">services:</span></span><br><span class=\"line\">  <span class=\"attr\">db:</span></span><br><span class=\"line\">    <span class=\"attr\">image:</span> <span class=\"string\">mysql:8.0</span></span><br><span class=\"line\">    <span class=\"attr\">restart:</span> <span class=\"string\">always</span></span><br><span class=\"line\">    <span class=\"attr\">environment:</span></span><br><span class=\"line\">      <span class=\"attr\">MYSQL_RANDOM_ROOT_PASSWORD:</span> <span class=\"number\">1</span></span><br><span class=\"line\">      <span class=\"attr\">MYSQL_DATABASE:</span> <span class=\"string\">postfixadmin</span></span><br><span class=\"line\">      <span class=\"attr\">MYSQL_USER:</span> <span class=\"string\">postfixadmin</span></span><br><span class=\"line\">      <span class=\"attr\">MYSQL_PASSWORD:</span> <span class=\"string\">example</span></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"attr\">postfixadmin:</span></span><br><span class=\"line\">    <span class=\"attr\">depends_on:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">db</span></span><br><span class=\"line\">    <span class=\"attr\">image:</span> <span class=\"string\">postfixadmin</span></span><br><span class=\"line\">    <span class=\"attr\">ports:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"number\">8000</span><span class=\"string\">:80</span></span><br><span class=\"line\">    <span class=\"attr\">restart:</span> <span class=\"string\">always</span></span><br><span class=\"line\">    <span class=\"attr\">environment:</span></span><br><span class=\"line\">      <span class=\"attr\">POSTFIXADMIN_DB_TYPE:</span> <span class=\"string\">mysqli</span></span><br><span class=\"line\">      <span class=\"attr\">POSTFIXADMIN_DB_HOST:</span> <span class=\"string\">db</span></span><br><span class=\"line\">      <span class=\"attr\">POSTFIXADMIN_DB_USER:</span> <span class=\"string\">postfixadmin</span></span><br><span class=\"line\">      <span class=\"attr\">POSTFIXADMIN_DB_NAME:</span> <span class=\"string\">postfixadmin</span></span><br><span class=\"line\">      <span class=\"attr\">POSTFIXADMIN_DB_PASSWORD:</span> <span class=\"string\">example</span></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<p>Where to file issues:<br><a href=\"https://github.com/postfixadmin/docker/issues\">https://github.com/postfixadmin/docker/issues</a></p>\n<h3 id=\"还差一个靠谱可用的postfix\"><a href=\"#还差一个靠谱可用的postfix\" class=\"headerlink\" title=\"还差一个靠谱可用的postfix\"></a>还差一个靠谱可用的postfix</h3><p><a href=\"https://gitlab.com/tozd/docker/postfix\">https://gitlab.com/tozd/docker/postfix</a></p>\n<p><a href=\"https://gitlab.com/tozd/docker/mail\">https://gitlab.com/tozd/docker/mail</a></p>\n<p><a href=\"https://hub.docker.com/r/tozd/postfix\">https://hub.docker.com/r/tozd/postfix</a></p>\n<h3 id=\"Ports\"><a href=\"#Ports\" class=\"headerlink\" title=\"Ports\"></a>Ports</h3><ul>\n<li><code>25/tcp</code>: SMTP port.</li>\n<li><code>465/tcp</code>: SMTPS port.</li>\n<li><code>587/tcp</code>: Mail submission port.</li>\n</ul>\n<p>alpine-316&#96;: Postfix 3.7.6</p>\n<p><a href=\"https://hub.docker.com/search?q=postfix\">https://hub.docker.com/search?q=postfix</a></p>\n<p>另外一个是：<a href=\"https://github.com/catatnight/docker-postfix\">https://github.com/catatnight/docker-postfix</a></p>\n<p>Note：这是我找到唯一简便安装且能正常使用的邮件系统，请留言告诉我你是否有更好的自建解决方案。</p>\n<h1 id=\"感谢列表\"><a href=\"#感谢列表\" class=\"headerlink\" title=\"感谢列表\"></a>感谢列表</h1><p><a href=\"https://kydsj.vip/doku.php?id=wiki:%E8%87%AA%E6%89%98%E7%AE%A1-%E7%94%B5%E5%AD%90%E9%82%AE%E4%BB%B6\">开源大世界-自托管-电子邮件</a></p>\n<p><a href=\"https://www.youtube.com/watch?v=qnnf3LWcUXA\">Running iRedMail E-Mail Server in Docker</a></p>\n<p><a href=\"https://docs.iredmail.org/setup.dns.html#mx\">Setup DNS records for your iRedMail server (A, PTR, MX, SPF, DKIM, DMARC)</a></p>\n<p><a href=\"https://www.youtube.com/watch?v=ScarlmgD0dU\">From zero to full mail server in 20 minutes with Mailu Docker images!</a></p>\n<p><a href=\"HTTPS/SSL%E8%AF%81%E4%B9%A6%E9%85%8D%E7%BD%AE\">HTTPS&#x2F;SSL证书配置</a></p>\n","more":"<p>备注：这是我找到唯一简便安装且能正常使用的邮件系统，请留言告诉我你是否有更好的自建解决方案。</p>\n<p>踩了很多的坑，经历了一个月左右的时间，才测试收发邮件成功（部分邮箱目的地无法达到，由于互联网上的反垃圾邮件策略），持续更新完善中.</p>\n<p>2024年3月18日 新增章节：“维护定时任务”</p>\n<p>2024年3月22日 新增章节：“SMTP服务测试” 并修正spf的DNS设置内容；关注到另外一个备选方案：<a href=\"https://lala.im/8977.html\">Stalwart Mail Server（All-in-One 邮件服务器）</a></p>\n<p>下一步：朋友提出新需求：如何批量发送邮件？</p>\n<div> \n<button onclick=\"synthesizeSpeech()\">朗读全文</button>\n</div>\n<audio controls id=\"audioPlayer\">Your browser does not support the audio element.</audio>      \n<script>\n  function synthesizeSpeech() { \n    var inputText = document.getElementsByClassName('post-block')[0].innerText;\n    var voice = \"ZH\";\n    var url = 'https://tts.carlzeng.com:3/speech?text=' + encodeURIComponent(inputText.substring(0,3000)) + '&voice=' + voice;\n    var audioPlayer = document.getElementById('audioPlayer');          \n    audioPlayer.src = url;\n    audioPlayer.load();\n    audioPlayer.play();\n  }\n</script>\n\n\n<h1 id=\"怎么用\"><a href=\"#怎么用\" class=\"headerlink\" title=\"怎么用\"></a>怎么用</h1><ul>\n<li><p>日常收发邮件</p>\n<ul>\n<li>通过搭建邮件服务来收发你自己域名下的邮件</li>\n</ul>\n</li>\n<li><p>第三方平台（或自己搭建的服务）上需要设置的SMTP服务（SMTP邮箱设置）邮件通知&#x2F;告知</p>\n</li>\n</ul>\n<h1 id=\"相关内容\"><a href=\"#相关内容\" class=\"headerlink\" title=\"相关内容\"></a>相关内容</h1><iframe style=\"box-shadow: 0px 0px 20px -10px;\" src=\"https://query.carlzeng.com:3/appsearch?q=email\" frameborder=\"0\" scrolling=\"auto\" width=\"100%\" height=\"500\"></iframe>\n\n<h1 id=\"实现方法\"><a href=\"#实现方法\" class=\"headerlink\" title=\"实现方法\"></a>实现方法</h1><h2 id=\"iRedMail-Docker搭建\"><a href=\"#iRedMail-Docker搭建\" class=\"headerlink\" title=\"iRedMail Docker搭建\"></a>iRedMail Docker搭建</h2><p>iRedMail docker-compose.yml</p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">version:</span> <span class=\"string\">&#x27;3.9&#x27;</span></span><br><span class=\"line\"><span class=\"attr\">services:</span></span><br><span class=\"line\">        <span class=\"attr\">mariadb:</span></span><br><span class=\"line\">            <span class=\"attr\">image:</span> <span class=\"string\">&#x27;iredmail/mariadb:stable&#x27;</span></span><br><span class=\"line\">            <span class=\"attr\">volumes:</span></span><br><span class=\"line\">                <span class=\"bullet\">-</span> <span class=\"string\">&#x27;./postfix_queue:/var/spool/postfix&#x27;</span></span><br><span class=\"line\">                <span class=\"bullet\">-</span> <span class=\"string\">&#x27;./sa_rules:/var/lib/spamassassin&#x27;</span></span><br><span class=\"line\">                <span class=\"bullet\">-</span> <span class=\"string\">&#x27;./clamav:/var/lib/clamav&#x27;</span></span><br><span class=\"line\">                <span class=\"bullet\">-</span> <span class=\"string\">&#x27;./mysql:/var/lib/mysql&#x27;</span></span><br><span class=\"line\">                <span class=\"bullet\">-</span> <span class=\"string\">&#x27;./ssl:/opt/iredmail/ssl&#x27;</span></span><br><span class=\"line\">                <span class=\"bullet\">-</span> <span class=\"string\">&#x27;./custom:/opt/iredmail/custom&#x27;</span></span><br><span class=\"line\">                <span class=\"bullet\">-</span> <span class=\"string\">&#x27;./imapsieve_copy:/var/vmail/imapsieve_copy&#x27;</span></span><br><span class=\"line\">                <span class=\"bullet\">-</span> <span class=\"string\">&#x27;./mlmmj-archive:/var/vmail/mlmmj-archive&#x27;</span></span><br><span class=\"line\">                <span class=\"bullet\">-</span> <span class=\"string\">&#x27;./mlmmj:/var/vmail/mlmmj&#x27;</span></span><br><span class=\"line\">                <span class=\"bullet\">-</span> <span class=\"string\">&#x27;./mailboxes:/var/vmail/vmail1&#x27;</span></span><br><span class=\"line\">                <span class=\"bullet\">-</span> <span class=\"string\">&#x27;./backup-mysql:/var/vmail/backup/mysql&#x27;</span></span><br><span class=\"line\">                <span class=\"bullet\">-</span> <span class=\"string\">&quot;/etc/localtime:/etc/localtime:ro&quot;</span> <span class=\"comment\">#这条可纠正邮件系统的时区</span></span><br><span class=\"line\">            <span class=\"attr\">ports:</span></span><br><span class=\"line\">                <span class=\"bullet\">-</span> <span class=\"string\">&#x27;587:587&#x27;</span></span><br><span class=\"line\">                <span class=\"bullet\">-</span> <span class=\"string\">&#x27;465:465&#x27;</span></span><br><span class=\"line\">                <span class=\"bullet\">-</span> <span class=\"string\">&#x27;25:25&#x27;</span></span><br><span class=\"line\">                <span class=\"bullet\">-</span> <span class=\"string\">&#x27;993:993&#x27;</span></span><br><span class=\"line\">                <span class=\"bullet\">-</span> <span class=\"string\">&#x27;143:143&#x27;</span></span><br><span class=\"line\">                <span class=\"bullet\">-</span> <span class=\"string\">&#x27;995:995&#x27;</span></span><br><span class=\"line\">                <span class=\"bullet\">-</span> <span class=\"string\">&#x27;110:110&#x27;</span></span><br><span class=\"line\">                <span class=\"bullet\">-</span> <span class=\"string\">&#x27;4433:443&#x27;</span></span><br><span class=\"line\">                <span class=\"bullet\">-</span> <span class=\"string\">&#x27;8093:80&#x27;</span></span><br><span class=\"line\">            <span class=\"attr\">env_file:</span></span><br><span class=\"line\">                <span class=\"bullet\">-</span> <span class=\"string\">./iredmail-docker.conf</span></span><br><span class=\"line\">            <span class=\"attr\">container_name:</span> <span class=\"string\">iRedMail</span></span><br></pre></td></tr></table></figure>\n\n<p>Docker启动后，假如一切正常则调试信息类似于：</p>\n<p><img data-src=\"https://img.carlzeng.com:3/i/2024/02/29/65dfda2b7efb5.png\" alt=\"docker启动iRedMail成功后输出信息\"></p>\n<p>一切启动正常后，可以开始设置DNS记录，然后端口映射出防火墙。</p>\n<p>最后可用系统自带的WEB网页客户端来收发邮件，或使用Outlook等客户端配置SMTP，POP3来收发邮件</p>\n<h2 id=\"设置DNS\"><a href=\"#设置DNS\" class=\"headerlink\" title=\"设置DNS\"></a>设置DNS</h2><p>Your DNS MX record should point to this value</p>\n<p>设置DNS项范例：</p>\n<p><img data-src=\"https://img.carlzeng.com:3/i/2024/02/29/65e0282f016cc.png\" alt=\"image-20240229144603695\"></p>\n<p><img data-src=\"https://img.carlzeng.com:3/i/2024/02/29/65e0289fe89be.png\" alt=\"image-20240229144758944\"></p>\n<p>| DNS类型 | DNS记录名 | 内容&#x2F;值 | 说明&#x2F;备注 |</p>\n<table>\n<thead>\n<tr>\n<th>DNS类型</th>\n<th>DNS记录名</th>\n<th>内容&#x2F;值</th>\n<th>备注&#x2F;说明</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>MX</td>\n<td>carlzeng.com.</td>\n<td>mail.carlzeng.com.</td>\n<td>标识邮件服务器名称，DNS MX entry</td>\n</tr>\n<tr>\n<td>A</td>\n<td>mail.carlzeng.com.</td>\n<td>*.8.18.*</td>\n<td>邮件服务器的IP地址</td>\n</tr>\n<tr>\n<td>TXT</td>\n<td>carlzeng.com.</td>\n<td>v&#x3D;spf1 mx -all</td>\n<td>SPF entry&#x2F;记录</td>\n</tr>\n<tr>\n<td>TXT</td>\n<td>dkim._domainkey.carlzeng.com.</td>\n<td>v&#x3D;DKIM1; k&#x3D;rsm; p&#x3D;*</td>\n<td>DKIM entry&#x2F;记录，含DKIM公钥public key，详见下方如何在docker中用命令获取这个内容值</td>\n</tr>\n<tr>\n<td>TXT</td>\n<td>dmarc.carlzeng.com</td>\n<td>v&#x3D;DMARC1; p&#x3D; reject; rua&#x3D;*</td>\n<td>DMARC entry&#x2F;记录</td>\n</tr>\n</tbody></table>\n<p>问：三个TXT记录不知道怎么从iRedMail邮件系统中获取？</p>\n<p>答：After installation: <a href=\"https://docs.iredmail.org/setup.dns.html#mx\">Setup DNS records for your iRedMail server (A, PTR, MX, SPF, DKIM, DMARC)</a></p>\n<p>假如想要检测DNS记录的正确性，可以使用：<a href=\"https://mxtoolbox.com/\">https://mxtoolbox.com/</a></p>\n<h3 id=\"SPF-entry-记录\"><a href=\"#SPF-entry-记录\" class=\"headerlink\" title=\"SPF entry&#x2F;记录\"></a>SPF entry&#x2F;记录</h3><p>v&#x3D;spf1 mx a:mail.carlzeng.com -all</p>\n<blockquote>\n<p>根据SMTP测试报告，这条记录可能存在错误</p>\n</blockquote>\n<p><img data-src=\"https://img.carlzeng.com:3/i/2024/03/21/65fc214953f21.png\" alt=\"image-20240321195957875\"></p>\n<p>v&#x3D;spf1 a mx include:_spf.google.com ~all</p>\n<p>CF中编辑DNS记录后使用dig检测：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">% dig carlzeng.com txt</span><br><span class=\"line\"></span><br><span class=\"line\">; &lt;&lt;&gt;&gt; DiG 9.10.6 &lt;&lt;&gt;&gt; carlzeng.com txt</span><br><span class=\"line\">;; global options: +cmd</span><br><span class=\"line\">;; Got answer:</span><br><span class=\"line\">;; -&gt;&gt;HEADER&lt;&lt;- opcode: QUERY, status: NOERROR, id: 49494</span><br><span class=\"line\">;; flags: qr rd ra; QUERY: 1, ANSWER: 3, AUTHORITY: 2, ADDITIONAL: 7</span><br><span class=\"line\"></span><br><span class=\"line\">;; OPT PSEUDOSECTION:</span><br><span class=\"line\">; EDNS: version: 0, flags:; udp: 1024</span><br><span class=\"line\">;; QUESTION SECTION:</span><br><span class=\"line\">;carlzeng.com.                  IN      TXT</span><br><span class=\"line\"></span><br><span class=\"line\">;; ANSWER SECTION:</span><br><span class=\"line\">carlzeng.com.           2099    IN      TXT     &quot;google-site-verification=709aI8iBja5qWYVP85LxviHsfbHWjpuJZmBOqENAXBM&quot;</span><br><span class=\"line\">carlzeng.com.           2099    IN      TXT     &quot;v=spf1 mx a:mail.carlzeng.com -all&quot;</span><br><span class=\"line\">carlzeng.com.           2099    IN      TXT     &quot;google-site-verification=CLgNXe3i4ZobXoFz9U4gy6OzMAa8gNmXImQbNmTiNPY&quot;</span><br><span class=\"line\"></span><br><span class=\"line\">;; AUTHORITY SECTION:</span><br><span class=\"line\">carlzeng.com.           0       IN      NS      amir.ns.cloudflare.com.</span><br><span class=\"line\">carlzeng.com.           0       IN      NS      paityn.ns.cloudflare.com.</span><br><span class=\"line\"></span><br><span class=\"line\">;; ADDITIONAL SECTION:</span><br><span class=\"line\">amir.ns.cloudflare.com. 20184   IN      A       108.162.193.62</span><br><span class=\"line\">amir.ns.cloudflare.com. 20184   IN      A       172.64.33.62</span><br><span class=\"line\">amir.ns.cloudflare.com. 20184   IN      A       173.245.59.62</span><br><span class=\"line\">paityn.ns.cloudflare.com. 59423 IN      A       108.162.194.18</span><br><span class=\"line\">paityn.ns.cloudflare.com. 59423 IN      A       172.64.34.18</span><br><span class=\"line\">paityn.ns.cloudflare.com. 59423 IN      A       162.159.38.18</span><br><span class=\"line\"></span><br><span class=\"line\">;; Query time: 5 msec</span><br><span class=\"line\">;; SERVER: 223.5.5.5#53(223.5.5.5)</span><br><span class=\"line\">;; WHEN: Thu Mar 21 20:18:20 CST 2024</span><br><span class=\"line\">;; MSG SIZE  rcvd: 403</span><br></pre></td></tr></table></figure>\n\n<p>大约半小时时间，修改过后的spf记录仍然没有得到更新，持续关注中….</p>\n<p>纠正了这条spf相关的DNS记录以后，测试SMTP；显示成功：</p>\n<p><img data-src=\"https://img.carlzeng.com:3/i/2024/03/22/65fccd6f7a5fc.png\" alt=\"image-20240322081436077\"></p>\n<h3 id=\"DKIM-entry-记录\"><a href=\"#DKIM-entry-记录\" class=\"headerlink\" title=\"DKIM entry&#x2F;记录\"></a>DKIM entry&#x2F;记录</h3><p>关于如何获取dkim._domainkey.mydomain.com.的内容&#x2F;值，举例：</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\">&gt; </span><span class=\"language-bash\">docker <span class=\"built_in\">exec</span> -it iRedMail bash</span></span><br><span class=\"line\"></span><br><span class=\"line\">root@cc9dd27b3e25:/etc/amavis/conf.d# amavisd-new showkeys</span><br><span class=\"line\">; key#1 1024 bits, i=dkim, d=carlzeng.com, /opt/iredmail/custom/amavisd/dkim/carlzeng.com.pem</span><br><span class=\"line\">dkim._domainkey.carlzeng.com.   3600 TXT (</span><br><span class=\"line\">  &quot;v=DKIM1; p=&quot;</span><br><span class=\"line\">  &quot;MIGfMA0GCSqGSIb3DQEBAQUAA4GNADCBiQKBgQDDUF5BslOb2fARJjXK41xsAPSg&quot;</span><br><span class=\"line\">  &quot;hToQAkJzRuxp5pwaCyqPzIbFNxTZ66z9yw+rbeXYKdpu3bKemHhKVQ7rvnmVlFFL&quot;</span><br><span class=\"line\">  &quot;Nvef7Pk9ddT/nur2T1sfUY6yDu5QRcZArClAQRjfNCFRA11VgsD5q6OKS5GTNtE5&quot;</span><br><span class=\"line\">  &quot;dz3kJGpVdCllilo4OwIDAQAB&quot;)</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<h3 id=\"DMARC-entry-记录\"><a href=\"#DMARC-entry-记录\" class=\"headerlink\" title=\"DMARC entry&#x2F;记录\"></a>DMARC entry&#x2F;记录</h3><figure class=\"highlight ini\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">v</span>=DMARC1<span class=\"comment\">; p=reject; sp=none; adkim=s; aspf=s; rua=mailto:postmaster@carlzeng.com; ruf=mailto:postmaster@carlzeng.com</span></span><br></pre></td></tr></table></figure>\n\n\n\n<h2 id=\"端口映射\"><a href=\"#端口映射\" class=\"headerlink\" title=\"端口映射\"></a>端口映射</h2><p>这个步骤的作用是让路由器上接收到的邮件相关的数据，都转发给正确的邮件服务系统。</p>\n<table>\n<thead>\n<tr>\n<th>外部端口</th>\n<th>内部NAS&#x2F;Mail主机端口</th>\n<th>说明</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>‘587:587’</td>\n<td></td>\n<td></td>\n</tr>\n<tr>\n<td>‘465:465’</td>\n<td></td>\n<td></td>\n</tr>\n<tr>\n<td>‘25:25’</td>\n<td></td>\n<td></td>\n</tr>\n<tr>\n<td>‘993:993’</td>\n<td></td>\n<td></td>\n</tr>\n<tr>\n<td>‘143:143’</td>\n<td></td>\n<td></td>\n</tr>\n<tr>\n<td>‘995:995’</td>\n<td></td>\n<td></td>\n</tr>\n<tr>\n<td>‘110:110’</td>\n<td></td>\n<td></td>\n</tr>\n<tr>\n<td></td>\n<td></td>\n<td></td>\n</tr>\n<tr>\n<td>4433</td>\n<td>4433</td>\n<td>添加到443端口的访问可能</td>\n</tr>\n<tr>\n<td></td>\n<td></td>\n<td></td>\n</tr>\n</tbody></table>\n<p>将这些端口一一对应，很庆幸这些端口还没有被ISP屏蔽；</p>\n<p><img data-src=\"https://img.carlzeng.com:3/i/2024/03/01/65e142d55ffd2.png\" alt=\"image-20240301105204159\"></p>\n<h2 id=\"SMTP设置发邮件\"><a href=\"#SMTP设置发邮件\" class=\"headerlink\" title=\"SMTP设置发邮件\"></a>SMTP设置发邮件</h2><p>比如在<a href=\"https://bestbuy.carlzeng.com:3/admin#/smtp\">佰阅发卡kamifaka</a>中设置邮箱信息，用于消息通知之邮箱通知。</p>\n<p>错误：无法成功到达邮件目的地</p>\n<p>解决办法：详见‘错误及解决办法’的章节：SMTP服务测试</p>\n<p>调整了SPF的那条DNS记录（第二天发现生效），再次测试；可以正常发送测试邮箱。</p>\n<h2 id=\"错误及解决方法\"><a href=\"#错误及解决方法\" class=\"headerlink\" title=\"错误及解决方法\"></a>错误及解决方法</h2><h3 id=\"Docker启动错误：”Permission-denied”\"><a href=\"#Docker启动错误：”Permission-denied”\" class=\"headerlink\" title=\"Docker启动错误：”Permission denied”\"></a>Docker启动错误：”Permission denied”</h3><p>iRedMail   | &#x2F;usr&#x2F;sbin&#x2F;mysqld: Can’t create file ‘&#x2F;var&#x2F;lib&#x2F;mysql&#x2F;mysqld.err’ (errno: 13 “Permission denied”)<br>iRedMail   | 2024-02-28 16:12:07 0 [ERROR] mysqld: Can’t create&#x2F;write to file ‘&#x2F;var&#x2F;lib&#x2F;mysql&#x2F;aria_log_control’ (Errcode: 13 “Permission denied”)</p>\n<p>解决办法：</p>\n<p>chmod 777 -R &#x2F;volume2&#x2F;KingchuxingSSD512G&#x2F;docker&#x2F;compose&#x2F;iRedMail<br>chmod 777 -R &#x2F;volume2&#x2F;KingchuxingSSD512G&#x2F;docker&#x2F;compose&#x2F;iRedMail&#x2F;mysql&#x2F;</p>\n<h3 id=\"DNS设置错误之No-DMARC-Record-found\"><a href=\"#DNS设置错误之No-DMARC-Record-found\" class=\"headerlink\" title=\"DNS设置错误之No DMARC Record found\"></a>DNS设置错误之No DMARC Record found</h3><p>错误列表检测自：<a href=\"https://mxtoolbox.com/emailhealth/carlzeng.com/\">https://mxtoolbox.com/emailhealth/carlzeng.com/</a></p>\n<table>\n<thead>\n<tr>\n<th align=\"left\"></th>\n<th align=\"left\">Category</th>\n<th align=\"left\">Host</th>\n<th align=\"left\">Result</th>\n<th align=\"left\"></th>\n</tr>\n</thead>\n<tbody><tr>\n<td align=\"left\"><img data-src=\"https://images.mxtoolbox.com/public/images/statusicons/problem.png\" alt=\"Status Problem\"></td>\n<td align=\"left\">dmarc</td>\n<td align=\"left\">carlzeng.com</td>\n<td align=\"left\">No DMARC Record found</td>\n<td align=\"left\"><a href=\"https://mxtoolbox.com/problem/dmarc/DMARC-Record-Published?page=health_dmarc&hidetoc=0&hidepitch=0&showlogin=1&action=dmarc:carlzeng.com&domain=carlzeng.com\"><img data-src=\"https://images.mxtoolbox.com/public/images/statusicons/info.png\" alt=\"information\"> More Info</a></td>\n</tr>\n<tr>\n<td align=\"left\"><img data-src=\"https://images.mxtoolbox.com/public/images/statusicons/problem.png\" alt=\"Status Problem\"></td>\n<td align=\"left\">blacklist</td>\n<td align=\"left\">mail.carlzeng.com</td>\n<td align=\"left\">Blacklisted by UCEPROTECTL3</td>\n<td align=\"left\"><a href=\"https://mxtoolbox.com/problem/blacklist/UCEPROTECTL3?page=health_blacklist&hidetoc=0&hidepitch=0&showlogin=1&action=blacklist:mail.carlzeng.com&domain=carlzeng.com\"><img data-src=\"https://images.mxtoolbox.com/public/images/statusicons/info.png\" alt=\"information\"> More Info</a></td>\n</tr>\n<tr>\n<td align=\"left\"><img data-src=\"https://images.mxtoolbox.com/public/images/statusicons/problem.png\" alt=\"Status Problem\"></td>\n<td align=\"left\">mx</td>\n<td align=\"left\">carlzeng.com</td>\n<td align=\"left\">No DMARC Record found</td>\n<td align=\"left\"><a href=\"https://mxtoolbox.com/problem/mx/DMARC-Record-Published?page=health_mx&hidetoc=0&hidepitch=0&showlogin=1&action=mx:carlzeng.com&domain=carlzeng.com\"><img data-src=\"https://img.carlzeng.com:3/i/2024/02/29/65e089fcef838.png\" alt=\"information\"> More Info</a></td>\n</tr>\n</tbody></table>\n<p>错误解决：</p>\n<p>原来DNS记录的名称搞错了，正确的dmarc DNS记录名必须是（含下划线）：_dmarc</p>\n<h3 id=\"iredadmin操作不携带端口错误\"><a href=\"#iredadmin操作不携带端口错误\" class=\"headerlink\" title=\"iredadmin操作不携带端口错误\"></a>iredadmin操作不携带端口错误</h3><p>操作的后台<a href=\"https://iredmail.carlzeng.com:3/iredadmin%EF%BC%8C%E5%BD%93%E6%8F%90%E4%BA%A4%E6%96%B0%E7%9A%84%E7%A1%AE%E8%AE%A4%E6%93%8D%E4%BD%9C%E6%97%B6%EF%BC%8C%E9%A1%B5%E9%9D%A2%E8%B7%B3%E8%BD%AC%E5%88%B0%E6%9C%AA%E6%90%BA%E5%B8%A6%E7%AB%AF%E5%8F%A3%E7%8A%B6%E6%80%81\">https://iredmail.carlzeng.com:3/iredadmin，当提交新的确认操作时，页面跳转到未携带端口状态</a></p>\n<p>错误解决：</p>\n<p><img data-src=\"https://img.carlzeng.com:3/i/2024/03/01/65e139600f9ea.png\" alt=\"image-20240301101140381\"></p>\n<p>没有解决自动携带端口的问题，等待docker重启后继续测试</p>\n<h3 id=\"icloud通信受阻rejected-due-to-listing-in-Spamhaus-PBL\"><a href=\"#icloud通信受阻rejected-due-to-listing-in-Spamhaus-PBL\" class=\"headerlink\" title=\"icloud通信受阻rejected due to listing in Spamhaus PBL\"></a>icloud通信受阻rejected due to listing in Spamhaus PBL</h3><p>host mx01.mail.icloud.com[17.56.9.31] said: 550<br>  5.7.1 Mail from IP 111.197.216.113 was rejected due to listing in Spamhaus<br>  PBL. For details please see<br>  <a href=\"http://www.spamhaus.org/query/bl?ip=111.197.216.113\">http://www.spamhaus.org/query/bl?ip=111.197.216.113</a> (in reply to RCPT TO<br>  command)</p>\n<p>解决办法：</p>\n<p>去给定的<a href=\"https://check.spamhaus.org/\">IP AND DOMAIN REPUTATION CHECKER网站</a>上提交解封申请，提交成功后，如图：</p>\n<p><img data-src=\"https://img.carlzeng.com:3/i/2024/03/01/65e140a62c982.png\" alt=\"image-20240301104242813\"></p>\n<h3 id=\"程序发邮件被自我拦截为SPAM\"><a href=\"#程序发邮件被自我拦截为SPAM\" class=\"headerlink\" title=\"程序发邮件被自我拦截为SPAM\"></a>程序发邮件被自我拦截为SPAM</h3><p>从网站平台配置的SMTP，程序发邮件被自我拦截为SPAM；</p>\n<figure class=\"highlight ini\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Spam scanner report:</span><br><span class=\"line\"> Spam detection software, running on the system &quot;cc9dd27b3e25&quot;,</span><br><span class=\"line\"> has identified this incoming email as possible spam.  The original</span><br><span class=\"line\"> message has been attached to this so you can view it or label</span><br><span class=\"line\"> similar future email.  If you have any questions, see</span><br><span class=\"line\"> the administrator of that system for details.</span><br><span class=\"line\"></span><br><span class=\"line\"> Content preview:  Test send email</span><br></pre></td></tr></table></figure>\n\n<p>解决办法： 未知，如何关闭自己对自己发邮件的过度SPAM检测（邮件不是SPAM，系统误判）。。。</p>\n<p>- <a href=\"https://docs.iredmail.org/disable.spam.virus.scanning.for.outgoing.mails.html\">https://docs.iredmail.org/disable.spam. … mails.html</a><br>- <a href=\"https://docs.iredmail.org/completely.disable.amavisd.clamav.spamassassin.html\">https://docs.iredmail.org/completely.di … assin.html</a></p>\n<blockquote>\n<p>docker exec -it iRedMail bash</p>\n</blockquote>\n<p>没有找到这个文件：&#x2F;etc&#x2F;amavis&#x2F;conf.d&#x2F;50-user</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"># @bypass_virus_checks_maps = (1);  # controls running of anti-virus code</span><br><span class=\"line\"># @bypass_spam_checks_maps  = (1);  # controls running of anti-spam code</span><br></pre></td></tr></table></figure>\n\n<p>Restarting Amavisd service is required after changing settings.</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&gt; service  amavis restart                                                     </span><br><span class=\"line\">Stopping amavisd: amavisd-new.                                                                                    </span><br><span class=\"line\">Starting amavisd: amavisd-new.              </span><br></pre></td></tr></table></figure>\n\n<p>environment:</p>\n<p>TZ&#x3D;Asia&#x2F;Shanghai</p>\n<p>发现：使用最初的账户没有这个误判的情况。</p>\n<h3 id=\"是否可删除mail-的DNS记录？\"><a href=\"#是否可删除mail-的DNS记录？\" class=\"headerlink\" title=\"是否可删除mail.**的DNS记录？\"></a>是否可删除mail.**的DNS记录？</h3><p>由于设定了泛域名解析道正确的IP <em>，目前增加的这条mail.carlzeng.com反而增加了DDNS需要去轮询更新IP的任务数，没有这条DNS解析，直接ping mail.</em>* 也一样得到最新且正确的IP地址。</p>\n<p>待实践核实&#x2F;测试… (理论上没问题，因为iodine已经成功删除&#x2F;优化掉A记录）</p>\n<h3 id=\"维护定时任务\"><a href=\"#维护定时任务\" class=\"headerlink\" title=\"维护定时任务\"></a>维护定时任务</h3><p>每天邮箱中都收到6封系统自动备份的邮件：</p>\n<figure class=\"highlight txt\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Cron &lt;root@c7e4835b8e6d&gt; /bin/bash /var/vmail/backup/backup_mysql.sh </span><br><span class=\"line\"></span><br><span class=\"line\">/bin/sh: 1: freshclam: not found</span><br><span class=\"line\"></span><br><span class=\"line\">/etc/cron.daily/logrotate:</span><br><span class=\"line\">invoke-rc.d: could not determine current runlevel</span><br><span class=\"line\">invoke-rc.d: policy-rc.d denied execution of reload-log.</span><br></pre></td></tr></table></figure>\n\n<p>进入docker</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">docker exec -it iRedMail bash   </span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">编辑Linux中的定时任务的命令</span></span><br><span class=\"line\">crontab -e</span><br></pre></td></tr></table></figure>\n\n<p>注释掉</p>\n<figure class=\"highlight txt\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">#40 3 * * * /bin/bash /var/vmail/backup/backup_mysql.sh </span><br><span class=\"line\"></span><br><span class=\"line\">#Ansible: freshclam: update database regularly.</span><br><span class=\"line\">#1 */6 * * * freshclam --quiet --foreground --config-file=/etc/clamav/freshclam.conf --daemon-notify=/etc/clamav/clamd.conf &gt;/dev/null</span><br><span class=\"line\"></span><br><span class=\"line\">#Ansible: Scan spam/ham reported by end users.</span><br><span class=\"line\">#*/10 * * * * /bin/bash /opt/iredmail/bin/dovecot/scan_reported_mails &gt;/dev/null</span><br></pre></td></tr></table></figure>\n\n<p>感受：去掉这些每天的自动备份功能以后，清爽许多 :-)</p>\n<p>尴尬的是，这种进bash编辑的方式，重启整个NAS后，编辑的内容会重置，还得再去编辑….</p>\n<p>这次NAS运行81天多才重启一次，暂且用这种收邮件的方式就知道docker中的内容被恢复了。</p>\n<h3 id=\"纠正邮件系统的时区\"><a href=\"#纠正邮件系统的时区\" class=\"headerlink\" title=\"纠正邮件系统的时区\"></a>纠正邮件系统的时区</h3><p>修改docker-compose文件，在volumes下面新增这条，可纠正邮件系统的时区：</p>\n<ul>\n<li>“&#x2F;etc&#x2F;localtime:&#x2F;etc&#x2F;localtime:ro” #这条可纠正邮件系统的时区</li>\n</ul>\n<h3 id=\"SMTP服务测试\"><a href=\"#SMTP服务测试\" class=\"headerlink\" title=\"SMTP服务测试\"></a>SMTP服务测试</h3><p><a href=\"https://www.gmass.co/smtp-test#\">SMTP Test Tool</a></p>\n<p>​\t优点：实时显示详细的debug日志。赞！</p>\n<p><a href=\"https://smtpserver.com/mail-tester\">Email Check Spam Score and Improve Quality</a></p>\n<p>​\t优点：可以检测出详细的DNS配置错误（如果有错误的话），并给出修正的建议。赞！</p>\n<h3 id=\"iredMail证书配置\"><a href=\"#iredMail证书配置\" class=\"headerlink\" title=\"iredMail证书配置\"></a>iredMail证书配置</h3><p>Using <a href=\"http://www.checktls.com/\">http://www.checktls.com/</a>, it’s clear that the Zendesk TLS cert is incorrect in that it doesn’t specify that mail.pod-4 host.</p>\n<p><img data-src=\"https://img.carlzeng.com:3/i/2024/03/28/6605735e21430.png\" alt=\"image-20240328214042643\"></p>\n<p>从这点来看，可能是自签证书的问题？那么如何替换和生成一个证书呢？</p>\n<p>测试配置步骤：</p>\n<ol>\n<li>下载NPM中生成的泛域名证书，得到certificate.zip，解压缩一共是4个文件。</li>\n<li>上传fullchain.pem 和 privkey.pem 到 映射的目录中（&#x2F;KingchuxingSSD512G&#x2F;docker&#x2F;compose&#x2F;iRedMail&#x2F;ssl），分别重命名为iRedMail.crt 和 iRedMail.key。再重新上传一遍（备份原文件名）</li>\n<li>测试<a href=\"https://www.ssllabs.com/ssltest/index.html\">https://www.ssllabs.com/ssltest/index.html</a> 和 <a href=\"https://www.checktls.com/\">https://www.checktls.com/</a></li>\n<li></li>\n<li></li>\n</ol>\n<p>本章节参考：</p>\n<p><a href=\"https://docs.iredmail.org/use.a.bought.ssl.certificate.html\">Use a bought SSL certificate</a></p>\n<p><a href=\"https://docs.iredmail.org/letsencrypt.html\">Request a free cert from Let’s Encrypt (for servers deployed with downloadable iRedMail installer)</a></p>\n<p><img data-src=\"https://img.carlzeng.com:3/i/2024/04/23/66271bd148a22.png\" alt=\"image-20240423102406511\"></p>\n<p>确保证书是： mail.carlzeng.com<br>    使用dns challenge的方式，dns_cloudflare_api_token<br>    Processing… This might take a few minutes.</p>\n<p><a href=\"https://dash.cloudflare.com/profile/api-tokens\">https://dash.cloudflare.com/profile/api-tokens</a><br>    &gt; Global API Key</p>\n<p>fail to get the cert by dns challenge<br>    成功了，原来不是使用Global API KEY；要使用”API 令牌”中的‘创建令牌’ 》 编辑区域 DNS\t</p>\n<p><img data-src=\"https://img.carlzeng.com:3/i/2024/04/23/662722fde4c91.png\" alt=\"image-20240423105448516\"></p>\n<p>cp mail.jbritian.com_bundle.crt cert.pem </p>\n<p>cp mail.jbritian.com_bundle.crt combined.pem </p>\n<p>cp mail.jbritian.com.key key.pem</p>\n<p><img data-src=\"https://img.carlzeng.com:3/i/2024/04/23/662725ef860df.png\" alt=\"image-20240423110722391\"></p>\n<p>cert1.pem 重命名成： cert.pem </p>\n<p>fullchain1.pem 重命名成：combined.pem</p>\n<p>privkey1.pem 重命名成：key.pem</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ln -s /etc/letsencrypt/live/mail.mydomain.com/fullchain.pem /etc/ssl/certs/iRedMail.crt</span><br><span class=\"line\">ln -s /etc/letsencrypt/live/mail.mydomain.com/privkey.pem /etc/ssl/private/iRedMail.key</span><br></pre></td></tr></table></figure>\n\n<p>都检查过这些组件了，确实都是映射到容器中的 &#x2F;opt&#x2F;iredmail&#x2F;ssl 目录中的三个文件</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Postfix</span><br><span class=\"line\">File /etc/postfix/main.cf (on Linux/OpenBSD)</span><br><span class=\"line\"></span><br><span class=\"line\">Dovecot</span><br><span class=\"line\">File `/etc/dovecot/dovecot.conf` (on Linux/OpenBSD) </span><br><span class=\"line\"></span><br><span class=\"line\">Nginx</span><br><span class=\"line\">File /etc/nginx/templates/ssl.tmpl (on Linux/OpenBSD)</span><br><span class=\"line\"></span><br><span class=\"line\">MySQL, MariaDB</span><br><span class=\"line\">On Debian and Ubuntu, it&#x27;s defined in /etc/mysql/my.cnf.</span><br></pre></td></tr></table></figure>\n\n<p>TXT记录变更：<br>    v&#x3D;spf1 a mx include:_spf.google.com ~all<br>    v&#x3D;spf1 mx -all</p>\n<hr>\n<h1 id=\"以下为踩坑记录-请跳过\"><a href=\"#以下为踩坑记录-请跳过\" class=\"headerlink\" title=\"以下为踩坑记录(请跳过)\"></a>以下为踩坑记录(请跳过)</h1><h2 id=\"docker-mailserver\"><a href=\"#docker-mailserver\" class=\"headerlink\" title=\"docker-mailserver\"></a>docker-mailserver</h2><p>docker-compose.yml (docker-mailserver)</p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">services:</span></span><br><span class=\"line\">  <span class=\"attr\">mailserver:</span></span><br><span class=\"line\">    <span class=\"attr\">image:</span> <span class=\"string\">ghcr.io/docker-mailserver/docker-mailserver:latest</span></span><br><span class=\"line\">    <span class=\"attr\">container_name:</span> <span class=\"string\">mailserver</span></span><br><span class=\"line\">    <span class=\"comment\"># Provide the FQDN of your mail server here (Your DNS MX record should point to this value)</span></span><br><span class=\"line\">    <span class=\"attr\">hostname:</span> <span class=\"string\">mail.carlzeng.com</span></span><br><span class=\"line\">    <span class=\"attr\">ports:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">&quot;25:25&quot;</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">&quot;465:465&quot;</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">&quot;587:587&quot;</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">&quot;993:993&quot;</span></span><br><span class=\"line\">    <span class=\"attr\">volumes:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">./mail-data/:/var/mail/</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">./mail-state/:/var/mail-state/</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">./mail-logs/:/var/log/mail/</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">./config/:/tmp/docker-mailserver/</span></span><br><span class=\"line\">    <span class=\"attr\">environment:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">ENABLE_RSPAMD=0</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">ENABLE_CLAMAV=0</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">ENABLE_FAIL2BAN=1</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">TZ=Asia/Shanghai</span></span><br><span class=\"line\">    <span class=\"attr\">cap_add:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">NET_ADMIN</span> <span class=\"comment\"># For Fail2Ban to work</span></span><br><span class=\"line\">    <span class=\"attr\">restart:</span> <span class=\"string\">always</span></span><br></pre></td></tr></table></figure>\n\n\n\n<p>docker-compose up 测试中…</p>\n<p>下一步要生成配置文件？</p>\n<p>docker exec -ti mailserver setup</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">mailserver    | [ WARNING ]  You need at least one mail account to start Dovecot (120s left for account creation before shutdown)</span><br></pre></td></tr></table></figure>\n\n\n\n<p>docker exec -ti mailserver setup email add <a href=\"mailto:&#x73;&#x65;&#x72;&#118;&#x69;&#99;&#x65;&#64;&#x63;&#x61;&#x72;&#108;&#122;&#101;&#110;&#x67;&#46;&#99;&#x6f;&#x6d;\">&#x73;&#x65;&#x72;&#118;&#x69;&#99;&#x65;&#64;&#x63;&#x61;&#x72;&#108;&#122;&#101;&#110;&#x67;&#46;&#99;&#x6f;&#x6d;</a></p>\n<p>解决办法：未知</p>\n<p>文档信息：</p>\n<p><a href=\"https://github.com/docker-mailserver/docker-mailserver?tab=readme-ov-file\">https://github.com/docker-mailserver/docker-mailserver?tab=readme-ov-file</a></p>\n<p><a href=\"https://docker-mailserver.github.io/docker-mailserver/latest/\">https://docker-mailserver.github.io/docker-mailserver/latest/</a></p>\n<h2 id=\"postfix-and-postfixadmin\"><a href=\"#postfix-and-postfixadmin\" class=\"headerlink\" title=\"postfix and postfixadmin\"></a>postfix and postfixadmin</h2><p>docker-compose for postfix and postfixadmin</p>\n<p>postfixadmin<br>    Postfix Admin is a web based interface to configure and manage a Postfix based email server for many users.</p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">version:</span> <span class=\"string\">&#x27;3&#x27;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attr\">services:</span></span><br><span class=\"line\">  <span class=\"attr\">db:</span></span><br><span class=\"line\">    <span class=\"attr\">image:</span> <span class=\"string\">mysql:8.0</span></span><br><span class=\"line\">    <span class=\"attr\">restart:</span> <span class=\"string\">always</span></span><br><span class=\"line\">    <span class=\"attr\">environment:</span></span><br><span class=\"line\">      <span class=\"attr\">MYSQL_RANDOM_ROOT_PASSWORD:</span> <span class=\"number\">1</span></span><br><span class=\"line\">      <span class=\"attr\">MYSQL_DATABASE:</span> <span class=\"string\">postfixadmin</span></span><br><span class=\"line\">      <span class=\"attr\">MYSQL_USER:</span> <span class=\"string\">postfixadmin</span></span><br><span class=\"line\">      <span class=\"attr\">MYSQL_PASSWORD:</span> <span class=\"string\">example</span></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"attr\">postfixadmin:</span></span><br><span class=\"line\">    <span class=\"attr\">depends_on:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">db</span></span><br><span class=\"line\">    <span class=\"attr\">image:</span> <span class=\"string\">postfixadmin</span></span><br><span class=\"line\">    <span class=\"attr\">ports:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"number\">8000</span><span class=\"string\">:80</span></span><br><span class=\"line\">    <span class=\"attr\">restart:</span> <span class=\"string\">always</span></span><br><span class=\"line\">    <span class=\"attr\">environment:</span></span><br><span class=\"line\">      <span class=\"attr\">POSTFIXADMIN_DB_TYPE:</span> <span class=\"string\">mysqli</span></span><br><span class=\"line\">      <span class=\"attr\">POSTFIXADMIN_DB_HOST:</span> <span class=\"string\">db</span></span><br><span class=\"line\">      <span class=\"attr\">POSTFIXADMIN_DB_USER:</span> <span class=\"string\">postfixadmin</span></span><br><span class=\"line\">      <span class=\"attr\">POSTFIXADMIN_DB_NAME:</span> <span class=\"string\">postfixadmin</span></span><br><span class=\"line\">      <span class=\"attr\">POSTFIXADMIN_DB_PASSWORD:</span> <span class=\"string\">example</span></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<p>Where to file issues:<br><a href=\"https://github.com/postfixadmin/docker/issues\">https://github.com/postfixadmin/docker/issues</a></p>\n<h3 id=\"还差一个靠谱可用的postfix\"><a href=\"#还差一个靠谱可用的postfix\" class=\"headerlink\" title=\"还差一个靠谱可用的postfix\"></a>还差一个靠谱可用的postfix</h3><p><a href=\"https://gitlab.com/tozd/docker/postfix\">https://gitlab.com/tozd/docker/postfix</a></p>\n<p><a href=\"https://gitlab.com/tozd/docker/mail\">https://gitlab.com/tozd/docker/mail</a></p>\n<p><a href=\"https://hub.docker.com/r/tozd/postfix\">https://hub.docker.com/r/tozd/postfix</a></p>\n<h3 id=\"Ports\"><a href=\"#Ports\" class=\"headerlink\" title=\"Ports\"></a>Ports</h3><ul>\n<li><code>25/tcp</code>: SMTP port.</li>\n<li><code>465/tcp</code>: SMTPS port.</li>\n<li><code>587/tcp</code>: Mail submission port.</li>\n</ul>\n<p>alpine-316&#96;: Postfix 3.7.6</p>\n<p><a href=\"https://hub.docker.com/search?q=postfix\">https://hub.docker.com/search?q=postfix</a></p>\n<p>另外一个是：<a href=\"https://github.com/catatnight/docker-postfix\">https://github.com/catatnight/docker-postfix</a></p>\n<p>Note：这是我找到唯一简便安装且能正常使用的邮件系统，请留言告诉我你是否有更好的自建解决方案。</p>\n<h1 id=\"感谢列表\"><a href=\"#感谢列表\" class=\"headerlink\" title=\"感谢列表\"></a>感谢列表</h1><p><a href=\"https://kydsj.vip/doku.php?id=wiki:%E8%87%AA%E6%89%98%E7%AE%A1-%E7%94%B5%E5%AD%90%E9%82%AE%E4%BB%B6\">开源大世界-自托管-电子邮件</a></p>\n<p><a href=\"https://www.youtube.com/watch?v=qnnf3LWcUXA\">Running iRedMail E-Mail Server in Docker</a></p>\n<p><a href=\"https://docs.iredmail.org/setup.dns.html#mx\">Setup DNS records for your iRedMail server (A, PTR, MX, SPF, DKIM, DMARC)</a></p>\n<p><a href=\"https://www.youtube.com/watch?v=ScarlmgD0dU\">From zero to full mail server in 20 minutes with Mailu Docker images!</a></p>\n<p><a href=\"HTTPS/SSL%E8%AF%81%E4%B9%A6%E9%85%8D%E7%BD%AE\">HTTPS&#x2F;SSL证书配置</a></p>","categories":[{"name":"email","path":"api/categories/email.json"}],"tags":[{"name":"docker","path":"api/tags/docker.json"},{"name":"email","path":"api/tags/email.json"},{"name":"iRedMail","path":"api/tags/iRedMail.json"}]}
{"title":"OpenWrt >  ADSL单线多拨，负载均衡（仅供参考）-CarlZeng","slug":"OpenWrt-ADSL单线多拨，负载均衡（仅供参考）-CarlZeng","date":"2016-03-22T13:29:00.000Z","updated":"2023-10-02T02:27:29.031Z","comments":true,"path":"api/articles/OpenWrt-ADSL单线多拨，负载均衡（仅供参考）-CarlZeng.json","excerpt":null,"covers":["http://images2015.cnblogs.com/blog/41238/201603/41238-20160323125607870-97593375.jpg","http://images2015.cnblogs.com/blog/41238/201603/41238-20160326151505526-1086117574.jpg","http://images.cnblogs.com/OutliningIndicators/ContractedBlock.gif","http://images.cnblogs.com/OutliningIndicators/ContractedBlock.gif","http://images.cnblogs.com/OutliningIndicators/ContractedBlock.gif","http://images.cnblogs.com/OutliningIndicators/ContractedBlock.gif"],"content":"<ul>\n<li>2021年11月更新：如果是K2P A2版本硬件，请参考更简易的步骤，更加高效，不需要太多代码知识。 <a href=\"https://www.cnblogs.com/backuper/p/15523365.html\">K2P刷机-坐标北京Unicom</a></li>\n</ul>\n<p><strong>前题</strong></p>\n<hr>\n<ul>\n<li>硬件：路由器，刷入<a href=\"https://openwrt.org/\">OpenWrt</a></li>\n<li>一些背景知识和动手能力</li>\n</ul>\n<p><strong>目标效果图</strong></p>\n<hr>\n<p><img data-src=\"http://images2015.cnblogs.com/blog/41238/201603/41238-20160323125607870-97593375.jpg\" alt=\"实际例子Sample \"></p>\n<p><img data-src=\"http://images2015.cnblogs.com/blog/41238/201603/41238-20160326151505526-1086117574.jpg\"></p>\n<p><strong>步骤</strong></p>\n<hr>\n<ol>\n<li><p>使用SSH 登陆路由器。I.e. ssh <a href=\"mailto:&#114;&#x6f;&#x6f;&#x74;&#64;&#49;&#x39;&#x32;&#x2e;&#49;&#x36;&#x38;&#46;&#50;&#x2e;&#x31;\">&#114;&#x6f;&#x6f;&#x74;&#64;&#49;&#x39;&#x32;&#x2e;&#49;&#x36;&#x38;&#46;&#50;&#x2e;&#x31;</a></p>\n</li>\n<li><p>运行&#x2F;usr&#x2F;bin&#x2F;duobo。日志类似：</p>\n</li>\n<li><p><img data-src=\"http://images.cnblogs.com/OutliningIndicators/ContractedBlock.gif\"><img data-src=\"http://images.cnblogs.com/OutliningIndicators/ExpandedBlockStart.gif\"></p>\n<p>sh: 2: unknown operand<br>Killed<br>Warning: Unable to locate ipset utility, disabling ipset support * Flushing IPv4 filter table * Flushing IPv4 nat table * Flushing IPv4 mangle table * Flushing IPv4 raw table * Flushing conntrack table … * Populating IPv4 filter table * Zone ‘lan’<br>   * Zone ‘wan’<br>   * Rule ‘Allow-DHCP-Renew’<br>   * Rule ‘Allow-Ping’<br>   * Rule ‘51413’<br>   * Rule ‘9091’<br>   * Rule ‘9000’<br>   * Rule ‘6800’<br>   * Forward ‘lan’ -&gt; ‘wan’<br> * Populating IPv4 nat table * Zone ‘lan’<br>   * Zone ‘wan’<br> * Populating IPv4 mangle table * Zone ‘lan’<br>   * Zone ‘wan’<br> * Populating IPv4 raw table * Zone ‘lan’<br>   * Zone ‘wan’<br> * Set tcp_ecn to off * Set tcp_syncookies to on * Set tcp_window_scaling to on * Running script ‘&#x2F;etc&#x2F;firewall.user’<br> * Running script ‘&#x2F;usr&#x2F;share&#x2F;miniupnpd&#x2F;firewall.include’<br> * Running script ‘&#x2F;usr&#x2F;share&#x2F;qos_gargoyle&#x2F;firewall.include’<br>   ! Failed with exit code 1 ___________________________________________________<br>开始第1次拔号………..<br>正在并发拔号中………….<br>等待3秒………….<br>[3]拔[0]拔成功, 小于设定的[2]拔，将重新拔号…</p>\n<p>_________________________</p>\n<p>View Code</p>\n</li>\n<li><p>_如果没有成功并发多播，根据提示信息调整duobo的内部参数设置，重新运行_。分享一些技巧：</p>\n</li>\n<li><p>number&#x3D;10 #number是重拔次数，本脚本启动后一共尝试的次数 n=7 #n是几拔，同时发出几拨，理论上设置越大成功概率越大！ ok=2 #ok是拔上几次后退出拔号, 要实现的预期目标<br>wait=5 #wait time 每次单线多拨失败后，重试的等待时间</p>\n<ul>\n<li><strong>原则：</strong>失败多次以后，建议冷重启路由器，多个运行中的脚本会互相冲突，把问题复杂化。</li>\n<li><strong>多拨失败以后，耐心等上1分钟；很多次的多播成功都是脚本完成以后退出，然后60秒内获取了超过预期的多条链接。</strong></li>\n<li><strong>把n调到7，这样会虚拟出很多wan接口，根据硬件性能，理论上设置越大成功概率越大！</strong></li>\n<li>将ok调低一点，比如2。我觉得别太贪心，如果能稳定多播2个ADSL的IP，那其实概率上更折中了稳定性和高负载下的带宽均衡。</li>\n<li>wait的时间我感觉5秒－8秒差不多，这个要看运行日志，做相应调整。</li>\n<li>看懂程序的原理，根据实际情况调整脚本程序。比如：这个版本的程序是这么多播的，ifup $prefix$i</li>\n</ul>\n</li>\n</ol>\n<p><strong>遗留问题</strong></p>\n<hr>\n<p><img data-src=\"http://images.cnblogs.com/OutliningIndicators/ContractedBlock.gif\"><img data-src=\"http://images.cnblogs.com/OutliningIndicators/ExpandedBlockStart.gif\"></p>\n<p> 1 开始第3次拔号………..<br> 2 正在并发拔号中………….<br> 3 等待10秒………….<br> 4 pppoe-wan Link encap:Point-to-Point Protocol<br> 5 pppoe-wan3 Link encap:Point-to-Point Protocol<br> 6 [3]拔[2]拔成功, 大于或等于设定的[2]拨，退出拔号…<br> 7 Error: an inet address is expected rather than “dev”.<br> 8 iptables v1.4.10: Couldn’t load target `zone_wan_notrack’:File not found<br> 9<br>10 Try `iptables -h’ or ‘iptables –help’ for more information.<br>11 iptables v1.4.10: Couldn’t load target `zone_wan_nat’:File not found 12<br>13 Try `iptables -h’ or ‘iptables –help’ for more information.<br>14 iptables: No chain&#x2F;target&#x2F;match by that name. 15 iptables v1.4.10: Couldn’t load target `zone_wan’:File not found 16<br>17 Try `iptables -h’ or ‘iptables –help’ for more information.<br>18 iptables: No chain&#x2F;target&#x2F;match by that name. 19 iptables: No chain&#x2F;target&#x2F;match by that name. 20 iptables: No chain&#x2F;target&#x2F;match by that name. 21 iptables: No chain&#x2F;target&#x2F;match by that name. 22 iptables: No chain&#x2F;target&#x2F;match by that name. 23 iptables: No chain&#x2F;target&#x2F;match by that name. 24 iptables: No chain&#x2F;target&#x2F;match by that name. 25 Error: an inet address is expected rather than “dev”. 26 iptables v1.4.10: Couldn’t load target `zone_wan_notrack’:File not found 27<br>28 Try `iptables -h’ or ‘iptables –help’ for more information.<br>29 iptables v1.4.10: Couldn’t load target `zone_wan_nat’:File not found 30<br>31 Try `iptables -h’ or ‘iptables –help’ for more information.<br>32 iptables: No chain&#x2F;target&#x2F;match by that name. 33 iptables v1.4.10: Couldn’t load target `zone_wan’:File not found 34<br>35 Try `iptables -h’ or ‘iptables –help’ for more information.<br>36 iptables: No chain&#x2F;target&#x2F;match by that name. 37 iptables: No chain&#x2F;target&#x2F;match by that name. 38 iptables: No chain&#x2F;target&#x2F;match by that name. 39 iptables: No chain&#x2F;target&#x2F;match by that name. 40 iptables: No chain&#x2F;target&#x2F;match by that name. 41 iptables: No chain&#x2F;target&#x2F;match by that name. 42 iptables: No chain&#x2F;target&#x2F;match by that name. 43 Error: an IP address is expected rather than “dev”<br>44 192.168.2.0&#x2F;24 dev br-lan  proto kernel  scope link  src 192.168.2.1<br>45 221.218.232.1 dev pppoe-wan3  proto kernel  scope link  src 123.112.248.148<br>46 221.218.232.1 dev pppoe-wan  proto kernel  scope link  src 221.218.236.51<br>47 Kernel IP routing table 48 Destination     Gateway         Genmask         Flags Metric Ref    Use Iface 49 192.168.2.0     0.0.0.0         255.255.255.0   U     0      0        0 br-lan 50 221.218.232.1   0.0.0.0         255.255.255.255 UH    0      0        0 pppoe-wan3 51 221.218.232.1   0.0.0.0         255.255.255.255 UH    0      0        0 pppoe-wan</p>\n<p>View Error Code</p>\n<p>显然这个0.3版本的脚本不完全适用于我的路由器，有时间我需要查查原因。</p>\n<p>估计都是关于iptables</p>\n<p>有没有大侠探讨一下？</p>\n<p><em>修正了下面版本中的一个错误</em></p>\n<p><em>line 19：if [ $j -ge $ok ] ;</em></p>\n<p><strong>多拨代码(V0.3)</strong></p>\n<hr>\n<p><img data-src=\"http://images.cnblogs.com/OutliningIndicators/ContractedBlock.gif\"><img data-src=\"http://images.cnblogs.com/OutliningIndicators/ExpandedBlockStart.gif\"></p>\n<p> 1 #!&#x2F;bin&#x2F;sh<br> 2 #modified by muziling v0.3<br> 3 #并发多拨脚本<br> 4<br> 5 #number是重拔次数<br> 6 #n是几拔<br> 7 #ok是拔上几次后退出拔号<br> 8 #wait time<br> 9<br> 10 number&#x3D;10<br> 11 n&#x3D;3<br> 12 ok&#x3D;2<br> 13 wait=5<br> 14 # avoid same with feixiang’s N-WAN naming and must start with “wan”<br> 15 prefix&#x3D;wan<br> 16 vthprefix&#x3D;vth<br> 17<br> 18 j&#x3D;$(ifconfig | grep pppoe-wan | wc -l)<br> 19 if [ “$j” &gt;&#x3D; “$ok” ] ; 20 then<br> 21     echo 已经是[$j]拔了，退出拔号… 22     exit 0<br> 23 fi<br> 24<br> 25 if [ -f &#x2F;etc&#x2F;config&#x2F;nwannumset ] ;<br> 26 then<br> 27     uci set nwannumset.@macvlan_numset[0].macvlan_num&#x3D;1<br> 28     uci commit nwannumset<br> 29 fi<br> 30 for i in $( seq 1 $(($n-1)))<br> 31 do<br> 32     ifname&#x3D;$prefix$i<br> 33     ifvth&#x3D;$vthprefix$i<br> 34     #ifwan&#x3D;$(uci get network.wan.ifname)<br> 35     pppoe_name&#x3D;$(uci get network.wan.username)<br> 36     pppoe_pw&#x3D;$(uci get network.wan.password)<br> 37<br> 38     if [ $(ip link | grep “ ${ifvth}@eth0.2:” | wc -l) &#x3D;&#x3D; “0” ] ; 39     then<br> 40         macfac&#x3D;$(ifconfig | grep eth0.2 | tr -s “ “ | cut -d “ “ -f5 | cut -b 1-8)<br> 41         mac&#x3D;”$macfac:”$(md5sum &#x2F;proc&#x2F;sys&#x2F;kernel&#x2F;random&#x2F;uuid | sed ‘s&#x2F;\\(..\\)&#x2F;&amp;:&#x2F;g’ | cut -b 1-8 | tr [a-f] [A-F])<br> 42         ip link add link eth0.2 $ifvth type macvlan 43         ifconfig $ifvth hw ether $mac 44     fi<br> 45<br> 46     # add &#x2F;etc&#x2F;config&#x2F;network<br> 47     uci delete network.$ifname<br> 48     uci set network.$ifname&#x3D;interface<br> 49     uci set network.$ifname.ifname&#x3D;$ifvth<br> 50     #uci set network.$ifname._orig_ifname&#x3D;eth0.2<br> 51     #uci set network.$ifname._orig_bridge&#x3D;false<br> 52     uci set network.$ifname.proto&#x3D;pppoe<br> 53     uci set network.$ifname.username&#x3D;$pppoe_name<br> 54     uci set network.$ifname.password&#x3D;$pppoe_pw<br> 55     uci set network.$ifname.auto&#x3D;0<br> 56     uci set network.$ifname.defaultroute&#x3D;0<br> 57     uci set network.$ifname.peerdns&#x3D;1<br> 58     uci set network.$ifname.pppd_options&#x3D;”plugin rp-pppoe.so syncppp $n”<br> 59<br> 60     # add &#x2F;etc&#x2F;config&#x2F;dhcp<br> 61     uci delete dhcp.$ifvth<br> 62     uci set dhcp.$ifvth&#x3D;dhcp<br> 63     uci set dhcp.$ifvth.interface&#x3D;$ifname<br> 64     uci set dhcp.$ifvth.ignore&#x3D;1<br> 65<br> 66     if [ -f &#x2F;etc&#x2F;config&#x2F;nwan ] ;<br> 67     then<br> 68         uci delete nwan.$ifname<br> 69         uci set nwan.$ifname&#x3D;interface<br> 70         uci set nwan.$ifname.name&#x3D;telecom<br> 71         uci set nwan.$ifname.route&#x3D;balance<br> 72         uci set nwan.$ifname.weight&#x3D;1<br> 73         uci set nwan.$ifname.uptime=0day,0hour,0min<br> 74         uci commit nwan<br> 75     fi<br> 76 done<br> 77 uci set network.wan.defaultroute&#x3D;0<br> 78 uci set network.wan.peerdns&#x3D;1<br> 79 uci set network.wan.pppd_options&#x3D;”plugin rp-pppoe.so syncppp $n”<br> 80 uci commit network<br> 81 uci commit dhcp<br> 82<br> 83 fw_wan_list&#x3D;$(uci show network |grep &#x3D;interface |grep -v lan|grep -v loopback |cut -d”.” -f2 | awk -F “=“ ‘{printf $1” “}’)<br> 84 uci set firewall.@zone[1].network&#x3D;”$fw_wan_list”<br> 85 uci commit firewall<br> 86 &#x2F;etc&#x2F;init.d&#x2F;firewall restart<br> 87<br> 88 for q in $( seq 1 $number ) 89 do<br> 90     echo<br> 91     echo ___________________________________________________ 92     echo 开始第$q次拔号……….. 93     killall -q -SIG pppd<br> 94     if [ “$q” &#x3D;&#x3D; “1” ] ; 95     then<br> 96         for i in $( seq 1 $(($n-1)))<br> 97         do<br> 98             ifup $prefix$i<br> 99         done<br>100     fi<br>101<br>102     echo 正在并发拔号中…………. 103     echo 等待$wait秒…………. 104     sleep $wait<br>105<br>106     j&#x3D;$(ps | grep pppd | wc -l) 107     ! [ “$j” -ge “$n” ]  &amp;&amp; ifup ${prefix}1<br>108<br>109     ifconfig|grep pppoe 110     j&#x3D;$(ifconfig | grep pppoe-wan | wc -l) 111<br>112     ! [ “$j” -ge “$ok” ] &amp;&amp; echo [$n]拔[$j]拔成功, 小于设定的[$ok]拔，将重新拔号… 113     [ “$j” -ge “$ok” ] &amp;&amp; echo [$n]拔[$j]拔成功, 大于或等于设定的[$ok]拨，退出拔号… 114<br>115     if [ “$j” -ge “$ok” ] ; 116     then<br>117         for i in $( seq 0 $(($n-1))) 118         do<br>119             if [ “$i” &#x3D;&#x3D; “0” ] ; 120             then<br>121                 interface&#x3D;wan 122             else<br>123                 interface&#x3D;$prefix$i 124             fi<br>125             if [ $(ifconfig | grep “pppoe-$interface “ | wc -l) &#x3D;&#x3D; “0” ] ; 126             then<br>127 ifdown $interface 128             fi<br>129         done<br>130 break 131     fi<br>132 done<br>133 # kill ddns sleep and re-check wan ip change 134 killall sleep<br>135<br>136 j&#x3D;$(ifconfig | grep pppoe-wan | wc -l) 137 ! [ “$j” -ge 0 ] &amp;&amp; reboot 138<br>139 #ppoename&#x3D;$(ifconfig |grep ‘ppoe-‘ |awk ‘{print substr($1,7)}’|tr ‘\\n’ ‘ ‘) 140 ppoename&#x3D;$(ifconfig |grep ‘ppoe-‘ |awk ‘{print $1}’|tr ‘\\n’ ‘ ‘) 141 i&#x3D;0<br>142 vias&#x3D;””<br>143 for wan_ifname in $ppoename 144 do<br>145     vias&#x3D;”$vias nexthop via $wan_ip dev $wan_ifname weight 1 “<br>146     let “rt&#x3D;100+$i”<br>147     i&#x3D;$(($i+1)) 148 ip route flush table $rt 149 ip route add default via $wan_ip dev $wan_ifname table $rt 150     ip route add table $rt to $(ip route | grep br-lan) 151<br>152     if [ $(iptables -t nat -vxnL POSTROUTING | grep -c “ $wan_ifname “) &#x3D;&#x3D; “0” ] ; 153     then<br>154         iptables -t raw -A PREROUTING -i $wan_ifname -j zone_wan_notrack 155         iptables -t nat -A PREROUTING -i $wan_ifname -j zone_wan_prerouting 156         iptables -t nat -A POSTROUTING -o $wan_ifname -j zone_wan_nat 157         iptables -t filter -A forward -i $wan_ifname -j zone_wan_forward 158         iptables -t filter -A input -i $wan_ifname -j zone_wan 159         iptables -t filter -A zone_wan_ACCEPT -o $wan_ifname -j ACCEPT 160         iptables -t filter -A zone_wan_ACCEPT -i $wan_ifname -j ACCEPT 161         iptables -t filter -A zone_wan_DROP -o $wan_ifname -j DROP 162         iptables -t filter -A zone_wan_DROP -i $wan_ifname -j DROP 163         iptables -t filter -A zone_wan_REJECT -o $wan_ifname -j reject 164         iptables -t filter -A zone_wan_REJECT -i $wan_ifname -j reject 165     fi<br>166     iptables -A PREROUTING -t mangle -i $wan_ifname -j MARK –set-mark $rt 167     iptables -t mangle -A zone_wan_MSSFIX -o $wan_ifname -p tcp -m tcp –tcp-flags SYN,RST SYN -j TCPMSS –clamp-mss-to-pmtu 168 ip rule add fwmark $rt table $rt prio $rt 169 done<br>170 ip route del default 171 ip route add default scope global $vias 172 ip route flush cache 173 ip route list 174 route -n 175 root@OpenWrt:~# </p>\n<p>View Code (duobo)</p>\n<p>修订版（V0.3.1）</p>\n<p><img data-src=\"http://images.cnblogs.com/OutliningIndicators/ContractedBlock.gif\"><img data-src=\"http://images.cnblogs.com/OutliningIndicators/ExpandedBlockStart.gif\"></p>\n<p> 1 #!&#x2F;bin&#x2F;sh<br> 2 #modified by muziling v0.3<br> 3 #并发多拨脚本<br> 4 #modified by carl v0.3.1 (修正一处bug，改善友好提示信息) 5<br> 6 #number是重拔次数，本脚本启动后一共尝试的次数<br> 7 #n是几拔，同时发出几拨，理论上设置越大成功概率越大！<br> 8 #ok是拔上几次后退出拔号, 要实现的预期目标<br> 9 #wait time 每次单线多拨失败后，重试的等待时间 10<br> 11 number&#x3D;15<br> 12 n&#x3D;7<br> 13 ok&#x3D;2<br> 14 wait=8<br> 15 # avoid same with feixiang’s N-WAN naming and must start with “wan”<br> 16 prefix&#x3D;wan<br> 17 vthprefix&#x3D;vth<br> 18<br> 19 j&#x3D;$(ifconfig | grep pppoe-wan | wc -l)<br> 20 if [ $j -ge $ok ] ;<br> 21 then<br> 22     echo 已经是[$j]拔了，退出拔号程序。 23     exit 0<br> 24 fi<br> 25<br> 26 if [ -f &#x2F;etc&#x2F;config&#x2F;nwannumset ] ;<br> 27 then<br> 28     uci set nwannumset.@macvlan_numset[0].macvlan_num&#x3D;1<br> 29     uci commit nwannumset<br> 30 fi<br> 31<br> 32 for i in $( seq 1 $(($n-1)))<br> 33 do<br> 34     ifname&#x3D;$prefix$i<br> 35     ifvth&#x3D;$vthprefix$i<br> 36     #ifwan&#x3D;$(uci get network.wan.ifname)<br> 37     pppoe_name&#x3D;$(uci get network.wan.username)<br> 38     pppoe_pw&#x3D;$(uci get network.wan.password)<br> 39<br> 40     if [ $(ip link | grep “ ${ifvth}@eth0.2:” | wc -l) &#x3D;&#x3D; “0” ] ; 41     then<br> 42         macfac&#x3D;$(ifconfig | grep eth0.2 | tr -s “ “ | cut -d “ “ -f5 | cut -b 1-8)<br> 43         mac&#x3D;”$macfac:”$(md5sum &#x2F;proc&#x2F;sys&#x2F;kernel&#x2F;random&#x2F;uuid | sed ‘s&#x2F;\\(..\\)&#x2F;&amp;:&#x2F;g’ | cut -b 1-8 | tr [a-f] [A-F])<br> 44         ip link add link eth0.2 $ifvth type macvlan 45         ifconfig $ifvth hw ether $mac 46         echo 更换MAC完毕$ifvth. 47     fi<br> 48<br> 49     # add &#x2F;etc&#x2F;config&#x2F;network<br> 50     uci delete network.$ifname<br> 51     uci set network.$ifname&#x3D;interface<br> 52     uci set network.$ifname.ifname&#x3D;$ifvth<br> 53     #uci set network.$ifname._orig_ifname&#x3D;eth0.2<br> 54     #uci set network.$ifname._orig_bridge&#x3D;false<br> 55     uci set network.$ifname.proto&#x3D;pppoe<br> 56     uci set network.$ifname.username&#x3D;$pppoe_name<br> 57     uci set network.$ifname.password&#x3D;$pppoe_pw<br> 58     uci set network.$ifname.auto&#x3D;0<br> 59     uci set network.$ifname.defaultroute&#x3D;0<br> 60     uci set network.$ifname.peerdns&#x3D;1<br> 61     uci set network.$ifname.pppd_options&#x3D;”plugin rp-pppoe.so syncppp $n”<br> 62<br> 63     # add &#x2F;etc&#x2F;config&#x2F;dhcp<br> 64     uci delete dhcp.$ifvth<br> 65     uci set dhcp.$ifvth&#x3D;dhcp<br> 66     uci set dhcp.$ifvth.interface&#x3D;$ifname<br> 67     uci set dhcp.$ifvth.ignore&#x3D;1<br> 68<br> 69     if [ -f &#x2F;etc&#x2F;config&#x2F;nwan ] ;<br> 70     then<br> 71         uci delete nwan.$ifname<br> 72         uci set nwan.$ifname&#x3D;interface<br> 73         uci set nwan.$ifname.name&#x3D;unicom<br> 74         uci set nwan.$ifname.route&#x3D;balance<br> 75         uci set nwan.$ifname.weight&#x3D;1<br> 76         uci set nwan.$ifname.uptime=0day,0hour,0min<br> 77         uci commit nwan<br> 78     fi<br> 79 done<br> 80<br> 81 uci set network.wan.defaultroute&#x3D;0<br> 82 uci set network.wan.peerdns&#x3D;1<br> 83 uci set network.wan.pppd_options&#x3D;”plugin rp-pppoe.so syncppp $n”<br> 84 uci commit network<br> 85 uci commit dhcp<br> 86<br> 87 fw_wan_list&#x3D;$(uci show network |grep &#x3D;interface |grep -v lan|grep -v loopback |cut -d”.” -f2 | awk -F “=“ ‘{printf $1” “}’)<br> 88 uci set firewall.@zone[1].network&#x3D;”$fw_wan_list”<br> 89 uci commit firewall<br> 90 &#x2F;etc&#x2F;init.d&#x2F;firewall restart<br> 91<br> 92 for q in $( seq 1 $number ) 93 do<br> 94     echo<br> 95     echo ___________________________________________________ 96     echo 开始第$q次拔号……….. 97     killall -q -SIG pppd<br> 98     if [ “$q” &#x3D;&#x3D; “1” ] ; 99     then<br>100         for i in $( seq 1 $(($n-1))) 101         do<br>102 ifup $prefix$i 103         done<br>104     fi<br>105<br>106     echo 正在并发拔号中…………. 107     echo 等待$wait秒…………. 108     sleep $wait<br>109<br>110     j&#x3D;$(ps | grep pppd | wc -l) 111     ! [ “$j” -ge “$n” ]  &amp;&amp; ifup ${prefix}1<br>112<br>113     ifconfig | grep pppoe 114     j&#x3D;$(ifconfig | grep pppoe-wan | wc -l) 115<br>116     ! [ “$j” -ge “$ok” ] &amp;&amp; echo [$n]拔[$j]拔成功, 小于设定的[$ok]拔，将重新拔号… 117     [ “$j” -ge “$ok” ] &amp;&amp; echo [$n]拔[$j]拔成功, 大于或等于设定的[$ok]拨，退出拔号… 118<br>119     if [ “$j” -ge “$ok” ] ; 120     then<br>121         for i in $( seq 0 $(($n-1))) 122         do<br>123             if [ “$i” &#x3D;&#x3D; “0” ] ; 124             then<br>125                 interface&#x3D;wan 126             else<br>127                 interface&#x3D;$prefix$i 128             fi<br>129             if [ $(ifconfig | grep “pppoe-$interface “ | wc -l) &#x3D;&#x3D; “0” ] ; 130             then<br>131 ifdown $interface 132             fi<br>133         done<br>134 break 135     fi<br>136 done # done&#x2F;tried all tring times $number 137<br>138 # kill ddns sleep and re-check wan ip change 139 killall sleep<br>140<br>141 # reboot the machine if failed tried times 142 #sleep $wait<br>143 j&#x3D;$(ifconfig | grep pppoe-wan | wc -l) 144 ! [ “$j” -gt 0 ] &amp;&amp; reboot 145<br>146<br>147 echo ___________________________________________________ 148 echo 开始N-WAN负载均衡功能… 149 #ppoename&#x3D;$(ifconfig |grep ‘ppoe-‘ |awk ‘{print substr($1,7)}’|tr ‘\\n’ ‘ ‘) 150 ppoename&#x3D;$(ifconfig|grep ‘ppoe-‘ |awk ‘{print $1}’|tr ‘\\n’ ‘ ‘) 151 i&#x3D;0<br>152 vias&#x3D;””<br>153 for wan_ifname in $ppoename 154 do<br>155     vias&#x3D;”$vias nexthop via $wan_ip dev $wan_ifname weight 1 “<br>156     let “rt&#x3D;100+$i”<br>157     i&#x3D;$(($i+1)) 158 ip route flush table $rt 159 #REMOVE ERROR 160 ip route add default via $wan_ip dev $wan_ifname table $rt 161     ip route add table $rt to $(ip route | grep br-lan) 162<br>163     if [ $(iptables -t nat -vxnL POSTROUTING | grep -c “ $wan_ifname “) &#x3D;&#x3D; “0” ] ; 164     then<br>165 #REMOVE ERROR 166         iptables -t raw -A PREROUTING -i $wan_ifname -j zone_wan_notrack 167         iptables -t nat -A PREROUTING -i $wan_ifname -j zone_wan_prerouting 168 #REMOVE ERROR 169         iptables -t nat -A POSTROUTING -o $wan_ifname -j zone_wan_nat 170         iptables -t filter -A forward -i $wan_ifname -j zone_wan_forward 171 #REMOVE ERROR 172         iptables -t filter -A input -i $wan_ifname -j zone_wan 173         iptables -t filter -A zone_wan_ACCEPT -o $wan_ifname -j ACCEPT 174         iptables -t filter -A zone_wan_ACCEPT -i $wan_ifname -j ACCEPT 175         iptables -t filter -A zone_wan_DROP -o $wan_ifname -j DROP 176         iptables -t filter -A zone_wan_DROP -i $wan_ifname -j DROP 177         iptables -t filter -A zone_wan_REJECT -o $wan_ifname -j reject 178         iptables -t filter -A zone_wan_REJECT -i $wan_ifname -j reject 179     fi<br>180<br>181     iptables -A PREROUTING -t mangle -i $wan_ifname -j MARK –set-mark $rt 182     iptables -t mangle -A zone_wan_MSSFIX -o $wan_ifname -p tcp -m tcp –tcp-flags SYN,RST SYN -j TCPMSS –clamp-mss-to-pmtu 183 ip rule add fwmark $rt table $rt prio $rt 184 done<br>185<br>186 ip route del default 187<br>188 echo ___________________________________________________ 189 echo 下面执行ip route add default scope global $vias 190 ip route add default scope global $vias 191<br>192 ip route flush cache 193<br>194 echo ___________________________________________________ 195 echo 下面输出ip route list 196 ip route list 197<br>198 echo ___________________________________________________ 199 echo 下面输出route -n 200 route -n</p>\n<p>View Code</p>\n<p><strong>参考文献</strong></p>\n<hr>\n<p><a href=\"http://www.right.com.cn/forum/thread-102073-1-1.html\">OpenWrt For AR71xx系列 ar2 Tr 脱机 N-WAN r48549</a></p>\n<p><a href=\"http://www.right.com.cn/forum/thread-104970-1-1.html\">自己动手 4530R 脱机 Samba U-BOOT 多拨（11-04更新部分问题说明，请看2楼）</a></p>\n<p><a href=\"http://www.right.com.cn/forum/thread-102411-1-1.html\">[0916更新]WR703N WR720N 及其他各类 OpenWRT类路由实现一号多拨带宽叠加教程</a></p>\n","more":"<ul>\n<li>2021年11月更新：如果是K2P A2版本硬件，请参考更简易的步骤，更加高效，不需要太多代码知识。 <a href=\"https://www.cnblogs.com/backuper/p/15523365.html\">K2P刷机-坐标北京Unicom</a></li>\n</ul>\n<p><strong>前题</strong></p>\n<hr>\n<ul>\n<li>硬件：路由器，刷入<a href=\"https://openwrt.org/\">OpenWrt</a></li>\n<li>一些背景知识和动手能力</li>\n</ul>\n<p><strong>目标效果图</strong></p>\n<hr>\n<p><img data-src=\"http://images2015.cnblogs.com/blog/41238/201603/41238-20160323125607870-97593375.jpg\" alt=\"实际例子Sample \"></p>\n<p><img data-src=\"http://images2015.cnblogs.com/blog/41238/201603/41238-20160326151505526-1086117574.jpg\"></p>\n<p><strong>步骤</strong></p>\n<hr>\n<ol>\n<li><p>使用SSH 登陆路由器。I.e. ssh <a href=\"mailto:&#114;&#x6f;&#x6f;&#x74;&#64;&#49;&#x39;&#x32;&#x2e;&#49;&#x36;&#x38;&#46;&#50;&#x2e;&#x31;\">&#114;&#x6f;&#x6f;&#x74;&#64;&#49;&#x39;&#x32;&#x2e;&#49;&#x36;&#x38;&#46;&#50;&#x2e;&#x31;</a></p>\n</li>\n<li><p>运行&#x2F;usr&#x2F;bin&#x2F;duobo。日志类似：</p>\n</li>\n<li><p><img data-src=\"http://images.cnblogs.com/OutliningIndicators/ContractedBlock.gif\"><img data-src=\"http://images.cnblogs.com/OutliningIndicators/ExpandedBlockStart.gif\"></p>\n<p>sh: 2: unknown operand<br>Killed<br>Warning: Unable to locate ipset utility, disabling ipset support * Flushing IPv4 filter table * Flushing IPv4 nat table * Flushing IPv4 mangle table * Flushing IPv4 raw table * Flushing conntrack table … * Populating IPv4 filter table * Zone ‘lan’<br>   * Zone ‘wan’<br>   * Rule ‘Allow-DHCP-Renew’<br>   * Rule ‘Allow-Ping’<br>   * Rule ‘51413’<br>   * Rule ‘9091’<br>   * Rule ‘9000’<br>   * Rule ‘6800’<br>   * Forward ‘lan’ -&gt; ‘wan’<br> * Populating IPv4 nat table * Zone ‘lan’<br>   * Zone ‘wan’<br> * Populating IPv4 mangle table * Zone ‘lan’<br>   * Zone ‘wan’<br> * Populating IPv4 raw table * Zone ‘lan’<br>   * Zone ‘wan’<br> * Set tcp_ecn to off * Set tcp_syncookies to on * Set tcp_window_scaling to on * Running script ‘&#x2F;etc&#x2F;firewall.user’<br> * Running script ‘&#x2F;usr&#x2F;share&#x2F;miniupnpd&#x2F;firewall.include’<br> * Running script ‘&#x2F;usr&#x2F;share&#x2F;qos_gargoyle&#x2F;firewall.include’<br>   ! Failed with exit code 1 ___________________________________________________<br>开始第1次拔号………..<br>正在并发拔号中………….<br>等待3秒………….<br>[3]拔[0]拔成功, 小于设定的[2]拔，将重新拔号…</p>\n<p>_________________________</p>\n<p>View Code</p>\n</li>\n<li><p>_如果没有成功并发多播，根据提示信息调整duobo的内部参数设置，重新运行_。分享一些技巧：</p>\n</li>\n<li><p>number&#x3D;10 #number是重拔次数，本脚本启动后一共尝试的次数 n=7 #n是几拔，同时发出几拨，理论上设置越大成功概率越大！ ok=2 #ok是拔上几次后退出拔号, 要实现的预期目标<br>wait=5 #wait time 每次单线多拨失败后，重试的等待时间</p>\n<ul>\n<li><strong>原则：</strong>失败多次以后，建议冷重启路由器，多个运行中的脚本会互相冲突，把问题复杂化。</li>\n<li><strong>多拨失败以后，耐心等上1分钟；很多次的多播成功都是脚本完成以后退出，然后60秒内获取了超过预期的多条链接。</strong></li>\n<li><strong>把n调到7，这样会虚拟出很多wan接口，根据硬件性能，理论上设置越大成功概率越大！</strong></li>\n<li>将ok调低一点，比如2。我觉得别太贪心，如果能稳定多播2个ADSL的IP，那其实概率上更折中了稳定性和高负载下的带宽均衡。</li>\n<li>wait的时间我感觉5秒－8秒差不多，这个要看运行日志，做相应调整。</li>\n<li>看懂程序的原理，根据实际情况调整脚本程序。比如：这个版本的程序是这么多播的，ifup $prefix$i</li>\n</ul>\n</li>\n</ol>\n<p><strong>遗留问题</strong></p>\n<hr>\n<p><img data-src=\"http://images.cnblogs.com/OutliningIndicators/ContractedBlock.gif\"><img data-src=\"http://images.cnblogs.com/OutliningIndicators/ExpandedBlockStart.gif\"></p>\n<p> 1 开始第3次拔号………..<br> 2 正在并发拔号中………….<br> 3 等待10秒………….<br> 4 pppoe-wan Link encap:Point-to-Point Protocol<br> 5 pppoe-wan3 Link encap:Point-to-Point Protocol<br> 6 [3]拔[2]拔成功, 大于或等于设定的[2]拨，退出拔号…<br> 7 Error: an inet address is expected rather than “dev”.<br> 8 iptables v1.4.10: Couldn’t load target `zone_wan_notrack’:File not found<br> 9<br>10 Try `iptables -h’ or ‘iptables –help’ for more information.<br>11 iptables v1.4.10: Couldn’t load target `zone_wan_nat’:File not found 12<br>13 Try `iptables -h’ or ‘iptables –help’ for more information.<br>14 iptables: No chain&#x2F;target&#x2F;match by that name. 15 iptables v1.4.10: Couldn’t load target `zone_wan’:File not found 16<br>17 Try `iptables -h’ or ‘iptables –help’ for more information.<br>18 iptables: No chain&#x2F;target&#x2F;match by that name. 19 iptables: No chain&#x2F;target&#x2F;match by that name. 20 iptables: No chain&#x2F;target&#x2F;match by that name. 21 iptables: No chain&#x2F;target&#x2F;match by that name. 22 iptables: No chain&#x2F;target&#x2F;match by that name. 23 iptables: No chain&#x2F;target&#x2F;match by that name. 24 iptables: No chain&#x2F;target&#x2F;match by that name. 25 Error: an inet address is expected rather than “dev”. 26 iptables v1.4.10: Couldn’t load target `zone_wan_notrack’:File not found 27<br>28 Try `iptables -h’ or ‘iptables –help’ for more information.<br>29 iptables v1.4.10: Couldn’t load target `zone_wan_nat’:File not found 30<br>31 Try `iptables -h’ or ‘iptables –help’ for more information.<br>32 iptables: No chain&#x2F;target&#x2F;match by that name. 33 iptables v1.4.10: Couldn’t load target `zone_wan’:File not found 34<br>35 Try `iptables -h’ or ‘iptables –help’ for more information.<br>36 iptables: No chain&#x2F;target&#x2F;match by that name. 37 iptables: No chain&#x2F;target&#x2F;match by that name. 38 iptables: No chain&#x2F;target&#x2F;match by that name. 39 iptables: No chain&#x2F;target&#x2F;match by that name. 40 iptables: No chain&#x2F;target&#x2F;match by that name. 41 iptables: No chain&#x2F;target&#x2F;match by that name. 42 iptables: No chain&#x2F;target&#x2F;match by that name. 43 Error: an IP address is expected rather than “dev”<br>44 192.168.2.0&#x2F;24 dev br-lan  proto kernel  scope link  src 192.168.2.1<br>45 221.218.232.1 dev pppoe-wan3  proto kernel  scope link  src 123.112.248.148<br>46 221.218.232.1 dev pppoe-wan  proto kernel  scope link  src 221.218.236.51<br>47 Kernel IP routing table 48 Destination     Gateway         Genmask         Flags Metric Ref    Use Iface 49 192.168.2.0     0.0.0.0         255.255.255.0   U     0      0        0 br-lan 50 221.218.232.1   0.0.0.0         255.255.255.255 UH    0      0        0 pppoe-wan3 51 221.218.232.1   0.0.0.0         255.255.255.255 UH    0      0        0 pppoe-wan</p>\n<p>View Error Code</p>\n<p>显然这个0.3版本的脚本不完全适用于我的路由器，有时间我需要查查原因。</p>\n<p>估计都是关于iptables</p>\n<p>有没有大侠探讨一下？</p>\n<p><em>修正了下面版本中的一个错误</em></p>\n<p><em>line 19：if [ $j -ge $ok ] ;</em></p>\n<p><strong>多拨代码(V0.3)</strong></p>\n<hr>\n<p><img data-src=\"http://images.cnblogs.com/OutliningIndicators/ContractedBlock.gif\"><img data-src=\"http://images.cnblogs.com/OutliningIndicators/ExpandedBlockStart.gif\"></p>\n<p> 1 #!&#x2F;bin&#x2F;sh<br> 2 #modified by muziling v0.3<br> 3 #并发多拨脚本<br> 4<br> 5 #number是重拔次数<br> 6 #n是几拔<br> 7 #ok是拔上几次后退出拔号<br> 8 #wait time<br> 9<br> 10 number&#x3D;10<br> 11 n&#x3D;3<br> 12 ok&#x3D;2<br> 13 wait=5<br> 14 # avoid same with feixiang’s N-WAN naming and must start with “wan”<br> 15 prefix&#x3D;wan<br> 16 vthprefix&#x3D;vth<br> 17<br> 18 j&#x3D;$(ifconfig | grep pppoe-wan | wc -l)<br> 19 if [ “$j” &gt;&#x3D; “$ok” ] ; 20 then<br> 21     echo 已经是[$j]拔了，退出拔号… 22     exit 0<br> 23 fi<br> 24<br> 25 if [ -f &#x2F;etc&#x2F;config&#x2F;nwannumset ] ;<br> 26 then<br> 27     uci set nwannumset.@macvlan_numset[0].macvlan_num&#x3D;1<br> 28     uci commit nwannumset<br> 29 fi<br> 30 for i in $( seq 1 $(($n-1)))<br> 31 do<br> 32     ifname&#x3D;$prefix$i<br> 33     ifvth&#x3D;$vthprefix$i<br> 34     #ifwan&#x3D;$(uci get network.wan.ifname)<br> 35     pppoe_name&#x3D;$(uci get network.wan.username)<br> 36     pppoe_pw&#x3D;$(uci get network.wan.password)<br> 37<br> 38     if [ $(ip link | grep “ ${ifvth}@eth0.2:” | wc -l) &#x3D;&#x3D; “0” ] ; 39     then<br> 40         macfac&#x3D;$(ifconfig | grep eth0.2 | tr -s “ “ | cut -d “ “ -f5 | cut -b 1-8)<br> 41         mac&#x3D;”$macfac:”$(md5sum &#x2F;proc&#x2F;sys&#x2F;kernel&#x2F;random&#x2F;uuid | sed ‘s&#x2F;\\(..\\)&#x2F;&amp;:&#x2F;g’ | cut -b 1-8 | tr [a-f] [A-F])<br> 42         ip link add link eth0.2 $ifvth type macvlan 43         ifconfig $ifvth hw ether $mac 44     fi<br> 45<br> 46     # add &#x2F;etc&#x2F;config&#x2F;network<br> 47     uci delete network.$ifname<br> 48     uci set network.$ifname&#x3D;interface<br> 49     uci set network.$ifname.ifname&#x3D;$ifvth<br> 50     #uci set network.$ifname._orig_ifname&#x3D;eth0.2<br> 51     #uci set network.$ifname._orig_bridge&#x3D;false<br> 52     uci set network.$ifname.proto&#x3D;pppoe<br> 53     uci set network.$ifname.username&#x3D;$pppoe_name<br> 54     uci set network.$ifname.password&#x3D;$pppoe_pw<br> 55     uci set network.$ifname.auto&#x3D;0<br> 56     uci set network.$ifname.defaultroute&#x3D;0<br> 57     uci set network.$ifname.peerdns&#x3D;1<br> 58     uci set network.$ifname.pppd_options&#x3D;”plugin rp-pppoe.so syncppp $n”<br> 59<br> 60     # add &#x2F;etc&#x2F;config&#x2F;dhcp<br> 61     uci delete dhcp.$ifvth<br> 62     uci set dhcp.$ifvth&#x3D;dhcp<br> 63     uci set dhcp.$ifvth.interface&#x3D;$ifname<br> 64     uci set dhcp.$ifvth.ignore&#x3D;1<br> 65<br> 66     if [ -f &#x2F;etc&#x2F;config&#x2F;nwan ] ;<br> 67     then<br> 68         uci delete nwan.$ifname<br> 69         uci set nwan.$ifname&#x3D;interface<br> 70         uci set nwan.$ifname.name&#x3D;telecom<br> 71         uci set nwan.$ifname.route&#x3D;balance<br> 72         uci set nwan.$ifname.weight&#x3D;1<br> 73         uci set nwan.$ifname.uptime=0day,0hour,0min<br> 74         uci commit nwan<br> 75     fi<br> 76 done<br> 77 uci set network.wan.defaultroute&#x3D;0<br> 78 uci set network.wan.peerdns&#x3D;1<br> 79 uci set network.wan.pppd_options&#x3D;”plugin rp-pppoe.so syncppp $n”<br> 80 uci commit network<br> 81 uci commit dhcp<br> 82<br> 83 fw_wan_list&#x3D;$(uci show network |grep &#x3D;interface |grep -v lan|grep -v loopback |cut -d”.” -f2 | awk -F “=“ ‘{printf $1” “}’)<br> 84 uci set firewall.@zone[1].network&#x3D;”$fw_wan_list”<br> 85 uci commit firewall<br> 86 &#x2F;etc&#x2F;init.d&#x2F;firewall restart<br> 87<br> 88 for q in $( seq 1 $number ) 89 do<br> 90     echo<br> 91     echo ___________________________________________________ 92     echo 开始第$q次拔号……….. 93     killall -q -SIG pppd<br> 94     if [ “$q” &#x3D;&#x3D; “1” ] ; 95     then<br> 96         for i in $( seq 1 $(($n-1)))<br> 97         do<br> 98             ifup $prefix$i<br> 99         done<br>100     fi<br>101<br>102     echo 正在并发拔号中…………. 103     echo 等待$wait秒…………. 104     sleep $wait<br>105<br>106     j&#x3D;$(ps | grep pppd | wc -l) 107     ! [ “$j” -ge “$n” ]  &amp;&amp; ifup ${prefix}1<br>108<br>109     ifconfig|grep pppoe 110     j&#x3D;$(ifconfig | grep pppoe-wan | wc -l) 111<br>112     ! [ “$j” -ge “$ok” ] &amp;&amp; echo [$n]拔[$j]拔成功, 小于设定的[$ok]拔，将重新拔号… 113     [ “$j” -ge “$ok” ] &amp;&amp; echo [$n]拔[$j]拔成功, 大于或等于设定的[$ok]拨，退出拔号… 114<br>115     if [ “$j” -ge “$ok” ] ; 116     then<br>117         for i in $( seq 0 $(($n-1))) 118         do<br>119             if [ “$i” &#x3D;&#x3D; “0” ] ; 120             then<br>121                 interface&#x3D;wan 122             else<br>123                 interface&#x3D;$prefix$i 124             fi<br>125             if [ $(ifconfig | grep “pppoe-$interface “ | wc -l) &#x3D;&#x3D; “0” ] ; 126             then<br>127 ifdown $interface 128             fi<br>129         done<br>130 break 131     fi<br>132 done<br>133 # kill ddns sleep and re-check wan ip change 134 killall sleep<br>135<br>136 j&#x3D;$(ifconfig | grep pppoe-wan | wc -l) 137 ! [ “$j” -ge 0 ] &amp;&amp; reboot 138<br>139 #ppoename&#x3D;$(ifconfig |grep ‘ppoe-‘ |awk ‘{print substr($1,7)}’|tr ‘\\n’ ‘ ‘) 140 ppoename&#x3D;$(ifconfig |grep ‘ppoe-‘ |awk ‘{print $1}’|tr ‘\\n’ ‘ ‘) 141 i&#x3D;0<br>142 vias&#x3D;””<br>143 for wan_ifname in $ppoename 144 do<br>145     vias&#x3D;”$vias nexthop via $wan_ip dev $wan_ifname weight 1 “<br>146     let “rt&#x3D;100+$i”<br>147     i&#x3D;$(($i+1)) 148 ip route flush table $rt 149 ip route add default via $wan_ip dev $wan_ifname table $rt 150     ip route add table $rt to $(ip route | grep br-lan) 151<br>152     if [ $(iptables -t nat -vxnL POSTROUTING | grep -c “ $wan_ifname “) &#x3D;&#x3D; “0” ] ; 153     then<br>154         iptables -t raw -A PREROUTING -i $wan_ifname -j zone_wan_notrack 155         iptables -t nat -A PREROUTING -i $wan_ifname -j zone_wan_prerouting 156         iptables -t nat -A POSTROUTING -o $wan_ifname -j zone_wan_nat 157         iptables -t filter -A forward -i $wan_ifname -j zone_wan_forward 158         iptables -t filter -A input -i $wan_ifname -j zone_wan 159         iptables -t filter -A zone_wan_ACCEPT -o $wan_ifname -j ACCEPT 160         iptables -t filter -A zone_wan_ACCEPT -i $wan_ifname -j ACCEPT 161         iptables -t filter -A zone_wan_DROP -o $wan_ifname -j DROP 162         iptables -t filter -A zone_wan_DROP -i $wan_ifname -j DROP 163         iptables -t filter -A zone_wan_REJECT -o $wan_ifname -j reject 164         iptables -t filter -A zone_wan_REJECT -i $wan_ifname -j reject 165     fi<br>166     iptables -A PREROUTING -t mangle -i $wan_ifname -j MARK –set-mark $rt 167     iptables -t mangle -A zone_wan_MSSFIX -o $wan_ifname -p tcp -m tcp –tcp-flags SYN,RST SYN -j TCPMSS –clamp-mss-to-pmtu 168 ip rule add fwmark $rt table $rt prio $rt 169 done<br>170 ip route del default 171 ip route add default scope global $vias 172 ip route flush cache 173 ip route list 174 route -n 175 root@OpenWrt:~# </p>\n<p>View Code (duobo)</p>\n<p>修订版（V0.3.1）</p>\n<p><img data-src=\"http://images.cnblogs.com/OutliningIndicators/ContractedBlock.gif\"><img data-src=\"http://images.cnblogs.com/OutliningIndicators/ExpandedBlockStart.gif\"></p>\n<p> 1 #!&#x2F;bin&#x2F;sh<br> 2 #modified by muziling v0.3<br> 3 #并发多拨脚本<br> 4 #modified by carl v0.3.1 (修正一处bug，改善友好提示信息) 5<br> 6 #number是重拔次数，本脚本启动后一共尝试的次数<br> 7 #n是几拔，同时发出几拨，理论上设置越大成功概率越大！<br> 8 #ok是拔上几次后退出拔号, 要实现的预期目标<br> 9 #wait time 每次单线多拨失败后，重试的等待时间 10<br> 11 number&#x3D;15<br> 12 n&#x3D;7<br> 13 ok&#x3D;2<br> 14 wait=8<br> 15 # avoid same with feixiang’s N-WAN naming and must start with “wan”<br> 16 prefix&#x3D;wan<br> 17 vthprefix&#x3D;vth<br> 18<br> 19 j&#x3D;$(ifconfig | grep pppoe-wan | wc -l)<br> 20 if [ $j -ge $ok ] ;<br> 21 then<br> 22     echo 已经是[$j]拔了，退出拔号程序。 23     exit 0<br> 24 fi<br> 25<br> 26 if [ -f &#x2F;etc&#x2F;config&#x2F;nwannumset ] ;<br> 27 then<br> 28     uci set nwannumset.@macvlan_numset[0].macvlan_num&#x3D;1<br> 29     uci commit nwannumset<br> 30 fi<br> 31<br> 32 for i in $( seq 1 $(($n-1)))<br> 33 do<br> 34     ifname&#x3D;$prefix$i<br> 35     ifvth&#x3D;$vthprefix$i<br> 36     #ifwan&#x3D;$(uci get network.wan.ifname)<br> 37     pppoe_name&#x3D;$(uci get network.wan.username)<br> 38     pppoe_pw&#x3D;$(uci get network.wan.password)<br> 39<br> 40     if [ $(ip link | grep “ ${ifvth}@eth0.2:” | wc -l) &#x3D;&#x3D; “0” ] ; 41     then<br> 42         macfac&#x3D;$(ifconfig | grep eth0.2 | tr -s “ “ | cut -d “ “ -f5 | cut -b 1-8)<br> 43         mac&#x3D;”$macfac:”$(md5sum &#x2F;proc&#x2F;sys&#x2F;kernel&#x2F;random&#x2F;uuid | sed ‘s&#x2F;\\(..\\)&#x2F;&amp;:&#x2F;g’ | cut -b 1-8 | tr [a-f] [A-F])<br> 44         ip link add link eth0.2 $ifvth type macvlan 45         ifconfig $ifvth hw ether $mac 46         echo 更换MAC完毕$ifvth. 47     fi<br> 48<br> 49     # add &#x2F;etc&#x2F;config&#x2F;network<br> 50     uci delete network.$ifname<br> 51     uci set network.$ifname&#x3D;interface<br> 52     uci set network.$ifname.ifname&#x3D;$ifvth<br> 53     #uci set network.$ifname._orig_ifname&#x3D;eth0.2<br> 54     #uci set network.$ifname._orig_bridge&#x3D;false<br> 55     uci set network.$ifname.proto&#x3D;pppoe<br> 56     uci set network.$ifname.username&#x3D;$pppoe_name<br> 57     uci set network.$ifname.password&#x3D;$pppoe_pw<br> 58     uci set network.$ifname.auto&#x3D;0<br> 59     uci set network.$ifname.defaultroute&#x3D;0<br> 60     uci set network.$ifname.peerdns&#x3D;1<br> 61     uci set network.$ifname.pppd_options&#x3D;”plugin rp-pppoe.so syncppp $n”<br> 62<br> 63     # add &#x2F;etc&#x2F;config&#x2F;dhcp<br> 64     uci delete dhcp.$ifvth<br> 65     uci set dhcp.$ifvth&#x3D;dhcp<br> 66     uci set dhcp.$ifvth.interface&#x3D;$ifname<br> 67     uci set dhcp.$ifvth.ignore&#x3D;1<br> 68<br> 69     if [ -f &#x2F;etc&#x2F;config&#x2F;nwan ] ;<br> 70     then<br> 71         uci delete nwan.$ifname<br> 72         uci set nwan.$ifname&#x3D;interface<br> 73         uci set nwan.$ifname.name&#x3D;unicom<br> 74         uci set nwan.$ifname.route&#x3D;balance<br> 75         uci set nwan.$ifname.weight&#x3D;1<br> 76         uci set nwan.$ifname.uptime=0day,0hour,0min<br> 77         uci commit nwan<br> 78     fi<br> 79 done<br> 80<br> 81 uci set network.wan.defaultroute&#x3D;0<br> 82 uci set network.wan.peerdns&#x3D;1<br> 83 uci set network.wan.pppd_options&#x3D;”plugin rp-pppoe.so syncppp $n”<br> 84 uci commit network<br> 85 uci commit dhcp<br> 86<br> 87 fw_wan_list&#x3D;$(uci show network |grep &#x3D;interface |grep -v lan|grep -v loopback |cut -d”.” -f2 | awk -F “=“ ‘{printf $1” “}’)<br> 88 uci set firewall.@zone[1].network&#x3D;”$fw_wan_list”<br> 89 uci commit firewall<br> 90 &#x2F;etc&#x2F;init.d&#x2F;firewall restart<br> 91<br> 92 for q in $( seq 1 $number ) 93 do<br> 94     echo<br> 95     echo ___________________________________________________ 96     echo 开始第$q次拔号……….. 97     killall -q -SIG pppd<br> 98     if [ “$q” &#x3D;&#x3D; “1” ] ; 99     then<br>100         for i in $( seq 1 $(($n-1))) 101         do<br>102 ifup $prefix$i 103         done<br>104     fi<br>105<br>106     echo 正在并发拔号中…………. 107     echo 等待$wait秒…………. 108     sleep $wait<br>109<br>110     j&#x3D;$(ps | grep pppd | wc -l) 111     ! [ “$j” -ge “$n” ]  &amp;&amp; ifup ${prefix}1<br>112<br>113     ifconfig | grep pppoe 114     j&#x3D;$(ifconfig | grep pppoe-wan | wc -l) 115<br>116     ! [ “$j” -ge “$ok” ] &amp;&amp; echo [$n]拔[$j]拔成功, 小于设定的[$ok]拔，将重新拔号… 117     [ “$j” -ge “$ok” ] &amp;&amp; echo [$n]拔[$j]拔成功, 大于或等于设定的[$ok]拨，退出拔号… 118<br>119     if [ “$j” -ge “$ok” ] ; 120     then<br>121         for i in $( seq 0 $(($n-1))) 122         do<br>123             if [ “$i” &#x3D;&#x3D; “0” ] ; 124             then<br>125                 interface&#x3D;wan 126             else<br>127                 interface&#x3D;$prefix$i 128             fi<br>129             if [ $(ifconfig | grep “pppoe-$interface “ | wc -l) &#x3D;&#x3D; “0” ] ; 130             then<br>131 ifdown $interface 132             fi<br>133         done<br>134 break 135     fi<br>136 done # done&#x2F;tried all tring times $number 137<br>138 # kill ddns sleep and re-check wan ip change 139 killall sleep<br>140<br>141 # reboot the machine if failed tried times 142 #sleep $wait<br>143 j&#x3D;$(ifconfig | grep pppoe-wan | wc -l) 144 ! [ “$j” -gt 0 ] &amp;&amp; reboot 145<br>146<br>147 echo ___________________________________________________ 148 echo 开始N-WAN负载均衡功能… 149 #ppoename&#x3D;$(ifconfig |grep ‘ppoe-‘ |awk ‘{print substr($1,7)}’|tr ‘\\n’ ‘ ‘) 150 ppoename&#x3D;$(ifconfig|grep ‘ppoe-‘ |awk ‘{print $1}’|tr ‘\\n’ ‘ ‘) 151 i&#x3D;0<br>152 vias&#x3D;””<br>153 for wan_ifname in $ppoename 154 do<br>155     vias&#x3D;”$vias nexthop via $wan_ip dev $wan_ifname weight 1 “<br>156     let “rt&#x3D;100+$i”<br>157     i&#x3D;$(($i+1)) 158 ip route flush table $rt 159 #REMOVE ERROR 160 ip route add default via $wan_ip dev $wan_ifname table $rt 161     ip route add table $rt to $(ip route | grep br-lan) 162<br>163     if [ $(iptables -t nat -vxnL POSTROUTING | grep -c “ $wan_ifname “) &#x3D;&#x3D; “0” ] ; 164     then<br>165 #REMOVE ERROR 166         iptables -t raw -A PREROUTING -i $wan_ifname -j zone_wan_notrack 167         iptables -t nat -A PREROUTING -i $wan_ifname -j zone_wan_prerouting 168 #REMOVE ERROR 169         iptables -t nat -A POSTROUTING -o $wan_ifname -j zone_wan_nat 170         iptables -t filter -A forward -i $wan_ifname -j zone_wan_forward 171 #REMOVE ERROR 172         iptables -t filter -A input -i $wan_ifname -j zone_wan 173         iptables -t filter -A zone_wan_ACCEPT -o $wan_ifname -j ACCEPT 174         iptables -t filter -A zone_wan_ACCEPT -i $wan_ifname -j ACCEPT 175         iptables -t filter -A zone_wan_DROP -o $wan_ifname -j DROP 176         iptables -t filter -A zone_wan_DROP -i $wan_ifname -j DROP 177         iptables -t filter -A zone_wan_REJECT -o $wan_ifname -j reject 178         iptables -t filter -A zone_wan_REJECT -i $wan_ifname -j reject 179     fi<br>180<br>181     iptables -A PREROUTING -t mangle -i $wan_ifname -j MARK –set-mark $rt 182     iptables -t mangle -A zone_wan_MSSFIX -o $wan_ifname -p tcp -m tcp –tcp-flags SYN,RST SYN -j TCPMSS –clamp-mss-to-pmtu 183 ip rule add fwmark $rt table $rt prio $rt 184 done<br>185<br>186 ip route del default 187<br>188 echo ___________________________________________________ 189 echo 下面执行ip route add default scope global $vias 190 ip route add default scope global $vias 191<br>192 ip route flush cache 193<br>194 echo ___________________________________________________ 195 echo 下面输出ip route list 196 ip route list 197<br>198 echo ___________________________________________________ 199 echo 下面输出route -n 200 route -n</p>\n<p>View Code</p>\n<p><strong>参考文献</strong></p>\n<hr>\n<p><a href=\"http://www.right.com.cn/forum/thread-102073-1-1.html\">OpenWrt For AR71xx系列 ar2 Tr 脱机 N-WAN r48549</a></p>\n<p><a href=\"http://www.right.com.cn/forum/thread-104970-1-1.html\">自己动手 4530R 脱机 Samba U-BOOT 多拨（11-04更新部分问题说明，请看2楼）</a></p>\n<p><a href=\"http://www.right.com.cn/forum/thread-102411-1-1.html\">[0916更新]WR703N WR720N 及其他各类 OpenWRT类路由实现一号多拨带宽叠加教程</a></p>\n","categories":[],"tags":[]}